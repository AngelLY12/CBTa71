---
// src/components/ChartDonut.astro
import { Fragment } from 'astro/jsx-runtime';
---

<Fragment>
  <div id="donut-wrapper" class="w-full flex flex-col items-center">
    <div id="donut-container" class="relative w-full max-w-[220px] sm:max-w-[280px] lg:max-w-[330px] aspect-square">
      <canvas id="chartDonut" class="absolute inset-0 w-full h-full"></canvas>
      <div class="absolute inset-0 z-10 flex justify-center items-center pointer-events-none">
        <div class="text-center -translate-y-1 sm:-translate-y-0.5">
          <span id="donut-pct" class="block text-2xl sm:text-4xl lg:text-[2.6rem] font-extrabold text-[#2e594d] leading-none">0%</span>
          <span class="block text-[11px] sm:text-sm font-medium text-gray-500 leading-none mt-0.5">Recaudado</span>
        </div>
      </div>
    </div>

    <div class="mt-3 flex flex-col items-center gap-2 text-sm text-gray-600">
      <div class="flex items-center gap-2">
        <span class="inline-block w-3 h-3 rounded-full bg-[#2E584C]"></span>
        <span class="text-xs sm:text-sm">Recaudado (Pagado)</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="inline-block w-3 h-3 rounded-full bg-[#dc2626]"></span>
        <span class="text-xs sm:text-sm">Pendiente (Adeudo)</span>
      </div>
    </div>

    <div id="meta-total-container" class="mt-4 py-2 border-t border-gray-200 w-full text-center">
      <p class="text-sm sm:text-lg font-semibold text-gray-700">
        Meta Total: <span id="meta-monto-dinamico" class="text-[#3b7666] font-bold">$0.00</span>
      </p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script is:inline>
    window.updateChartDonut = function() {
      const ctx = document.getElementById('chartDonut');
      const metaEl = document.getElementById('meta-monto-dinamico');
      if (!ctx) return;
      if (typeof Chart === 'undefined') return;

      try {
        // Intentar obtener datos del Dashboard primero
        let dashboardPayments = null;
        let dashboardPending = null;
        try {
          dashboardPayments = JSON.parse(localStorage.getItem('dashboardPayments') || 'null');
          dashboardPending = JSON.parse(localStorage.getItem('dashboardPendingPayments') || 'null');
          console.log('游늵 Donut - dashboardPayments:', dashboardPayments, 'dashboardPending:', dashboardPending);
        } catch (e) {
          console.warn('No dashboard data available');
        }

        let paid, pending, totalMeta;

        if (dashboardPayments && dashboardPayments.totalPayments !== undefined && dashboardPending && dashboardPending.totalAmount !== undefined) {
          // Usar datos del Dashboard
          const totalPayments = parseFloat(dashboardPayments.totalPayments || 0);
          const totalPendingAmount = parseFloat(dashboardPending.totalAmount || 0);
          
          // Total es todos los pagos en el sistema: recaudados + pendientes/adeudos
          totalMeta = totalPayments + totalPendingAmount;
          paid = totalPayments;
          pending = totalPendingAmount;
          
          console.log('游늵 Donut usando datos del Dashboard - Total:', totalMeta, 'Pagado:', paid, 'Pendiente:', pending);
        } else {
          // Fallback a chargesList
          const charges = JSON.parse(localStorage.getItem('chargesList') || '[]');
          
          totalMeta = charges.reduce((s, c) => s + (parseFloat(c.amount) || 0), 0);
          
          paid = charges
            .filter(c => ['paid', 'pagado'].includes(String(c.status).toLowerCase()))
            .reduce((s, c) => s + (parseFloat(c.amount) || 0), 0);

          pending = totalMeta - paid;
          
          console.log('游늵 Donut usando chargesList - Pagado:', paid, 'Pendiente:', pending);
        }

        // Actualizar el texto de Meta Total con formato de moneda
        if (metaEl) {
          metaEl.textContent = new Intl.NumberFormat('es-MX', { 
            style: 'currency', 
            currency: 'MXN' 
          }).format(totalMeta);
        }

        // Actualizar porcentaje central
        const pct = totalMeta > 0 ? ((paid / totalMeta) * 100).toFixed(1) : '0.0';
        document.getElementById('donut-pct').textContent = pct + '%';

        // Dibujar o refrescar la gr치fica
        if (window.myDonutChart) window.myDonutChart.destroy();

        const isMobile = window.matchMedia('(max-width: 640px)').matches;
        const labels = isMobile
          ? ['Recaudado', 'Pendiente']
          : ['Recaudado (Pagado)', 'Pendiente (Adeudo)'];

        window.myDonutChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data: [paid, pending],
              backgroundColor: ['#2E584C', '#dc2626'], // Verde y Rojo
              borderWidth: 0,
              hoverOffset: isMobile ? 6 : 10
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: isMobile ? '74%' : '78%',
            layout: { padding: isMobile ? { top: 4, bottom: 4 } : { top: 8, bottom: 8 } },
            animation: {
              duration: isMobile ? 550 : 850,
              easing: 'easeOutQuart'
            },
            plugins: { 
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const val = context.parsed.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
                    return `${context.label}: ${val}`;
                  }
                }
              }
            }
          }
        });
      } catch (e) { 
        console.error("Error en Donut Din치mico:", e); 
      }
    };

    // Ejecuci칩n inicial y escucha de cambios
    const initChartDonut = () => {
      if (typeof Chart !== 'undefined') {
        setTimeout(window.updateChartDonut, 150);
      } else {
        setTimeout(initChartDonut, 100);
      }
    };
    
    document.addEventListener('DOMContentLoaded', initChartDonut);
    document.addEventListener('astro:page-load', initChartDonut);
    window.addEventListener('storage', window.updateChartDonut);
    window.addEventListener('chargesUpdated', window.updateChartDonut);
    window.addEventListener('paymentsDataLoaded', () => {
      console.log('游늵 ChartDonut escuch칩 evento paymentsDataLoaded');
      setTimeout(window.updateChartDonut, 50);
    });

    if (!window.__chartDonutResizeBound) {
      window.__chartDonutResizeBound = true;
      let resizeTimeout;
      const onResize = () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          if (typeof window.updateChartDonut === 'function') {
            window.updateChartDonut();
          }
        }, 120);
      };
      window.addEventListener('resize', onResize);
      window.addEventListener('orientationchange', onResize);
    }
  </script>
</Fragment>