---
// src/components/ChartLine.astro
import { Fragment } from 'astro/jsx-runtime';
---

<Fragment>
  <div class="relative h-64 sm:h-80 md:h-96 w-full">
    <canvas id="chartLine"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script is:inline>
    window.updateChartLine = function() {
      const ctx = document.getElementById('chartLine');
      if (!ctx) return;
      if (typeof Chart === 'undefined') return;

      const currentYear = new Date().getFullYear();
      const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
      const recaudado = new Array(12).fill(0);
      const pendientes = new Array(12).fill(0);

      try {
        // Intentar obtener datos del Dashboard primero
        let dashboardPayments = null;
        let dashboardPending = null;
        try {
          dashboardPayments = JSON.parse(localStorage.getItem('dashboardPayments') || 'null');
          dashboardPending = JSON.parse(localStorage.getItem('dashboardPendingPayments') || 'null');
          console.log('ğŸ“Š ChartLine - dashboardPayments:', dashboardPayments, 'dashboardPending:', dashboardPending);
        } catch (e) {
          console.warn('No dashboard data available:', e);
        }

        if (dashboardPayments && dashboardPayments.totalPayments !== undefined && dashboardPending && dashboardPending.totalAmount !== undefined) {
          // Usar datos del Dashboard: mostrar totalPayments (recaudado) y totalAmount de pendientes (adeudos)
          const totalPayments = parseFloat(dashboardPayments.totalPayments || 0);
          const totalPendingAmount = parseFloat(dashboardPending.totalAmount || 0);
          
          console.log('ğŸ“Š ChartLine usando Dashboard - Recaudado:', totalPayments, 'Pagos Pendientes:', totalPendingAmount);
          
          // Mostrar los valores en febrero (mes actual)
          const currentMonth = new Date().getMonth();
          recaudado[currentMonth] = totalPayments;
          pendientes[currentMonth] = totalPendingAmount;
          
          console.log('ğŸ“Š ChartLine arrays - Febrero [' + currentMonth + '] - Recaudado:', recaudado[currentMonth], 'Pendiente:', pendientes[currentMonth]);
        } else {
          // Fallback a chargesList
          console.log('ğŸ“Š ChartLine usando chargesList como fallback');
          const charges = JSON.parse(localStorage.getItem('chargesList') || '[]');

          charges.forEach(c => {
            const date = new Date(c.createdAt || c.date);
            if (date.getFullYear() === currentYear) {
              const m = date.getMonth();
              const amount = parseFloat(c.amount) || 0;
              const status = String(c.status).toLowerCase();

              if (['paid', 'pagado'].includes(status)) {
                recaudado[m] += amount;
              } else {
                pendientes[m] += amount;
              }
            }
          });
          
          console.log('ğŸ“Š ChartLine chargesList - Recaudado:', recaudado, 'Pendiente:', pendientes);
        }

        console.log('ğŸ“Š ChartLine final arrays - Recaudado:', recaudado, 'Pendiente:', pendientes);

        if (window.myLineChart) window.myLineChart.destroy();

        const isMobile = window.matchMedia('(max-width: 640px)').matches;

        window.myLineChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [
              {
                label: 'Recaudado ($)',
                data: recaudado,
                borderColor: '#2E584C',
                backgroundColor: 'rgba(46, 88, 76, 0.15)',
                borderWidth: 3,
                tension: 0.35,
                fill: true,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointBackgroundColor: '#2E584C',
                yAxisID: 'y'
              },
              {
                label: 'Pendiente ($)',
                data: pendientes,
                borderColor: '#dc2626',
                borderWidth: 2,
                borderDash: [6, 6],
                tension: 0.35,
                pointRadius: 2,
                pointHoverRadius: 4,
                yAxisID: 'y'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: isMobile ? { left: 2, right: 6, top: 6, bottom: 2 } : { left: 8, right: 12, top: 8, bottom: 4 } },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.06)' },
                ticks: {
                  maxTicksLimit: isMobile ? 4 : 6,
                  font: { size: isMobile ? 10 : 12 },
                  callback: v => '$' + Number(v).toLocaleString('es-MX')
                }
              },
              x: {
                grid: { display: false },
                ticks: {
                  maxRotation: 0,
                  autoSkip: true,
                  maxTicksLimit: isMobile ? 6 : 12,
                  font: { size: isMobile ? 10 : 12 }
                }
              }
            },
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  usePointStyle: true,
                  boxWidth: isMobile ? 6 : 8,
                  padding: isMobile ? 10 : 16,
                  font: { size: isMobile ? 10 : 12 }
                }
              },
              tooltip: { mode: 'index', intersect: false }
            },
            interaction: { mode: 'index', intersect: false }
          }
        });
      } catch (e) { 
        console.error('Error en ChartLine:', e); 
      }
    };

    // EjecuciÃ³n inmediata y tras carga
    const initChartLine = () => {
      if (typeof Chart !== 'undefined') {
        window.updateChartLine();
      } else {
        setTimeout(initChartLine, 100);
      }
    };
    
    document.addEventListener('DOMContentLoaded', initChartLine);
    window.addEventListener('storage', window.updateChartLine);
    window.addEventListener('chargesUpdated', window.updateChartLine);    window.addEventListener('paymentsDataLoaded', () => {
      console.log('ğŸ“Š ChartLine escuchÃ³ evento paymentsDataLoaded');
      setTimeout(window.updateChartLine, 50);
    });  </script>
</Fragment>