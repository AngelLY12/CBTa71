---
import Layout from '../layouts/Layout.astro';
const pageTitle = "Conceptos de Cobro";
---

<Layout title={pageTitle}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    
    <div class="flex justify-between items-center mb-10 pb-4 border-b-2 border-green-100">
      <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">
        <i class="fas fa-file-invoice-dollar mr-3 text-green-700"></i> Gesti칩n de Conceptos de Cobro
      </h1>
      <a href="/new" class="px-7 py-3 bg-green-700 text-white font-bold rounded-lg shadow-xl hover:bg-green-800 transition-all duration-300">
        <i class="fas fa-plus-circle mr-2"></i> Crear Nuevo Concepto
      </a>
    </div>

    <div id="concepts-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-7">
      </div>
  </div>

  <script type="module" client:load>
  // =======================================================
  // Funciones de Ayuda (Se mantienen sin cambios)
  // =======================================================
  
  function getStudents() {
    return JSON.parse(localStorage.getItem('studentsList') || '[]');
  }

  function saveStudents(students) {
    localStorage.setItem('studentsList', JSON.stringify(students));
    try { localStorage.setItem('studentsLastUpdate', Date.now().toString()); } catch(e) {}
  }

  function getCharges() {
    return JSON.parse(localStorage.getItem('chargesList') || '[]');
  }

  function saveCharges(charges) {
    localStorage.setItem('chargesList', JSON.stringify(charges));
    try { localStorage.setItem('chargesLastUpdate', Date.now().toString()); } catch(e) {}
  }

  function getConcepts() {
    return JSON.parse(localStorage.getItem('conceptsList') || '[]');
  }

  function saveConcepts(concepts) {
    localStorage.setItem('conceptsList', JSON.stringify(concepts));
    try { localStorage.setItem('conceptsLastUpdate', Date.now().toString()); } catch(e) {}
  }

  function escapeHtml(str = '') {
    return String(str).replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m]);
  }

  function getScopeText(scope, concept) {
    switch(String(scope || '').toLowerCase()) {
      case 'all': 
      case 'todos':
        return 'Todos los estudiantes activos';
      case 'career':
      case 'carrera':
        return `Carrera: ${escapeHtml(concept.career)}`;
      case 'semester':
      case 'semestre':
        return `${concept.semester}춿 Semestre`;
      case 'students':
      case 'especificos':
        return `${concept.selectedStudents?.length || 0} alumnos espec칤ficos`;
      default:
        return '츼mbito No Definido';
    }
  }

  function getTargetStudentsForConcept(concept) {
    const students = getStudents() || [];
    const scope = String(concept.scope || '').toLowerCase();
    const activeStudents = students.filter(s => {
      if (s.status) return String(s.status).toLowerCase() !== 'inactive' && String(s.status).toLowerCase() !== 'inactivo';
      return true;
    });

    switch (scope) {
      case 'all':
      case 'todos':
        return activeStudents;
      case 'career':
      case 'carrera':
        return activeStudents.filter(s => String(s.carrera || s.career || '').toLowerCase() === String(concept.career || '').toLowerCase());
      case 'semester':
      case 'semestre':
        return activeStudents.filter(s => Number(s.semestre) === Number(concept.semester));
      case 'students':
      case 'especificos':
        const sel = concept.selectedStudents || [];
        const ids = sel.map(x => (typeof x === 'object' ? String(x.id) : String(x)));
        return activeStudents.filter(s => ids.includes(String(s.id)));
      default:
        return [];
    }
  }

  function assignConceptToScope(concept, opts = {}) {
    const targets = getTargetStudentsForConcept(concept);
    if (!targets || targets.length === 0) {
      if (!opts.silent) alert('No hay alumnos objetivo para este concepto seg칰n el 치mbito seleccionado.');
      throw new Error('No target students for concept');
    }

    if (!concept.id) {
      concept.id = 'c_' + (Date.now().toString(36) + Math.random().toString(36).slice(2,8));
      const concepts = getConcepts();
      const idx = concepts.findIndex(x => x.title === concept.title && x.createdAt === concept.createdAt);
      if (idx >= 0) concepts[idx].id = concept.id;
      else { concepts.push(concept); saveConcepts(concepts); }
    }

    const amount = Number(concept.amount) || 0;
    const existingCharges = getCharges();
    const nowIso = new Date().toISOString();

    const toAdd = targets.reduce((acc, s) => {
      const exists = existingCharges.some(ec => 
        ec.conceptId === concept.id && 
        String(ec.studentId) === String(s.id) && 
        (String(ec.status || '').toLowerCase() === 'pending' || String(ec.status || '').toLowerCase() === 'pendiente')
      );

      if (!exists) {
        acc.push({
          id: 'chg_' + (Date.now().toString(36) + Math.random().toString(36).slice(2,6)),
          studentId: s.id,
          conceptId: concept.id,
          amount,
          status: 'pending',
          createdAt: nowIso,
          scopeApplied: concept.scope || 'all'
        });
      }
      return acc;
    }, []);

    if (toAdd.length === 0) {
      if (!opts.silent) alert('Ya existen cargos pendientes para los alumnos objetivo de este concepto.');
      return 0;
    }

    const combined = existingCharges.concat(toAdd);
    saveCharges(combined);
    recalcStudentAdeudosFromCharges();

    const concepts = getConcepts();
    const idxc = concepts.findIndex(c => c.id === concept.id);
    if (idxc >= 0) {
      concepts[idxc].assignedCount = (concepts[idxc].assignedCount || 0) + toAdd.length;
      concepts[idxc].lastAssignedAt = nowIso;
      if ((concept.scope || '').toLowerCase() === 'all') concepts[idxc].assignedAll = true;
      saveConcepts(concepts);
    }

    if (!opts.silent) alert(`Asignado a ${toAdd.length} alumno(s). Adeudos actualizados.`);
    return toAdd.length;
  }

  function recalcStudentAdeudosFromCharges() {
    const charges = getCharges();
    const students = getStudents();
    const pendingChargesByStudent = {};
    
    charges.forEach(ch => {
      if (String(ch.status || '').toLowerCase() === 'pending' || String(ch.status || '').toLowerCase() === 'pendiente') {
        const sid = String(ch.studentId);
        pendingChargesByStudent[sid] = (pendingChargesByStudent[sid] || 0) + Number(ch.amount || 0);
      }
    });

    const updated = students.map(s => {
      const totalPending = pendingChargesByStudent[String(s.id)] || 0;
      s.adeudo = parseFloat((totalPending).toFixed(2)); 
      return s;
    });
    saveStudents(updated);
  }

  function editConcept(conceptId) {
    const concepts = getConcepts();
    const idx = concepts.findIndex(c => c.id === conceptId);
    if (idx < 0) { alert('Concepto no encontrado'); return; }
    const concept = concepts[idx];

    try {
      localStorage.setItem('editingConcept', JSON.stringify(concept));
      localStorage.setItem('editingConceptLastUpdate', Date.now().toString());
    } catch (e) {
      console.error('No se pudo guardar editingConcept', e);
    }

    window.location.href = '/new?edit=' + encodeURIComponent(conceptId);
  }

  function deleteConcept(conceptId) {
    if (!confirm('游뚿 춰ATENCI칍N! 쮼st치 seguro de eliminar este concepto y TODOS sus cargos (pendientes y pagados)? Esta acci칩n no se puede deshacer y recalcular치 los adeudos de todos los alumnos.')) return;

    let concepts = getConcepts();
    concepts = concepts.filter(c => c.id !== conceptId);
    saveConcepts(concepts);

    let charges = getCharges();
    charges = charges.filter(ch => ch.conceptId !== conceptId);
    saveCharges(charges);

    recalcStudentAdeudosFromCharges();

    try { localStorage.setItem('conceptsLastUpdate', Date.now().toString()); } catch(e){}
    try { localStorage.setItem('chargesLastUpdate', Date.now().toString()); } catch(e){}
    try { localStorage.setItem('studentsLastUpdate', Date.now().toString()); } catch(e){}

    alert('Concepto eliminado y adeudos actualizados.');
    renderConcepts();
  }

  // =======================================================
  // Funci칩n de Render con el dise침o educativo optimizado
  // =======================================================

  function renderConcepts() {
    const grid = document.getElementById('concepts-grid');
    if (!grid) return;
    try {
      const concepts = getConcepts().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      if (concepts.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-20 bg-white rounded-xl shadow-lg border border-gray-200">
            <i class="fas fa-folder-open text-6xl mb-4 text-gray-400"></i>
            <p class="text-xl text-gray-600 font-semibold mb-3">A칰n no hay conceptos de cobro creados.</p>
            <p class="text-gray-500 mb-5">Utilice el bot칩n "Crear Nuevo Concepto" para empezar a gestionar los cargos escolares.</p>
            <a href="/new" class="inline-block px-5 py-2 bg-green-700 text-white rounded-lg shadow hover:bg-green-800 transition-colors">
              <i class="fas fa-plus-circle mr-2"></i> Crear Primer Concepto
            </a>
          </div>
        `;
        return;
      }

      grid.innerHTML = concepts.map(c => {
        const amount = Number(c.amount) || 0;
        const statusText = c.status === 'active' ? 'Activo' : 'Borrador';
        const statusClass = c.status === 'active' 
          ? 'bg-green-100 text-green-800 border-green-300' // Verde para Activo
          : 'bg-yellow-100 text-yellow-800 border-yellow-300'; // Amarillo sutil para Borrador/Pendiente
        
        const scopeText = getScopeText(c.scope, c);
        const assignedIndicator = c.assignedAll 
          ? '<span class="text-xs font-medium text-green-600"><i class="fas fa-check-circle mr-1"></i> Aplicaci칩n Completa</span>' 
          : '<span class="text-xs font-medium text-amber-600"><i class="fas fa-exclamation-triangle mr-1"></i> Pendiente de Asignaci칩n</span>';

        const targetCount = getTargetStudentsForConcept(c).length;

        return `
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition-all duration-200 flex">
            
            <div class="p-5 flex-grow">
              <div class="flex justify-between items-start mb-2">
                <h3 class="text-lg font-bold text-gray-800 leading-snug">${escapeHtml(c.title)}</h3>
                <span class="px-3 py-1 text-xs font-semibold rounded-full border ${statusClass} ml-3 flex-shrink-0">
                  ${statusText}
                </span>
              </div>

              <div class="text-3xl font-extrabold text-amber-700 mb-4 tracking-wider">
                $${amount.toFixed(2)}
              </div>
              
              <div class="space-y-2 text-sm">
                
                <div class="flex items-start text-gray-700">
                  <i class="fas fa-users w-5 pt-1 text-green-600 flex-shrink-0"></i>
                  <div class="ml-3">
                    <span class="font-semibold block leading-none">츼mbito:</span>
                    <span class="text-gray-600">${scopeText}</span>
                  </div>
                </div>

                ${c.description ? `
                <div class="flex items-start text-gray-700">
                  <i class="fas fa-info-circle w-5 pt-1 text-gray-500 flex-shrink-0"></i>
                  <div class="ml-3">
                    <span class="font-semibold block leading-none">Descripci칩n:</span>
                    <span class="text-gray-600">${escapeHtml(c.description.substring(0, 50) + (c.description.length > 50 ? '...' : ''))}</span>
                  </div>
                </div>` : ''}
                
                <div class="flex items-center text-gray-500 pt-1">
                  <i class="fas fa-user-check w-5 text-gray-400"></i>
                  <span class="ml-3 text-xs font-semibold uppercase tracking-wider">${targetCount} Alumnos Objetivo</span>
                </div>
              </div>
            </div>

            <div class="p-4 bg-gray-50 border-l border-gray-200 rounded-r-xl flex flex-col justify-between items-center space-y-3 w-28">
                
                <div class="text-center w-full">
                    ${assignedIndicator}
                </div>

                <div class="flex flex-col space-y-2 w-full">
                    <button data-concept-id="${c.id || ''}" title="Asignar cargos a los alumnos objetivo" class="assign-all px-2 py-2 text-xs font-medium bg-green-700 text-white rounded-lg shadow hover:bg-green-800 transition-colors w-full">
                        <i class="fas fa-user-plus mr-1"></i> Asignar
                    </button>
                    <button data-concept-id="${c.id || ''}" title="Editar Concepto" class="edit-concept px-2 py-2 text-xs font-medium border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors w-full">
                        <i class="fas fa-edit mr-1"></i> Editar
                    </button>
                    <button data-concept-id="${c.id || ''}" title="Eliminar Concepto" class="delete-concept px-2 py-2 text-xs font-medium bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors w-full">
                        <i class="fas fa-trash-alt mr-1"></i> Eliminar
                    </button>
                </div>

                <div class="text-xs text-gray-400 mt-auto">
                    ${new Date(c.createdAt).toLocaleDateString()}
                </div>
            </div>
          </div>
        `;
      }).join('');
    } catch(e) {
      console.error(e);
      grid.innerHTML = '<div class="col-span-full text-center text-red-500 p-10 bg-red-50 rounded-lg border border-red-200">Error cargando conceptos. Verifique la consola para detalles.</div>';
    }
  }

  // Delegaci칩n de eventos (Se mantienen sin cambios)
  document.addEventListener('click', (ev) => {
    const assignBtn = ev.target.closest && ev.target.closest('.assign-all');
    if (assignBtn) {
      const conceptId = assignBtn.getAttribute('data-concept-id');
      const concept = getConcepts().find(c => (c.id || '') === conceptId);
      if (!concept) { alert('Concepto no encontrado. Aseg칰rate de que el concepto tenga id.'); return; }
      try {
        const assignedCount = assignConceptToScope(concept);
        if (assignedCount > 0) {
          renderConcepts();
          try { localStorage.setItem('chargesLastUpdate', Date.now().toString()); } catch(e) {}
        }
      } catch (err) {
        console.error(err);
      }
      return;
    }

    const editBtn = ev.target.closest && ev.target.closest('.edit-concept');
    if (editBtn) {
      const conceptId = editBtn.getAttribute('data-concept-id');
      editConcept(conceptId);
      return;
    }

    const delBtn = ev.target.closest && ev.target.closest('.delete-concept');
    if (delBtn) {
      const conceptId = delBtn.getAttribute('data-concept-id');
      deleteConcept(conceptId);
      return;
    }
  });

  // Render inicial y re-render cuando cambie storage
  renderConcepts();
  window.addEventListener('storage', (e) => {
    if (['conceptsList', 'chargesList', 'studentsList', 'chargesLastUpdate', 'studentsLastUpdate', 'conceptsLastUpdate'].includes(e.key)) {
      renderConcepts();
    }
  });

  // Exponer funciones correctas y alias legacy
  window.assignConceptToScope = assignConceptToScope;
  window.assignConceptToAll = assignConceptToScope; 
  window.editConcept = editConcept;
  window.deleteConcept = deleteConcept;
</script>
</Layout>