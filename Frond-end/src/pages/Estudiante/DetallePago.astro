---
import StudentLayout from '../../layouts/LayoutEstu.astro';

const paymentId = Astro.url.searchParams.get('id');
---

<script src="/studentAPI.js?v=20260218r32" is:inline></script>

<StudentLayout title={`Detalle de Pago ${paymentId ? '#' + paymentId : ''}`}>
  <div class="page-wrapper" x-data={`{
    paymentId: ${paymentId ? JSON.stringify(paymentId) : "''"},
    paymentDetail: null,
    loading: true,
    errorMessage: '',
    downloadingReceipt: false,
    portalRole: 'student',
    autoRefreshEnabled: true,
    autoRefreshIntervalMs: 180000,
    autoRefreshTimerId: null,
    autoRefreshFocusHandler: null,
    autoRefreshVisibilityHandler: null,

    pickFirstValue(source, keys, fallback = null) {
      if (!source || !Array.isArray(keys)) return fallback;
      for (const key of keys) {
        const value = source?.[key];
        if (value !== undefined && value !== null && value !== '') {
          return value;
        }
      }
      return fallback;
    },

    normalizeStatus(statusValue) {
      const value = String(statusValue || '').toLowerCase().trim();
      if (!value) return 'unknown';
      if (value === 'completed' || value === 'completado' || value === 'paid' || value === 'pagado' || value === 'success' || value === 'succeeded') return 'paid';
      if (value === 'pending' || value === 'pendiente' || value === 'processing' || value === 'in_process' || value === 'no pagado' || value === 'unpaid') return 'pending';
      if (value === 'failed' || value === 'error' || value === 'declined' || value === 'canceled' || value === 'cancelled') return 'failed';
      if (value === 'refunded' || value === 'refund' || value === 'reembolsado') return 'refunded';
      return value;
    },

    getStatusLabel(statusValue) {
      const normalized = this.normalizeStatus(statusValue);
      if (normalized === 'paid') return 'Pagado';
      if (normalized === 'pending') return 'Pendiente';
      if (normalized === 'failed') return 'Fallido';
      if (normalized === 'refunded') return 'Reembolsado';
      return 'Desconocido';
    },

    canDownloadReceipt() {
      if (this.paymentDetail?.url) return true;
      const normalized = this.normalizeStatus(this.paymentDetail?.status);
      return normalized === 'paid' || normalized === 'refunded';
    },

    normalizeMethodDetails(payment) {
      const rawMethodDetails = payment?.payment_method_details ?? payment?.payment_method ?? payment?.method ?? null;
      const normalizedMethods = [];

      const toMethodLabel = (methodEntry) => {
        if (!methodEntry) return null;
        if (typeof methodEntry === 'string') {
          const trimmed = methodEntry.trim();
          return trimmed || null;
        }

        const brand = String(methodEntry.brand || methodEntry.card_brand || '').trim();
        const last4 = String(methodEntry.last4 || methodEntry.card_last4 || '').trim();
        const type = String(methodEntry.type || methodEntry.method || methodEntry.payment_type || '').trim();
        const bank = String(methodEntry.bank || methodEntry.bank_name || '').trim();

        if (brand && last4) return brand.toUpperCase() + ' ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + last4;
        if (bank && last4) return bank + ' ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + last4;
        if (type && last4) return type + ' ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + last4;
        if (brand) return brand.toUpperCase();
        if (bank) return bank;
        if (type) return type;

        return null;
      };

      if (Array.isArray(rawMethodDetails)) {
        rawMethodDetails.forEach((methodEntry) => {
          const label = toMethodLabel(methodEntry);
          if (label) normalizedMethods.push(label);
        });
      } else {
        const singleLabel = toMethodLabel(rawMethodDetails);
        if (singleLabel) normalizedMethods.push(singleLabel);
      }

      const fallbackType = this.pickFirstValue(payment, ['payment_method_type', 'method_type', 'payment_type'], '');
      if (!normalizedMethods.length && fallbackType) {
        normalizedMethods.push(String(fallbackType));
      }

      return {
        allMethods: normalizedMethods,
        methodLabel: normalizedMethods[0] || 'Metodo desconocido'
      };
    },

    detectPortalRole() {
      const userDataRaw = localStorage.getItem('user_data');
      let inferredRole = '';

      if (userDataRaw) {
        try {
          const userData = JSON.parse(userDataRaw);
          const roles = [];
          if (Array.isArray(userData?.roles)) roles.push(...userData.roles);
          if (userData?.role) roles.push(userData.role);
          if (userData?.role_name) roles.push(userData.role_name);
          if (userData?.type) roles.push(userData.type);

          const firstRole = roles.find(Boolean);
          const normalizedFirstRole = typeof firstRole === 'string'
            ? firstRole
            : (firstRole?.name || firstRole?.slug || firstRole?.role || '');

          inferredRole = String(normalizedFirstRole || '').toLowerCase().trim();
        } catch (_) {}
      }

      const roleCandidates = [
        localStorage.getItem('userRole'),
        localStorage.getItem('role'),
        inferredRole
      ]
        .filter(Boolean)
        .map(function(roleValue) {
          return String(roleValue).toLowerCase().trim();
        });

      const hasParentRole = roleCandidates.some(function(roleValue) {
        return roleValue === 'parent' || roleValue === 'padre';
      });

      const hasApplicantRole = roleCandidates.some(function(roleValue) {
        return roleValue === 'applicant' || roleValue === 'aspirante' || roleValue === 'solicitante';
      });

      if (hasParentRole) return 'parent';
      if (hasApplicantRole) return 'applicant';
      return 'student';
    },

    resolvePaymentIdFromUrl() {
      try {
        const urlParams = new URLSearchParams(window.location.search || '');
        const idFromUrl = urlParams.get('id');
        if (!idFromUrl) return '';
        return String(idFromUrl).trim();
      } catch (_) {
        return '';
      }
    },

    openUrlInNewTab(url) {
      if (!url) return false;
      const popup = window.open(url, '_blank', 'noopener,noreferrer');
      if (popup) return true;
      const link = document.createElement('a');
      link.href = url;
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      document.body.appendChild(link);
      link.click();
      link.remove();
      return false;
    },

    async init() {
      console.log('üîç DetallePago init - paymentId recibido:', this.paymentId);
      console.log('üîç URL completa:', window.location.href);
      console.log('üîç Search params:', window.location.search);

      const idFromUrl = this.resolvePaymentIdFromUrl();
      console.log('üîç ID desde URLSearchParams:', idFromUrl);
      if (idFromUrl && String(idFromUrl) !== String(this.paymentId || '')) {
        this.paymentId = idFromUrl;
        console.log('‚úÖ ID sincronizado desde URL:', this.paymentId);
      } else if (!this.paymentId && idFromUrl) {
        this.paymentId = idFromUrl;
        console.log('‚úÖ ID rescatado de URL:', this.paymentId);
      }

      this.portalRole = this.detectPortalRole();
      
      await this.loadDetail();
      this.setupAutoRefresh();
    },

    setupAutoRefresh() {
      if (!this.autoRefreshEnabled) return;

      const runAutoRefresh = async () => {
        if (document.hidden) return;
        if (this.loading || this.downloadingReceipt) return;
        try {
          await this.loadDetail();
        } catch (error) {
          console.warn('‚ö†Ô∏è [DetallePago] Auto-refresh omitido por error:', error?.message || error);
        }
      };

      if (this.autoRefreshTimerId) {
        clearInterval(this.autoRefreshTimerId);
        this.autoRefreshTimerId = null;
      }

      this.autoRefreshTimerId = setInterval(() => {
        void runAutoRefresh();
      }, this.autoRefreshIntervalMs);

      if (!this.autoRefreshFocusHandler) {
        this.autoRefreshFocusHandler = () => {
          void runAutoRefresh();
        };
        window.addEventListener('focus', this.autoRefreshFocusHandler);
      }

      if (!this.autoRefreshVisibilityHandler) {
        this.autoRefreshVisibilityHandler = () => {
          if (!document.hidden) {
            void runAutoRefresh();
          }
        };
        document.addEventListener('visibilitychange', this.autoRefreshVisibilityHandler);
      }

      window.addEventListener('beforeunload', () => {
        if (this.autoRefreshTimerId) {
          clearInterval(this.autoRefreshTimerId);
          this.autoRefreshTimerId = null;
        }
      }, { once: true });
    },

    async loadDetail() {
      this.loading = true;
      this.errorMessage = '';

      const runtimePaymentId = this.resolvePaymentIdFromUrl() || this.paymentId;
      this.paymentId = runtimePaymentId || '';

      console.log('üîÑ loadDetail iniciado con paymentId:', this.paymentId);

      if (!this.paymentId) {
        console.error('‚ùå No se proporcion√≥ ID de pago');
        this.errorMessage = 'ID de pago no proporcionado';
        this.loading = false;
        return;
      }

      if (!window.StudentAPI) {
        console.error('‚ùå StudentAPI no disponible');
        this.errorMessage = 'StudentAPI no esta disponible.';
        this.loading = false;
        return;
      }

      const token = localStorage.getItem('access_token');
      if (!token) {
        console.error('‚ùå No hay token de autenticaci√≥n');
        this.errorMessage = 'Usuario no autenticado';
        this.loading = false;
        return;
      }

      try {
        console.log('üì° Llamando a API con paymentId:', this.paymentId);
        const response = await window.StudentAPI.getPaymentById(runtimePaymentId, token, this.portalRole);
        console.log('‚úÖ Respuesta del API:', response);
        const payment = response?.data?.payment;
        console.log('üíæ Datos del pago:', payment);
        if (!payment) {
          this.errorMessage = response?.message || 'Error al cargar el detalle del pago';
          this.loading = false;
          return;
        }

        const normalizedStatus = this.normalizeStatus(payment.status);
        const methodData = this.normalizeMethodDetails(payment);

        const amountValue = this.pickFirstValue(payment, ['amount', 'total_amount', 'total', 'monto'], '0');
        const amountReceivedValue = this.pickFirstValue(payment, ['amount_received', 'received_amount', 'paid_amount', 'amount_paid', 'monto_recibido'], amountValue);
        const balanceValue = this.pickFirstValue(payment, ['balance', 'pending_amount', 'amount_pending', 'remaining_amount', 'remaining_balance', 'balance_due', 'saldo'], '0');
        const conceptValue = this.pickFirstValue(payment, ['concept_name', 'concept', 'concepto', 'description', 'payment_concept_name', 'paymentConceptName'], 'Pago');
        const referenceValue = this.pickFirstValue(payment, ['reference', 'payment_reference', 'folio', 'payment_intent_id', 'transaction_id', 'stripe_charge_id', 'external_reference'], null);
        const receiptUrlValue = this.pickFirstValue(payment, ['url', 'receipt_url', 'receiptUrl', 'voucher_url', 'invoice_url'], payment?.receipt?.url || null);
        const createdAtValue = this.pickFirstValue(payment, ['created_at_human', 'payment_date', 'paid_at', 'created_at', 'date'], null);
        const updatedAtValue = this.pickFirstValue(payment, ['updated_at_human', 'updated_at', 'payment_updated_at'], null);
        const paymentConceptIdValue = this.pickFirstValue(payment, ['payment_concept_id', 'concept_id', 'paymentConceptId'], null);
        const paymentMethodIdValue = this.pickFirstValue(payment, ['payment_method_id', 'method_id', 'paymentMethodId'], null);
        const userIdValue = this.pickFirstValue(payment, ['user_id', 'userId', 'student_id', 'studentId'], null);
        const stripePaymentMethodIdValue = this.pickFirstValue(payment, ['stripe_payment_method_id', 'stripePaymentMethodId'], null);
        const paymentIntentIdValue = this.pickFirstValue(payment, ['payment_intent_id', 'paymentIntentId'], null);
        const stripeSessionIdValue = this.pickFirstValue(payment, ['stripe_session_id', 'stripeSessionId'], null);
        const currencyValue = this.pickFirstValue(payment, ['currency', 'moneda'], 'MXN');
        const hasPendingAmountValue = Boolean(this.pickFirstValue(payment, ['has_pending_amount', 'hasPendingAmount'], false));
        const balanceNumericValue = Number(balanceValue) || 0;

        this.paymentDetail = {
          id: payment.id,
          concept: conceptValue,
          amount: String(amountValue),
          amountReceived: String(amountReceivedValue),
          balance: String(balanceValue),
          pendingAmount: String(balanceNumericValue),
          hasPendingAmount: hasPendingAmountValue,
          reference: referenceValue,
          status: normalizedStatus || 'unknown',
          paymentMethod: methodData.methodLabel,
          userId: userIdValue,
          createdAt: createdAtValue,
          updatedAt: updatedAtValue,
          stripePaymentId: stripePaymentMethodIdValue,
          paymentIntentId: paymentIntentIdValue,
          url: receiptUrlValue,
          stripeSessionId: stripeSessionIdValue,
          allMethods: methodData.allMethods,
          paymentConceptId: paymentConceptIdValue,
          paymentMethodId: paymentMethodIdValue,
          currency: currencyValue
        };
      } catch (err) {
        console.error('‚ùå Error fetching payment detail:', err);
        this.errorMessage = err?.message || 'Error al cargar la informacion del pago';
      } finally {
        this.loading = false;
      }
    },

    async downloadReceipt() {
      const runtimePaymentId = this.resolvePaymentIdFromUrl() || this.paymentId;
      const detailPaymentId = this.paymentDetail?.id ?? null;
      const canonicalPaymentId = runtimePaymentId || detailPaymentId;

      if (!canonicalPaymentId) {
        this.errorMessage = 'ID de pago no proporcionado';
        return;
      }

      if (!this.canDownloadReceipt()) {
        this.errorMessage = 'El recibo solo est√° disponible para pagos completados o reembolsados.';
        return;
      }

      if (!window.StudentAPI) {
        this.errorMessage = 'StudentAPI no esta disponible.';
        return;
      }

      if (this.downloadingReceipt) {
        return;
      }

      const token = localStorage.getItem('access_token');
      if (!token) {
        this.errorMessage = 'Usuario no autenticado';
        return;
      }

      this.downloadingReceipt = true;
      this.errorMessage = '';
      const pendingTab = window.open('', '_blank');
      let receiptResultUrl = null;
      const fallbackReceiptUrl = String(detailPaymentId || '') === String(canonicalPaymentId)
        ? (this.paymentDetail?.url || null)
        : null;
      const proxyOpenUrl = '/api/receipts/' + encodeURIComponent(canonicalPaymentId) + '?mode=open&_=' + Date.now();

      try {
        const result = await window.StudentAPI.downloadPaymentReceipt(canonicalPaymentId, token, this.portalRole);
        receiptResultUrl = result?.url || result?.data?.url || null;
        if (receiptResultUrl) {
          if (pendingTab && !pendingTab.closed) {
            pendingTab.location.href = receiptResultUrl;
          } else {
            const opened = this.openUrlInNewTab(receiptResultUrl);
            if (!opened) {
              window.location.assign(receiptResultUrl);
            }
          }
          this.downloadingReceipt = false;
          return;
        }
      } catch (error) {
        const message = String(error?.message || error || '').toLowerCase();
        const isNonTerminal = message.includes('estado terminal') || message.includes('terminal') || message.includes('no pagado') || message.includes('unprocessable');
        if (isNonTerminal) {
          this.errorMessage = 'El recibo a√∫n no est√° disponible para este pago.';
          if (pendingTab && !pendingTab.closed) {
            pendingTab.close();
          }
          this.downloadingReceipt = false;
          return;
        }

        if (fallbackReceiptUrl) {
          if (pendingTab && !pendingTab.closed) {
            pendingTab.location.href = fallbackReceiptUrl;
          } else {
            const opened = this.openUrlInNewTab(fallbackReceiptUrl);
            if (!opened) {
              window.location.assign(fallbackReceiptUrl);
            }
          }
          this.downloadingReceipt = false;
          return;
        }

        this.errorMessage = error?.message || 'No se pudo generar el recibo nuevo para este pago';
      }

      if (pendingTab && !pendingTab.closed) {
        pendingTab.location.href = proxyOpenUrl;
        this.downloadingReceipt = false;
        return;
      }
      window.location.assign(proxyOpenUrl);
      this.downloadingReceipt = false;
    }
  }`}>
    <header class="detail-header">
      <a href="/Estudiante/Historial" class="back-button">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
        <span>Volver al historial</span>
      </a>
      <div class="header-title">
        <p class="pre-title">Detalle de Pago</p>
        <h1>Pago {paymentId ? '#' + paymentId : 'No disponible'}</h1>
      </div>
    </header>

    <template x-if="errorMessage">
      <div class="error-container">
        <div class="error-icon">‚ùå</div>
        <h2>Error</h2>
        <p x-text="errorMessage"></p>
        <a href="/Estudiante/Historial" class="error-link">Volver al historial</a>
      </div>
    </template>

    <template x-if="loading">
      <div class="loading-container">
        <div class="spinner"></div>
        <p>Cargando informaci√≥n del pago...</p>
      </div>
    </template>

    <template x-if="!loading && !errorMessage && paymentDetail">
      <main class="detail-content">
        <!-- STATUS CARD -->
        <div :class="'status-card status-' + paymentDetail.status">
          <div class="status-icon">
            <span x-show="paymentDetail.status === 'paid'">‚úÖ</span>
            <span x-show="paymentDetail.status === 'pending'">‚è≥</span>
            <span x-show="paymentDetail.status === 'failed'">‚ùå</span>
            <span x-show="paymentDetail.status === 'refunded'">‚Ü©Ô∏è</span>
          </div>
          <div class="status-text">
            <span class="status-label">Estado</span>
            <span class="status-value" x-text="getStatusLabel(paymentDetail.status)"></span>
          </div>
        </div>

        <!-- MAIN DETAILS -->
        <div class="detail-grid">
          <!-- AMOUNT CARD -->
          <div class="detail-card amount-card">
            <div class="card-icon">üí∞</div>
            <div class="card-content">
              <span class="card-label">Monto</span>
              <div class="amount-display">
                <span class="currency">$</span>
                <span class="amount" x-text="paymentDetail.amount"></span>
              </div>
            </div>
          </div>

          <!-- CONCEPT CARD -->
          <div class="detail-card concept-card">
            <div class="card-icon">üìã</div>
            <div class="card-content">
              <span class="card-label">Concepto</span>
              <span class="card-value" x-text="paymentDetail.concept"></span>
            </div>
          </div>

          <!-- DATE CARD -->
          <div class="detail-card date-card">
            <div class="card-icon">üìÖ</div>
            <div class="card-content">
              <span class="card-label">Fecha de pago</span>
              <span class="card-value" x-text="paymentDetail.createdAt"></span>
            </div>
          </div>

          <!-- METHOD CARD -->
          <div class="detail-card method-card">
            <div class="card-icon">üè¶</div>
            <div class="card-content">
              <span class="card-label">M√©todo de pago</span>
              <span class="card-value" x-text="paymentDetail.paymentMethod"></span>
            </div>
          </div>
        </div>

        <!-- DETAILED INFO -->
        <div class="info-section">
          <h2>Informaci√≥n detallada</h2>
          
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">ID del pago</span>
              <span class="info-value mono" x-text="paymentDetail.id"></span>
            </div>

            <template x-if="paymentDetail.userId">
              <div class="info-item">
                <span class="info-label">ID del usuario</span>
                <span class="info-value mono" x-text="paymentDetail.userId"></span>
              </div>
            </template>

            <div class="info-item">
              <span class="info-label">Monto recibido</span>
              <span class="info-value" x-text="'$' + paymentDetail.amountReceived"></span>
            </div>

            <template x-if="Number(paymentDetail.pendingAmount || 0) !== 0">
              <div class="info-item">
                <span class="info-label" x-text="(Number(paymentDetail.pendingAmount || 0) > 0 || paymentDetail.hasPendingAmount) ? 'Monto pendiente' : 'Saldo a favor'"></span>
                <span class="info-value" x-text="'$' + Math.abs(Number(paymentDetail.pendingAmount || 0)).toFixed(2)"></span>
              </div>
            </template>

            <template x-if="paymentDetail.reference">
              <div class="info-item">
                <span class="info-label">Referencia</span>
                <span class="info-value mono" x-text="paymentDetail.reference"></span>
              </div>
            </template>

            <template x-if="paymentDetail.paymentIntentId">
              <div class="info-item">
                <span class="info-label">ID de intenci√≥n de pago</span>
                <span class="info-value mono" x-text="paymentDetail.paymentIntentId"></span>
              </div>
            </template>

            <template x-if="paymentDetail.paymentConceptId">
              <div class="info-item">
                <span class="info-label">ID del concepto</span>
                <span class="info-value mono" x-text="paymentDetail.paymentConceptId"></span>
              </div>
            </template>

            <template x-if="paymentDetail.paymentMethodId">
              <div class="info-item">
                <span class="info-label">ID del m√©todo</span>
                <span class="info-value mono" x-text="paymentDetail.paymentMethodId"></span>
              </div>
            </template>

            <template x-if="paymentDetail.currency">
              <div class="info-item">
                <span class="info-label">Moneda</span>
                <span class="info-value" x-text="paymentDetail.currency"></span>
              </div>
            </template>

            <template x-if="paymentDetail.stripePaymentId">
              <div class="info-item">
                <span class="info-label">ID de m√©todo Stripe</span>
                <span class="info-value mono" x-text="paymentDetail.stripePaymentId"></span>
              </div>
            </template>

            <template x-if="paymentDetail.stripeSessionId">
              <div class="info-item">
                <span class="info-label">ID de sesi√≥n Stripe</span>
                <span class="info-value mono" x-text="paymentDetail.stripeSessionId"></span>
              </div>
            </template>

            <template x-if="paymentDetail.updatedAt">
              <div class="info-item">
                <span class="info-label">√öltima actualizaci√≥n</span>
                <span class="info-value" x-text="paymentDetail.updatedAt"></span>
              </div>
            </template>
          </div>
        </div>

        <!-- PAYMENT METHODS -->
        <template x-if="paymentDetail.allMethods && paymentDetail.allMethods.length > 0">
          <div class="methods-section">
            <h2>M√©todos de pago registrados</h2>
            <div class="methods-list">
              <template x-for="(method, index) in paymentDetail.allMethods" :key="index">
                <div class="method-item">
                  <span class="method-number" x-text="index + 1"></span>
                  <span class="method-text" x-text="method"></span>
                </div>
              </template>
            </div>
          </div>
        </template>

        <!-- ACTION BUTTONS -->
        <div class="action-section">
          <template x-if="paymentDetail.id">
            <button type="button" @click="downloadReceipt()" :disabled="downloadingReceipt || !canDownloadReceipt()" class="btn btn-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
              <span x-text="downloadingReceipt ? 'Descargando...' : (canDownloadReceipt() ? 'Descargar recibo' : 'Recibo no disponible')"></span>
            </button>
          </template>
          
          <a href="/Estudiante/Historial" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            Volver al historial
          </a>
        </div>
      </main>
    </template>
  </div>
</StudentLayout>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

  :root {
    --primary: #112d26;
    --accent: #c4a47c;
    --text-muted: #64748b;
    --bg-page: #f8fafc;
    --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }

  .page-wrapper {
    max-width: 900px;
    margin: 0 auto;
    padding: 2.5rem 1.25rem;
    font-family: 'Plus Jakarta Sans', sans-serif;
    background-color: var(--bg-page);
    min-height: 100vh;
  }

  .detail-header {
    margin-bottom: 2.5rem;
  }

  .back-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.2s;
  }

  .back-button:hover {
    background: rgba(17, 45, 38, 0.1);
    transform: translateX(-2px);
  }

  .header-title {
    margin-bottom: 1rem;
  }

  .header-title h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 800;
    color: var(--primary);
  }

  .pre-title {
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
  }

  .error-container {
    background: white;
    border-radius: 20px;
    padding: 3rem 2rem;
    text-align: center;
    box-shadow: var(--card-shadow);
  }

  .error-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .error-container h2 {
    margin: 0.5rem 0;
    font-size: 1.5rem;
    color: var(--primary);
  }

  .error-container p {
    color: var(--text-muted);
    margin: 1rem 0;
  }

  .error-link {
    display: inline-block;
    background: var(--primary);
    color: white;
    padding: 10px 24px;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 700;
    margin-top: 1rem;
    transition: all 0.2s;
  }

  .error-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(17, 45, 38, 0.2);
  }

  .loading-container {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 20px;
    box-shadow: var(--card-shadow);
  }

  .spinner {
    width: 40px;
    height: 40px;
    margin: 0 auto 1rem;
    border: 3px solid #f1f5f9;
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-container p {
    color: var(--text-muted);
    font-weight: 500;
  }

  .detail-content {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .status-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: var(--card-shadow);
    border-left: 4px solid;
  }

  .status-card.status-paid {
    border-left-color: var(--success);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%);
  }

  .status-card.status-pending {
    border-left-color: var(--warning);
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, transparent 100%);
  }

  .status-card.status-failed {
    border-left-color: var(--danger);
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%);
  }

  .status-icon {
    font-size: 2rem;
  }

  .status-text {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .status-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-muted);
    letter-spacing: 0.3px;
  }

  .status-value {
    font-size: 1.1rem;
    font-weight: 800;
    color: var(--primary);
  }

  .detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }

  .detail-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: var(--card-shadow);
    transition: all 0.3s;
  }

  .detail-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
  }

  .card-icon {
    font-size: 2rem;
    min-width: 50px;
  }

  .card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .card-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-muted);
    letter-spacing: 0.3px;
  }

  .amount-display {
    display: flex;
    align-items: baseline;
    gap: 2px;
  }

  .currency {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--primary);
  }

  .amount {
    font-size: 1.6rem;
    font-weight: 800;
    color: var(--primary);
  }

  .card-value {
    font-size: 1rem;
    font-weight: 700;
    color: var(--primary);
  }

  .info-section,
  .methods-section {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--card-shadow);
  }

  .info-section h2,
  .methods-section h2 {
    margin: 0 0 16px 0;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--primary);
    padding-bottom: 12px;
    border-bottom: 2px solid #f1f5f9;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
  }

  .info-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 12px;
    background: #f8fafc;
    border-radius: 10px;
    border: 1px solid #f1f5f9;
  }

  .info-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-muted);
    letter-spacing: 0.3px;
  }

  .info-value {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--primary);
    word-break: break-all;
  }

  .info-value.mono {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    background: white;
    padding: 6px;
    border-radius: 6px;
  }

  .methods-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .method-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f8fafc;
    border-radius: 10px;
    border: 1px solid #f1f5f9;
  }

  .method-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    font-weight: 700;
    font-size: 0.8rem;
    min-width: 28px;
  }

  .method-text {
    color: var(--primary);
    font-weight: 600;
  }

  .action-section {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 0.9rem;
    text-decoration: none;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
    box-shadow: 0 2px 8px rgba(17, 45, 38, 0.2);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(17, 45, 38, 0.3);
  }

  .btn-secondary {
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
  }

  .btn-secondary:hover {
    background: #f8fafc;
  }

  @media (max-width: 768px) {
    .page-wrapper {
      padding: 1.5rem 1rem;
    }

    .header-title h1 {
      font-size: 1.6rem;
    }

    .detail-grid {
      grid-template-columns: 1fr;
    }

    .info-grid {
      grid-template-columns: 1fr;
    }

    .action-section {
      flex-direction: column;
    }

    .btn {
      width: 100%;
    }
  }
</style>
