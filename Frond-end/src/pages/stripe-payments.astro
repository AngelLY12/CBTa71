---
import Layout from "../layouts/Layout.astro";

const pageTitle = "Pagos de Stripe - CBTA 71";

// Note: Data will be loaded client-side with authentication
const stripePayments = [];

const stripePaymentsJSON = JSON.stringify(stripePayments);
---

<Layout title={pageTitle}>
  <!-- Load StudentAPI globally before any module scripts -->
  <script src="/studentAPI.js" is:inline></script>
  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    
    <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-10 pb-8 border-b-2 border-purple-500/20">
      <div class="flex items-center gap-4 w-full justify-start">
        <div class="p-3 bg-purple-600 rounded-xl shadow-lg shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h10m4 0a1 1 0 11-2 0 1 1 0 012 0zM7 15a1 1 0 11-2 0 1 1 0 012 0z" />
          </svg>
        </div>
        <div class="text-left">
          <h1 class="text-3xl font-black text-gray-900 tracking-tight leading-none text-left">Pagos de Stripe</h1>
          <p class="text-sm text-purple-600 mt-1 font-medium text-left">üí≥ Pagos procesados en Stripe</p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto justify-start lg:justify-end">
        <div class="relative w-full lg:w-[240px]">
           <input type="text" id="search-input" placeholder="Email, CURP, n_control..." class="w-full pl-4 h-[46px] border-2 border-gray-200 rounded-xl text-sm outline-none focus:border-purple-500 bg-white shadow-sm" />
        </div>
        
        <select id="year-filter" class="h-[46px] px-3 border-2 border-gray-200 rounded-xl text-sm outline-none focus:border-purple-500 bg-white shadow-sm font-bold">
          <option value="">Todos los a√±os</option>
          <option value="2025">2025</option>
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="2022">2022</option>
        </select>
        
        <button id="refresh-stripe-btn" class="h-[46px] px-5 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-all flex items-center justify-center text-[10px] font-black uppercase tracking-widest gap-2 shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
          Actualizar
        </button>
        <button id="export-stripe" class="h-[46px] px-5 bg-emerald-600 text-white rounded-xl shadow-md hover:bg-emerald-700 transition-all flex items-center justify-center text-[10px] font-black uppercase tracking-widest gap-2">
           EXPORTAR EXCEL
        </button>
      </div>
    </header>

    <div class="bg-white rounded-[2rem] shadow-2xl border border-gray-100 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse">
          <thead class="bg-purple-600">
            <tr>
              <th class="px-8 py-5 text-left text-[10px] font-black text-white uppercase tracking-widest">ID Pago</th>
              <th class="px-8 py-5 text-left text-[10px] font-black text-white uppercase tracking-widest">Concepto</th>
              <th class="px-8 py-5 text-center text-[10px] font-black text-white uppercase tracking-widest">Estado</th>
              <th class="px-8 py-5 text-right text-[10px] font-black text-white uppercase tracking-widest">Monto</th>
              <th class="px-8 py-5 text-left text-[10px] font-black text-white uppercase tracking-widest">Fecha</th>
              <th class="px-8 py-5 text-center text-[10px] font-black text-white uppercase tracking-widest">Acciones</th>
            </tr>
          </thead>
          <tbody id="stripe-table-body" class="bg-white divide-y divide-gray-50"></tbody>
        </table>
      </div>

      <div class="px-8 py-4 bg-gray-50 border-t border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4">
        <span id="pagination-info" class="text-[11px] font-bold text-gray-500 uppercase">Mostrando 0 de 0 pagos</span>
        <div class="flex items-center gap-2" id="pagination-buttons"></div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">
      <div class="bg-purple-50 border border-purple-200 rounded-xl p-6">
        <div class="text-center">
          <p class="text-sm font-bold text-purple-600 uppercase">Total Recibido</p>
          <p id="total-received" class="text-3xl font-black text-purple-600 mt-2">$0.00</p>
        </div>
      </div>
      
      <div class="bg-green-50 border border-green-200 rounded-xl p-6">
        <div class="text-center">
          <p class="text-sm font-bold text-green-600 uppercase">Pagos Exitosos</p>
          <p id="count-succeeded" class="text-3xl font-black text-green-600 mt-2">0</p>
        </div>
      </div>
      
      <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
        <div class="text-center">
          <p class="text-sm font-bold text-yellow-600 uppercase">Pagos Pendientes</p>
          <p id="count-pending" class="text-3xl font-black text-yellow-600 mt-2">0</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>

  <script type="module">
    // StudentAPI is loaded globally via public/studentAPI.js
    
    // Wait for StudentAPI to be available
    async function ensureStudentAPI() {
      let attempts = 0;
      while (!window.StudentAPI && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      if (!window.StudentAPI) {
        throw new Error('StudentAPI could not be loaded');
      }
    }
    
    const ITEMS_PER_PAGE = 50;
    let currentPage = 1;
    let stripePayments = [];
    let isLoading = false;

    const tableBody = document.getElementById('stripe-table-body');
    const searchInput = document.getElementById('search-input');
    const yearFilter = document.getElementById('year-filter');
    const paginationInfo = document.getElementById('pagination-info');
    const paginationButtons = document.getElementById('pagination-buttons');
    const refreshBtn = document.getElementById('refresh-stripe-btn');
    const exportBtn = document.getElementById('export-stripe');
    const totalReceivedEl = document.getElementById('total-received');
    const countSucceededEl = document.getElementById('count-succeeded');
    const countPendingEl = document.getElementById('count-pending');
      const AUTO_REFRESH_INTERVAL_MS = 180000;
      let autoRefreshTimer = null;
      let autoRefreshFocusHandler = null;
      let autoRefreshVisibilityHandler = null;

    const fmt = n => '$' + Number(n).toLocaleString('es-MX', { minimumFractionDigits: 2 });

    const formatDate = (value) => {
      if (!value) return 'N/A';
      const date = new Date(value);
      return Number.isNaN(date.getTime()) ? String(value) : date.toLocaleDateString('es-MX');
    };

    const normalizeStripePayment = (payment) => {
      return {
        id: String(payment.id || ''),
        paymentIntentId: String(payment.payment_intent_id || payment.payment_intent || ''),
        conceptName: String(payment.concept_name || payment.concept || 'N/A'),
        status: String(payment.status || 'unknown'),
        amountTotal: Number(payment.amount_total ?? payment.amount ?? 0),
        amountReceived: Number(payment.amount_received ?? payment.amount_received_total ?? 0),
        created: payment.created || null,
        receiptUrl: payment.receipt_url || payment.receipt || ''
      };
    };
    
    async function loadStripePayments(forceRefresh = false) {
      if (isLoading) return;
      
      try {
        isLoading = true;
        if (refreshBtn) {
          refreshBtn.disabled = true;
          refreshBtn.innerHTML = `
            <svg class="animate-spin w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Cargando...
          `;
        }

        const token = localStorage.getItem('access_token');
        if (!token) {
          console.warn('No hay token de autenticaci√≥n');
          renderTable();
          return;
        }

        const search = searchInput.value;
        const year = yearFilter.value ? parseInt(yearFilter.value) : null;
        
        const response = await window.StudentAPI.getStripePayments(token, search, year, forceRefresh);
        
        if (response.success && response.data?.payments) {
          stripePayments = response.data.payments.map(normalizeStripePayment);
          
          console.log('‚úÖ Pagos de Stripe cargados:', stripePayments.length);
          renderTable();
          updateSummary();
        }
      } catch (error) {
        console.error('‚ùå Error al cargar pagos de Stripe:', error);
        renderTable();
      } finally {
        isLoading = false;
        if (refreshBtn) {
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
            </svg>
            Actualizar
          `;
        }
      }
    }

    function renderTable() {
      const term = searchInput.value.toLowerCase();
      
      const filtered = stripePayments.filter(payment => {
        if (!term) return true;
         return payment.conceptName.toLowerCase().includes(term) ||
           payment.id.toLowerCase().includes(term) ||
           payment.paymentIntentId.toLowerCase().includes(term);
      });

      const totalItems = filtered.length;
      const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
      if (currentPage > totalPages) currentPage = totalPages || 1;
      
      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const pageData = filtered.slice(start, start + ITEMS_PER_PAGE);

      tableBody.innerHTML = pageData.map((payment) => {
        const statusClass = payment.status === 'succeeded' ? 'text-green-600 bg-green-100' : 
                           payment.status === 'pending' ? 'text-yellow-600 bg-yellow-100' : 
                           'text-red-600 bg-red-100';
        const rowClass = payment.status === 'succeeded' ? 'bg-green-50' : 
                        payment.status === 'pending' ? 'bg-yellow-50' : 
                        'bg-red-50';

        const displayId = payment.id ? `${payment.id.substring(0,12)}...` : 'N/A';
        const displayIntent = payment.paymentIntentId ? `${payment.paymentIntentId.substring(0,12)}...` : 'N/A';
        
        return `
          <tr class="hover:bg-gray-50 transition-all border-l-4 border-purple-500 ${rowClass}">
            <td class="px-8 py-5">
                <div class="text-[11px] font-mono font-black text-gray-900">${displayId}</div>
                <div class="text-[9px] text-gray-400 font-mono">${displayIntent}</div>
            </td>
            <td class="px-8 py-5 text-[11px] text-gray-600 font-bold">${payment.conceptName}</td>
            <td class="px-8 py-5 text-center">
              <span class="px-3 py-1 rounded-full text-[11px] font-black ${statusClass}">
                ${payment.status.toUpperCase()}
              </span>
            </td>
            <td class="px-8 py-5 text-right text-sm font-black text-purple-600 font-mono">${fmt(payment.amountReceived)}</td>
            <td class="px-8 py-5 text-[11px] text-gray-600 font-bold">${formatDate(payment.created)}</td>
            <td class="px-8 py-5 text-center">
              ${payment.receiptUrl ? `<a href="${payment.receiptUrl}" target="_blank" class="text-blue-600 hover:underline text-[10px] font-black">VER RECIBO</a>` : '<span class="text-gray-400 text-[10px]">N/A</span>'}
            </td>
          </tr>
        `;
      }).join('');

      updatePaginationControls(totalItems, totalPages);
    }

    function updatePaginationControls(totalItems, totalPages) {
      const startItem = totalItems === 0 ? 0 : (currentPage - 1) * ITEMS_PER_PAGE + 1;
      const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
      paginationInfo.innerText = `Mostrando ${startItem}-${endItem} de ${totalItems} pagos`;
      paginationButtons.innerHTML = '';
      if (totalPages <= 1) return;
      
      const createBtn = (text, targetPage, active = false, disabled = false) => {
        const btn = document.createElement('button');
        btn.innerText = text;
        btn.className = `min-w-[32px] h-8 px-2 rounded-lg text-xs font-black ${active ? 'bg-purple-600 text-white' : disabled ? 'text-gray-300' : 'text-gray-500 hover:bg-gray-200'}`;
        if (!disabled) btn.onclick = () => { currentPage = targetPage; renderTable(); window.scrollTo(0,0); };
        return btn;
      };
      paginationButtons.appendChild(createBtn('‚Üê', currentPage - 1, false, currentPage === 1));
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          paginationButtons.appendChild(createBtn(i, i, currentPage === i));
        }
      }
      paginationButtons.appendChild(createBtn('‚Üí', currentPage + 1, false, currentPage === totalPages));
    }

    function updateSummary() {
      const totalReceived = stripePayments.reduce((sum, p) => sum + (p.amountReceived || 0), 0);
      const succeeded = stripePayments.filter(p => p.status === 'succeeded').length;
      const pending = stripePayments.filter(p => p.status === 'pending').length;
      
      if (totalReceivedEl) totalReceivedEl.textContent = fmt(totalReceived);
      if (countSucceededEl) countSucceededEl.textContent = succeeded;
      if (countPendingEl) countPendingEl.textContent = pending;
    }

    // Export to Excel
    exportBtn.addEventListener('click', () => {
      const data = stripePayments.map(p => ({
        'ID Pago': p.id,
        'Payment Intent ID': p.paymentIntentId,
        'Concepto': p.conceptName,
        'Estado': p.status,
        'Monto Recibido': p.amountReceived,
        'Fecha': formatDate(p.created),
        'Recibo': p.receiptUrl || 'No disponible'
      }));

      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Pagos Stripe");
      XLSX.writeFile(workbook, `Pagos_Stripe_${new Date().toLocaleDateString()}.xlsx`);
    });

    // Event listeners
    searchInput.addEventListener('input', () => { currentPage = 1; renderTable(); });
    yearFilter.addEventListener('change', () => { currentPage = 1; renderTable(); });
    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => loadStripePayments(true));
    }

      const triggerAutoRefresh = () => {
        if (isLoading || document.hidden) return;
        loadStripePayments(true).catch((err) => console.warn('‚ö†Ô∏è Auto-refresh stripe:', err?.message || err));
      };

      const setupAutoRefresh = () => {
        if (autoRefreshTimer) clearInterval(autoRefreshTimer);
        autoRefreshTimer = setInterval(triggerAutoRefresh, AUTO_REFRESH_INTERVAL_MS);

        if (!autoRefreshFocusHandler) {
          autoRefreshFocusHandler = () => triggerAutoRefresh();
          window.addEventListener('focus', autoRefreshFocusHandler);
        }

        if (!autoRefreshVisibilityHandler) {
          autoRefreshVisibilityHandler = () => {
            if (!document.hidden) triggerAutoRefresh();
          };
          document.addEventListener('visibilitychange', autoRefreshVisibilityHandler);
        }
      };
    
    // Load data initially (esperar a que StudentAPI est√© disponible)
    ensureStudentAPI()
        .then(() => {
          setupAutoRefresh();
          return loadStripePayments();
        })
      .catch(err => console.error('‚ùå Error al inicializar:', err));

      window.addEventListener('beforeunload', () => {
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
        }
      }, { once: true });
  </script>

  <style>
    [x-cloak] { display: none !important; }
  </style>
</Layout>
