---
import { conceptsStore } from '../store.js';

interface Props {
  concept?: {
    id: string;
    title: string;
    amount: string;
    description: string;
    status: string;
    applyTo?: string;
    semester?: string;
    career?: string;
    students?: string[]; // Ahora es un array de strings
  };
}

const { concept } = Astro.props;
---

<form id="conceptForm" class="bg-white rounded-lg shadow-lg p-8 max-w-2xl mx-auto">
  <input type="hidden" name="id" value={concept?.id || ''} />

  <div class="mb-6">
    <label for="conceptTitle" class="block text-gray-700 font-semibold mb-2">Concepto</label>
    <input
      type="text"
      id="conceptTitle"
      name="title"
      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2e594d]"
      value={concept?.title || ''}
      placeholder="Colegiatura Semestral"
    />
  </div>

  <div class="mb-6">
    <label for="amount" class="block text-gray-700 font-semibold mb-2">Monto</label>
    <input
      type="text"
      id="amount"
      name="amount"
      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2e594d]"
      value={concept?.amount || ''}
      placeholder="1200"
    />
  </div>

  <div class="mb-6">
    <label for="description" class="block text-gray-700 font-semibold mb-2">Descripción</label>
    <textarea
      id="description"
      name="description"
      rows="3"
      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2e594d]"
      set:html={concept?.description || ''}
      placeholder="Escribe la descripción del concepto"
    ></textarea>
  </div>
  
  <div class="mb-6">
    <label class="block text-gray-700 font-semibold mb-2">Estado</label>
    <select id="status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
      <option value="Activo" selected={concept?.status === 'Activo'}>Activo</option>
      <option value="Finalizado" selected={concept?.status === 'Finalizado'}>Finalizado</option>
    </select>
  </div>

  <div class="mb-6">
    <label class="block text-gray-700 font-semibold mb-2">Aplicar a</label>
    <input type="hidden" name="applyTo" id="applyTo" value={concept?.applyTo || 'todos'} />
    <div class="flex items-center gap-2 mb-4" id="target-buttons">
      <button type="button" data-target="todos" class="px-4 py-1 rounded-full bg-green-100 text-green-800 font-semibold text-sm">Todos</button>
      <button type="button" data-target="semestre" class="px-4 py-1 rounded-full bg-green-100 text-green-800 font-semibold text-sm">Semestre</button>
      <button type="button" data-target="carrera" class="px-4 py-1 rounded-full bg-green-100 text-green-800 font-semibold text-sm">Carrera</button>
      <button type="button" data-target="alumnos" class="px-4 py-1 rounded-full bg-green-100 text-green-800 font-semibold text-sm">Alumnos</button>
    </div>
    
    <select
      id="semesterSelect"
      name="semester"
      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2e594d] mt-2"
      style="display: none;"
    >
      <option value="" disabled selected>Selecciona un semestre</option>
      <option value="1" selected={concept?.semester === '1'}>1ro</option>
      <option value="2" selected={concept?.semester === '2'}>2do</option>
      <option value="3" selected={concept?.semester === '3'}>3ro</option>
      <option value="4" selected={concept?.semester === '4'}>4to</option>
      <option value="5" selected={concept?.semester === '5'}>5to</option>
      <option value="6" selected={concept?.semester === '6'}>6to</option>
    </select>
    
    <select
      id="careerSelect"
      name="career"
      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2e594d] mt-2"
      style="display: none;"
    >
      <option value="" disabled selected>Selecciona una carrera</option>
      <option value="Programacion" selected={concept?.career === 'Programacion'}>Programación</option>
      <option value="Agropecuario" selected={concept?.career === 'Agropecuario'}>Agropecuario</option>
      <option value="Alimentos" selected={concept?.career === 'Alimentos'}>Alimentos</option>
    </select>
    
    <div id="studentsContainer" style="display: none;">
    </div>
    <div id="addStudentBtnWrapper" style="display: none;">
      <button type="button" id="addStudentBtn" class="px-4 py-1 rounded-lg bg-gray-200 text-gray-700 font-semibold text-sm mt-2">
        + Agregar Alumno
      </button>
    </div>
  </div>

  <div class="flex justify-end gap-4 mt-8">
    <button
      type="button"
      class="px-6 py-2 rounded-lg text-gray-700 border border-gray-300 font-semibold"
      onClick={() => window.history.back()}
    >
      Cancelar
    </button>
    <button
      type="submit"
      class="px-6 py-2 rounded-lg bg-[#2e594d] text-white font-semibold"
    >
      {concept ? 'Guardar Cambios' : 'Crear'}
    </button>
  </div>
</form>

<script>
  import { conceptsStore } from '../store.js';

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('conceptForm');
    const targetButtons = document.getElementById('target-buttons');
    const applyToInput = document.getElementById('applyTo');
    const semesterSelect = document.getElementById('semesterSelect');
    const careerSelect = document.getElementById('careerSelect');
    const studentsContainer = document.getElementById('studentsContainer');
    const addStudentBtn = document.getElementById('addStudentBtn');
    const addStudentBtnWrapper = document.getElementById('addStudentBtnWrapper');

    function createStudentField(value = '') {
      const newStudentField = document.createElement('div');
      newStudentField.className = 'flex items-center gap-2 mb-2';
      newStudentField.innerHTML = `
        <input
          type="text"
          name="students[]"
          class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2e594d]"
          placeholder="Nombre o matrícula del alumno"
          value="${value}"
        />
        <button type="button" class="px-3 py-1 rounded-lg bg-red-200 text-red-800 font-semibold text-sm remove-student">
          -
        </button>
      `;
      studentsContainer.appendChild(newStudentField);
    }
    
    function updateUI(target) {
      targetButtons.querySelectorAll('button').forEach(btn => {
        btn.classList.remove('bg-green-100', 'text-green-800');
        btn.classList.add('bg-green-100', 'text-green-800');
        if (btn.dataset.target === target) {
          btn.classList.remove('bg-green-100', 'text-green-800');
          btn.classList.add('bg-[#2e594d]', 'text-white');
        }
      });
      
      semesterSelect.style.display = 'none';
      careerSelect.style.display = 'none';
      studentsContainer.style.display = 'none';
      addStudentBtnWrapper.style.display = 'none';
      
      if (target === 'semestre') {
        semesterSelect.style.display = 'block';
      } else if (target === 'carrera') {
        careerSelect.style.display = 'block';
      } else if (target === 'alumnos') {
        studentsContainer.style.display = 'block';
        addStudentBtnWrapper.style.display = 'block';
      }
    }
    
    const initialApplyTo = applyToInput.value;
    updateUI(initialApplyTo);
    if (initialApplyTo === 'alumnos' && window.Astro.props.concept?.students) {
      studentsContainer.innerHTML = '';
      window.Astro.props.concept.students.forEach(student => {
        createStudentField(student);
      });
      if (window.Astro.props.concept.students.length === 0) {
        createStudentField();
      }
    } else if (initialApplyTo === 'alumnos') {
      createStudentField();
    }

    addStudentBtn.addEventListener('click', () => {
      createStudentField();
    });
    
    studentsContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('remove-student')) {
            event.target.closest('.flex.items-center.gap-2.mb-2').remove();
        }
    });

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData.entries());
      
      const allConcepts = conceptsStore.get() || [];
      const existingConceptIndex = allConcepts.findIndex(c => c.id === data.id);

      const studentsArray = Array.from(document.querySelectorAll('#studentsContainer input[name="students[]"]'))
                               .map(input => input.value.trim())
                               .filter(value => value !== '');
      
      if (existingConceptIndex !== -1) { // CORRECTED LINE
        const updatedConcepts = [...allConcepts];
        updatedConcepts[existingConceptIndex] = {
          ...updatedConcepts[existingConceptIndex],
          title: data.title,
          amount: data.amount, // Changed to save just the number
          description: data.description,
          status: data.status,
          applyTo: data.applyTo,
          semester: data.semester || null,
          career: data.career || null,
          students: studentsArray
        };
        conceptsStore.set(updatedConcepts);
        alert('Concepto actualizado con éxito.');
      } else {
        const newConcept = {
          id: crypto.randomUUID(),
          title: data.title,
          amount: data.amount, // Changed to save just the number
          description: data.description,
          status: 'Activo',
          applyTo: data.applyTo,
          semester: data.semester || null,
          career: data.career || null,
          students: studentsArray
        };
        conceptsStore.set([...allConcepts, newConcept]);
        alert('Concepto creado con éxito.');
      }

      window.location.href = '/concepts';
    });

    if (targetButtons) {
      targetButtons.addEventListener('click', (event) => {
        const clickedButton = event.target.closest('button');
        if (clickedButton) {
          const target = clickedButton.dataset.target;
          applyToInput.value = target;
          updateUI(target);
        }
      });
    }
  });
</script>