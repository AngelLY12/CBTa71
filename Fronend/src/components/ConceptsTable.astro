---
// src/components/ConceptsTable.astro
---

<div class="overflow-x-auto bg-white rounded-lg">
  <table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Concepto</th>
        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Monto</th>
        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Estado</th>
        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Fecha Inicio</th>
        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Fecha Fin</th>
      </tr>
    </thead>
    <tbody id="dashboard-concepts-body" class="bg-white divide-y divide-gray-200">
    </tbody>
  </table>
</div>

<script is:inline>
  function updateDashboardTable() {
    const tbody = document.getElementById('dashboard-concepts-body');
    if (!tbody) return;

    try {
      const concepts = JSON.parse(localStorage.getItem('conceptsList') || '[]');
      const formatCurrency = (n) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(n);

      // FunciÃ³n para limpiar el formato ISO (YYYY-MM-DDTHH:mm...) a solo YYYY-MM-DD
      const formatDate = (dateStr) => {
        if (!dateStr || dateStr === '---') return '---';
        return dateStr.split('T')[0]; // Corta la cadena antes de la 'T'
      };

      tbody.innerHTML = concepts.map(concept => {
        const isInactive = concept.status === 'inactive' || concept.status === 'Finalizado';
        const badgeClass = isInactive ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
        
        // Obtenemos las fechas crudas
        const rawInicio = concept.fechaInicio || concept.fecha || concept.startDate || concept.createdAt || '---';
        const rawFin = concept.fechaFin || concept.endDate || '---';
        
        return `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 uppercase">
              ${concept.title || concept.name || 'S/N'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
              ${formatCurrency(concept.amount || 0)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-3 py-1 text-xs font-bold rounded-full ${badgeClass}">
                ${isInactive ? 'FINALIZADO' : 'ACTIVO'}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${formatDate(rawInicio)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${formatDate(rawFin)}
            </td>
          </tr>
        `;
      }).join('');

    } catch (e) {
      console.error("Error al actualizar tabla:", e);
    }
  }

  document.addEventListener('DOMContentLoaded', updateDashboardTable);
  window.addEventListener('storage', updateDashboardTable);
  window.addEventListener('conceptsUpdated', updateDashboardTable);
</script>