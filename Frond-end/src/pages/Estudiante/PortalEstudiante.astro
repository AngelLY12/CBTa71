---
import StudentLayout from '../../layouts/LayoutEstu.astro';

const title = 'Panel de Estudiante';
---

<StudentLayout title={title}>
  <script src="/studentAPI.js?v=20260218r32" is:inline></script>
  <script is:inline>
    function studentDashboard() {
      return {
        alumnoNombre: 'Estudiante',
        history: [],
        showAllPayments: false,
        overdue: { totalAmount: '0.00', totalCount: 0 },
        paid: { totalPayments: '0.00', paymentsByMonth: {} },
        pending: { totalAmount: '0.00', totalCount: 0 },
        porcentajeProgreso: 0,
        loading: false,
        error: '',
        portalRole: 'student',
        roleNotice: '',
        emptyPaymentsMessage: 'No hay registros de pagos',
        initCompleted: false,
        initInProgress: false,

        normalizePortalRole(roleValue) {
          const role = String(roleValue || '').toLowerCase().trim();
          if (!role) return '';
          if (role === 'parent' || role === 'padre') return 'parent';
          if (role === 'applicant' || role === 'aspirante' || role === 'solicitante') return 'applicant';
          if (role === 'student' || role === 'estudiante' || role === 'alumno') return 'student';
          return role;
        },

        pickFirstValue(source, keys, fallback = null) {
          if (!source || !Array.isArray(keys)) return fallback;
          for (const key of keys) {
            const value = source?.[key];
            if (value !== undefined && value !== null && value !== '') {
              return value;
            }
          }
          return fallback;
        },

        extractDashboardHistoryItems(historyResponse) {
          if (!historyResponse || typeof historyResponse !== 'object') return [];

          const data = historyResponse?.data || {};
          const candidates = [
            data?.payment_history?.items,
            data?.payment_history?.data,
            data?.payment_history,
            data?.history?.items,
            data?.history?.data,
            data?.history,
            data?.items,
            historyResponse?.payment_history?.items,
            historyResponse?.payment_history?.data,
            historyResponse?.payment_history,
            historyResponse?.history?.items,
            historyResponse?.history?.data,
            historyResponse?.history,
            historyResponse?.items,
            data,
            historyResponse
          ];

          for (const candidate of candidates) {
            if (Array.isArray(candidate)) return candidate;
          }

          return [];
        },

        resolveHistoryConcept(payment) {
          const directConcept = this.pickFirstValue(payment, [
            'concept_name',
            'concept',
            'concepto',
            'description',
            'payment_concept_name',
            'paymentConceptName',
            'name',
            'title',
            'label'
          ], null);

          const nestedConcept =
            payment?.payment_concept?.name ||
            payment?.payment_concept?.concept_name ||
            payment?.concept_data?.name ||
            payment?.concept_detail?.name ||
            payment?.concept?.name ||
            payment?.concept?.title ||
            payment?.conceptName ||
            null;

          const conceptValue = directConcept ?? nestedConcept ?? 'Pago';
          return String(conceptValue);
        },

        resolveHistoryAmount(payment) {
          return this.pickFirstValue(payment, [
            'amount_received',
            'received_amount',
            'paid_amount',
            'amount_paid',
            'amount',
            'total_amount',
            'total',
            'monto',
            'importe',
            'value'
          ], '0.00');
        },

        detectPortalRoleFromStorage() {
          const roleValues = [];
          const rawUserCandidates = [
            localStorage.getItem('user_data'),
            localStorage.getItem('userData')
          ].filter(Boolean);

          rawUserCandidates.forEach((rawValue) => {
            try {
              const parsed = JSON.parse(rawValue);
              const userData = parsed?.data?.user || parsed?.user || parsed?.data || parsed || {};
              const roles = [];

              if (Array.isArray(userData?.roles)) roles.push(...userData.roles);
              if (userData?.role) roles.push(userData.role);
              if (userData?.role_name) roles.push(userData.role_name);
              if (userData?.type) roles.push(userData.type);

              roles.forEach((entry) => {
                if (!entry) return;
                if (typeof entry === 'string') {
                  roleValues.push(entry);
                  return;
                }
                roleValues.push(entry?.name || entry?.slug || entry?.role || '');
              });
            } catch (error) {
              console.warn('‚ö†Ô∏è [PortalEstudiante] No se pudo parsear user_data/userData:', error?.message || error);
            }
          });

          const roleCandidates = [
            localStorage.getItem('userRole'),
            localStorage.getItem('role'),
            ...roleValues
          ]
            .filter(Boolean)
            .map((value) => this.normalizePortalRole(value))
            .filter(Boolean);

          if (roleCandidates.includes('parent')) return 'parent';
          if (roleCandidates.includes('applicant')) return 'applicant';
          if (roleCandidates.includes('student')) return 'student';
          return '';
        },

        async syncPortalRoleFromApi(token) {
          if (!token || !window.StudentAPI?.getAuthenticatedUser) return '';

          const now = Date.now();
          const nextAllowedSyncAt = Number(localStorage.getItem('portal_role_sync_next_at') || '0');
          if (Number.isFinite(nextAllowedSyncAt) && now < nextAllowedSyncAt) {
            return '';
          }

          try {
            const response = await window.StudentAPI.getAuthenticatedUser(token);
            const user = response?.data?.user || response?.user || response?.data || {};
            const rawRoles = [];

            if (Array.isArray(user?.roles)) rawRoles.push(...user.roles);
            if (user?.role) rawRoles.push(user.role);
            if (user?.role_name) rawRoles.push(user.role_name);
            if (user?.type) rawRoles.push(user.type);

            const normalizedRoles = rawRoles
              .map((entry) => {
                if (!entry) return '';
                if (typeof entry === 'string') return entry;
                return entry?.name || entry?.slug || entry?.role || '';
              })
              .map((value) => this.normalizePortalRole(value))
              .filter(Boolean);

            const resolvedRole = normalizedRoles.includes('parent')
              ? 'parent'
              : normalizedRoles.includes('applicant')
                  ? 'applicant'
                  : normalizedRoles.includes('student')
                    ? 'student'
                  : '';

            if (resolvedRole) {
              localStorage.setItem('userRole', resolvedRole);
              localStorage.setItem('role', resolvedRole);
              localStorage.setItem('portal_role_sync_next_at', String(now + (15 * 60 * 1000)));
              console.log('üîç [PortalEstudiante] Rol sincronizado desde API:', resolvedRole);
            }

            return resolvedRole;
          } catch (error) {
            const errorMessage = String(error?.message || error || '').toLowerCase();
            const isRateLimited = errorMessage.includes('429') || errorMessage.includes('l√≠mite de solicitudes') || errorMessage.includes('limite de solicitudes') || errorMessage.includes('too many requests');
            if (isRateLimited) {
              localStorage.setItem('portal_role_sync_next_at', String(now + (5 * 60 * 1000)));
            }
            console.warn('‚ö†Ô∏è [PortalEstudiante] No se pudo sincronizar rol desde API:', error?.message || error);
            return '';
          }
        },

        async init() {
          if (this.initCompleted || this.initInProgress) {
            return;
          }
          this.initInProgress = true;

          const token = localStorage.getItem('access_token');
          const userId = localStorage.getItem('userId');
          const userName = localStorage.getItem('userName');

          if (userName) {
            this.alumnoNombre = userName;
          }

          if (!token || !window.StudentAPI) {
            this.error = 'Usuario no autenticado';
            return;
          }

          this.loading = true;
          try {
            const parsedUserId = parseInt(userId, 10);
            let roleForPortal = this.detectPortalRoleFromStorage();
            if (!roleForPortal) {
              const roleFromApi = await this.syncPortalRoleFromApi(token);
              if (roleFromApi) {
                roleForPortal = roleFromApi;
              }
            }
            if (!roleForPortal) {
              roleForPortal = 'student';
            }

            this.portalRole = roleForPortal;
            const scopedStudentId = Number.isInteger(parsedUserId) ? parsedUserId : null;
            this.roleNotice = '';
            this.emptyPaymentsMessage = 'No hay registros de pagos';
            const requestRole = roleForPortal === 'applicant' ? 'student' : roleForPortal;

            if (roleForPortal === 'applicant') {
              this.roleNotice = '';
            }

            const dashboardCalls = [
              window.StudentAPI.getDashboardHistory(scopedStudentId, token, 1, 15, false, requestRole).catch(function(e) { return { error: e.message }; }),
              window.StudentAPI.getOverdueTotal(scopedStudentId, token, false, requestRole).catch(function(e) { return { error: e.message }; }),
              window.StudentAPI.getPaidTotal(scopedStudentId, token, false, requestRole).catch(function(e) { return { error: e.message }; }),
              window.StudentAPI.getPendingTotal(scopedStudentId, token, false, requestRole).catch(function(e) { return { error: e.message }; })
            ];

            const [historyRes, overdueRes, paidRes, pendingRes] = await Promise.all(dashboardCalls);

            if (historyRes && !historyRes.error) {
              const items = this.extractDashboardHistoryItems(historyRes);
              this.history = items.map((payment) => {
                const montoValue = this.resolveHistoryAmount(payment);
                const conceptValue = this.resolveHistoryConcept(payment);

                return {
                  id: payment?.id ?? payment?.payment_id ?? Math.random().toString(36).slice(2),
                  concepto: String(conceptValue),
                  monto: this.formatDashboardHistoryAmount(montoValue),
                  fecha: this.formatDashboardHistoryDate(payment),
                  metodo: payment?.method || payment?.payment_method || 'Metodo desconocido',
                  status: this.normalizeHistoryStatus(payment?.status)
                };
              });
              console.log('‚úÖ Historial de pagos cargado:', this.history.length);
            }

            if (overdueRes && !overdueRes.error) {
              this.overdue = overdueRes.data && overdueRes.data.total_overdue ? overdueRes.data.total_overdue : { totalAmount: '0.00', totalCount: 0 };
            }

            if (paidRes && !paidRes.error) {
              this.paid = paidRes.data && paidRes.data.paid_data ? paidRes.data.paid_data : { totalPayments: '0.00', paymentsByMonth: {} };
            }

            if (pendingRes && !pendingRes.error) {
              this.pending = pendingRes.data && pendingRes.data.total_pending ? pendingRes.data.total_pending : { totalAmount: '0.00', totalCount: 0 };
            }

            const paidAmount = parseFloat(this.paid && this.paid.totalPayments ? this.paid.totalPayments : '0');
            const pendingAmount = parseFloat(this.pending && this.pending.totalAmount ? this.pending.totalAmount : '0');
            const totalAmount = paidAmount + pendingAmount;
            this.porcentajeProgreso = totalAmount > 0 ? Math.round((paidAmount / totalAmount) * 100) : 0;
            this.initCompleted = true;
          } catch (err) {
            console.error('Error loading dashboard data:', err);
            this.error = 'Error al cargar los datos del panel';
          } finally {
            this.loading = false;
            this.initInProgress = false;
          }
        },

        formatMoney(value) {
          const parsed = parseFloat(value || '0');
          return '$' + parsed.toFixed(2) + ' MXN';
        },

        pendingSubtitle() {
          return this.pending && this.pending.totalCount
            ? this.pending.totalCount + ' ' + (this.pending.totalCount === 1 ? 'Adeudo' : 'Adeudos')
            : 'Sin adeudos';
        },

        overdueSubtitle() {
          return this.overdue && this.overdue.totalCount
            ? this.overdue.totalCount + ' ' + (this.overdue.totalCount === 1 ? 'Pago vencido' : 'Pagos vencidos')
            : 'Sin pagos vencidos';
        },

        normalizeHistoryStatus(statusValue) {
          const value = String(statusValue || '').toLowerCase().trim();
          if (!value) return 'paid';
          if (value === 'paid' || value === 'completed' || value === 'success' || value === 'succeeded') return 'paid';
          if (value === 'pending' || value === 'processing' || value === 'in_process') return 'pending';
          if (value === 'failed' || value === 'error' || value === 'declined' || value === 'canceled' || value === 'cancelled') return 'failed';
          if (value === 'refunded' || value === 'refund') return 'refunded';
          return value;
        },

        formatDashboardHistoryDate(payment) {
          const humanDate = payment?.date;
          if (humanDate && typeof humanDate === 'string') {
            const normalized = humanDate.toLowerCase();
            if (normalized.includes('hace') || normalized.includes('ago')) {
              return this.translateRelativeDateToEs(humanDate);
            }
          }

          const isoDate = payment?.date_iso || payment?.payment_date || payment?.created_at || payment?.date;
          if (!isoDate) {
            return new Date().toLocaleDateString('es-MX');
          }

          const parsed = new Date(isoDate);
          if (Number.isNaN(parsed.getTime())) {
            return String(humanDate || isoDate);
          }

          return parsed.toLocaleDateString('es-MX', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
        },

        translateRelativeDateToEs(value) {
          const text = String(value || '').trim();
          if (!text) return text;
          if (text.toLowerCase().includes('hace')) return text;

          let normalized = text
            .replace(/seconds?\s+ago/i, 'hace segundos')
            .replace(/a\s+second\s+ago/i, 'hace 1 segundo')
            .replace(/minutes?\s+ago/i, 'hace minutos')
            .replace(/a\s+minute\s+ago/i, 'hace 1 minuto')
            .replace(/hours?\s+ago/i, 'hace horas')
            .replace(/an?\s+hour\s+ago/i, 'hace 1 hora')
            .replace(/days?\s+ago/i, 'hace d√≠as')
            .replace(/a\s+day\s+ago/i, 'hace 1 d√≠a')
            .replace(/weeks?\s+ago/i, 'hace semanas')
            .replace(/a\s+week\s+ago/i, 'hace 1 semana')
            .replace(/months?\s+ago/i, 'hace meses')
            .replace(/a\s+month\s+ago/i, 'hace 1 mes')
            .replace(/years?\s+ago/i, 'hace a√±os')
            .replace(/a\s+year\s+ago/i, 'hace 1 a√±o');

          const numberUnitMatch = normalized.match(/^(\d+)\s+(second|seconds|minute|minutes|hour|hours|day|days|week|weeks|month|months|year|years)\s+ago$/i);
          if (numberUnitMatch) {
            const amount = numberUnitMatch[1];
            const unit = numberUnitMatch[2].toLowerCase();
            const map = {
              second: 'segundo',
              seconds: 'segundos',
              minute: 'minuto',
              minutes: 'minutos',
              hour: 'hora',
              hours: 'horas',
              day: 'd√≠a',
              days: 'd√≠as',
              week: 'semana',
              weeks: 'semanas',
              month: 'mes',
              months: 'meses',
              year: 'a√±o',
              years: 'a√±os'
            };
            return `hace ${amount} ${map[unit] || unit}`;
          }

          return normalized;
        },

        formatDashboardHistoryAmount(value) {
          if (typeof value === 'number' && Number.isFinite(value)) {
            return value.toFixed(2);
          }

          const raw = String(value ?? '').trim();
          if (!raw) return '0.00';

          const sanitized = raw
            .replace(/\s+/g, '')
            .replace(/[^\d,.-]/g, '')
            .replace(/,(?=\d{3}(\D|$))/g, '')
            .replace(',', '.');

          const parsed = Number(sanitized);
          if (!Number.isFinite(parsed)) return '0.00';
          return parsed.toFixed(2);
        },

        progressOffset() {
          const radius = 60;
          const circumference = 2 * Math.PI * radius;
          return circumference - (circumference * this.porcentajeProgreso / 100);
        },

        circumference() {
          return 2 * Math.PI * 50;
        },

        getVisiblePayments() {
          if (this.showAllPayments) {
            return this.history;
          }
          return this.history.slice(0, 5);
        },

        toggleShowAllPayments() {
          this.showAllPayments = !this.showAllPayments;
        }
      };
    }
  </script>
  <div class="main-container" x-data="studentDashboard()" x-init="init()">
    <header class="welcome-header">
      <div class="header-left">
        <div class="icon-box">
          <svg xmlns="http://www.w3.org/2000/svg" class="header-icon-svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <div>
          <p class="welcome-label">Dashboard Acad√©mico</p>
          <h1 class="student-name" x-text="'Hola, ' + (alumnoNombre ? alumnoNombre.split(' ')[0] : 'Estudiante')"></h1>
        </div>
      </div>
      <div class="header-right">
        <button 
          id="refreshCacheBtn"
          class="refresh-cache-btn"
          title="Limpiar cach√© del dashboard"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
          <span class="btn-text">Actualizar</span>
        </button>
        <span class="current-date mobile-hide">{new Date().toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' })}</span>
      </div>
    </header>

    <div x-show="roleNotice" class="mb-4 px-4 py-3 rounded-xl border border-amber-200 bg-amber-50 text-amber-800 text-sm font-medium" x-text="roleNotice"></div>



    <section class="stats-scroll-container">
      <div class="card-container danger">
        <div class="card-header">
          <span class="label">Pendientes</span>
          <div class="icon-wrapper">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v4l3 3"></path></svg>
          </div>
        </div>
        <div class="card-body">
          <h2 class="amount" x-text="formatMoney(pending.totalAmount)"></h2>
        </div>
        <div class="card-footer">
          <p class="subtitle" x-text="pendingSubtitle()"></p>
        </div>
      </div>

      <div class="card-container warning">
        <div class="card-header">
          <span class="label">Vencidos</span>
          <div class="icon-wrapper">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
          </div>
        </div>
        <div class="card-body">
          <h2 class="amount" x-text="formatMoney(overdue.totalAmount)"></h2>
        </div>
        <div class="card-footer">
          <p class="subtitle" x-text="overdueSubtitle()"></p>
        </div>
      </div>

      <div class="card-container success">
        <div class="card-header">
          <span class="label">Realizados</span>
          <div class="icon-wrapper">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
          </div>
        </div>
        <div class="card-body">
          <h2 class="amount" x-text="formatMoney(paid.totalPayments)"></h2>
        </div>
        <div class="card-footer">
          <p class="subtitle">Total pagado</p>
        </div>
      </div>
    </section>

    <div class="bottom-grid">
      <div class="summary-card glass-effect">
        <div class="card-header">
           <h3 class="summary-title">Balance de Cuenta</h3>
           <span class="status-badge">Actualizado</span>
        </div>
        <div class="summary-row">
          <div class="label-group">
            <div class="dot green"></div>
            <span class="summary-label">Monto Liquidado</span>
          </div>
          <span class="val-ok" x-text="formatMoney(paid.totalPayments)"></span>
        </div>
        <div class="summary-row">
          <div class="label-group">
            <div class="dot orange"></div>
            <span class="summary-label">Monto Vencido</span>
          </div>
          <span class="val-warning" x-text="formatMoney(overdue.totalAmount)"></span>
        </div>
        <div class="summary-row no-border">
          <div class="label-group">
            <div class="dot red"></div>
            <span class="summary-label">Monto por Pagar</span>
          </div>
          <span class="val-alert" x-text="formatMoney(pending.totalAmount)"></span>
        </div>
      </div>

      <div class="progress-card glass-effect">
        <div class="progress-inner">
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 2rem; padding: 1.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;">
            <p style="position: absolute; top: 1rem; left: 1rem; color: #9ca3af; font-weight: bold; font-size: 0.75rem; text-transform: uppercase;">Estado de Pagos</p>
            
            <!-- C√≠rculo Donut Chart -->
            <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 160px; height: 160px; margin: 1.5rem 0;">
              <svg style="width: 100%; height: 100%; transform: rotate(-90deg);" viewBox="0 0 120 120">
                <!-- C√≠rculo de fondo rojo (representa deuda/por pagar) -->
                <circle cx="60" cy="60" r="50" stroke="#fecaca" stroke-width="12" fill="none" />
                <!-- C√≠rculo verde (representa pagos realizados - va cubriendo el rojo) -->
                <circle 
                  cx="60" cy="60" r="50" 
                  stroke="#10b981" 
                  stroke-width="12" 
                  fill="none"
                  x-bind:stroke-dasharray="circumference()"
                  x-bind:stroke-dashoffset="circumference() - (circumference() * porcentajeProgreso / 100)"
                  style="stroke-linecap: round; transition: stroke-dashoffset 0.8s ease;"
                />
              </svg>
              <div style="position: absolute; text-align: center;">
                <div style="font-size: 2rem; font-weight: 900; line-height: 1;" :style="'color: ' + (porcentajeProgreso >= 50 ? '#10b981' : '#ef4444')" x-text="porcentajeProgreso + '%'">0%</div>
                <div style="font-size: 0.7rem; color: #9ca3af; font-weight: 600; margin-top: 0.25rem;">Completado</div>
              </div>
            </div>

            <!-- Leyenda con montos -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%; margin-top: 0.5rem;">
              <div style="text-align: center; padding: 0.75rem; background: #f0fdf4; border-radius: 0.75rem;">
                <div style="display: flex; align-items: center; gap: 0.4rem; justify-content: center; margin-bottom: 0.4rem;">
                  <div style="width: 10px; height: 10px; border-radius: 50%; background: #10b981;"></div>
                  <span style="font-size: 0.7rem; color: #059669; font-weight: 700; text-transform: uppercase;">Pagado</span>
                </div>
                <div style="font-size: 1rem; font-weight: 800; color: #10b981; word-break: break-all;" x-text="formatMoney(paid.totalPayments)">$0.00</div>
              </div>
              <div style="text-align: center; padding: 0.75rem; background: #fef2f2; border-radius: 0.75rem;">
                <div style="display: flex; align-items: center; gap: 0.4rem; justify-content: center; margin-bottom: 0.4rem;">
                  <div style="width: 10px; height: 10px; border-radius: 50%; background: #ef4444;"></div>
                  <span style="font-size: 0.7rem; color: #dc2626; font-weight: 700; text-transform: uppercase;">Por Pagar</span>
                </div>
                <div style="font-size: 1rem; font-weight: 800; color: #ef4444; word-break: break-all;" x-text="formatMoney(pending.totalAmount)">$0.00</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="payments-wrapper glass-effect">
      <div class="table-header">
        <h3 class="summary-title">Historial Reciente</h3>
      </div>
      <div class="payments-section">
        <h3 class="payments-title">Mis Pagos</h3>

        <div class="payments-table-wrapper">
          <table class="payments-table">
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Monto</th>
                <th>Fecha</th>
              </tr>
            </thead>

            <tbody>
              <template x-if="history && history.length > 0">
                <template x-for="pago in getVisiblePayments()" :key="pago.id">
                  <tr>
                    <td data-label="Concepto" x-text="pago.concepto"></td>
                    <td class="monto" data-label="Monto" x-text="'$' + pago.monto"></td>
                    <td class="fecha-celda" data-label="Fecha" x-text="pago.fecha || '‚Äî'"></td>
                  </tr>
                </template>
              </template>
              <template x-if="!history || history.length === 0">
                <tr>
                  <td colspan="3" class="empty-row" x-text="emptyPaymentsMessage"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <template x-if="history && history.length > 5">
          <button class="btn-ver-mas" @click="toggleShowAllPayments()" type="button">
            <span x-text="showAllPayments ? '‚Üë Mostrar menos' : '‚Üì Ver todos (' + history.length + ')'"></span>
          </button>
        </template>
      </div>
    </div>
  </div>
</StudentLayout>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');

  :root {
    --primary: #2E594D;
    --primary-light: #e9f0ee;
    --primary-gradient: linear-gradient(135deg, #2E594D 0%, #3d7566 100%);
    --danger: #ef4444;
    --success: #10b981;
    --warning: #f59e0b;
    --text-main: #111827;
    --text-muted: #6b7280;
    --bg-page: #f8fafc;
    --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
    --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideInLeft {
    from {
      opacity: 0;
      transform: translateX(-30px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(30px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
  }

  @keyframes shimmer {
    0% {
      background-position: -1000px 0;
    }
    100% {
      background-position: 1000px 0;
    }
  }

  .main-container { 
    padding: 2.5rem; 
    display: flex; 
    flex-direction: column; 
    gap: 2rem; 
    max-width: 1200px;
    margin: 0 auto;
    font-family: 'Plus Jakarta Sans', sans-serif;
    background-color: var(--bg-page);
    position: relative;
  }

  .main-container::before {
    content: '';
    position: fixed;
    top: -50%;
    right: -10%;
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(46, 89, 77, 0.08) 0%, transparent 70%);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
  }

  .main-container > * {
    position: relative;
    z-index: 1;
  }

  /* --- HEADER --- */
  .welcome-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    animation: slideInLeft 0.6s ease-out;
  }
  .header-left { 
    display: flex; 
    align-items: center; 
    gap: 1.25rem;
  }
  .icon-box { 
    background: var(--primary-gradient); 
    padding: 1rem; 
    border-radius: 1.25rem; 
    box-shadow: 0 10px 25px -5px rgba(46, 89, 77, 0.4), 0 0 0 1px rgba(46, 89, 77, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  .icon-box::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transform: rotate(45deg);
    animation: shimmer 3s infinite;
  }
  .icon-box:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 15px 35px -5px rgba(46, 89, 77, 0.5);
  }
  .header-icon-svg { 
    width: 1.75rem; 
    height: 1.75rem; 
    color: #fff;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }
  .welcome-label { 
    font-size: 0.85rem; 
    font-weight: 700; 
    text-transform: uppercase; 
    color: var(--primary); 
    letter-spacing: 0.05em; 
    margin-bottom: 0.25rem;
    background: linear-gradient(135deg, var(--primary) 0%, #3d7566 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .student-name { 
    font-size: 2.25rem; 
    font-weight: 800; 
    color: var(--text-main); 
    letter-spacing: -0.02em;
    background: linear-gradient(135deg, #111827 0%, #374151 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
    animation: slideInRight 0.6s ease-out;
  }
  .current-date { 
    color: var(--text-muted); 
    font-weight: 600; 
    text-transform: capitalize;
    background: white;
    padding: 0.75rem 1.25rem;
    border-radius: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(241, 245, 249, 1);
  }

  /* --- STATS --- */
  .stats-scroll-container { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 1.5rem;
    animation: fadeIn 0.8s ease-out 0.2s both;
  }
  
  .stats-scroll-container > :nth-child(1) {
    animation: scaleIn 0.5s ease-out 0.3s both;
  }
  
  .stats-scroll-container > :nth-child(2) {
    animation: scaleIn 0.5s ease-out 0.4s both;
  }
  
  .stats-scroll-container > :nth-child(3) {
    animation: scaleIn 0.5s ease-out 0.5s both;
  }

  .stats-scroll-container .card-container {
    background: white;
    border: none;
    border-radius: 1.5rem;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 160px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .stats-scroll-container .card-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, currentColor 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .stats-scroll-container .card-container:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12), 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .stats-scroll-container .danger::before { background: linear-gradient(90deg, #ff0000 0%, #ff6b6b 100%); }
  .stats-scroll-container .warning::before { background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%); }
  .stats-scroll-container .success::before { background: linear-gradient(90deg, #10b981 0%, #6ee7b7 100%); }

  .stats-scroll-container .card-container:hover::before {
    opacity: 1;
  }

  .stats-scroll-container .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    width: 100%;
    margin-bottom: 0.75rem;
  }

  .stats-scroll-container .label {
    font-size: 0.9rem;
    color: #4b5563;
    font-weight: 500;
  }

  .stats-scroll-container .icon-wrapper {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease;
  }

  .stats-scroll-container .card-container:hover .icon-wrapper {
    transform: scale(1.1);
  }

  .stats-scroll-container .card-body {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-grow: 1;
    margin: 0.5rem 0;
  }

  .stats-scroll-container .amount {
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: -0.03em;
    text-align: center;
    line-height: 1.2;
  }

  .stats-scroll-container .card-footer {
    text-align: center;
    width: 100%;
  }

  .stats-scroll-container .subtitle {
    font-size: 0.825rem;
    color: #9ca3af;
    font-weight: 500;
  }

  .stats-scroll-container .default .amount { color: #2E594D; }
  .stats-scroll-container .default .icon-wrapper { color: #2E594D; }
  .stats-scroll-container .danger .amount { color: #ff0000; }
  .stats-scroll-container .danger .icon-wrapper { color: #ff0000; }
  .stats-scroll-container .warning .amount { color: #f59e0b; }
  .stats-scroll-container .warning .icon-wrapper { color: #f59e0b; }
  .stats-scroll-container .success .amount { color: #10b981; }
  .stats-scroll-container .success .icon-wrapper { color: #10b981; }

  .payments-section {
    background: white;
    border: none;
    border-radius: 1.5rem;
    padding: 2rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .payments-title {
    color: #2E594D;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 1.5rem;
  }

  .payments-table-wrapper {
    width: 100%;
    overflow-x: auto;
  }

  .payments-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .payments-table thead th {
    text-align: left;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #9ca3af;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #f3f4f6;
  }

  .payments-table tbody tr {
    border-top: 1px solid #f3f4f6;
    transition: background-color 0.2s ease;
  }

  .payments-table tbody tr:hover {
    background-color: #f9fafb;
  }

  .payments-table td {
    padding: 1rem 0;
    color: #374151;
  }

  .payments-table .monto {
    color: #2E594D;
    font-weight: 700;
  }

  .fecha-celda {
    color: #6b7280;
  }

  .empty-row {
    text-align: center;
    padding: 2.5rem 0;
    color: #9ca3af;
    font-size: 0.85rem;
  }

  .btn-ver-mas {
    display: block;
    width: 100%;
    margin-top: 1.5rem;
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, #2e594d 0%, #3d7566 100%);
    color: white;
    border: none;
    border-radius: 1rem;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(46, 89, 77, 0.2);
  }

  .btn-ver-mas:hover {
    background: linear-gradient(135deg, #3d7566 0%, #4a8a77 100%);
    box-shadow: 0 6px 16px rgba(46, 89, 77, 0.3);
    transform: translateY(-2px);
  }

  .btn-ver-mas:active {
    transform: translateY(0);
  }

  /* --- CARDS & GRID --- */
  .bottom-grid { 
    display: grid; 
    grid-template-columns: 1.8fr 1.2fr; 
    gap: 1.5rem;
    animation: fadeIn 0.8s ease-out 0.6s both;
  }

  .glass-effect {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(241, 245, 249, 1); 
    border-radius: 2rem; 
    padding: 2rem; 
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  
  .glass-effect::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary-gradient);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
  }
  
  .glass-effect:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl), 0 0 0 1px rgba(0, 0, 0, 0.03);
  }
  
  .glass-effect:hover::before {
    transform: scaleX(1);
  }

  .card-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 2rem;
  }
  .status-badge { 
    background: linear-gradient(135deg, rgba(46, 89, 77, 0.1) 0%, rgba(46, 89, 77, 0.15) 100%);
    color: var(--primary); 
    padding: 0.4rem 0.8rem; 
    border-radius: 2rem; 
    font-size: 0.75rem; 
    font-weight: 700;
    border: 1px solid rgba(46, 89, 77, 0.2);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .status-badge::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0.5rem;
    width: 6px;
    height: 6px;
    background: var(--success);
    border-radius: 50%;
    animation: pulse 2s infinite;
    box-shadow: 0 0 8px var(--success);
  }
  
  .status-badge:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, rgba(46, 89, 77, 0.15) 0%, rgba(46, 89, 77, 0.2) 100%);
  }
  
  .summary-title { color: var(--text-main); font-weight: 800; font-size: 1.25rem; margin: 0; }
  
  .summary-row { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 1.25rem 0; 
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.3s ease;
  }
  
  .summary-row:hover {
    padding-left: 0.5rem;
    background: linear-gradient(90deg, rgba(46, 89, 77, 0.03) 0%, transparent 100%);
    border-radius: 0.5rem;
  }
  
  .label-group { 
    display: flex; 
    align-items: center; 
    gap: 0.75rem;
    transition: all 0.3s ease;
  }
  
  .summary-row:hover .label-group {
    transform: translateX(4px);
  }
  
  .dot { 
    width: 8px; 
    height: 8px; 
    border-radius: 50%;
    position: relative;
    animation: pulse 3s infinite;
  }
  
  .dot::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border-radius: 50%;
    opacity: 0.3;
    animation: pulse 3s infinite;
  }
  
  .dot.green { 
    background: var(--success); 
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.4), 0 0 20px rgba(16, 185, 129, 0.2);
  }
  .dot.green::after {
    background: var(--success);
  }
  
  .dot.orange { 
    background: var(--warning); 
    box-shadow: 0 0 10px rgba(245, 158, 11, 0.4), 0 0 20px rgba(245, 158, 11, 0.2);
  }
  .dot.orange::after {
    background: var(--warning);
  }
  
  .dot.red { 
    background: var(--danger); 
    box-shadow: 0 0 10px rgba(239, 68, 68, 0.4), 0 0 20px rgba(239, 68, 68, 0.2);
  }
  .dot.red::after {
    background: var(--danger);
  }
  
  .summary-label { 
    font-weight: 600; 
    color: var(--text-muted); 
    font-size: 1rem;
    transition: color 0.3s ease;
  }
  
  .summary-row:hover .summary-label {
    color: var(--text-main);
  }
  
  .val-ok, .val-alert, .val-warning { 
    color: var(--text-main); 
    font-weight: 800; 
    font-size: 1.35rem;
    transition: all 0.3s ease;
    font-variant-numeric: tabular-nums;
  }
  
  .summary-row:hover .val-ok,
  .summary-row:hover .val-alert,
  .summary-row:hover .val-warning {
    transform: scale(1.05);
  }
  
  .val-ok {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .val-alert { 
    background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .val-warning { 
    background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .no-border { border: none; }

  .progress-inner { 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 100%;
    animation: scaleIn 0.6s ease-out 0.8s both;
  }
  
  .progress-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(249, 250, 251, 0.98) 100%);
    position: relative;
  }
  
  .progress-card::before {
    content: '';
    position: absolute;
    inset: -1px;
    border-radius: 2rem;
    padding: 2px;
    background: linear-gradient(135deg, var(--primary) 0%, rgba(46, 89, 77, 0.3) 100%);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .progress-card:hover::before {
    opacity: 1;
  }

  .table-header { 
    margin-bottom: 1.5rem;
  }
  
  .payments-wrapper {
    animation: fadeIn 0.8s ease-out 0.9s both;
  }

  /* --- MOBILE ADAPTATIONS --- */
  @media (max-width: 768px) {
    .main-container { padding: 1rem; gap: 1.5rem; max-width: none; }
    .welcome-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
    .header-left { gap: 0.8rem; }
    .header-right { width: 100%; justify-content: flex-start; }
    .icon-box { padding: 0.8rem; border-radius: 1rem; }
    .header-icon-svg { width: 1.5rem; height: 1.5rem; }
    .welcome-label { font-size: 0.75rem; }
    .student-name { font-size: 1.5rem; }
    .mobile-hide { display: none; }

    .stats-scroll-container {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .stats-scroll-container .card-container {
      padding: 1rem 1.1rem;
      min-height: 150px;
    }

    .stats-scroll-container .label {
      font-size: 0.85rem;
    }

    .stats-scroll-container .amount {
      font-size: clamp(1.8rem, 8vw, 2.2rem);
      line-height: 1.1;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .stats-scroll-container .subtitle {
      font-size: 0.8rem;
    }

    .bottom-grid { grid-template-columns: 1fr; gap: 1.5rem; }
    .summary-card { order: 1; }
    .progress-card { order: 2; }
    .payments-wrapper { order: 3; }
    .glass-effect { padding: 1.2rem; border-radius: 1.2rem; }
    .card-header { margin-bottom: 1.5rem; }
    .summary-title { font-size: 1.1rem; }
    .summary-row { padding: 1rem 0; gap: 0.75rem; }
    .label-group { gap: 0.5rem; }
    .dot { width: 6px; height: 6px; }
    .summary-label { font-size: 0.9rem; }
    .val-ok, .val-alert, .val-warning { font-size: 1.2rem; }
    .progress-inner { padding: 1rem; }
    .table-header { margin-bottom: 1rem; }
    .payments-title { font-size: 1rem; }
    .payments-section { padding: 1.25rem; }

    /* Tabla responsiva para m√≥vil */
    .payments-table { font-size: 0.825rem; }
    .payments-table thead { display: none; }
    .payments-table tbody tr {
      display: block;
      border: 1px solid #e5e7eb;
      border-radius: 0.875rem;
      padding: 1rem;
      margin-bottom: 0.875rem;
      background: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .payments-table tbody tr:hover {
      background: #f9fafb;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    }
    .payments-table tbody td {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      text-align: right;
    }
    .payments-table tbody td::before {
      content: attr(data-label);
      font-weight: 700;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6b7280;
      text-align: left;
      flex: 1;
    }
    .btn-ver-mas { font-size: 0.9rem; padding: 0.75rem 1.25rem; }
  }

  @media (max-width: 480px) {
    .main-container {
      padding: 0.85rem;
      gap: 1.1rem;
    }

    .student-name {
      font-size: 1.15rem;
      line-height: 1.15;
    }

    .stats-scroll-container .card-container {
      border-radius: 1.2rem;
      padding: 0.95rem 1rem;
      min-height: 138px;
    }

    .stats-scroll-container .amount {
      font-size: clamp(1.6rem, 9vw, 2rem);
      letter-spacing: -0.02em;
    }

    .stats-scroll-container .subtitle {
      font-size: 0.76rem;
    }

    .glass-effect {
      padding: 1rem;
      border-radius: 1rem;
    }

    .summary-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.35rem;
    }

    .val-ok,
    .val-alert,
    .val-warning {
      width: 100%;
      text-align: left;
      font-size: 1.45rem;
      line-height: 1.1;
      overflow-wrap: anywhere;
    }

    .status-badge {
      font-size: 0.7rem;
      padding: 0.35rem 0.7rem;
    }
  }

  /* Refresh Cache Button */
  .refresh-cache-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1rem;
    background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
    color: white;
    border: none;
    border-radius: 0.75rem;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2), 0 1px 3px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
  }
  
  .refresh-cache-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
  }
  
  .refresh-cache-btn:hover::before {
    left: 100%;
  }

  .refresh-cache-btn:hover:not(:disabled) {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }

  .refresh-cache-btn:active:not(:disabled) {
    transform: translateY(0) scale(0.98);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.25);
  }

  .refresh-cache-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .refresh-cache-btn svg {
    flex-shrink: 0;
    transition: transform 0.3s ease;
  }
  
  .refresh-cache-btn:hover:not(:disabled) svg {
    transform: rotate(15deg);
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  .animate-spin {
    animation: spin 1s linear infinite;
  }

  @media (max-width: 768px) {
    .refresh-cache-btn .btn-text {
      display: none;
    }
    .refresh-cache-btn {
      padding: 0.6rem;
    }
  }

  /* Toast Notification */
  .toast-notification {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 9999;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 0.75rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 300px;
    max-width: 400px;
    border-left: 4px solid;
    opacity: 0;
    transform: translateX(400px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .toast-notification.show {
    opacity: 1;
    transform: translateX(0);
    animation: slideInRight 0.4s ease-out;
  }

  .toast-notification.success {
    border-color: #10b981;
  }

  .toast-notification.error {
    border-color: var(--danger);
  }

  .toast-notification.success .toast-icon {
    color: #10b981;
  }

  .toast-notification.error .toast-icon {
    color: var(--danger);
  }

  .toast-message {
    flex: 1;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-main);
  }

  .toast-close {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
  }

  .toast-close:hover {
    color: var(--text-main);
  }
</style>

<!-- Toast Notification -->
<div id="toast" class="toast-notification">
  <svg class="toast-icon" width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
    <path id="toastIconPath" fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
  </svg>
  <span id="toastMessage" class="toast-message"></span>
  <button class="toast-close" onclick="document.getElementById('toast').classList.remove('show')">
    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
    </svg>
  </button>
</div>

<script>
  function normalizePortalRoleForDashboard(roleValue: unknown): string {
    const role = String(roleValue || '').toLowerCase().trim();
    if (!role) return '';
    if (role === 'parent' || role === 'padre') return 'parent';
    if (role === 'student' || role === 'estudiante' || role === 'alumno') return 'student';
    if (role === 'applicant' || role === 'aspirante' || role === 'solicitante') return 'applicant';
    return role;
  }

  function detectPortalRoleFromStorageForDashboard() {
    const roleValues: string[] = [];
    const rawUserCandidates = [
      localStorage.getItem('user_data'),
      localStorage.getItem('userData')
    ].filter((value): value is string => Boolean(value));

    rawUserCandidates.forEach((rawValue) => {
      try {
        const parsed = JSON.parse(rawValue);
        const userData = parsed?.data?.user || parsed?.user || parsed?.data || parsed || {};
        const roles = [];

        if (Array.isArray(userData?.roles)) roles.push(...userData.roles);
        if (userData?.role) roles.push(userData.role);
        if (userData?.role_name) roles.push(userData.role_name);
        if (userData?.type) roles.push(userData.type);

        roles.forEach((entry) => {
          if (!entry) return;
          if (typeof entry === 'string') {
            roleValues.push(entry);
            return;
          }
          roleValues.push(entry?.name || entry?.slug || entry?.role || '');
        });
      } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        console.warn('‚ö†Ô∏è [PortalEstudiante] No se pudo parsear user_data/userData (refresh):', errorMessage);
      }
    });

    const roleCandidates = [
      localStorage.getItem('userRole'),
      localStorage.getItem('role'),
      ...roleValues
    ]
      .filter(Boolean)
      .map((value) => normalizePortalRoleForDashboard(value))
      .filter(Boolean);

    if (roleCandidates.includes('parent')) return 'parent';
    if (roleCandidates.includes('applicant')) return 'applicant';
    if (roleCandidates.includes('student')) return 'student';
    return 'student';
  }

  async function syncPortalRoleFromApiForDashboard(token: string, studentAPI: any): Promise<string> {
    if (!token || !studentAPI?.getAuthenticatedUser) return '';

    try {
      const response = await studentAPI.getAuthenticatedUser(token);
      const user = response?.data?.user || response?.user || response?.data || {};
      const rawRoles = [];

      if (Array.isArray(user?.roles)) rawRoles.push(...user.roles);
      if (user?.role) rawRoles.push(user.role);
      if (user?.role_name) rawRoles.push(user.role_name);
      if (user?.type) rawRoles.push(user.type);

      const normalizedRoles = rawRoles
        .map((entry) => {
          if (!entry) return '';
          if (typeof entry === 'string') return entry;
          return entry?.name || entry?.slug || entry?.role || '';
        })
        .map((value) => normalizePortalRoleForDashboard(value))
        .filter(Boolean);

      const resolvedRole = normalizedRoles.includes('parent')
        ? 'parent'
        : normalizedRoles.includes('applicant')
            ? 'applicant'
            : normalizedRoles.includes('student')
              ? 'student'
            : '';

      if (resolvedRole) {
        localStorage.setItem('userRole', resolvedRole);
        localStorage.setItem('role', resolvedRole);
      }

      return resolvedRole;
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      console.warn('‚ö†Ô∏è [PortalEstudiante] No se pudo sincronizar rol desde API (refresh):', errorMessage);
      return '';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const refreshBtn = document.getElementById('refreshCacheBtn') as HTMLButtonElement | null;
    let originalHTML = '';
    let isRefreshingDashboard = false;

    const refreshDashboard = async (options: { silent?: boolean; reloadAfterSuccess?: boolean } = {}) => {
      const { silent = false, reloadAfterSuccess = true } = options;
      if (isRefreshingDashboard) return;

      isRefreshingDashboard = true;

      try {
        if (refreshBtn) {
          refreshBtn.disabled = true;
          originalHTML = refreshBtn.innerHTML;

          refreshBtn.innerHTML = `
            <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="btn-text">Actualizando...</span>
          `;
        }

        const token = localStorage.getItem('access_token');
        const userId = localStorage.getItem('userId');
        const studentAPI = (window as any).StudentAPI;

        if (!token) {
          if (!silent) {
            showToast('error', 'No se encontr√≥ el token de autenticaci√≥n. Por favor, inicia sesi√≥n nuevamente.');
          }
          return;
        }

        if (!studentAPI) {
          if (!silent) {
            showToast('error', 'API no disponible. Por favor, recarga la p√°gina.');
          }
          return;
        }

        let roleForPortal = detectPortalRoleFromStorageForDashboard();
        const roleFromApi = await syncPortalRoleFromApiForDashboard(token, studentAPI);
        if (roleFromApi) {
          roleForPortal = roleFromApi;
        }
        const requestRole = roleForPortal === 'applicant' ? 'student' : roleForPortal;

        const parsedUserId = userId ? parseInt(userId, 10) : null;
        const scopedStudentId = Number.isInteger(parsedUserId) ? parsedUserId : null;

        const response = await studentAPI.refreshDashboardCache(scopedStudentId, token, requestRole);
          
        if (response.success) {
          if (!silent) {
            showToast('success', response.message || 'Cach√© actualizado correctamente');
          }
            
          if (reloadAfterSuccess) {
            setTimeout(() => {
              window.location.reload();
            }, silent ? 250 : 1500);
          }
        } else {
          if (!silent) {
            showToast('error', response.message || 'Error al actualizar el cach√©');
          }
        }
      } catch (error) {
        console.error('Error al actualizar cach√©:', error);
        if (!silent) {
          const errorMessage = error instanceof Error ? error.message : 'Error al actualizar el cach√© del dashboard';
          showToast('error', errorMessage);
        }
      } finally {
        isRefreshingDashboard = false;
        setTimeout(() => {
          if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = originalHTML;
          }
        }, 100);
      }
    };

    if (refreshBtn) {
      refreshBtn.addEventListener('click', async () => {
        await refreshDashboard({ silent: false, reloadAfterSuccess: true });
      });
    }

    window.addEventListener('focus', () => {
      if (document.hidden) return;
      void refreshDashboard({ silent: true, reloadAfterSuccess: true });
    });

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        void refreshDashboard({ silent: true, reloadAfterSuccess: true });
      }
    });
  });

  function showToast(type: 'success' | 'error', message: string) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const toastIconPath = document.getElementById('toastIconPath');
    
    if (!toast || !toastMessage || !toastIconPath) return;
    
    // Remove previous classes
    toast.classList.remove('success', 'error');
    
    // Add new class
    toast.classList.add(type);
    
    // Update icon based on type
    if (type === 'success') {
      toastIconPath.setAttribute('d', 'M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z');
    } else if (type === 'error') {
      toastIconPath.setAttribute('d', 'M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z');
    }
    
    // Set message
    toastMessage.textContent = message;
    
    // Show toast
    toast.classList.add('show');
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      toast?.classList.remove('show');
    }, 5000);
  }
</script>