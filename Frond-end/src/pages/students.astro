---
import Layout from '../layouts/Layout.astro';

// ================= CONFIG =================
const MAX_SEMESTER = 10;
const SEMESTERS = Array.from({ length: MAX_SEMESTER }, (_, i) => i + 1);

// Las carreras se cargar√°n din√°micamente desde API en el cliente
const careerEntries: Array<[string, string]> = [];
const CAREER_MAP = Object.fromEntries([['', 'Sin Carrera'], ...careerEntries]);

const careerMapJSON = JSON.stringify(CAREER_MAP);
---

<style>
:root {
  --ui-primary: #2D584C;
  --status-pending-bg: #FFEBE6;
  --status-pending-text: #B35F4C;
  --status-current-bg: #EAF4E9;
  --status-current-text: #50784D;
}

body {
  font-family: "Space Grotesk", "Segoe UI", system-ui, sans-serif;
  background-color: #F8F9FA;
    overflow-x: hidden;
}

.badge-pending { background-color: var(--status-pending-bg); color: var(--status-pending-text); }
.badge-current { background-color: var(--status-current-bg); color: var(--status-current-text); }

#filter-menu {
  display: none;
  animation: fadeIn 0.2s ease-out;
}

#filter-menu.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<Layout title="Administraci√≥n de Alumnos">
  <!-- Load StudentAPI globally before any module scripts -->
  <script src="/studentAPI.js" is:inline></script>

<div class="max-w-7xl mx-auto px-3 sm:px-6 py-6 sm:py-10 min-h-screen bg-gradient-to-br from-gray-50 via-white to-[#2E594D]/5 overflow-x-hidden">

    <header class="flex flex-wrap items-center justify-between mb-10 gap-4 bg-white rounded-2xl shadow-lg px-4 sm:px-6 py-4 sm:py-5 overflow-hidden">
        <div class="flex items-start sm:items-center gap-3 sm:gap-4 min-w-0 w-full">
      <div class="p-3 bg-gradient-to-br from-[#2D584C] to-[#1e3d35] rounded-2xl text-white shadow-xl shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
      </div>
            <div class="min-w-0 flex-1">
                <h1 class="text-lg sm:text-3xl font-black text-[#2D584C] tracking-tight leading-tight flex flex-wrap items-center gap-2 sm:gap-3 break-words">
                    <span class="min-w-0 break-words">Estudiantes Registrados</span>
                    <span class="text-[10px] sm:text-xs bg-[#2D584C]/10 text-[#2D584C] px-2 sm:px-3 py-1 rounded-full font-semibold whitespace-nowrap">Gesti√≥n Acad√©mica</span>
        </h1>
                <p class="text-gray-600 text-xs sm:text-sm mt-2 font-medium break-words">Registro y control de alumnos inscritos</p>
      </div>
    </div>
  </header>

  <div class="relative flex items-center gap-2 mb-6">
    <button id="filter-btn" class="flex items-center justify-center p-2.5 sm:px-4 sm:py-2.5 rounded-xl border-2 border-[#2D584C] text-[#2D584C] font-bold hover:bg-[#2D584C] hover:text-white transition shadow-md shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        <span class="hidden sm:inline ml-2 text-sm">Filtros</span>
    </button>

    <div class="relative flex-1 min-w-0">
      <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </span>
      <input id="search" placeholder="Buscar por nombre, CURP o n√∫mero de control..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border-2 border-gray-200 focus:ring-4 focus:ring-[#2D584C]/10 focus:border-[#2D584C] outline-none transition bg-white text-sm shadow-sm" />
    </div>

    <button id="refresh-btn" class="flex items-center gap-2 px-4 py-2.5 rounded-xl border-2 border-green-600 text-green-600 font-bold hover:bg-green-600 hover:text-white transition shadow-md shrink-0" title="Actualizar cach√©">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
        </svg>
        <span class="hidden sm:inline text-sm">Actualizar</span>
    </button>

    <div id="filter-menu" class="absolute top-full left-0 z-50 w-full sm:w-80 mt-2 bg-white rounded-2xl shadow-2xl border border-gray-100 p-6">
      <h3 class="text-gray-800 font-black mb-4 border-b pb-2">Opciones de Filtrado</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Programa Educativo:</label>
          <select id="filter-carrera" class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm outline-none focus:border-[#2D584C] bg-gray-50">
            <option value="">Cargando carreras...</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Nivel Semestral:</label>
          <select id="filter-semestre" class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm outline-none focus:border-[#2D584C] bg-gray-50">
            <option value="">Todos los Semestres</option>
            {SEMESTERS.map(s => <option value={String(s)}>{s}¬∫ Semestre</option>)}
          </select>
        </div>
        <button id="clear-filters" class="w-full mt-2 py-2.5 rounded-xl bg-red-50 text-red-600 font-bold border border-red-100 hover:bg-red-200 transition flex items-center justify-center gap-2 text-xs">
            Limpiar Filtros
        </button>
      </div>
    </div>
  </div>

  <section class="bg-gradient-to-br from-white via-[#2D584C]/5 to-white rounded-2xl shadow-2xl border-2 border-[#2D584C]/20 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gradient-to-r from-[#2D584C] to-[#1e3d35] text-white text-left">
          <tr>
            <th class="px-4 py-4 font-bold uppercase tracking-wider text-xs">N. Control</th>
            <th class="px-4 py-4 font-bold uppercase tracking-wider text-xs">Nombre Completo</th>
            <th class="px-4 py-4 font-bold uppercase tracking-wider text-center text-xs">Sem.</th>
            <th class="px-4 py-4 font-bold uppercase tracking-wider text-xs">Carrera</th>
            <th class="px-3 py-4 font-bold uppercase tracking-wider text-center text-xs">Pendientes</th>
            <th class="px-3 py-4 font-bold uppercase tracking-wider text-center text-xs">Vencidos</th>
            <th class="px-4 py-4 font-bold uppercase tracking-wider text-right text-xs">Adeudo</th>
            <th class="px-4 py-4 font-bold uppercase tracking-wider text-right text-xs">Pagado</th>
          </tr>
        </thead>
        <tbody id="tbody-desktop" class="divide-y divide-gray-100 text-gray-700"></tbody>
      </table>
    </div>

    <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-t border-[#2D584C]/10 flex flex-col sm:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-4">
            <span id="pagination-info" class="text-[11px] font-bold text-[#2D584C] uppercase tracking-widest italic"></span>
            <span id="page-indicator" class="text-xs font-bold text-gray-500">P√°gina <span id="current-page" class="text-[#2D584C]">1</span> de <span id="last-page" class="text-[#2D584C]">1</span></span>
        </div>
        <div id="pagination-controls" class="flex items-center gap-1"></div>
    </div>

    <div id="no-results" class="hidden text-center text-gray-400 py-20 text-lg italic">No hay alumnos que coincidan.</div>
  </section>
</div>

<script is:inline define:vars={{ careerMapJSON }}>
window.__CAREER_MAP = JSON.parse(careerMapJSON);
</script>

<script type="module">
// StudentAPI is loaded globally via public/studentAPI.js
const ITEMS_PER_PAGE = 15;
let currentPage = 1;
let lastPage = 1;
let totalRecords = 0;
let isLoading = false;
let searchTerm = '';
let filters = { carrera: '', semestre: '' };
let searchTimeout = null;

const CAREER_MAP = window.__CAREER_MAP;

// Wait for StudentAPI to be available
async function ensureStudentAPI() {
  let attempts = 0;
  while (!window.StudentAPI && attempts < 50) {
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
  }
  if (!window.StudentAPI) {
    throw new Error('StudentAPI could not be loaded');
  }
}

const filterBtn = document.getElementById('filter-btn');
const filterMenu = document.getElementById('filter-menu');
const searchInput = document.getElementById('search');
const refreshBtn = document.getElementById('refresh-btn');
const filterCarrera = document.getElementById('filter-carrera');
const filterSemestre = document.getElementById('filter-semestre');
const clearFiltersButton = document.getElementById('clear-filters');
const tbodyDesktop = document.getElementById('tbody-desktop'); 
const noResults = document.getElementById('no-results');
const paginationInfo = document.getElementById('pagination-info');
const paginationControls = document.getElementById('pagination-controls');

// Interacci√≥n Men√∫ Filtros
filterBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  filterMenu.classList.toggle('active');
});

document.addEventListener('click', (e) => {
    if (!filterBtn.contains(e.target) && !filterMenu.contains(e.target)) {
        filterMenu.classList.remove('active');
    }
});

function toNumber(value) {
    if (value === null || value === undefined || value === '') return 0;
    const parsed = Number(String(value).replace(/[$,\s]/g, ''));
    return Number.isFinite(parsed) ? parsed : 0;
}

function pickFirst(item, keys) {
    for (const key of keys) {
        if (item?.[key] !== undefined && item?.[key] !== null && item?.[key] !== '') {
            return item[key];
        }
    }
    return null;
}

function normalizeControlNumber(value) {
    const normalized = String(value || '').trim();
    if (!normalized || normalized.toLowerCase() === 'n/a' || normalized === '-') return 'N/A';
    return normalized;
}

function normalizeSemesterValue(value) {
    if (value === null || value === undefined || value === '') return '-';
    const asString = String(value).trim();
    const match = asString.match(/\d+/);
    if (!match) return '-';
    const parsed = Number(match[0]);
    if (!Number.isFinite(parsed) || parsed <= 0) return '-';
    return String(parsed);
}

function getStudentUniqueKey(student) {
    const explicitId = pickFirst(student, ['student_id', 'user_id', 'id_student', 'idUser', 'studentId', 'userId', 'id']);
    if (explicitId !== null && explicitId !== undefined && explicitId !== '') {
        return `id:${String(explicitId).trim()}`;
    }

    const control = normalizeControlNumber(pickFirst(student, ['n_control', 'nControl', 'control_number', 'controlNumber', 'numero_control', 'student_control_number', 'matricula', 'no_control']));
    if (control !== 'N/A') {
        return `control:${control}`;
    }

    return null;
}

function mergeStudentSummaries(students) {
    const grouped = new Map();
    let fallbackIndex = 0;

    for (const student of (Array.isArray(students) ? students : [])) {
        const detectedKey = getStudentUniqueKey(student);
        const key = detectedKey || `row:${fallbackIndex++}`;
        const current = grouped.get(key);

        if (!current) {
            grouped.set(key, { ...student });
            continue;
        }

        const currentControl = normalizeControlNumber(current.n_control);
        const nextControl = normalizeControlNumber(student.n_control);
        if (currentControl === 'N/A' && nextControl !== 'N/A') {
            current.n_control = nextControl;
        }

        if ((!current.career_name || current.career_name === 'N/A') && student.career_name && student.career_name !== 'N/A') {
            current.career_name = student.career_name;
        }

        if ((!current.career_id || String(current.career_id).trim() === '') && student.career_id) {
            current.career_id = student.career_id;
        }

        const currentSemester = normalizeSemesterValue(current.semestre);
        const nextSemester = normalizeSemesterValue(student.semestre);
        if (currentSemester === '-' && nextSemester !== '-') {
            current.semestre = nextSemester;
        }

        current.num_pending = Math.max(toNumber(current.num_pending), toNumber(student.num_pending));
        current.num_expired = Math.max(toNumber(current.num_expired), toNumber(student.num_expired));
        current.total_amount_pending = Math.max(toNumber(current.total_amount_pending), toNumber(student.total_amount_pending));
        current.total_paid = Math.max(toNumber(current.total_paid), toNumber(student.total_paid));
    }

    return Array.from(grouped.values());
}

function extractPaginatedList(response) {
    const payload = response?.data;
    if (!payload) return null;

    const topPage = payload.currentPage ?? payload.current_page ?? 1;
    const topLast = payload.lastPage ?? payload.last_page ?? 1;
    const topTotal = payload.total ?? 0;

    const candidates = [
        payload?.payments,
        payload?.students,
        payload?.items,
        payload?.data?.payments,
        payload?.data?.students,
        payload?.data?.items,
        payload?.data,
        payload
    ];

    for (const candidate of candidates) {
        if (!candidate) continue;

        if (Array.isArray(candidate)) {
            return {
                items: candidate,
                currentPage: topPage,
                lastPage: topLast,
                total: topTotal || candidate.length
            };
        }

        if (Array.isArray(candidate.items)) {
            return {
                items: candidate.items,
                currentPage: candidate.currentPage ?? candidate.current_page ?? topPage,
                lastPage: candidate.lastPage ?? candidate.last_page ?? topLast,
                total: candidate.total ?? topTotal ?? candidate.items.length
            };
        }
    }

    return null;
}

function normalizeStudentSummary(rawStudent) {
    const userData = rawStudent?.user_data || rawStudent?.student || rawStudent?.user || {};
    const careerObj = rawStudent?.career || userData?.career || {};

    const controlNumber = normalizeControlNumber(
        pickFirst(rawStudent, ['n_control', 'nControl', 'control_number', 'controlNumber', 'numero_control', 'student_control_number', 'matricula', 'no_control']) ??
        pickFirst(userData, ['n_control', 'nControl', 'control_number', 'controlNumber', 'numero_control', 'student_control_number', 'matricula', 'no_control']) ??
        ''
    );

    const fullName = String(
        pickFirst(rawStudent, ['fullName', 'full_name', 'student_name', 'name', 'nombre_completo']) ??
        pickFirst(userData, ['fullName', 'full_name', 'student_name', 'name', 'nombre_completo']) ??
        `${rawStudent?.name || userData?.name || ''} ${rawStudent?.lastName || userData?.lastName || userData?.apellido_paterno || ''} ${rawStudent?.secondLastName || userData?.secondLastName || userData?.apellido_materno || ''}`
    ).replace(/\s+/g, ' ').trim();

    const careerId = String(
        pickFirst(rawStudent, ['career_id', 'id_career', 'carrera_id', 'id_carrera']) ??
        pickFirst(userData, ['career_id', 'id_career', 'carrera_id', 'id_carrera']) ??
        careerObj?.id ??
        ''
    ).trim();

    const careerName = String(
        pickFirst(rawStudent, ['career_name', 'careerName', 'nombre_carrera', 'program_name', 'carrera']) ??
        pickFirst(userData, ['career_name', 'careerName', 'nombre_carrera', 'program_name', 'carrera']) ??
        careerObj?.career_name ??
        careerObj?.name ??
        (window.careerMap?.[careerId] || '')
    ).trim();

    const semesterValue = pickFirst(rawStudent, ['semestre', 'semester', 'current_semester']) ??
        pickFirst(userData, ['semestre', 'semester', 'current_semester']);

    return {
        n_control: controlNumber,
        fullName: fullName || 'Sin nombre',
        semestre: normalizeSemesterValue(semesterValue),
        career_id: careerId,
        career_name: careerName || 'N/A',
        num_pending: toNumber(pickFirst(rawStudent, ['num_pending', 'pending_count', 'pendientes', 'pending', 'numPending'])),
        num_expired: toNumber(pickFirst(rawStudent, ['num_expired', 'expired_count', 'overdue_count', 'vencidos', 'expired', 'overdue'])),
        total_amount_pending: toNumber(pickFirst(rawStudent, ['total_amount_pending', 'pending_amount', 'amount_pending', 'adeudo_total', 'debt_amount', 'total_pending', 'amount_due'])),
        total_paid: toNumber(pickFirst(rawStudent, ['total_paid', 'paid_amount', 'amount_paid', 'total_pagado', 'total_paid_amount']))
    };
}

function buildStudentSummariesFromPayments(paymentRows) {
    const groupedByStudent = new Map();

    for (const row of paymentRows) {
        const normalizedBase = normalizeStudentSummary(row);
        const studentId = pickFirst(row, ['student_id', 'user_id', 'id_student', 'idUser']) || normalizedBase.n_control;
        const key = String(studentId || normalizedBase.n_control || normalizedBase.fullName || Math.random());

        if (!groupedByStudent.has(key)) {
            groupedByStudent.set(key, {
                ...normalizedBase,
                num_pending: 0,
                num_expired: 0,
                total_amount_pending: 0,
                total_paid: 0
            });
        }

        const current = groupedByStudent.get(key);
        const amount = toNumber(pickFirst(row, ['amount', 'total', 'amount_total', 'price', 'monto', 'total_amount', 'amount_paid']));
        const status = String(pickFirst(row, ['status', 'payment_status', 'estado']) || '').toLowerCase();
        const dueDate = pickFirst(row, ['due_date', 'dueDate', 'fecha_limite', 'expiration_date']);
        const isPastDue = dueDate ? new Date(dueDate).getTime() < Date.now() : false;
        const isPaid = ['paid', 'pagado', 'completed', 'succeeded', 'success'].some(token => status.includes(token));

        if (isPaid) {
            current.total_paid += amount;
        } else {
            current.num_pending += 1;
            current.total_amount_pending += amount;
            if (isPastDue || ['expired', 'vencido', 'overdue'].some(token => status.includes(token))) {
                current.num_expired += 1;
            }
        }
    }

    return Array.from(groupedByStudent.values());
}

function applyStudentFilters(students) {
    let filteredStudents = Array.isArray(students) ? students : [];

    if (filters.carrera) {
        const selectedCareer = String(filters.carrera).trim();
        const selectedCareerName = (window.careerMap?.[selectedCareer] || '').trim().toLowerCase();

        filteredStudents = filteredStudents.filter(student => {
            const studentCareerId = String(student.career_id || '').trim();
            const studentCareerName = String(student.career_name || '').trim().toLowerCase();
            return (
                studentCareerId === selectedCareer ||
                (selectedCareerName && studentCareerName === selectedCareerName)
            );
        });
    }

    if (filters.semestre) {
        const selectedSemester = String(filters.semestre).trim();
        filteredStudents = filteredStudents.filter(student => String(student.semestre || '').trim() === selectedSemester);
    }

    return filteredStudents;
}

async function fetchStudentsResponse(token, requestOptions) {
    try {
        return await window.StudentAPI.getPaymentStudents(token, requestOptions);
    } catch (primaryError) {
        console.warn('‚ö†Ô∏è /payments/students fall√≥, intentando /payments como fallback:', primaryError);
        return await window.StudentAPI.getAllPayments(token, {
            search: requestOptions.search,
            page: requestOptions.page,
            perPage: requestOptions.perPage,
            forceRefresh: requestOptions.forceRefresh
        });
    }
}

// Cargar estudiantes desde API
async function loadStudents(forceRefresh = false) {
    if (isLoading) return;
    isLoading = true;

    tbodyDesktop.innerHTML = `
        <tr>
            <td colspan="8" class="px-8 py-12 text-center">
                <div class="flex flex-col items-center gap-3">
                    <i class="fas fa-spinner fa-spin text-4xl text-[#2D584C]"></i>
                    <p class="text-gray-600 font-bold">${forceRefresh ? 'Actualizando datos...' : 'Cargando estudiantes...'}</p>
                </div>
            </td>
        </tr>
    `;

    try {
        const token = localStorage.getItem('access_token');
        
        // Obtener rol del userData guardado
        let role = 'financial-staff';
        try {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            if (userData.roles && Array.isArray(userData.roles) && userData.roles.length > 0) {
                role = userData.roles[0];
            } else {
                role = userData.role || userData.type || 'financial-staff';
            }
        } catch (e) {
            console.warn('‚ö†Ô∏è No se pudo obtener el rol, usando financial-staff');
        }
        
        if (!token) {
            showError('No hay sesi√≥n activa. Por favor inicia sesi√≥n.');
            setTimeout(() => window.location.href = '/login', 2000);
            return;
        }

        const requestOptions = {
            search: searchTerm,
            page: currentPage,
            perPage: ITEMS_PER_PAGE,
            forceRefresh: forceRefresh,
            role: role,
            permission: 'view.payments.student.summary'
        };

        const response = await fetchStudentsResponse(token, requestOptions);

        console.log('üì° Respuesta del servidor:', response);
        console.log('üìä Estructura completa:', JSON.stringify(response, null, 2));

        const isResponseOk = response?.success !== false && !!response?.data;

        if (isResponseOk) {
            const extracted = extractPaginatedList(response);

            if (!extracted || !Array.isArray(extracted.items)) {
                showError('Estructura de datos incorrecta del servidor');
                return;
            }

            const normalizedList = extracted.items.map(normalizeStudentSummary);
            const hasSummaryFields = normalizedList.some(student =>
                student.num_pending > 0 || student.num_expired > 0 || student.total_amount_pending > 0 || student.total_paid > 0
            );

            const studentsListRaw = hasSummaryFields
                ? normalizedList
                : buildStudentSummariesFromPayments(extracted.items);

            const studentsList = mergeStudentSummaries(studentsListRaw);

            const filteredStudents = applyStudentFilters(studentsList);

            currentPage = Number(extracted.currentPage || 1);
            lastPage = Number(extracted.lastPage || 1);
            totalRecords = Number(extracted.total || filteredStudents.length);

            renderTable(filteredStudents);
            updatePaginationInfo();
        } else {
            showError('No se pudieron cargar los estudiantes');
        }
    } catch (error) {
        console.error('‚ùå Error al cargar estudiantes:', error);
        showError(error.message || 'Error al cargar los estudiantes');
    } finally {
        isLoading = false;
    }
}

// Renderizar tabla
function renderTable(students) {
    noResults.classList.add('hidden');
    
    if (!students || students.length === 0) {
        tbodyDesktop.innerHTML = `
            <tr>
                <td colspan="8" class="px-8 py-12 text-center">
                    <div class="flex flex-col items-center gap-3">
                        <i class="fas fa-inbox text-5xl text-gray-300"></i>
                        <p class="text-gray-500 font-bold">No se encontraron estudiantes</p>
                        <p class="text-gray-400 text-sm">Intenta ajustar los filtros de b√∫squeda</p>
                    </div>
                </td>
            </tr>
        `;
        noResults.classList.remove('hidden');
        return;
    }

    tbodyDesktop.innerHTML = students.map(s => {
        const hasPending = Number(s.num_pending || 0) > 0;
        const hasExpired = Number(s.num_expired || 0) > 0;
        const pendingAmount = Number(s.total_amount_pending || 0);
        const paidAmount = Number(s.total_paid || 0);
        const semesterDisplay = normalizeSemesterValue(s.semestre);

        return `
            <tr class="hover:bg-[#2D584C]/5 transition border-b border-gray-50">
                <td class="px-4 py-4 font-mono text-xs font-bold text-gray-600">${s.n_control || 'N/A'}</td>
                <td class="px-4 py-4 font-bold text-gray-900 text-sm">${s.fullName || 'Sin nombre'}</td>
                <td class="px-4 py-4 text-center font-medium">${semesterDisplay === '-' ? '‚Äî' : `${semesterDisplay}¬∫`}</td>
                <td class="px-4 py-4 text-gray-600 text-xs">${s.career_name || 'N/A'}</td>
                <td class="px-3 py-4 text-center">
                    <span class="inline-flex items-center justify-center min-w-[24px] h-6 px-2 rounded-full text-xs font-black ${
                        hasPending ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-400'
                    }">${s.num_pending || 0}</span>
                </td>
                <td class="px-3 py-4 text-center">
                    <span class="inline-flex items-center justify-center min-w-[24px] h-6 px-2 rounded-full text-xs font-black ${
                        hasExpired ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-400'
                    }">${s.num_expired || 0}</span>
                </td>
                <td class="px-4 py-4 text-right font-black ${pendingAmount > 0 ? 'text-red-600' : 'text-gray-400'}">$${pendingAmount.toLocaleString('es-MX', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                <td class="px-4 py-4 text-right font-black ${paidAmount > 0 ? 'text-emerald-600' : 'text-gray-400'}">$${paidAmount.toLocaleString('es-MX', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            </tr>
        `;
    }).join('');
}

// Mostrar errores
function showError(message) {
    tbodyDesktop.innerHTML = `
        <tr>
            <td colspan="8" class="px-8 py-12 text-center">
                <div class="flex flex-col items-center gap-3">
                    <i class="fas fa-exclamation-triangle text-5xl text-red-400"></i>
                    <p class="text-red-600 font-bold">${message}</p>
                    <button onclick="location.reload()" class="mt-2 px-4 py-2 bg-[#2D584C] text-white rounded-lg hover:bg-[#1e3d35] transition">
                        Reintentar
                    </button>
                </div>
            </td>
        </tr>
    `;
}

// Actualizar informaci√≥n de paginaci√≥n
function updatePaginationInfo() {
    const startItem = totalRecords === 0 ? 0 : (currentPage - 1) * ITEMS_PER_PAGE + 1;
    const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalRecords);
    
    paginationInfo.innerText = `Mostrando ${startItem}-${endItem} de ${totalRecords} estudiantes`;
    document.getElementById('current-page').textContent = currentPage;
    document.getElementById('last-page').textContent = lastPage;
    
    renderPagination();
}

// Renderizar paginaci√≥n
function renderPagination() {
    paginationControls.innerHTML = '';
    if (lastPage <= 1) return;

    const createBtn = (label, targetPage, disabled = false, active = false) => {
        const btn = document.createElement('button');
        btn.innerText = label;
        btn.disabled = disabled;
        btn.className = `min-w-[32px] h-8 px-2 rounded-lg text-xs font-black transition-all ${
            active ? 'bg-[#2D584C] text-white shadow-md' : 
            disabled ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:bg-gray-200'
        }`;
        if (!disabled) btn.onclick = () => { currentPage = targetPage; loadStudents(); window.scrollTo({top:0, behavior:'smooth'}); };
        return btn;
    };

    paginationControls.appendChild(createBtn('‚Üê', currentPage - 1, currentPage === 1));

    for (let i = 1; i <= lastPage; i++) {
        if (i === 1 || i === lastPage || (i >= currentPage - 1 && i <= currentPage + 1)) {
            paginationControls.appendChild(createBtn(i, i, false, currentPage === i));
        } else if (i === currentPage - 2 || i === currentPage + 2) {
            const span = document.createElement('span');
            span.innerText = '...';
            span.className = 'text-gray-400 px-1';
            paginationControls.appendChild(span);
        }
    }

    paginationControls.appendChild(createBtn('‚Üí', currentPage + 1, currentPage === lastPage));
}

// Eventos
searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        searchTerm = searchInput.value.trim();
        currentPage = 1;
        loadStudents();
    }, 500);
});

refreshBtn.addEventListener('click', () => {
    const icon = refreshBtn.querySelector('svg');
    icon.style.animation = 'spin 1s linear infinite';
    loadStudents(true).finally(() => {
        icon.style.animation = '';
    });
});

filterCarrera.addEventListener('change', () => { 
    console.log('üéì Cambi√≥ filtro de carrera a:', filterCarrera.value);
    filters.carrera = filterCarrera.value; 
    currentPage = 1; 
    loadStudents(); 
});

filterSemestre.addEventListener('change', () => { 
    console.log('üìö Cambi√≥ filtro de semestre a:', filterSemestre.value);
    filters.semestre = filterSemestre.value; 
    currentPage = 1; 
    loadStudents(); 
});

clearFiltersButton.addEventListener('click', () => {
    searchInput.value = '';
    searchTerm = '';
    filterCarrera.value = '';
    filterSemestre.value = '';
    filters = { carrera: '', semestre: '' };
    currentPage = 1;
    loadStudents();
    filterMenu.classList.remove('active');
});

// CSS para animaci√≥n de spin
const style = document.createElement('style');
style.textContent = `
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
`;
document.head.appendChild(style);

const AUTO_REFRESH_INTERVAL_MS = 180000;
let autoRefreshTimer = null;
let autoRefreshFocusHandler = null;
let autoRefreshVisibilityHandler = null;

function triggerAutoRefresh() {
    if (isLoading || document.hidden) return;
    loadStudents(true).catch((err) => console.warn('‚ö†Ô∏è Auto-refresh students:', err?.message || err));
}

function setupAutoRefresh() {
    if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    autoRefreshTimer = setInterval(triggerAutoRefresh, AUTO_REFRESH_INTERVAL_MS);

    if (!autoRefreshFocusHandler) {
        autoRefreshFocusHandler = () => triggerAutoRefresh();
        window.addEventListener('focus', autoRefreshFocusHandler);
    }

    if (!autoRefreshVisibilityHandler) {
        autoRefreshVisibilityHandler = () => {
            if (!document.hidden) triggerAutoRefresh();
        };
        document.addEventListener('visibilitychange', autoRefreshVisibilityHandler);
    }
}

// Cargar carreras desde API
async function loadCareers() {
    try {
        const token = localStorage.getItem('access_token');
        
        // Obtener rol del userData guardado
        let role = 'financial-staff';
        try {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            if (userData.roles && Array.isArray(userData.roles) && userData.roles.length > 0) {
                role = userData.roles[0];
            } else {
                role = userData.role || userData.type || 'financial-staff';
            }
        } catch (e) {
            console.warn('‚ö†Ô∏è No se pudo obtener el rol para carreras');
        }
        
        if (!token) {
            console.warn('‚ö†Ô∏è No hay token para cargar carreras');
            return;
        }

        const response = await window.StudentAPI.getCareers(token, { role, permission: 'view.careers' });
        console.log('üì° Respuesta de carreras:', response);

        if (response.success && response.data && response.data.careers) {
            const careers = response.data.careers;
            console.log(`‚úÖ Carreras cargadas: ${careers.length}`);
            console.log('üìã Carreras:', careers.map(c => `${c.id}: ${c.career_name}`).join(', '));

            // Guardar mapa de carrera para referencia
            window.careerMap = {};
            careers.forEach(career => {
                window.careerMap[career.id] = career.career_name;
            });
            console.log('üìå Mapa de carreras guardado:', window.careerMap);

            // Llenar el select con las opciones
            const careerSelect = document.getElementById('filter-carrera');
            careerSelect.innerHTML = '<option value="">Todos los Programas</option>';

            careers.forEach(career => {
                const option = document.createElement('option');
                option.value = career.id;  // ID como valor
                option.textContent = career.career_name;  // Nombre como texto mostrado
                option.dataset.careerName = career.career_name;  // Guardar nombre como atributo
                careerSelect.appendChild(option);
            });

            console.log('‚úÖ Select de carreras poblado correctamente');
        } else {
            console.warn('‚ö†Ô∏è Respuesta de carreras sin estructura v√°lida');
        }
    } catch (error) {
        console.error('‚ùå Error al cargar carreras:', error);
        document.getElementById('filter-carrera').innerHTML = '<option value="">Error al cargar carreras</option>';
    }
}

// Cargar estudiantes al iniciar (esperar a que StudentAPI est√© disponible)
ensureStudentAPI()
  .then(() => loadCareers())
    .then(() => {
        setupAutoRefresh();
        return loadStudents();
    })
  .catch(err => console.error('‚ùå Error al inicializar:', err));

window.addEventListener('beforeunload', () => {
        if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
        }
}, { once: true });
</script>

</Layout>