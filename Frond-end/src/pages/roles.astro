---
import Layout from '../layouts/Layout.astro';

// No cargar usuarios en SSR - se cargar√°n del lado del cliente con autenticaci√≥n
const API_BASE_URL = (import.meta.env.PUBLIC_API_BASE_URL ?? (() => { throw new Error('Falta PUBLIC_API_BASE_URL'); })()).replace(/\/$/, '');
---

<Layout title="Gesti√≥n de Personal | CBTA 71">
    <script is:inline src="/js/xlsx.min.js"></script>
    <script is:inline define:vars={{ API_BASE_URL }}>
        // Declarar tipos para propiedades personalizadas
        window.__API_BASE_URL__ = API_BASE_URL;
        window.__adminAPILoaded = false;
        window.AdminAPI = null;
    </script>
    
    <style is:global>
        [x-cloak] { display: none !important; }
        
        /* Colores institucionales */
        .bg-institucional { background-color: #2E594D; }
        .text-institucional { color: #2E594D; }
        .border-institucional { border-color: #2E594D; }
        .hover-institucional:hover { background-color: #234238; }
        
        .input-institucional:focus {
            outline: none;
            border-color: #2E594D;
            box-shadow: 0 0 0 3px rgba(46, 89, 77, 0.1);
        }
        
        /* Tabla de estad√≠sticas */
        table.stats-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        @media (min-width: 640px) {
            table.stats-table {
                table-layout: fixed;
            }

            table.stats-table td {
                width: 33.333%;
            }
        }
        
        .dropzone-active {
            border-color: #2E594D;
            background-color: rgba(46, 89, 77, 0.05);
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @media (max-width: 639px) {
            table.stats-table,
            table.stats-table tbody,
            table.stats-table tr,
            table.stats-table td {
                display: block;
                width: 100% !important;
            }

            table.stats-table tr {
                border: 0;
            }

            table.stats-table td {
                border-bottom: 1px solid #bfdbfe;
            }

            table.stats-table td:last-child {
                border-bottom: 0;
            }
        }
    </style>

    <div x-data="rolesData" class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-8">
        
        <template x-teleport="body">
            <div x-show="notification.show" x-cloak
                 x-transition:enter="transition ease-out duration-300"
                 class="fixed top-5 right-5 z-[100] p-4 rounded-xl shadow-2xl text-white font-bold"
                 :class="notification.type === 'success' ? 'bg-institucional' : 'bg-red-600'">
                <span x-text="notification.message"></span>
            </div>
        </template>

        <div class="mb-8">
            <!-- Loading state -->
            <div x-show="isLoadingUsers" class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                <div class="flex items-center gap-3">
                    <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <div>
                        <h3 class="font-bold text-blue-900">‚è≥ Cargando usuarios...</h3>
                        <p class="text-sm text-blue-700">Conectando con la API</p>
                    </div>
                </div>
            </div>
            
            <!-- Error state -->
            <div x-show="apiError && !isLoadingUsers" class="mb-4 p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="flex-1">
                        <h3 class="font-bold text-red-900">‚ùå Sin Autenticaci√≥n</h3>
                        <p class="text-sm text-red-700">No has iniciado sesi√≥n. Redirigiendo al login...</p>
                        <p class="text-xs text-red-600 mt-1">Abre la consola (F12) para ver detalles</p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-institucional rounded-2xl flex items-center justify-center shadow-lg">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-institucional mb-1">Gesti√≥n de Usuarios</h1>
                        <p class="text-[#2E594D] font-medium opacity-80">Administraci√≥n completa de usuarios, roles y permisos</p>
                    </div>
                </div>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="flex flex-wrap gap-2 md:gap-3">
                <button @click="openPanelForAdd()" 
                        class="px-3 md:px-4 py-2 bg-institucional text-white text-sm md:text-base font-semibold rounded-lg hover-institucional transition-all flex items-center gap-2 shadow-md">
                    ‚ûï Nuevo Usuario
                </button>
                <button @click="openStudentPanel()" 
                        class="px-3 md:px-4 py-2 bg-blue-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2">
                    üéì Asociar Estudiante
                </button>
                <button @click="openRolesPanel()" 
                        class="px-3 md:px-4 py-2 bg-purple-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-purple-700 transition-all flex items-center gap-2">
                    üîê Gestionar Roles
                </button>
                <button @click="openPermissionsPanel()"
                        class="px-3 md:px-4 py-2 bg-indigo-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-indigo-700 transition-all flex items-center gap-2">
                    üîë Permisos
                </button>
                <div class="relative" x-data="{ showImportMenu: false }">
                    <button @click="showImportMenu = !showImportMenu" 
                            class="px-3 md:px-4 py-2 bg-emerald-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-emerald-700 transition-all flex items-center gap-2">
                        üì• Importar
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div x-show="showImportMenu" @click.away="showImportMenu = false" 
                         class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                        <button @click="openImportModal(); showImportMenu = false" 
                                class="w-full text-left px-4 py-3 hover:bg-emerald-50 transition-colors flex items-center gap-2">
                            <span class="text-2xl">üë•</span>
                            <div>
                                <div class="font-semibold text-gray-800">Usuarios Completos</div>
                                <div class="text-xs text-gray-500">Importar usuarios con todos sus datos</div>
                            </div>
                        </button>
                        <button @click="openImportStudentsModal(); showImportMenu = false" 
                                class="w-full text-left px-4 py-3 hover:bg-purple-50 transition-colors flex items-center gap-2 border-t">
                            <span class="text-2xl">üéì</span>
                            <div>
                                <div class="font-semibold text-gray-800">Detalles de Estudiantes</div>
                                <div class="text-xs text-gray-500">Solo datos acad√©micos (CURP requerido)</div>
                            </div>
                        </button>
                    </div>
                </div>
                <button @click="openCareerModal()"
                        class="px-3 md:px-4 py-2 bg-teal-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-teal-700 transition-all flex items-center gap-2">
                    üß≠ Nueva Carrera
                </button>
                <button @click="promoteStudents()" 
                        class="px-3 md:px-4 py-2 bg-pink-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-pink-700 transition-all flex items-center gap-2">
                    üìà Promocionar Estudiantes
                </button>
                <button @click="loadUsers(localStorage.getItem('access_token'))" 
                        class="px-3 md:px-4 py-2 bg-gray-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-gray-700 transition-all flex items-center gap-2">
                    üîÑ Actualizar
                </button>
            </div>
        </div>

        <!-- Filtros y B√∫squeda -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input
                        type="text"
                        x-model="searchTerm"
                        placeholder="üîç Buscar por nombre, email o CURP..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-institucional focus:border-transparent"
                    />
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <label class="text-sm font-medium">Estado:</label>
                    <select
                        x-model="filterStatus"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-institucional"
                    >
                        <option value="">Todos</option>
                        <option value="activo">Activo</option>
                        <option value="baja-temporal">Baja Temporal</option>
                        <option value="baja">Baja</option>
                        <option value="eliminado">Eliminado</option>
                    </select>

                    <label class="text-sm font-medium">Rol:</label>
                    <select
                        x-model="filterRole"
                        @change="handleRoleFilterChange()"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-institucional"
                    >
                        <option value="">Todos</option>
                        <template x-for="role in roleFilterOptions" :key="role.value">
                            <option :value="role.value" x-text="role.label"></option>
                        </template>
                    </select>

                </div>
            </div>
            <!-- Acciones Masivas -->
            <div x-show="selectedUsers.length > 0" class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
                    <span class="text-sm font-medium text-blue-900">
                        <span x-text="selectedUsers.length"></span> usuario(s) seleccionado(s)
                    </span>
                    <div class="flex flex-wrap gap-2">
                        <button @click="openRolesPanel()" class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 transition">
                            üîê Roles
                        </button>
                        <button @click="openPermissionsPanel()" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                            üîë Permisos
                        </button>
                        <button @click="activateUsers()" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                            ‚úÖ Activar
                        </button>
                        <button @click="bulkTemporaryDisable()" class="px-3 py-1 text-sm bg-yellow-600 text-white rounded hover:bg-yellow-700 transition">
                            ‚è∏Ô∏è Baja Temporal
                        </button>
                        <button @click="bulkDisable()" class="px-3 py-1 text-sm bg-orange-600 text-white rounded hover:bg-orange-700 transition">
                            üö´ Dar de Baja
                        </button>
                        <button @click="bulkDelete()" class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-4 flex items-center gap-2">
            <button
                type="button"
                @click="adminPanelView = 'info'"
                class="px-4 py-2 text-sm font-semibold rounded-lg border transition-colors"
                :class="adminPanelView === 'info' ? 'bg-[#2E594D] text-white border-[#2E594D]' : 'bg-white text-[#2E594D] border-[#2E594D]/30 hover:bg-[#2E594D]/5'">
                Informaci√≥n
            </button>
            <button
                type="button"
                @click="adminPanelView = 'table'"
                class="px-4 py-2 text-sm font-semibold rounded-lg border transition-colors"
                :class="adminPanelView === 'table' ? 'bg-[#2E594D] text-white border-[#2E594D]' : 'bg-white text-[#2E594D] border-[#2E594D]/30 hover:bg-[#2E594D]/5'">
                Tabla
            </button>
        </div>

        <div x-show="adminPanelView === 'info'" x-cloak class="bg-white rounded-xl shadow-sm border border-blue-200 mb-6 overflow-hidden">
            <table class="stats-table">
                <tbody>
                    <tr class="divide-x divide-blue-200">
                        <td class="p-4 sm:p-6 hover:bg-blue-50 transition-colors">
                            <div class="flex items-center gap-3 sm:gap-4">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-[11px] sm:text-xs text-slate-500 font-medium uppercase tracking-wide">Total Usuarios</p>
                                    <p class="text-xl sm:text-2xl font-bold text-slate-800" x-text="stats.total"></p>
                                </div>
                            </div>
                        </td>
                        <td class="p-4 sm:p-6 hover:bg-blue-50 transition-colors">
                            <div class="flex items-center gap-3 sm:gap-4">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-emerald-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-[11px] sm:text-xs text-slate-500 font-medium uppercase tracking-wide">Usuarios Activos</p>
                                    <p class="text-xl sm:text-2xl font-bold text-green-600" x-text="stats.active"></p>
                                </div>
                            </div>
                        </td>
                        <td class="p-4 sm:p-6 hover:bg-blue-50 transition-colors">
                            <div class="flex items-center gap-3 sm:gap-4">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-[11px] sm:text-xs text-blue-600 font-medium uppercase tracking-wide">Con rol asignado</p>
                                    <p class="text-xl sm:text-2xl font-bold text-purple-600" x-text="stats.withRole"></p>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div x-show="adminPanelView === 'info'" x-cloak class="bg-white rounded-xl shadow-sm border border-blue-200 mb-6 overflow-hidden">
            <div class="px-4 py-2.5 border-b border-blue-100 bg-institucional/5 flex items-center justify-between">
                <h3 class="text-sm font-bold text-[#2E594D]">Resumen de usuarios</h3>
                <div class="flex items-center gap-2">
                    <button
                        type="button"
                        class="text-[11px] px-2 py-1 rounded-md border border-blue-200 text-blue-700 bg-white hover:bg-blue-50 transition-colors"
                        @click="summaryDetailsExpanded = !summaryDetailsExpanded"
                        x-text="summaryDetailsExpanded ? 'Ocultar detalle' : 'Desplegar detalle'">
                    </button>
                    <span class="text-[11px] text-slate-500 font-medium">Cards peque√±as</span>
                </div>
            </div>

            <div class="p-3 sm:p-3.5 space-y-2">
                <div class="overflow-x-auto rounded-lg border border-blue-100">
                    <table class="w-full min-w-[660px] border-collapse">
                        <thead>
                            <tr class="bg-slate-50 text-[10px] uppercase tracking-wide">
                                <th class="px-2 py-1.5 text-left font-semibold text-blue-700 border-b border-blue-100">Con rol</th>
                                <th class="px-2 py-1.5 text-left font-semibold text-slate-600 border-b border-blue-100">Sin rol</th>
                                <th class="px-2 py-1.5 text-left font-semibold text-emerald-700 border-b border-blue-100">Con acad√©mico</th>
                                <th class="px-2 py-1.5 text-left font-semibold text-amber-700 border-b border-blue-100">Sin acad√©mico</th>
                                <th class="px-2 py-1.5 text-left font-semibold text-orange-700 border-b border-blue-100">Estudiantes sin detalle acad√©mico</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="text-lg font-bold leading-none">
                                <td class="px-2 py-1.5 text-blue-700 bg-blue-50 border-r border-blue-100" x-text="stats.withRole"></td>
                                <td class="px-2 py-1.5 text-slate-700 bg-slate-50 border-r border-blue-100" x-text="stats.withoutRole"></td>
                                <td class="px-2 py-1.5 text-emerald-700 bg-emerald-50 border-r border-blue-100" x-text="stats.withAcademicDetail"></td>
                                <td class="px-2 py-1.5 text-amber-700 bg-amber-50 border-r border-blue-100" x-text="stats.withoutAcademicDetailWithRole"></td>
                                <td class="px-2 py-1.5 text-orange-700 bg-orange-50" x-text="stats.studentLikeWithoutAcademicDetail"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div x-show="summaryDetailsExpanded" x-transition>
                    <p class="text-[11px] font-bold uppercase tracking-wider text-slate-500 mb-1.5">Por rol</p>
                    <div class="overflow-x-auto rounded-lg border border-[#2E594D]/20" x-show="stats.roleCountEntries.length">
                        <table class="w-full min-w-[620px] border-collapse">
                            <tbody>
                                <template x-for="(roleRow, rowIndex) in chunkEntries(stats.roleCountEntries, 4)" :key="`role-row-${rowIndex}`">
                                    <tr class="border-b border-[#2E594D]/15 last:border-b-0">
                                        <template x-for="(roleEntry, colIndex) in roleRow" :key="`role-${rowIndex}-${colIndex}-${roleEntry.key}`">
                                            <td class="px-2 py-1.5 align-top border-r border-[#2E594D]/10 last:border-r-0 bg-[#2E594D]/5">
                                                <p class="text-[11px] font-semibold text-[#2E594D] truncate" x-text="getRoleDisplayName(roleEntry.key)"></p>
                                                <p class="text-base font-bold text-[#2E594D]" x-text="roleEntry.count"></p>
                                            </td>
                                        </template>
                                        <template x-if="roleRow.length < 4">
                                            <td class="bg-white" :colspan="4 - roleRow.length"></td>
                                        </template>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div x-show="!stats.roleCountEntries.length" class="rounded-lg border border-slate-200 bg-slate-50 px-2.5 py-2 text-xs text-slate-500">
                        Sin roles asignados
                    </div>
                </div>

                <div x-show="summaryDetailsExpanded" x-transition>
                    <p class="text-[11px] font-bold uppercase tracking-wider text-slate-500 mb-1.5">Por estatus</p>
                    <div class="overflow-x-auto rounded-lg border border-slate-200" x-show="stats.statusCountEntries.length">
                        <table class="w-full min-w-[620px] border-collapse">
                            <tbody>
                                <template x-for="(statusRow, rowIndex) in chunkEntries(stats.statusCountEntries, 4)" :key="`status-row-${rowIndex}`">
                                    <tr class="border-b border-slate-200 last:border-b-0">
                                        <template x-for="(statusEntry, colIndex) in statusRow" :key="`status-${rowIndex}-${colIndex}-${statusEntry.key}`">
                                            <td class="px-2 py-1.5 align-top border-r border-slate-200 last:border-r-0"
                                                :class="statusEntry.key === 'activo' ? 'bg-emerald-50' : statusEntry.key === 'baja-temporal' ? 'bg-amber-50' : statusEntry.key === 'baja' ? 'bg-orange-50' : statusEntry.key === 'eliminado' ? 'bg-slate-50' : 'bg-red-50'">
                                                <p class="text-[11px] font-semibold"
                                                   :class="statusEntry.key === 'activo' ? 'text-emerald-700' : statusEntry.key === 'baja-temporal' ? 'text-amber-700' : statusEntry.key === 'baja' ? 'text-orange-700' : statusEntry.key === 'eliminado' ? 'text-slate-700' : 'text-red-700'"
                                                   x-text="statusLabel(statusEntry.key)"></p>
                                                <p class="text-base font-bold text-slate-800" x-text="statusEntry.count"></p>
                                            </td>
                                        </template>
                                        <template x-if="statusRow.length < 4">
                                            <td class="bg-white" :colspan="4 - statusRow.length"></td>
                                        </template>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div x-show="!stats.statusCountEntries.length" class="rounded-lg border border-slate-200 bg-slate-50 px-2.5 py-2 text-xs text-slate-500">
                        Sin estatus disponibles
                    </div>
                </div>
            </div>
        </div>

        <div x-show="adminPanelView === 'table'" x-cloak class="bg-gradient-to-br from-[#2E594D]/5 via-white to-[#2E594D]/10 rounded-2xl shadow-lg border border-[#2E594D]/20 overflow-hidden">
            <div class="overflow-x-auto table-responsive">
                <table class="w-full min-w-[980px]">
                    <thead class="bg-institucional border-b-4 border-[#234238]">
                        <tr>
                            <th class="px-6 py-4 text-left">
                                <input
                                    type="checkbox"
                                    @change="toggleSelectAll()"
                                    :checked="selectedUsers.length === filteredUsers.length && filteredUsers.length > 0"
                                    class="rounded border-gray-300 w-5 h-5 cursor-pointer accent-[#2E594D]"
                                />
                            </th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-white uppercase tracking-wider">Usuario</th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-white uppercase tracking-wider">Contacto</th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-white uppercase tracking-wider">CURP</th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-white uppercase tracking-wider">Roles</th>
                            <th class="px-6 py-4 text-left text-sm font-bold text-white uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-4 text-right text-sm font-bold text-white uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-[#2E594D]/20">
                        <template x-for="user in filteredUsers" :key="user.id">
                            <tr class="hover:bg-[#2E594D]/10 transition-all duration-200 even:bg-white odd:bg-[#2E594D]/5">
                                <td class="px-6 py-4">
                                    <input
                                        type="checkbox"
                                        @change="toggleUserSelection(user.id)"
                                        :checked="selectedUsers.includes(user.id)"
                                        class="rounded border-gray-300 w-5 h-5 cursor-pointer accent-[#2E594D]"
                                    />
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-institucional flex items-center justify-center text-white font-bold text-sm shadow-md">
                                            <span x-text="(user.fullName || user.name || 'Usuario').split(' ').map(n => n.charAt(0)).slice(0, 2).join('').toUpperCase()"></span>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-[#2E594D]" x-text="user.fullName || `${user.name || ''} ${user.last_name || ''}`.trim() || 'Sin nombre'"></div>
                                            <div class="text-xs text-[#2E594D] opacity-70" x-text="user.createdAtHuman || 'Reciente'"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-[#2E594D] font-medium" x-text="user.email"></div>
                                    <div class="text-xs text-[#2E594D] opacity-60" x-text="user.id ? `ID: ${user.id}` : ''"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-xs font-mono text-[#2E594D] bg-[#2E594D]/10 px-3 py-2 rounded-lg inline-block border border-[#2E594D]/30" x-text="user.curp || 'N/A'"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-3 py-2 rounded-full text-xs font-semibold inline-flex items-center gap-2 bg-[#2E594D]/20 text-[#2E594D] border border-[#2E594D]/30 shadow-sm">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                        </svg>
                                        <span x-text="getVisibleRoleText(user)"></span>
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold" :class="statusClass(user.status)">
                                        <span x-text="statusLabel(user.status)"></span>
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex justify-end items-center gap-2">
                                        <button @click="viewUserDetails(user.id)" class="p-2 rounded-lg border border-blue-200 text-blue-700 hover:bg-blue-50" title="Ver detalles">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                        </button>
                                        <button
                                            @click="openStudentPanel(user.id)"
                                            x-show="!user.n_control"
                                            class="p-2 rounded-lg border border-emerald-200 text-emerald-700 hover:bg-emerald-50"
                                            title="Asociar estudiante">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                                            </svg>
                                        </button>
                                        <button
                                            @click="confirmDeleteUser(user)"
                                            class="p-2 rounded-lg border border-red-200 text-red-700 hover:bg-red-50"
                                            title="Eliminar">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <div x-show="isPanelOpen" x-cloak class="fixed inset-0 z-[110] flex items-center justify-center p-4">
            <div x-show="isPanelOpen" x-transition.opacity @click="closePanel()" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
            <div x-show="isPanelOpen" 
                 x-transition:enter="transition ease-out duration-300 transform" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-200 transform" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                 class="relative bg-white rounded-2xl p-6 sm:p-8 shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <button @click="closePanel()" class="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div class="mb-6">
                    <h2 class="text-2xl font-black text-institucional mb-2" x-text="isEditing ? 'Editar Colaborador' : 'Registrar Administrador/Personal'"></h2>
                    <p class="text-xs text-slate-500 flex items-start gap-2">
                        <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <span>La contrase√±a se genera autom√°ticamente por el sistema y se enviar√° al email del usuario.</span>
                    </p>
                </div>
                <form @submit.prevent="saveUser()" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nombre(s)</label>
                            <input x-model="newUser.name" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Apellidos</label>
                            <input x-model="newUser.last_name" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Email</label>
                        <input x-model="newUser.email" type="email" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:col-span-2">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tel√©fono</label>
                            <input x-model="newUser.phone_number" type="tel" placeholder="5512345678" :required="!isEditing" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Fecha Nacimiento</label>
                            <input x-model="newUser.birthdate" type="date" :required="!isEditing" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:col-span-2">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">G√©nero</label>
                            <select x-model="newUser.gender" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                                <option value="hombre">Hombre</option>
                                <option value="mujer">Mujer</option>
                            </select>
                        </div>
                        <div></div>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">CURP</label>
                        <input x-model="newUser.curp" type="text" pattern="[A-Z0-9]{18}" maxlength="18" placeholder="PELJ000512HDFRPN09" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional uppercase">
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Calle y N√∫mero</label>
                        <input x-model="newUser.address[0]" type="text" :required="!isEditing" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:col-span-2">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Colonia</label>
                            <input x-model="newUser.address[1]" type="text" :required="!isEditing" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Ciudad/Estado</label>
                            <input x-model="newUser.address[2]" type="text" :required="!isEditing" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tipo de Sangre</label>
                        <select x-model="newUser.blood_type" :required="!isEditing" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            <option value="">Seleccionar tipo de sangre</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Asignar Rol</label>
                        <select x-model="newUser.role" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional font-semibold">
                            <option value="">üö´ Sin rol</option>
                            <option value="admin">Administrador</option>
                            <option value="financial-staff">Personal de pagos</option>
                        </select>
                    </div>

                    <!-- SECCI√ìN DE DATOS DE ESTUDIANTE (solo si ya est√° asociado como estudiante) -->
                    <template x-if="isEditing && hasStudentDetails">
                    <div class="sm:col-span-2 pt-6 border-t-2 border-slate-200">
                        <h3 class="text-lg font-bold text-institucional mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C6.5 6.253 3 9.2 3 12s3.5 5.747 9 5.747m0-13c5.5 0 9-2.948 9-5.747m0 13c5.5 0 9-2.948 9-5.747M12 6.253v13"/>
                            </svg>
                            Datos de Estudiante
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Matr√≠cula (N. Control)</label>
                                <input x-model="newUser.studentDetail.n_control" type="text" placeholder="2023001" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Carrera</label>
                                <select x-model="newUser.studentDetail.career_id" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                                    <option value="">Seleccionar carrera...</option>
                                    <template x-for="career in careers" :key="career.id">
                                        <option :value="career.id" x-text="career.name || career.career_name"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Semestre</label>
                                <input x-model.number="newUser.studentDetail.semestre" type="number" min="1" max="12" placeholder="1" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Grupo</label>
                                <input x-model="newUser.studentDetail.group" type="text" maxlength="10" placeholder="A" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Taller</label>
                                <input x-model="newUser.studentDetail.workshop" type="text" placeholder="Taller 1" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            </div>
                        </div>
                    </div>
                    </template>

                    <div class="flex flex-col sm:flex-row gap-3 pt-6 sm:col-span-2">
                        <button type="button" @click="closePanel()" :disabled="isSaving" class="flex-1 py-3 font-bold text-slate-600 hover:bg-slate-100 rounded-xl disabled:opacity-50 border-2 border-slate-200 transition-colors">Cancelar</button>
                        <button type="submit" :disabled="isSaving" class="flex-1 py-3 bg-institucional text-white font-bold rounded-xl shadow-lg hover-institucional disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            <span x-show="!isSaving" x-text="isEditing ? 'Actualizar Datos' : 'Registrar Ahora'"></span>
                            <span x-show="isSaving" class="flex items-center justify-center gap-2">
                                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Guardando...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <template x-teleport="body">
            <div x-show="isDeleting" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-2 sm:p-4">
                <div @click="isDeleting = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-3 sm:p-8 w-full max-w-sm text-center shadow-2xl">
                    <div class="w-12 sm:w-16 h-12 sm:h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3 sm:mb-4">
                        <svg class="w-6 sm:w-8 h-6 sm:h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h3 class="text-lg sm:text-xl font-bold text-slate-800 mb-2">¬øEliminar usuario?</h3>
                    <p class="text-slate-500 text-xs sm:text-sm mb-4 sm:mb-6" x-text="`Se eliminar√° permanentemente a ${userToDeleteName}`"></p>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                        <button @click="isDeleting = false" class="flex-1 py-2.5 sm:py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors text-sm sm:text-base">Cancelar</button>
                        <button @click="deleteUser(userToDeleteId)" class="flex-1 py-2.5 sm:py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition-colors text-sm sm:text-base">Eliminar</button>
                    </div>
                </div>
            </div>
        </template>

        <template x-teleport="body">
            <div x-show="isImporting" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-2 sm:p-4">
                <div @click="isImporting = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-3 sm:p-8 w-full max-w-2xl shadow-2xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
                    <h3 class="text-lg sm:text-2xl font-bold text-slate-800 mb-1 sm:mb-2">Importar Usuarios desde Excel</h3>
                    <p class="text-slate-500 text-xs sm:text-sm mb-4 sm:mb-6">Carga un archivo Excel con los datos de m√∫ltiples usuarios para registrarlos masivamente</p>
                    
                    <div @dragover.prevent="isDragging = true" 
                         @dragleave.prevent="isDragging = false"
                         @drop.prevent="handleFileDrop($event)"
                         :class="isDragging ? 'dropzone-active' : ''"
                         class="border-2 border-dashed border-slate-300 rounded-xl p-4 sm:p-8 text-center transition-all cursor-pointer hover:border-institucional"
                         @click="$refs.fileInput.click()">
                        <input type="file" x-ref="fileInput" @change="handleFileSelect($event)" accept=".xlsx,.xls" class="hidden">
                        <svg class="w-12 sm:w-16 h-12 sm:h-16 mx-auto text-slate-400 mb-2 sm:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-slate-700 font-semibold mb-1 sm:mb-2 text-sm sm:text-base">Arrastra tu archivo Excel aqu√≠</p>
                        <p class="text-slate-500 text-xs sm:text-sm mb-2 sm:mb-4">o haz clic para seleccionar</p>
                        <p class="text-xs text-slate-400">Formatos: .xlsx, .xls</p>
                    </div>

                    <div x-show="selectedFile" class="mt-3 sm:mt-4 p-2 sm:p-4 bg-slate-50 rounded-lg flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3">
                        <svg class="w-6 sm:w-8 h-6 sm:h-8 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-slate-800 text-xs sm:text-sm truncate" x-text="selectedFile?.name"></p>
                            <p class="text-xs text-slate-500" x-text="selectedFile ? `${(selectedFile.size / 1024).toFixed(2)} KB` : ''"></p>
                        </div>
                        <button @click="selectedFile = null; importedData = []" class="p-2 text-slate-400 hover:text-red-500 flex-shrink-0">
                            <svg class="w-4 sm:w-5 h-4 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div x-show="importedData.length > 0" class="mt-3 sm:mt-4 p-2 sm:p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-xs sm:text-sm text-blue-800">
                            <span class="font-bold" x-text="importedData.length"></span> usuario(s) detectado(s) en el archivo
                        </p>
                    </div>

                    <div class="mt-4 sm:mt-6 p-2 sm:p-4 bg-amber-50 border border-amber-200 rounded-lg">
                        <p class="text-xs sm:text-sm font-semibold text-amber-900 mb-2">üìã Columnas requeridas:</p>
                        <div class="text-xs text-amber-700 font-mono bg-white p-2 sm:p-3 rounded overflow-x-auto space-y-1">
                            <div>1. name | 2. last_name | 3. email</div>
                            <div>4. phone_number | 5. birthdate | 6. gender</div>
                            <div>7. curp | 8. street | 9. city</div>
                            <div>10. state | 11. zip_code | 12. stripe_id</div>
                            <div>13. blood_type | 14. register_date</div>
                            <div>15. status | 16. career_id | 17. n_control</div>
                            <div>18. semestre | 19. group | 20. workshop</div>
                        </div>
                        <p class="text-xs text-amber-800 mt-2">
                            üí° <strong>Nota:</strong> Password se genera autom√°ticamente
                        </p>
                        <button @click="downloadTemplate()" class="mt-2 text-xs text-institucional hover:underline font-semibold flex items-center gap-1">
                            ‚¨áÔ∏è Descargar plantilla
                        </button>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 mt-4 sm:mt-6">
                        <button @click="closeImportModal()" class="flex-1 py-2.5 sm:py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors text-sm sm:text-base">Cancelar</button>
                        <button @click="processImport()" :disabled="!selectedFile || isSaving" class="flex-1 py-2.5 sm:py-3 bg-institucional hover-institucional text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base">
                            <span x-show="!isSaving">Importar Usuarios</span>
                            <span x-show="isSaving">Importando...</span>
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Modal de Importaci√≥n de Estudiantes -->
        <template x-teleport="body">
            <div x-show="isImportingStudents" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-2 sm:p-4">
                <div @click="closeImportStudentsModal()" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-3 sm:p-8 w-full max-w-2xl shadow-2xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
                    <h3 class="text-lg sm:text-2xl font-bold text-slate-800 mb-1 sm:mb-2">üìö Importar Detalles de Estudiantes</h3>
                    <p class="text-slate-500 text-xs sm:text-sm mb-4 sm:mb-6">Carga un archivo Excel con los detalles acad√©micos de estudiantes existentes</p>

                    <div x-show="importStudentsError" class="mb-2 sm:mb-4 p-2 sm:p-3 bg-red-50 border border-red-200 rounded-lg text-xs sm:text-sm text-red-700">
                        <span x-text="importStudentsError"></span>
                    </div>
                    <div x-show="importStudentsErrorDetails.length" class="mb-2 sm:mb-4 p-2 sm:p-3 bg-red-50 border border-red-200 rounded-lg text-xs text-red-700 space-y-1 max-h-32 overflow-y-auto">
                        <template x-for="(err, idx) in importStudentsErrorDetails" :key="idx">
                            <div class="font-mono" x-text="err"></div>
                        </template>
                    </div>
                    
                    <div @dragover.prevent="isDragging = true" 
                         @dragleave.prevent="isDragging = false"
                         @drop.prevent="handleFileDrop($event)"
                         :class="isDragging ? 'dropzone-active' : ''"
                         class="border-2 border-dashed border-slate-300 rounded-xl p-4 sm:p-8 text-center transition-all cursor-pointer hover:border-institucional"
                         @click="$refs.fileInputStudents.click()">
                        <input type="file" x-ref="fileInputStudents" @change="handleFileSelect($event)" accept=".xlsx,.xls" class="hidden">
                        <svg class="w-12 sm:w-16 h-12 sm:h-16 mx-auto text-slate-400 mb-2 sm:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-slate-700 font-semibold mb-1 sm:mb-2 text-sm sm:text-base">Arrastra tu archivo Excel aqu√≠</p>
                        <p class="text-slate-500 text-xs sm:text-sm mb-2 sm:mb-4">o haz clic para seleccionar</p>
                        <p class="text-xs text-slate-400">Formatos: .xlsx, .xls</p>
                    </div>

                    <div x-show="selectedFile" class="mt-3 sm:mt-4 p-2 sm:p-4 bg-slate-50 rounded-lg flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3">
                        <svg class="w-6 sm:w-8 h-6 sm:h-8 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-slate-800 text-xs sm:text-sm truncate" x-text="selectedFile?.name"></p>
                            <p class="text-xs text-slate-500" x-text="selectedFile ? `${(selectedFile.size / 1024).toFixed(2)} KB` : ''"></p>
                        </div>
                        <button @click="selectedFile = null" class="p-2 text-slate-400 hover:text-red-500 flex-shrink-0">
                            <svg class="w-4 sm:w-5 h-4 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="mt-4 sm:mt-6 p-2 sm:p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <p class="text-xs sm:text-sm font-semibold text-purple-900 mb-2">üìã Columnas requeridas:</p>
                        <div class="text-xs text-purple-700 font-mono bg-white p-2 sm:p-2 rounded break-all whitespace-normal">
                            curp | career_id | n_control | semestre | group | workshop
                        </div>
                        <div class="mt-2 sm:mt-3 space-y-1 text-xs text-purple-800">
                            <p>‚ö†Ô∏è <strong>Importante:</strong></p>
                            <ul class="list-disc list-inside pl-2 space-y-0.5 text-xs">
                                <li>CURP debe existir</li>
                                <li>career_id: n√∫mero entero</li>
                                <li>n_control: texto</li>
                                <li>semestre: 1-12</li>
                                <li>group/workshop: opcional</li>
                            </ul>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 mt-4 sm:mt-6">
                        <button @click="closeImportStudentsModal()" class="flex-1 py-2.5 sm:py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors text-sm sm:text-base">
                            Cancelar
                        </button>
                        <button @click="processImportStudents()" :disabled="!selectedFile || isSaving" class="flex-1 py-2.5 sm:py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base">
                            <span x-show="!isSaving">Importar Estudiantes</span>
                            <span x-show="isSaving">Importando...</span>
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Modal de Gesti√≥n de Estudiante -->
        <template x-teleport="body">
            <div x-show="showStudentModal" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-2 sm:p-4">
                <div @click="showStudentModal = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-3 sm:p-8 w-full max-w-2xl shadow-2xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
                    <h3 class="text-lg sm:text-2xl font-bold text-slate-800 mb-1 sm:mb-2">
                        <span x-show="!hasStudentDetails">üéì Asociar Detalles de Estudiante</span>
                        <span x-show="hasStudentDetails">‚úèÔ∏è Editar Detalles de Estudiante</span>
                    </h3>
                    <p class="text-slate-500 text-xs sm:text-sm mb-4 sm:mb-6">
                        <span x-show="!hasStudentDetails">Asignar informaci√≥n acad√©mica al usuario seleccionado</span>
                        <span x-show="hasStudentDetails">Actualizar carrera, grupo y taller del estudiante</span>
                    </p>
                    
                    <!-- Datos del usuario seleccionado -->
                    <div x-show="currentStudentUser" class="bg-slate-50 p-2 sm:p-4 rounded-lg mb-4 sm:mb-6 border border-slate-200">
                        <p class="text-xs sm:text-sm text-slate-600"><strong>Usuario:</strong> <span class="truncate" x-text="(currentStudentUser?.nombre || currentStudentUser?.name || 'N/A') + ' ' + (currentStudentUser?.apellidoP || currentStudentUser?.apellidoPaterno || currentStudentUser?.apellido_paterno || '')"></span></p>
                        <p class="text-xs sm:text-sm text-slate-600"><strong>Email:</strong> <span class="truncate" x-text="currentStudentUser?.correo || currentStudentUser?.email || 'N/A'"></span></p>
                        <p class="text-xs sm:text-sm text-slate-600"><strong>ID:</strong> <span x-text="studentDetails.user_id"></span></p>
                    </div>
                    
                    <form @submit.prevent="saveStudentDetails()" class="space-y-3 sm:space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Carrera *</label>
                                <div class="flex items-start gap-2">
                                    <div class="flex-1">
                                        <select x-model="studentDetails.career_id" required
                                                class="w-full p-2 sm:p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional text-sm sm:text-base">
                                            <option value="">Selecciona una carrera</option>
                                            <template x-for="career in careers" :key="career.id">
                                                <option :value="career.id" x-text="`ID ${career.id} - ${career.career_name}`"></option>
                                            </template>
                                        </select>
                                        <p x-show="isLoadingCareers" class="text-xs text-slate-500 mt-1">Cargando carreras...</p>
                                        <p x-show="!isLoadingCareers && !careers.length" class="text-xs text-slate-500 mt-1">No hay carreras.</p>
                                    </div>
                                    <button type="button" @click="loadCareers(true)"
                                            class="px-2 sm:px-3 py-2 text-xs font-semibold text-teal-700 hover:text-teal-800 hover:bg-teal-50 rounded-lg border border-teal-200 flex-shrink-0">
                                        üîÑ
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">
                                    N¬∫ Control *
                                    <span x-show="hasStudentDetails" class="text-xs font-normal text-amber-600 ml-1">(No editable)</span>
                                </label>
                                <input x-model="studentDetails.n_control" type="text" required 
                                       :readonly="hasStudentDetails"
                                       :class="hasStudentDetails ? 'bg-slate-100 cursor-not-allowed opacity-60' : 'bg-slate-50'"
                                       class="w-full p-2 sm:p-3 border border-slate-200 rounded-xl input-institucional text-sm sm:text-base">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">
                                    Semestre *
                                    <span x-show="hasStudentDetails" class="text-xs font-normal text-amber-600 ml-1">(Promocion)</span>
                                </label>
                                <input x-model="studentDetails.semestre" type="number" required min="1" max="12" 
                                       :readonly="hasStudentDetails"
                                       :class="hasStudentDetails ? 'bg-slate-100 cursor-not-allowed opacity-60' : 'bg-slate-50'"
                                       class="w-full p-2 sm:p-3 border border-slate-200 rounded-xl input-institucional text-sm sm:text-base">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Grupo</label>
                                <input x-model="studentDetails.group" type="text" maxlength="10" 
                                       class="w-full p-2 sm:p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional text-sm sm:text-base">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Taller</label>
                                <input x-model="studentDetails.workshop" type="text" 
                                       class="w-full p-2 sm:p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional text-sm sm:text-base">
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 mt-4 sm:mt-6">
                            <button type="button" @click="showStudentModal = false" class="flex-1 py-2.5 sm:py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors text-sm sm:text-base">
                                Cancelar
                            </button>
                            <button type="submit" :disabled="isSaving" class="flex-1 py-2.5 sm:py-3 bg-institucional hover-institucional text-white rounded-lg font-semibold transition-colors disabled:opacity-50 text-sm sm:text-base">
                                <span x-show="!isSaving && !studentDetails.n_control">Asociar Estudiante</span>
                                <span x-show="!isSaving && studentDetails.n_control">Actualizar Detalles</span>
                                <span x-show="isSaving && !studentDetails.n_control">Asociando...</span>
                                <span x-show="isSaving && studentDetails.n_control">Actualizando...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </template>

        <!-- Modal de Creaci√≥n/Edici√≥n de Carrera -->
        <template x-teleport="body">
            <div x-show="showCareerModal" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-2 sm:p-4">
                <div @click="closeCareerModal()" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-3 sm:p-8 w-full max-w-lg shadow-2xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
                    <h3 class="text-lg sm:text-2xl font-bold text-slate-800 mb-1 sm:mb-2" x-text="careerEditingId ? '‚úèÔ∏è Editar carrera' : 'üß≠ Crear nueva carrera'"></h3>
                    <p class="text-slate-500 text-xs sm:text-sm mb-4 sm:mb-6" x-text="careerEditingId ? 'Modifica el nombre de la carrera.' : 'Registra una carrera acad√©mica disponible para los estudiantes.'"></p>

                    <form @submit.prevent="saveCareer()" class="space-y-3 sm:space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nombre de la carrera *</label>
                            <input x-model="careerForm.career_name" type="text" required maxlength="100"
                                   class="w-full p-2 sm:p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional text-sm sm:text-base"
                                   placeholder="Ej. Ofim√°tica">
                            <p x-show="careerError" class="text-xs sm:text-sm text-red-600 mt-2" x-text="careerError"></p>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 pt-2">
                            <button type="button" @click="closeCareerModal()" class="flex-1 py-2.5 sm:py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors text-sm sm:text-base">
                                Cancelar
                            </button>
                            <button type="submit" :disabled="isSavingCareer"
                                    class="flex-1 py-2.5 sm:py-3 bg-teal-600 hover:bg-teal-700 text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base">
                                <span x-show="!isSavingCareer" x-text="careerEditingId ? 'Actualizar carrera' : 'Crear carrera'"></span>
                                <span x-show="isSavingCareer" x-text="careerEditingId ? 'Actualizando...' : 'Creando...'"></span>
                            </button>
                        </div>
                    </form>

                    <div class="mt-4 sm:mt-6 p-3 sm:p-4 bg-slate-50 border border-slate-200 rounded-lg">
                        <div class="flex items-center justify-between mb-2 sm:mb-3">
                            <h4 class="text-xs sm:text-sm font-semibold text-slate-800">Carreras existentes (ID)</h4>
                            <button type="button" @click="loadCareers(false)" class="text-xs font-semibold text-teal-700 hover:text-teal-800">
                                ‚Üª Refr.
                            </button>
                        </div>
                        <div x-show="isLoadingCareers" class="text-xs sm:text-sm text-slate-600">Cargando carreras...</div>
                        <div x-show="!isLoadingCareers && careers.length" class="max-h-40 sm:max-h-56 overflow-y-auto divide-y divide-slate-200 text-xs sm:text-sm">
                            <template x-for="career in careers" :key="career.id">
                                <div class="py-2 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-3">
                                    <div class="flex flex-col">
                                        <span class="font-mono text-slate-600 text-xs" x-text="`ID ${career.id}`"></span>
                                        <span class="font-semibold text-slate-800" x-text="career.career_name"></span>
                                    </div>
                                    <div class="flex gap-2 w-full sm:w-auto">
                                        <button type="button"
                                                @click="startEditCareer(career)"
                                                class="flex-1 sm:flex-none px-2 py-1 text-xs font-semibold text-blue-700 hover:text-blue-800 hover:bg-blue-50 rounded">
                                            Editar
                                        </button>
                                        <button type="button"
                                                @click="deleteCareer(career.id)"
                                                :disabled="careerDeletingId === career.id"
                                                class="flex-1 sm:flex-none px-2 py-1 text-xs font-semibold text-red-700 hover:text-red-800 hover:bg-red-50 rounded disabled:opacity-50">
                                            <span x-show="careerDeletingId !== career.id">Eliminar</span>
                                            <span x-show="careerDeletingId === career.id">Borr...</span>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <p x-show="!isLoadingCareers && !careers.length" class="text-xs sm:text-sm text-slate-500">No hay carreras registradas.</p>
                    </div>
                </div>
            </div>
        </template>

        <!-- Modal de Gesti√≥n de Roles -->
        <template x-teleport="body">
            <div x-show="showRolesModal" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-2 sm:p-4">
                <div @click="showRolesModal = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-4 sm:p-8 w-full max-w-3xl shadow-2xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl sm:text-2xl font-bold text-slate-800 mb-1 sm:mb-2">üîê Gestionar Roles</h3>
                    <p class="text-slate-500 text-xs sm:text-sm mb-4 sm:mb-6">
                        Agregar o eliminar roles para <span class="font-bold" x-text="selectedUsers.length"></span> usuario(s) seleccionado(s)
                    </p>
                    
                    <form @submit.prevent="updateRoles()" class="space-y-6">
                        
                        <!-- Mensaje de ayuda -->
                        <div class="p-3 sm:p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                            <div class="flex items-start gap-2 sm:gap-3">
                                <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                                <div class="flex-1">
                                    <p class="text-xs sm:text-sm font-bold text-blue-900 mb-1">üí° Instrucciones</p>
                                    <p class="text-xs sm:text-sm text-blue-800">
                                        <strong>Debes seleccionar al menos un rol</strong> para agregar O eliminar antes de actualizar.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alerta cuando no hay roles seleccionados -->
                        <div x-show="rolesToAdd.length === 0 && rolesToRemove.length === 0" 
                             class="p-3 sm:p-4 bg-amber-50 border-2 border-amber-400 rounded-xl">
                            <div class="flex items-start gap-2 sm:gap-3">
                                <svg class="w-5 sm:w-6 h-5 sm:h-6 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <div class="flex-1">
                                    <p class="font-bold text-amber-900 mb-1 text-sm sm:text-base">‚ö†Ô∏è No hay roles seleccionados</p>
                                    <p class="text-xs sm:text-sm text-amber-800">
                                        Marca al menos un checkbox en <strong>"Agregar Roles"</strong> O <strong>"Eliminar Roles"</strong> para continuar.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-6">
                            <!-- Agregar Roles -->
                            <div class="p-3 sm:p-4 bg-green-50 border-2 border-green-300 rounded-xl shadow-lg">
                                <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                                    <h4 class="font-black text-green-900 text-base sm:text-lg flex items-center gap-1 sm:gap-2">
                                        <span class="text-xl sm:text-2xl">‚ûï</span> <span>Agregar Roles</span>
                                    </h4>
                                    <span class="px-2 sm:px-3 py-1 bg-green-200 text-green-900 rounded-full text-xs font-bold" 
                                          x-text="rolesToAdd.length + ' sel.'"></span>
                                </div>
                                <div class="space-y-1 max-h-40 sm:max-h-60 overflow-y-auto">
                                    <!-- Opci√≥n "Sin rol" -->
                                    <label class="flex items-center gap-2 p-2 hover:bg-green-100 rounded-lg cursor-pointer transition-colors border-b border-green-200">
                                        <input type="checkbox" value="__NO_ROLE__" 
                                               x-model="rolesToAdd"
                                               class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                        <span class="text-sm font-medium text-green-800">üö´ Sin rol</span>
                                    </label>
                                    
                                    <template x-for="role in availableRoles" :key="role.id">
                                        <label class="flex items-center gap-2 p-2 hover:bg-green-100 rounded-lg cursor-pointer transition-colors">
                                            <input type="checkbox" :value="role.name" 
                                                   x-model="rolesToAdd"
                                                   class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                            <span class="text-sm font-medium text-green-800" x-text="role.displayName || role.name"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- Eliminar Roles -->
                            <div class="p-3 sm:p-4 bg-red-50 border-2 border-red-300 rounded-xl shadow-lg">
                                <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                                    <h4 class="font-black text-red-900 text-base sm:text-lg flex items-center gap-1 sm:gap-2">
                                        <span class="text-xl sm:text-2xl">‚ûñ</span> <span>Eliminar Roles</span>
                                    </h4>
                                    <span class="px-2 sm:px-3 py-1 bg-red-200 text-red-900 rounded-full text-xs font-bold" 
                                          x-text="rolesToRemove.length + ' sel.'"></span>
                                </div>
                                <div class="space-y-1 max-h-40 sm:max-h-60 overflow-y-auto">
                                    <template x-for="role in availableRoles" :key="role.id">
                                        <label class="flex items-center gap-2 p-2 hover:bg-red-100 rounded-lg cursor-pointer transition-colors text-xs sm:text-sm">
                                            <input type="checkbox" :value="role.name" 
                                                   x-model="rolesToRemove"
                                                   class="w-4 h-4 text-red-600 rounded focus:ring-red-500">
                                            <span class="font-medium text-red-800" x-text="role.displayName || role.name"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‚ö†Ô∏è Advertencia de conflictos -->
                        <div x-show="rolesToAdd.filter(r => rolesToRemove.includes(r)).length > 0" 
                             class="p-4 bg-amber-50 border-2 border-amber-400 rounded-xl">
                            <div class="flex items-start gap-3">
                                <svg class="w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <div class="flex-1">
                                    <p class="font-bold text-amber-900 mb-1">‚ö†Ô∏è Conflicto Detectado</p>
                                    <p class="text-sm text-amber-800 mb-2">
                                        Los siguientes roles est√°n marcados para <strong>agregar Y eliminar</strong>:
                                    </p>
                                    <div class="flex flex-wrap gap-2">
                                        <template x-for="role in rolesToAdd.filter(r => rolesToRemove.includes(r))" :key="role">
                                            <span class="px-3 py-1 bg-amber-200 text-amber-900 rounded-full text-xs font-bold" x-text="role || '(Sin rol)'"></span>
                                        </template>
                                    </div>
                                    <p class="text-xs text-amber-700 mt-2">
                                        üí° <strong>Soluci√≥n:</strong> Desmarca el rol de una de las dos columnas
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                            <button type="button" @click="showRolesModal = false" class="flex-1 py-2.5 sm:py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors text-sm sm:text-base">
                                Cancelar
                            </button>
                            <button type="submit" :disabled="isSaving || (rolesToAdd.length === 0 && rolesToRemove.length === 0)" 
                                    class="flex-1 py-2.5 sm:py-3 bg-institucional hover-institucional text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed relative group text-sm sm:text-base"
                                    :title="(rolesToAdd.length === 0 && rolesToRemove.length === 0) ? 'Selecciona al menos un rol para continuar' : 'Actualizar roles de usuarios seleccionados'">
                                <span x-show="!isSaving && (rolesToAdd.length > 0 || rolesToRemove.length > 0)">‚úÖ Actualizar Roles</span>
                                <span x-show="!isSaving && rolesToAdd.length === 0 && rolesToRemove.length === 0">‚ö†Ô∏è Selecciona roles</span>
                                <span x-show="isSaving">‚è≥ Actualizando...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </template>

        <!-- Modal de Gesti√≥n de Permisos -->
        <template x-teleport="body">
            <div x-show="showPermissionsModal" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-2 sm:p-4">
                <div @click="showPermissionsModal = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-4 sm:p-8 w-full max-w-3xl shadow-2xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl sm:text-2xl font-bold text-slate-800 mb-1 sm:mb-2">üîë Gestionar Permisos</h3>
                    <p class="text-slate-500 text-xs sm:text-sm mb-4 sm:mb-6">
                        Agregar o eliminar permisos para <span class="font-bold" x-text="selectedUsers.length"></span> usuario(s) seleccionado(s)
                    </p>
                    
                    <form @submit.prevent="updatePermissions()" class="space-y-4 sm:space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-6">
                            <!-- Agregar Permisos -->
                            <div class="p-3 sm:p-4 bg-blue-50 border-2 border-blue-300 rounded-xl shadow-lg">
                                <h4 class="font-black text-blue-900 mb-3 text-base sm:text-lg flex items-center gap-2">
                                    <span class="text-xl sm:text-2xl">‚ûï</span> <span>Agregar Permisos</span>
                                </h4>
                                <div x-show="permissionsAvailableToAdd.length === 0" class="text-xs sm:text-sm text-blue-600 italic py-2">
                                    Los usuarios seleccionados ya tienen todos los permisos disponibles.
                                </div>
                                <div class="space-y-1 max-h-40 sm:max-h-60 overflow-y-auto">
                                    <template x-if="permissionsAvailableToAdd && permissionsAvailableToAdd.length > 0">
                                        <template x-for="permission in permissionsAvailableToAdd" :key="permission.name">
                                            <label class="flex items-center gap-2 p-2 hover:bg-blue-100 rounded-lg cursor-pointer transition-colors text-xs sm:text-sm">
                                                <input type="checkbox" 
                                                       :value="permission.name"
                                                       x-model="permissionsToAdd"
                                                       class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                                <span class="font-medium text-blue-800">
                                                    <span x-show="permission.displayName" x-text="permission.displayName"></span>
                                                    <span x-show="!permission.displayName" x-text="permission.name"></span>
                                                </span>
                                            </label>
                                        </template>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- Eliminar Permisos -->
                            <div class="p-3 sm:p-4 bg-orange-50 border-2 border-orange-300 rounded-xl shadow-lg">
                                <h4 class="font-black text-orange-900 mb-3 text-base sm:text-lg flex items-center gap-2">
                                    <span class="text-xl sm:text-2xl">‚ûñ</span> <span>Eliminar Permisos</span>
                                </h4>
                                <div x-show="permissionsAvailableToRemove.length === 0" class="text-xs sm:text-sm text-orange-600 italic py-2">
                                    Los usuarios seleccionados no tienen permisos para eliminar.
                                </div>
                                <div class="space-y-1 max-h-40 sm:max-h-60 overflow-y-auto">
                                    <template x-if="permissionsAvailableToRemove && permissionsAvailableToRemove.length > 0">
                                        <template x-for="permission in permissionsAvailableToRemove" :key="permission.name">
                                            <label class="flex items-center gap-2 p-2 hover:bg-orange-100 rounded-lg cursor-pointer transition-colors text-xs sm:text-sm">
                                                <input type="checkbox"
                                                       :value="permission.name"
                                                       x-model="permissionsToRemove"
                                                       class="w-4 h-4 text-orange-600 rounded focus:ring-orange-500">
                                                <span class="font-medium text-orange-800">
                                                    <span x-show="permission.displayName" x-text="permission.displayName"></span>
                                                    <span x-show="!permission.displayName" x-text="permission.name"></span>
                                                </span>
                                            </label>
                                        </template>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                            <button type="button" @click="showPermissionsModal = false" class="flex-1 py-2.5 sm:py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors text-sm sm:text-base">
                                Cancelar
                            </button>
                            <button type="submit" :disabled="isSaving || (permissionsToAdd.length === 0 && permissionsToRemove.length === 0)" 
                                    class="flex-1 py-2.5 sm:py-3 bg-institucional hover-institucional text-white rounded-lg font-semibold transition-colors disabled:opacity-50 text-sm sm:text-base">
                                <span x-show="!isSaving">‚úÖ Actualizar Permisos</span>
                                <span x-show="isSaving">‚è≥ Actualizando...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </template>

        <!-- Modal de Importaci√≥n de Usuarios -->
        <template x-teleport="body">
            <div x-show="showImportModal" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-4">
                <div @click="!isImporting && closeImportModal()" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-8 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">üì• Importar Usuarios</h3>
                    <p class="text-slate-500 text-sm mb-6">
                        Carga un archivo Excel (.xlsx) con los datos de los usuarios
                    </p>
                    
                    <!-- Resumen de importaci√≥n exitosa -->
                    <template x-if="importResult && !importError">
                        <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-xl">
                            <h4 class="font-bold text-green-900 mb-3">‚úì Importaci√≥n Completada</h4>
                            <div class="space-y-2 text-sm text-green-800">
                                <div class="flex justify-between">
                                    <span>Total de filas recibidas:</span>
                                    <span class="font-semibold" x-text="importResult.summary?.total_rows_received || importResult.total_rows_received || '0'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Filas procesadas:</span>
                                    <span class="font-semibold" x-text="importResult.summary?.rows_processed || importResult.rows_processed || '0'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Filas insertadas:</span>
                                    <span class="font-semibold" x-text="importResult.summary?.rows_inserted || importResult.rows_inserted || '0'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Filas fallidas:</span>
                                    <span class="font-semibold" x-text="importResult.summary?.rows_failed || importResult.rows_failed || '0'"></span>
                                </div>
                                <div class="flex justify-between pt-2 border-t border-green-200">
                                    <span>Tasa de √©xito:</span>
                                    <span class="font-semibold" x-text="(importResult.summary?.success_rate || importResult.success_rate || 0).toFixed(2) + '%'"></span>
                                </div>
                            </div>

                            <!-- Mostrar errores si los hay -->
                            <template x-if="importResult.errors || importResult.summary?.errors">
                                <div x-show="(importResult.errors?.total_errors || importResult.summary?.errors?.total_errors || 0) > 0" class="mt-4 pt-4 border-t border-green-200">
                                    <h5 class="font-bold text-red-900 mb-2">‚ö†Ô∏è Errores Encontrados</h5>
                                    <div class="space-y-2 max-h-40 overflow-y-auto">
                                        <template x-for="error in (importResult.errors?.row_errors || importResult.summary?.errors?.row_errors || []).slice(0, 5)" :key="error.row_number">
                                            <div class="p-2 bg-red-100 rounded text-sm text-red-800">
                                                <strong x-text="`Fila ${error.row_number}:`"></strong>
                                                <span x-text="error.message"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Error en la importaci√≥n -->
                    <template x-if="importError">
                        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl">
                            <h4 class="font-bold text-red-900 mb-3">‚ùå Error en la Importaci√≥n</h4>
                            <p class="text-sm text-red-800 mb-3" x-text="importError.message"></p>
                            
                            <template x-if="importError.hasDetails && importError.errors">
                                <div class="mt-3 p-2 bg-red-100 rounded text-sm text-red-800 max-h-32 overflow-y-auto">
                                    <template x-for="(messages, field) in importError.errors" :key="field">
                                        <div class="mb-2">
                                            <strong x-text="`${field}:`"></strong>
                                            <ul class="ml-4 mt-1">
                                                <template x-for="message in (Array.isArray(messages) ? messages : [messages])" :key="message">
                                                    <li class="text-xs" x-text="`‚Ä¢ ${message}`"></li>
                                                </template>
                                            </ul>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Formulario de carga -->
                    <template x-if="!importResult && !importError">
                        <form @submit.prevent="importUsersFromFile()" class="space-y-6">
                            <!-- Input de archivo -->
                            <div class="p-4 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 hover:border-institucional transition-colors">
                                <label class="cursor-pointer block">
                                    <div class="flex items-center justify-center gap-3">
                                        <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <div class="text-center">
                                            <p class="font-semibold text-slate-700"
                                               x-text="importFile ? `Archivo: ${importFile.name}` : 'Selecciona un archivo Excel'">
                                            </p>
                                            <p class="text-xs text-slate-500">(.xlsx o .xls)</p>
                                        </div>
                                    </div>
                                    <input type="file" 
                                           @change="handleFileSelect"
                                           accept=".xlsx,.xls"
                                           class="hidden"
                                           :disabled="isImporting">
                                </label>
                            </div>

                            <!-- Informaci√≥n sobre formato del archivo -->
                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                                <h4 class="font-bold text-blue-900 mb-2 text-sm">üìã Columnas Requeridas (en orden):</h4>
                                <div class="grid grid-cols-2 gap-2 text-xs text-blue-800">
                                    <div>1. Nombre</div>
                                    <div>2. Apellidos</div>
                                    <div>3. Email</div>
                                    <div>4. Tel√©fono (+52)</div>
                                    <div>5. Fecha nacimiento (YYYY-MM-DD)</div>
                                    <div>6. G√©nero</div>
                                    <div>7. CURP</div>
                                    <div>8. Calle</div>
                                    <div>9. Ciudad</div>
                                    <div>10. Estado</div>
                                    <div>11. C√≥digo postal</div>
                                    <div>12. Tipo de sangre</div>
                                    <div>13. Fecha registro (YYYY-MM-DD)</div>
                                    <div>14. Estado</div>
                                    <div>15. Career ID</div>
                                    <div>16. N. Control</div>
                                    <div>17. Semestre</div>
                                    <div>18. Grupo</div>
                                    <div>19. Taller</div>
                                </div>
                            </div>

                            <div class="flex gap-3">
                                <button type="button" 
                                        @click="closeImportModal()" 
                                        :disabled="isImporting"
                                        class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors disabled:opacity-50">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                        :disabled="isImporting || !importFile"
                                        class="flex-1 py-3 bg-institucional hover-institucional text-white rounded-lg font-semibold transition-colors disabled:opacity-50">
                                    <span x-show="!isImporting">Importar Usuarios</span>
                                    <span x-show="isImporting">Importando...</span>
                                </button>
                            </div>
                        </form>
                    </template>

                    <!-- Bot√≥n de cierre para resultados -->
                    <template x-if="importResult || importError">
                        <div class="flex gap-3">
                            <button type="button" 
                                    @click="closeImportModal()"
                                    class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors">
                                Cerrar
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- Modal de Error Global -->
        <template x-teleport="body">
            <div x-show="showErrorModal" x-cloak class="fixed inset-0 z-[150] flex items-center justify-center p-4">
                <div @click="showErrorModal = false" class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
                <div class="relative bg-white rounded-2xl p-8 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
                    <!-- Icono de error -->
                    <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full">
                        <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>

                    <!-- T√≠tulo -->
                    <h3 class="text-2xl font-bold text-center text-red-900 mb-4" x-text="errorModalTitle"></h3>
                    
                    <!-- Mensaje principal -->
                    <div class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                        <p class="text-red-800 font-medium" x-text="errorModalMessage"></p>
                    </div>

                    <!-- Detalles t√©cnicos: OCULTOS POR SEGURIDAD -->
                    <!-- No mostrar informaci√≥n de infraestructura (endpoints, servidores, etc.) -->

                    <!-- Bot√≥n de cerrar -->
                    <div class="flex justify-center">
                        <button @click="showErrorModal = false" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors shadow-lg">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <template x-teleport="body">
            <div x-show="userDetailsPreview.show" x-cloak class="fixed inset-0 z-[140] flex items-center justify-center p-4">
                <div @click="userDetailsPreview.show = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
                <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-hidden border border-slate-200">
                    <div class="p-4 sm:p-5 border-b border-slate-200 flex items-start justify-between gap-3">
                        <div>
                            <h3 class="text-lg sm:text-xl font-bold text-[#2E594D]">Detalles del usuario seleccionado</h3>
                            <p class="text-xs sm:text-sm text-slate-500" x-text="userDetailsPreview.email || 'Sin correo' "></p>
                        </div>
                        <button type="button" @click="userDetailsPreview.show = false" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                    </div>

                    <div class="p-4 sm:p-5 grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto max-h-[65vh]">
                        <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
                            <div class="text-xs font-semibold text-slate-500 uppercase mb-2">Roles</div>
                            <div x-show="userDetailsPreview.roles.length" class="flex flex-wrap gap-2">
                                <template x-for="(roleItem, idx) in userDetailsPreview.roles" :key="idx">
                                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-[#2E594D]/10 text-[#2E594D] border border-[#2E594D]/20" x-text="getRoleDisplayName(roleItem)"></span>
                                </template>
                            </div>
                            <p x-show="!userDetailsPreview.roles.length" class="text-sm text-slate-500">Sin roles</p>
                        </div>

                        <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
                            <div class="text-xs font-semibold text-slate-500 uppercase mb-2">Permisos (<span x-text="userDetailsPreview.permissions.length"></span>)</div>
                            <div x-show="userDetailsPreview.permissions.length" class="max-h-56 overflow-y-auto space-y-1 pr-1">
                                <template x-for="(permissionItem, idx) in userDetailsPreview.permissions" :key="idx">
                                    <div class="text-xs text-slate-700 bg-white border border-slate-200 rounded px-2 py-1" x-text="getPermissionDisplayName(permissionItem)"></div>
                                </template>
                            </div>
                            <p x-show="!userDetailsPreview.permissions.length" class="text-sm text-slate-500">Sin permisos</p>
                        </div>

                        <div class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-lg p-3">
                            <div class="text-xs font-semibold text-slate-500 uppercase mb-2">Datos extra del usuario</div>
                            <div x-show="userDetailsPreview.extraDetails.length" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <template x-for="(detail, idx) in userDetailsPreview.extraDetails" :key="idx">
                                    <div class="bg-white border border-slate-200 rounded px-2.5 py-2">
                                        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500" x-text="detail.label"></p>
                                        <p class="text-sm text-slate-700 break-words" x-text="detail.value"></p>
                                    </div>
                                </template>
                            </div>
                            <p x-show="!userDetailsPreview.extraDetails.length" class="text-sm text-slate-500">Sin datos extra disponibles</p>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>
</Layout>

<!-- Cargar AdminAPI primero con script module (Astro lo procesa correctamente) -->
<script>
    import { AdminAPI } from '../utils/adminAPI.js';
    window.AdminAPI = AdminAPI;
    window.__adminAPILoaded = true;
</script>

<script is:inline>
    // Prevenir m√∫ltiples inicializaciones de Alpine
    (function() {
        if (window.__rolesDataRegistered__) return;
        window.__rolesDataRegistered__ = true;
        
        function registerComponent() {
            Alpine.data('rolesData', () => ({
                users: [],
                apiBaseUrl: window.__API_BASE_URL__ || '',
                apiError: null,
                isLoadingUsers: true,
                isPanelOpen: false,
                isEditing: false,
                isDeleting: false,
                isSaving: false,
                isImporting: false,
                isImportingStudents: false,
                isDragging: false,
                selectedFile: null,
                importedData: [],
                importStudentsError: '',
                importStudentsErrorDetails: [],
                userToDeleteId: null,
                userToDeleteName: '',
                selectedUsers: [],
                searchTerm: '',
                filterStatus: '',
                filterRole: '',
                roleOptionsLoaded: false,
                roleEnrichmentInProgress: false,
                roleEnrichmentBatchSize: 5,
                roleEnrichmentRequestDelayMs: 250,
                roleEnrichmentMaxRetries: 3,
                roleFilterAutoBatchDone: false,
                adminPanelView: 'info',
                usersSummary: null,
                summaryDetailsExpanded: false,
                newUser: { 
                    id: null, name: '', last_name: '', email: '', phone_number: '',
                    birthdate: '', gender: 'hombre', curp: '', address: ['', '', ''],
                    blood_type: 'O+', registration_date: new Date().toISOString().split('T')[0],
                    status: 'activo', role: 'admin',
                    studentDetail: {
                        user_id: null,
                        career_id: '',
                        n_control: '',
                        semestre: 1,
                        group: '',
                        workshop: ''
                    }
                },
                notification: { show: false, message: '', type: 'success' },
                autoRefreshEnabled: true,
                autoRefreshIntervalMs: 180000,
                autoRefreshTimerId: null,
                _onWindowFocus: null,
                _onVisibilityChange: null,
                
                // Modal de error global
                showErrorModal: false,
                errorModalTitle: 'Error',
                errorModalMessage: '',
                errorModalDetails: null,
                userDetailsPreview: {
                    show: false,
                    userId: null,
                    email: '',
                    roles: [],
                    permissions: [],
                    extraDetails: []
                },
                
                // Estados para gesti√≥n de estudiantes
                showStudentModal: false,
                currentStudentUser: null,
                studentDetails: {
                    user_id: null,
                    career_id: '',
                    n_control: '',
                    semestre: 1,
                    group: '',
                    workshop: ''
                },
                hasStudentDetails: false,

                // Estados para gesti√≥n de carreras
                showCareerModal: false,
                careerForm: { career_name: '' },
                careerError: '',
                isSavingCareer: false,
                careers: [],
                isLoadingCareers: false,
                careerDeletingId: null,
                careerEditingId: null,
                
                // Estados para gesti√≥n de roles
                showRolesModal: false,
                availableRoles: [],
                rolesToAdd: [],
                rolesToRemove: [],
                
                // Estados para gesti√≥n de permisos
                showPermissionsModal: false,
                availablePermissions: [],
                permissionsAvailableToAdd: [],
                permissionsAvailableToRemove: [],
                permissionsToAdd: [],
                permissionsToRemove: [],
                permissionTargetRole: '',

                // Estados para importaci√≥n de usuarios
                showImportModal: false,
                importFile: null,
                isImporting: false,
                importResult: null,
                importError: null,

            // Funci√≥n helper para hacer fetch con auto-refresh
            async authenticatedFetch(url, options = {}, isRetry = false) {
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    throw new Error('No hay token de autenticaci√≥n');
                }

                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    }
                });

                // Si el token expir√≥ (401 o 403) y no hemos reintentado
                if ((response.status === 401 || response.status === 403) && !isRetry) {
                    console.log('üîÑ Token expirado. Intentando refresh...');
                    
                    const newToken = await this.refreshAuthToken();
                    
                    if (newToken) {
                        console.log('‚úÖ Token refrescado. Reintentando petici√≥n...');
                        // Reintentar con el nuevo token
                        return await this.authenticatedFetch(url, options, true);
                    } else {
                        console.error('‚ùå No se pudo refrescar el token. Cerrando sesi√≥n...');
                        this.showNotify('Tu sesi√≥n ha expirado', 'error');
                        setTimeout(() => {
                            localStorage.clear();
                            window.location.href = '/';
                        }, 2000);
                        throw new Error('Sesi√≥n expirada');
                    }
                } else if ((response.status === 401 || response.status === 403) && isRetry) {
                    // Ya reintentamos y fall√≥
                    this.showNotify('Tu sesi√≥n ha expirado', 'error');
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = '/';
                    }, 2000);
                    throw new Error('Sesi√≥n expirada');
                }

                return response;
            },

            normalizeDate(value) {
                if (!value) return '';
                if (typeof value === 'string') {
                    return value.split('T')[0];
                }
                return value;
            },

            normalizeRoleValue(roleValue) {
                return String(roleValue || '')
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/[._\/-]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            },

            toCanonicalRole(roleValue) {
                const key = this.normalizeRoleValue(roleValue);
                if (!key) return '';

                if (key === 'sin rol' || key === 'none' || key === 'no role') return '';

                if (key === 'admin' || key === 'administrador' || key === 'super admin' || key === 'superadmin') return 'admin';
                if (
                    key === 'caja' ||
                    key === 'cajero' ||
                    key === 'tesoreria' ||
                    key === 'finanzas' ||
                    key === 'personal de pago' ||
                    key === 'personal de pagos' ||
                    key === 'cobranza' ||
                    key === 'financial staff' ||
                    key === 'staff financiero'
                ) return 'financial-staff';
                if (key === 'student' || key === 'estudiante' || key === 'alumno' || key === 'alumna') return 'student';
                if (key === 'teacher' || key === 'docente' || key === 'maestro' || key === 'profesor' || key === 'profesora') return 'teacher';
                if (
                    key === 'parent' ||
                    key === 'padre' ||
                    key === 'madre' ||
                    key === 'tutor' ||
                    key === 'tutora' ||
                    key === 'tutor legal' ||
                    key === 'padre tutor' ||
                    key === 'padre de familia' ||
                    key === 'madre tutora'
                ) return 'parent';
                if (key === 'applicant' || key === 'solicitante' || key === 'aspirante' || key === 'preinscrito' || key === 'pre inscrito') return 'applicant';
                if (
                    key === 'unverified' ||
                    key === 'nverified' ||
                    key === 'not verified' ||
                    key === 'sin verificar' ||
                    key === 'no verificado' ||
                    key === 'pendiente verificacion' ||
                    key === 'pendiente de verificacion'
                ) return 'unverified';
                if (key === 'supervisor' || key === 'coordinador' || key === 'coordinadora') return 'supervisor';

                return key;
            },

            normalizeRoleForApi(roleValue) {
                return this.toCanonicalRole(roleValue);
            },

            normalizeRoleForFilter(roleValue) {
                return this.toCanonicalRole(roleValue);
            },

            getRoleDisplayName(roleValue) {
                const key = this.normalizeRoleForFilter(roleValue);
                const labels = {
                    'admin': 'Administrador',
                    'financial-staff': 'Personal de pagos',
                    'teacher': 'Maestro',
                    'student': 'Estudiante',
                    'parent': 'Padre/Tutor',
                    'supervisor': 'Supervisor',
                    'unverified': 'Sin verificar',
                    'applicant': 'Solicitante'
                };

                if (labels[key]) return labels[key];
                if (!key) return 'Sin rol';
                return key
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            },

            getPermissionDisplayName(permissionValue) {
                const backendLabel = typeof permissionValue === 'object'
                    ? String(permissionValue?.label || permissionValue?.display_label || '').trim()
                    : '';
                if (backendLabel) return backendLabel;

                const rawValue = typeof permissionValue === 'string'
                    ? permissionValue
                    : (permissionValue?.displayName || permissionValue?.name || permissionValue?.slug || permissionValue?.permission || '');

                const normalized = String(rawValue || '').toLowerCase().trim();
                const normalizedSpaced = normalized
                    .replace(/[._-]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                const normalizedCompact = normalizedSpaced.replace(/\s+/g, '');

                const permissionLabels = {
                    'view.own.pending.concepts.summary': 'Ver resumen de conceptos pendientes propios',
                    'view own pending concepts summary': 'Ver resumen de conceptos pendientes propios',
                    'viewownpendingconceptssummary': 'Ver resumen de conceptos pendientes propios',
                    'view.own.paid.concepts.summary': 'Ver resumen de conceptos pagados propios',
                    'view own paid concepts summary': 'Ver resumen de conceptos pagados propios',
                    'viewownpaidconceptssummary': 'Ver resumen de conceptos pagados propios',
                    'view.own.overdue.concepts.summary': 'Ver resumen de conceptos vencidos propios',
                    'view own overdue concepts summary': 'Ver resumen de conceptos vencidos propios',
                    'viewownoverdueconceptssummary': 'Ver resumen de conceptos vencidos propios',
                    'view.payments.history': 'Ver historial de pagos',
                    'view payments history': 'Ver historial de pagos',
                    'viewpaymentshistory': 'Ver historial de pagos',
                    'view.payments.summary': 'Ver resumen de pagos',
                    'view payments summary': 'Ver resumen de pagos',
                    'viewpaymentssummary': 'Ver resumen de pagos',
                    'view.pending.concepts': 'Ver pagos pendientes',
                    'view pending concepts': 'Ver pagos pendientes',
                    'viewpendingconcepts': 'Ver pagos pendientes',
                    'view.overdue.concepts': 'Ver pagos vencidos',
                    'view overdue concepts': 'Ver pagos vencidos',
                    'viewoverdueconcepts': 'Ver pagos vencidos',
                    'view.receipt': 'Ver recibos',
                    'view receipt': 'Ver recibos',
                    'viewreceipt': 'Ver recibos',
                    'view.cards': 'Ver tarjetas registradas',
                    'view cards': 'Ver tarjetas registradas',
                    'viewcards': 'Ver tarjetas registradas',
                    'view.all.pending.concepts.summary': 'Ver resumen de conceptos pendientes de todos los estudiantes',
                    'view all pending concepts summary': 'Ver resumen de conceptos pendientes de todos los estudiantes',
                    'viewallpendingconceptssummary': 'Ver resumen de conceptos pendientes de todos los estudiantes',
                    'view.all.students.summary': 'Ver resumen de estudiantes',
                    'view all students summary': 'Ver resumen de estudiantes',
                    'viewallstudentssummary': 'Ver resumen de estudiantes',
                    'view.all.paid.concepts.summary': 'Ver resumen de conceptos pagados',
                    'view all paid concepts summary': 'Ver resumen de conceptos pagados',
                    'viewallpaidconceptssummary': 'Ver resumen de conceptos pagados',
                    'view.concepts.summary': 'Ver resumen de conceptos',
                    'view concepts summary': 'Ver resumen de conceptos',
                    'viewconceptssummary': 'Ver resumen de conceptos',
                    'view.concepts': 'Ver conceptos',
                    'view concepts': 'Ver conceptos',
                    'viewconcepts': 'Ver conceptos',
                    'view.debts': 'Ver deudas',
                    'view debts': 'Ver deudas',
                    'viewdebts': 'Ver deudas',
                    'view.payments': 'Ver pagos',
                    'view payments': 'Ver pagos',
                    'viewpayments': 'Ver pagos',
                    'view.users': 'Ver usuarios',
                    'view users': 'Ver usuarios',
                    'viewusers': 'Ver usuarios',
                    'view.permissions': 'Ver permisos',
                    'view permissions': 'Ver permisos',
                    'viewpermissions': 'Ver permisos',
                    'view.roles': 'Ver roles',
                    'view roles': 'Ver roles',
                    'viewroles': 'Ver roles',
                    'view.student': 'Ver detalles acad√©micos',
                    'view student': 'Ver detalles acad√©micos',
                    'viewstudent': 'Ver detalles acad√©micos',
                    'view.payments.student.summary': 'Ver el resumen financiero de los estudiantes',
                    'view payments student summary': 'Ver el resumen financiero de los estudiantes',
                    'viewpaymentsstudentsummary': 'Ver el resumen financiero de los estudiantes',
                    'view.stripe.payments': 'Ver pagos en Stripe',
                    'view stripe payments': 'Ver pagos en Stripe',
                    'viewstripepayments': 'Ver pagos en Stripe',
                    'create.users': 'Crear usuarios',
                    'create users': 'Crear usuarios',
                    'createusers': 'Crear usuarios',
                    'create.user': 'Crear usuario',
                    'create user': 'Crear usuario',
                    'createuser': 'Crear usuario',
                    'create.concepts': 'Crear conceptos de pago',
                    'create concepts': 'Crear conceptos de pago',
                    'createconcepts': 'Crear conceptos de pago',
                    'update.users': 'Editar usuarios',
                    'update users': 'Editar usuarios',
                    'updateusers': 'Editar usuarios',
                    'update.student': 'Actualizar detalles acad√©micos',
                    'update student': 'Actualizar detalles acad√©micos',
                    'updatestudent': 'Actualizar detalles acad√©micos',
                    'update.concepts': 'Actualizar conceptos de pago',
                    'update concepts': 'Actualizar conceptos de pago',
                    'updateconcepts': 'Actualizar conceptos de pago',
                    'delete.users': 'Eliminar usuarios',
                    'delete users': 'Eliminar usuarios',
                    'deleteusers': 'Eliminar usuarios',
                    'attach.student': 'Asignar detalles acad√©micos',
                    'attach student': 'Asignar detalles acad√©micos',
                    'attachstudent': 'Asignar detalles acad√©micos',
                    'import.users': 'Importar usuarios',
                    'import users': 'Importar usuarios',
                    'importusers': 'Importar usuarios',
                    'sync.permissions': 'Sincronizar permisos',
                    'sync permissions': 'Sincronizar permisos',
                    'syncpermissions': 'Sincronizar permisos',
                    'sync.roles': 'Sincronizar roles',
                    'sync roles': 'Sincronizar roles',
                    'syncroles': 'Sincronizar roles',
                    'activate.users': 'Activar usuarios',
                    'activate users': 'Activar usuarios',
                    'activateusers': 'Activar usuarios',
                    'disable.users': 'Deshabilitar usuarios',
                    'disable users': 'Deshabilitar usuarios',
                    'disableusers': 'Deshabilitar usuarios',
                    'promote.student': 'Incrementar semestres',
                    'promote student': 'Incrementar semestres',
                    'promotestudent': 'Incrementar semestres',
                    'refresh.all.dashboard': 'Actualizar tablero de pagos',
                    'refresh all dashboard': 'Actualizar tablero de pagos',
                    'refreshalldashboard': 'Actualizar tablero de pagos',
                    'create_setup': 'Configurar sistema',
                    'create.setup': 'Configurar sistema',
                    'create-setup': 'Configurar sistema',
                    'create setup': 'Configurar sistema',
                    'createsetup': 'Configurar sistema',
                    'delete_card': 'Eliminar tarjeta',
                    'delete.card': 'Eliminar tarjeta',
                    'delete-card': 'Eliminar tarjeta',
                    'delete card': 'Eliminar tarjeta',
                    'deletecard': 'Eliminar tarjeta',
                    'create_payment': 'Registrar pago',
                    'create.payment': 'Registrar pago',
                    'create-payment': 'Registrar pago',
                    'create payment': 'Registrar pago',
                    'finalize.concepts': 'Finalizar conceptos de pago',
                    'finalize concepts': 'Finalizar conceptos de pago',
                    'finalizeconcepts': 'Finalizar conceptos de pago',
                    'disable.concepts': 'Deshabilitar conceptos de pago',
                    'disable concepts': 'Deshabilitar conceptos de pago',
                    'disableconcepts': 'Deshabilitar conceptos de pago',
                    'eliminate.concepts': 'Eliminar conceptos de pago',
                    'eliminate concepts': 'Eliminar conceptos de pago',
                    'eliminateconcepts': 'Eliminar conceptos de pago',
                    'activate.concepts': 'Activar conceptos de pago',
                    'activate concepts': 'Activar conceptos de pago',
                    'activateconcepts': 'Activar conceptos de pago',
                    'validate.debt': 'Validar deuda',
                    'validate debt': 'Validar deuda',
                    'validatedebt': 'Validar deuda',
                    'create.payout': 'Crear liquidaci√≥n de pagos',
                    'create payout': 'Crear liquidaci√≥n de pagos',
                    'createpayout': 'Crear liquidaci√≥n de pagos'
                    ,'createpayment': 'Registrar pago'
                };

                const resolvedLabel = permissionLabels[normalized]
                    || permissionLabels[normalizedSpaced]
                    || permissionLabels[normalizedCompact];

                if (resolvedLabel) return resolvedLabel;

                const tokenTranslations = {
                    'attach': 'Asociar',
                    'import': 'Importar',
                    'sync': 'Actualizar',
                    'view': 'Ver',
                    'create': 'Crear',
                    'update': 'Actualizar',
                    'delete': 'Eliminar',
                    'activate': 'Activar',
                    'disable': 'Desactivar',
                    'manage': 'Gestionar',
                    'setup': 'configuraci√≥n',
                    'student': 'estudiante',
                    'students': 'estudiantes',
                    'user': 'usuario',
                    'users': 'usuarios',
                    'permission': 'permiso',
                    'permissions': 'permisos',
                    'role': 'rol',
                    'roles': 'roles',
                    'card': 'tarjeta',
                    'cards': 'tarjetas',
                    'payment': 'pago',
                    'payments': 'pagos'
                };

                const translatedByTokens = normalizedSpaced
                    .split(' ')
                    .filter(Boolean)
                    .map((token, index) => {
                        const translated = tokenTranslations[token] || token;
                        return index === 0
                            ? translated.charAt(0).toUpperCase() + translated.slice(1)
                            : translated;
                    })
                    .join(' ')
                    .trim();

                if (translatedByTokens) return translatedByTokens;

                return String(rawValue || 'Permiso no identificado')
                    .replace(/[._-]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            },

            getFirstDetailValue(sources, keys) {
                if (!Array.isArray(sources) || !Array.isArray(keys)) return '';

                for (const source of sources) {
                    if (!source || typeof source !== 'object') continue;

                    for (const key of keys) {
                        const value = source[key];
                        if (value === null || value === undefined) continue;

                        if (Array.isArray(value)) {
                            const cleanArray = value.map(v => String(v || '').trim()).filter(Boolean);
                            if (cleanArray.length) return cleanArray.join(', ');
                            continue;
                        }

                        const text = String(value).trim();
                        if (text) return text;
                    }
                }

                return '';
            },

            buildUserExtraDetails(userDetails) {
                const basicInfo = userDetails?.basicInfo || {};
                const studentDetail = userDetails?.studentDetail || {};
                const candidateSources = [
                    userDetails,
                    basicInfo,
                    userDetails?.profile || {},
                    userDetails?.extraData || userDetails?.extra_data || {},
                    studentDetail
                ];

                const addressParts = [
                    this.getFirstDetailValue(candidateSources, ['street', 'calle']),
                    this.getFirstDetailValue(candidateSources, ['city', 'ciudad']),
                    this.getFirstDetailValue(candidateSources, ['state', 'estado']),
                    this.getFirstDetailValue(candidateSources, ['postal_code', 'postalCode', 'codigo_postal', 'cp'])
                ].filter(Boolean);

                const resolvedAddress = this.getFirstDetailValue(candidateSources, ['address', 'direccion', 'domicilio'])
                    || (addressParts.length ? addressParts.join(', ') : '');

                const detailEntries = [
                    { label: 'Nombre', value: this.getFirstDetailValue(candidateSources, ['fullName', 'full_name', 'name']) },
                    { label: 'Apellidos', value: this.getFirstDetailValue(candidateSources, ['last_name', 'lastName', 'apellido', 'apellidos']) },
                    { label: 'Tel√©fono', value: this.getFirstDetailValue(candidateSources, ['phone_number', 'phoneNumber', 'telefono', 'celular']) },
                    { label: 'CURP', value: this.getFirstDetailValue(candidateSources, ['curp', 'CURP']) },
                    { label: 'RFC', value: this.getFirstDetailValue(candidateSources, ['rfc', 'tax_id', 'taxId']) },
                    { label: 'Puesto', value: this.getFirstDetailValue(candidateSources, ['position', 'puesto', 'job_title', 'cargo']) },
                    { label: 'Departamento', value: this.getFirstDetailValue(candidateSources, ['department', 'departamento', 'area']) },
                    { label: 'No. Empleado', value: this.getFirstDetailValue(candidateSources, ['employee_number', 'employeeNumber', 'numero_empleado', 'no_empleado', 'staff_id']) },
                    { label: 'Estatus', value: this.getFirstDetailValue(candidateSources, ['status', 'estado']) },
                    { label: 'Fecha de Nacimiento', value: this.getFirstDetailValue(candidateSources, ['birthdate', 'fecha_nacimiento']) },
                    { label: 'G√©nero', value: this.getFirstDetailValue(candidateSources, ['gender', 'genero']) },
                    { label: 'Tipo de Sangre', value: this.getFirstDetailValue(candidateSources, ['blood_type', 'tipo_sangre', 'bloodType']) },
                    { label: 'Direcci√≥n', value: resolvedAddress },
                    { label: 'No. Control', value: this.getFirstDetailValue(candidateSources, ['n_control', 'nControl']) },
                    { label: 'Semestre', value: this.getFirstDetailValue(candidateSources, ['semestre', 'semester']) },
                    { label: 'Grupo', value: this.getFirstDetailValue(candidateSources, ['group', 'grupo']) },
                    { label: 'Taller', value: this.getFirstDetailValue(candidateSources, ['workshop', 'taller']) },
                    { label: 'Carrera', value: this.getFirstDetailValue(candidateSources, ['career_name', 'careerName', 'career']) }
                ];

                return detailEntries.filter(entry => String(entry.value || '').trim().length > 0);
            },

            getVisibleRoleText(user) {
                const directRoles = this.normalizeRoleList(user?.roles || []);
                const roleCount = Number(user?.roles_count || directRoles.length || 0);
                if (roleCount > 0) return String(roleCount);

                const roleText = String(user?.role || '').trim();
                if (roleText && roleText.toLowerCase() !== 'sin rol') {
                    return '1';
                }

                return '';
            },

            normalizeRoleList(values) {
                if (!Array.isArray(values)) return [];

                const normalized = values
                    .map(value => {
                        if (typeof value === 'string') return value;
                        if (value && typeof value === 'object') return value.name || value.slug || value.role || value.value || '';
                        return String(value || '');
                    })
                    .map(value => String(value || '').trim())
                    .filter(Boolean);

                return Array.from(new Set(normalized));
            },

            extractRolesFromUserPayload(payload) {
                const list = [];

                const collect = (value) => {
                    if (value === null || value === undefined) return;

                    if (Array.isArray(value)) {
                        value.forEach(item => collect(item));
                        return;
                    }

                    if (typeof value === 'object') {
                        const roleName = value.name || value.slug || value.role || value.role_name || value.value || value.label || '';
                        if (roleName) {
                            list.push(roleName);
                            return;
                        }
                    }

                    const text = String(value || '').trim();
                    if (text) list.push(text);
                };

                const candidates = [
                    payload,
                    payload?.user,
                    payload?.data,
                    payload?.basicInfo,
                    payload?.profile,
                    payload?.student,
                    payload?.studentDetail,
                    payload?.details
                ].filter(Boolean);

                candidates.forEach((candidate) => {
                    collect(candidate?.roles);
                    collect(candidate?.role);
                    collect(candidate?.role_name);
                    collect(candidate?.roleName);
                    collect(candidate?.roles_name);
                    collect(candidate?.user_role);
                });

                return this.normalizeRoleList(list);
            },

            chunkEntries(entries, size = 4) {
                if (!Array.isArray(entries) || !entries.length) return [];

                const safeSize = Math.max(1, Number(size) || 4);
                const rows = [];

                for (let index = 0; index < entries.length; index += safeSize) {
                    rows.push(entries.slice(index, index + safeSize));
                }

                return rows;
            },

            sleep(ms) {
                const waitMs = Math.max(0, Number(ms) || 0);
                return new Promise(resolve => setTimeout(resolve, waitMs));
            },

            extractUserRoleKeys(user) {
                const rawValues = [];

                if (Array.isArray(user?.roles) && user.roles.length) {
                    rawValues.push(...user.roles);
                }

                if (user?.roleKey) rawValues.push(user.roleKey);
                if (user?.role) rawValues.push(user.role);

                if (user?.roleLabel) {
                    if (typeof user.roleLabel === 'function') {
                        rawValues.push(user.roleLabel());
                    } else {
                        rawValues.push(user.roleLabel);
                    }
                }

                const normalized = rawValues
                    .flatMap(value => String(value ?? '').split(','))
                    .map(value => this.normalizeRoleForFilter(value))
                    .filter(Boolean);

                return Array.from(new Set(normalized));
            },

            get roleFilterOptions() {
                const keys = new Set();

                this.users.forEach(user => {
                    this.extractUserRoleKeys(user).forEach(role => keys.add(role));
                });

                (this.availableRoles || []).forEach(role => {
                    const rawRoleName = role?.name || role?.slug || role?.role || role?.value || role;
                    const normalized = this.normalizeRoleForFilter(rawRoleName);
                    if (normalized) keys.add(normalized);
                });

                return Array.from(keys)
                    .sort((a, b) => this.getRoleDisplayName(a).localeCompare(this.getRoleDisplayName(b), 'es'))
                    .map(key => ({ value: key, label: this.getRoleDisplayName(key) }));
            },

            async enrichUsersWithDetailRoles(options = {}) {
                if (this.roleEnrichmentInProgress) return;

                const maxRequests = Math.max(0, Number(options.maxRequests ?? this.roleEnrichmentBatchSize ?? 5));
                const force = Boolean(options.force);
                if (!maxRequests) return;

                let roleCache = {};
                try {
                    roleCache = JSON.parse(localStorage.getItem('roles_user_detail_cache') || '{}') || {};
                } catch (_) {
                    roleCache = {};
                }

                // Aplicar cache antes de pedir al backend
                this.users = this.users.map(user => {
                    const cachedRoles = this.normalizeRoleList(roleCache?.[user.id]?.roles || []);
                    if (!cachedRoles.length) return user;

                    return {
                        ...user,
                        roles: cachedRoles,
                        roles_count: cachedRoles.length,
                        role: this.getRoleLabel(cachedRoles),
                        roleKey: this.normalizeRoleForFilter(cachedRoles[0]) || user.roleKey
                    };
                });

                const usersNeedingRoles = this.users.filter(user => {
                    const hasRoles = Array.isArray(user?.roles) && user.roles.length > 0;
                    const hasRoleText = user?.role && String(user.role).trim() && String(user.role).toLowerCase() !== 'sin rol';
                    return !hasRoles && !hasRoleText;
                });

                let usersToEnrich = usersNeedingRoles;
                if (force) {
                    usersToEnrich = this.filteredUsers.length ? this.filteredUsers : this.users;
                }

                usersToEnrich = usersToEnrich.slice(0, maxRequests);

                if (!usersToEnrich.length) {
                    return;
                }

                console.log(`üîÑ Enriqueciendo roles para ${usersToEnrich.length} usuario(s)...`);

                this.roleEnrichmentInProgress = true;
                try {
                    const rolesByUserId = new Map();
                    let rateLimitedCount = 0;

                    for (let index = 0; index < usersToEnrich.length; index++) {
                        const user = usersToEnrich[index];
                        const detail = await this.getUserDetailsWithRetry(user.id, {
                            silent: true,
                            maxRetries: this.roleEnrichmentMaxRetries,
                            baseDelayMs: 700
                        });

                        if (!detail) {
                            rateLimitedCount += 1;
                            await this.sleep(this.roleEnrichmentRequestDelayMs);
                            continue;
                        }

                        const detailRoles = this.extractRolesFromUserPayload(detail);

                        if (detailRoles.length) {
                            roleCache[user.id] = { roles: detailRoles, updatedAt: Date.now() };
                            rolesByUserId.set(user.id, detailRoles);
                        }

                        await this.sleep(this.roleEnrichmentRequestDelayMs);
                    }

                    try {
                        localStorage.setItem('roles_user_detail_cache', JSON.stringify(roleCache));
                    } catch (_) {}

                    if (!rolesByUserId.size) {
                        this.showNotify('No se detectaron roles en este lote. Revisa permisos del usuario actual o la respuesta del endpoint de detalle.', 'info');
                        return;
                    }

                    this.users = this.users.map(user => {
                        const roles = rolesByUserId.get(user.id);
                        if (!roles) return user;

                        return {
                            ...user,
                            roles,
                            roles_count: roles.length,
                            role: this.getRoleLabel(roles),
                            roleKey: this.normalizeRoleForFilter(roles[0]) || user.roleKey
                        };
                    });

                    console.log(`‚úÖ Roles enriquecidos para ${rolesByUserId.size} usuario(s)`);
                    if (rateLimitedCount > 0) {
                        this.showNotify(`Roles actualizados para ${rolesByUserId.size} usuario(s). ${rateLimitedCount} quedaron pendientes por l√≠mite del servidor.`, 'info');
                    } else {
                        this.showNotify(`Roles actualizados para ${rolesByUserId.size} usuario(s)`, 'success');
                    }
                } finally {
                    this.roleEnrichmentInProgress = false;
                }
            },

            async handleRoleFilterChange() {
                if (!this.filterRole) return;
                if (this.roleFilterAutoBatchDone) return;

                this.roleFilterAutoBatchDone = true;
                await this.enrichUsersWithDetailRoles({ maxRequests: this.roleEnrichmentBatchSize });
            },

            generatePassword() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%';
                let password = '';
                for (let i = 0; i < 12; i++) {
                    password += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return password;
            },

            statusLabel(status) {
                const key = (status || '').toLowerCase();
                if (key === 'activo' || key === 'active') return 'Activo';
                if (key === 'baja-temporal') return 'Baja temporal';
                if (key === 'baja') return 'Baja';
                if (key === 'eliminado' || key === 'deleted') return 'Eliminado';
                return 'Inactivo';
            },

            statusClass(status) {
                const key = (status || '').toLowerCase();
                if (key === 'activo' || key === 'active') return 'bg-emerald-100 text-emerald-800 border-emerald-300';
                if (key === 'baja-temporal') return 'bg-amber-100 text-amber-800 border-amber-300';
                if (key === 'eliminado' || key === 'deleted') return 'bg-slate-200 text-slate-700 border-slate-300';
                return 'bg-red-100 text-red-800 border-red-300';
            },

            roleClass(roleKey) {
                const key = this.normalizeRoleForFilter(roleKey);
                if (key === 'admin') return 'bg-purple-100 text-purple-700';
                if (key === 'financial-staff') return 'bg-blue-100 text-blue-700';
                if (key === 'teacher') return 'bg-emerald-100 text-emerald-700';
                return 'bg-slate-100 text-slate-600';
            },

            getRoleLabel(rolesArray) {
                if (!rolesArray || rolesArray.length === 0) return 'Sin rol';

                const translatedRoles = rolesArray.map(role => this.getRoleDisplayName(role));

                return translatedRoles.join(', ');
            },

            mapUser(raw) {
                if (!raw) return null;
                
                // Log para debugging - EXPANDIDO
                console.log('========================================');
                console.log('üîç mapUser - INICIO');
                console.log('========================================');
                console.log('üì¶ raw completo:', raw);
                console.log('üîç raw.roles (tipo):', Array.isArray(raw.roles) ? `array[${raw.roles.length}]` : typeof raw.roles);
                console.log('üîç raw.roles (valor):', raw.roles);
                console.log('üîç raw.roles[0]:', raw.roles?.[0]);
                console.log('üîç raw.roles_count:', raw.roles_count);
                console.log('üîç raw.role:', raw.role);
                console.log('üîç JSON.stringify(raw.roles):', JSON.stringify(raw.roles));
                
                // Extraer roles como array
                let roles = [];
                if (Array.isArray(raw.roles) && raw.roles.length > 0) {
                    roles = raw.roles.map(r => {
                        if (typeof r === 'string') return r;
                        if (r && typeof r === 'object') return r.name || r.slug || r.role || r.value || '';
                        return String(r);
                    }).map(r => String(r || '').trim()).filter(Boolean);
                    console.log('‚úÖ Roles encontrados en raw.roles (array):', roles);
                } else if (raw.role && raw.role !== 'Sin rol') {
                    if (Array.isArray(raw.role)) {
                        roles = raw.role.map(r => {
                            if (r && typeof r === 'object') return r.name || r.slug || r.role || r.value || '';
                            return String(r);
                        }).map(r => String(r || '').trim()).filter(Boolean);
                    } else if (typeof raw.role === 'object') {
                        const roleFromObject = raw.role.name || raw.role.slug || raw.role.role || raw.role.value || '';
                        roles = roleFromObject ? [String(roleFromObject).trim()] : [];
                    } else {
                        roles = [String(raw.role).trim()];
                    }
                    console.log('‚úÖ Roles encontrados en raw.role:', roles);
                } else if (raw.role_name && raw.role_name !== 'Sin rol') {
                    if (typeof raw.role_name === 'object') {
                        const roleName = raw.role_name.name || raw.role_name.slug || raw.role_name.role || raw.role_name.value || '';
                        roles = roleName ? [String(roleName).trim()] : [];
                    } else {
                        roles = [String(raw.role_name).trim()];
                    }
                    console.log('‚úÖ Roles encontrados en raw.role_name:', roles);
                }
                
                console.log('üîç roles extra√≠dos:', roles);
                
                let roleLabel = 'Sin rol';
                let roleKey = '';
                
                if (roles.length > 0) {
                    const translatedRoles = roles.map(role => this.getRoleDisplayName(role));

                    roleLabel = translatedRoles.join(', ');
                    roleKey = this.normalizeRoleForFilter(roles[0]);
                    console.log('‚úÖ Rol traducido:', roleLabel, '| roleKey:', roleKey);
                } else {
                    // Intentar con campos individuales si no hay array de roles
                    const roleValue = raw.role || raw.role_name || '';
                    const roleValueNormalized = typeof roleValue === 'object'
                        ? (roleValue.name || roleValue.slug || roleValue.role || roleValue.value || '')
                        : roleValue;
                    if (roleValue && roleValue !== 'Sin rol') {
                        roleKey = this.normalizeRoleForFilter(roleValueNormalized);
                        roleLabel = this.getRoleDisplayName(roleValueNormalized);
                        console.log('‚úÖ Rol desde raw.role:', roleLabel);
                    } else {
                        console.warn('‚ö†Ô∏è No hay roles encontrados para este usuario');
                    }
                }

                const statusKey = (raw.status || '').toString().toLowerCase();
                let status = 'inactivo';
                if (statusKey === 'active' || statusKey === 'activo') status = 'activo';
                else if (statusKey === 'baja-temporal' || statusKey === 'baja temporal' || statusKey === 'temporary-disable') status = 'baja-temporal';
                else if (statusKey === 'deleted' || statusKey === 'eliminado') status = 'eliminado';
                else if (statusKey) status = statusKey;

                if (raw.deleted_at && status !== 'eliminado') {
                    status = 'eliminado';
                }

                // Address puede ser string o array, asegurar que siempre sea array
                let address = ['', '', ''];
                if (Array.isArray(raw.address)) {
                    address = raw.address;
                } else if (typeof raw.address === 'string') {
                    address = [raw.address, '', ''];
                }

                // Extraer name y last_name desde fullName si no vienen separados
                let name = raw.name || '';
                let last_name = raw.last_name || '';
                
                if (!name && !last_name && raw.fullName) {
                    // Dividir fullName en partes
                    const parts = raw.fullName.trim().split(' ');
                    if (parts.length > 0) {
                        name = parts[0]; // Primera palabra = nombre
                        last_name = parts.slice(1).join(' '); // Resto = apellidos
                    }
                }

                const mapped = {
                    ...raw,
                    id: raw.id || null,
                    name: name,
                    last_name: last_name,
                    email: raw.email || '',
                    phone_number: raw.phone_number || '',
                    birthdate: this.normalizeDate(raw.birthdate),
                    gender: raw.gender || 'hombre',
                    curp: raw.curp || 'N/A',
                    blood_type: raw.blood_type || 'O+',
                    address: address,
                    registration_date: this.normalizeDate(raw.registration_date),
                    status: status,
                    fullName: raw.fullName || `${name} ${last_name}`.trim(),
                    roles: roles, // Array de roles
                    role: roleLabel,
                    roleLabel: () => this.getRoleLabel(this.roles || roles), // Funci√≥n para recalcular din√°micamente
                    roleKey,
                    // Campos de estudiante (si existen)
                    n_control: raw.n_control || '',
                    career_id: raw.career_id || '',
                    semestre: raw.semestre || 1,
                    group: raw.group || '',
                    workshop: raw.workshop || ''
                };

                console.log('üì§ mapUser retorna:', mapped);
                return mapped;
            },

            get stats() {
                const backendSummary = this.usersSummary;
                if (backendSummary) {
                    const toNumber = (value, fallback = 0) => {
                        const parsed = Number(value);
                        return Number.isFinite(parsed) ? parsed : fallback;
                    };

                    const population = backendSummary.populationSummary || {};
                    const roleSummary = backendSummary.usersByRoleSummary || {};
                    const academicSummary = backendSummary.academicSummary || {};
                    const alerts = backendSummary.systemAlerts || {};

                    const total = toNumber(population.total_users, this.users.length);
                    const active = toNumber(population.active_users, 0);
                    const withoutRole = toNumber(
                        alerts.users_without_role,
                        toNumber(population.users_without_role, 0)
                    );
                    const withRole = Math.max(0, toNumber(population.users_with_role, total - withoutRole));

                    const studentsWithoutDetail = toNumber(
                        academicSummary.students_without_student_details,
                        toNumber(alerts.students_without_student_details, 0)
                    );

                    const studentsTotal = toNumber(academicSummary.students_total, 0);
                    const withAcademicDetail = toNumber(
                        academicSummary.users_with_student_details,
                        Math.max(0, studentsTotal - studentsWithoutDetail)
                    );

                    const withoutAcademicDetailWithRole = studentsWithoutDetail;
                    const studentLikeWithoutAcademicDetail = studentsWithoutDetail;

                    const roleCounts = {};
                    Object.entries(roleSummary).forEach(([rawKey, rawValue]) => {
                        const normalizedKey = this.normalizeRoleForFilter(rawKey) || String(rawKey || '').toLowerCase().trim();
                        if (!normalizedKey) return;
                        roleCounts[normalizedKey] = toNumber(rawValue, 0);
                    });

                    const preferredRoleOrder = ['admin', 'financial-staff', 'teacher', 'student', 'parent', 'applicant', 'supervisor', 'unverified'];
                    const roleCountEntries = Object.entries(roleCounts)
                        .map(([key, count]) => ({ key, count }))
                        .sort((a, b) => {
                            const indexA = preferredRoleOrder.indexOf(a.key);
                            const indexB = preferredRoleOrder.indexOf(b.key);

                            const rankA = indexA === -1 ? Number.MAX_SAFE_INTEGER : indexA;
                            const rankB = indexB === -1 ? Number.MAX_SAFE_INTEGER : indexB;

                            if (rankA !== rankB) return rankA - rankB;
                            return b.count - a.count;
                        });

                    const statusCounts = {
                        'activo': toNumber(population.active_users, 0),
                        'baja-temporal': toNumber(population.temporal_inactive_users, 0),
                        'eliminado': toNumber(population.deleted_users, 0),
                        'inactivo': toNumber(population.inactive_users, 0)
                    };

                    const statusCountEntries = Object.entries(statusCounts)
                        .filter(([, count]) => count > 0)
                        .map(([key, count]) => ({ key, count }));

                    return {
                        total,
                        active,
                        withRole,
                        withoutRole,
                        withAcademicDetail,
                        withoutAcademicDetailWithRole,
                        studentLikeWithoutAcademicDetail,
                        roleCounts,
                        statusCounts,
                        roleCountEntries,
                        statusCountEntries
                    };
                }

                const total = this.users.length;
                const active = this.users.filter(u => u.status === 'activo').length;

                const roleCounts = {};
                const statusCounts = {};
                let withRole = 0;
                let withoutRole = 0;
                let withAcademicDetail = 0;
                let withoutAcademicDetailWithRole = 0;
                let studentLikeWithoutAcademicDetail = 0;

                const studentLikeRoles = new Set(['student']);

                this.users.forEach(user => {
                    const roleKeys = this.extractUserRoleKeys(user);
                    const hasRole = roleKeys.length > 0;

                    if (hasRole) {
                        withRole += 1;
                        roleKeys.forEach(roleKey => {
                            roleCounts[roleKey] = (roleCounts[roleKey] || 0) + 1;
                        });
                    } else {
                        withoutRole += 1;
                    }

                    const statusKey = String(user?.status || 'sin-estatus').toLowerCase().trim();
                    statusCounts[statusKey] = (statusCounts[statusKey] || 0) + 1;

                    const hasAcademicDetail = Boolean(
                        String(user?.n_control || '').trim()
                        || String(user?.career_id || '').trim()
                        || String(user?.group || '').trim()
                        || String(user?.workshop || '').trim()
                        || Number(user?.semestre || 0) > 0
                    );

                    if (hasAcademicDetail) {
                        withAcademicDetail += 1;
                    } else if (hasRole) {
                        withoutAcademicDetailWithRole += 1;

                        const hasStudentLikeRole = roleKeys.some(roleKey => studentLikeRoles.has(roleKey));
                        if (hasStudentLikeRole) {
                            studentLikeWithoutAcademicDetail += 1;
                        }
                    }
                });

                const preferredRoleOrder = ['admin', 'financial-staff', 'teacher', 'student', 'parent', 'applicant', 'supervisor', 'unverified'];
                const roleCountEntries = Object.entries(roleCounts)
                    .map(([key, count]) => ({ key, count }))
                    .sort((a, b) => {
                        const indexA = preferredRoleOrder.indexOf(a.key);
                        const indexB = preferredRoleOrder.indexOf(b.key);

                        const rankA = indexA === -1 ? Number.MAX_SAFE_INTEGER : indexA;
                        const rankB = indexB === -1 ? Number.MAX_SAFE_INTEGER : indexB;

                        if (rankA !== rankB) return rankA - rankB;
                        return b.count - a.count;
                    });

                const preferredStatusOrder = ['activo', 'baja-temporal', 'baja', 'eliminado', 'inactivo'];
                const statusCountEntries = Object.entries(statusCounts)
                    .map(([key, count]) => ({ key, count }))
                    .sort((a, b) => {
                        const indexA = preferredStatusOrder.indexOf(a.key);
                        const indexB = preferredStatusOrder.indexOf(b.key);

                        const rankA = indexA === -1 ? Number.MAX_SAFE_INTEGER : indexA;
                        const rankB = indexB === -1 ? Number.MAX_SAFE_INTEGER : indexB;

                        if (rankA !== rankB) return rankA - rankB;
                        return b.count - a.count;
                    });

                return {
                    total,
                    active,
                    withRole,
                    withoutRole,
                    withAcademicDetail,
                    withoutAcademicDetailWithRole,
                    studentLikeWithoutAcademicDetail,
                    roleCounts,
                    statusCounts,
                    roleCountEntries,
                    statusCountEntries
                };
            },

            extractUsersSummary(result) {
                const candidates = [
                    result?.data?.summary,
                    result?.summary,
                    result?.data?.data?.summary,
                    result?.data,
                    result
                ];

                return candidates.find(candidate => {
                    if (!candidate || typeof candidate !== 'object') return false;

                    return Boolean(
                        candidate.populationSummary
                        || candidate.usersByRoleSummary
                        || candidate.academicSummary
                        || candidate.systemAlerts
                    );
                }) || null;
            },

            async loadUsersSummary(token, isRetry = false) {
                const summaryEndpoints = [
                    '/v1/admin-actions/users-summary',
                    '/v1/admin-actions/summary-users',
                    '/v1/admin-actions/users/summary',
                    '/v1/admin-actions/summary'
                ];

                for (const path of summaryEndpoints) {
                    try {
                        const endpoint = `${this.apiBaseUrl}${path}`;
                        const response = await this.authenticatedFetch(endpoint, { method: 'GET' }, isRetry);
                        if (!response.ok) continue;

                        const result = await response.json();
                        const summary = this.extractUsersSummary(result);
                        if (summary) {
                            this.usersSummary = summary;
                            console.log(`‚úÖ Resumen de usuarios cargado desde ${path}`);
                            return true;
                        }
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è No se pudo cargar resumen desde ${path}:`, error);
                    }
                }

                return false;
            },

            async refreshUsersSilently(reason = 'auto') {
                if (!this.autoRefreshEnabled) return;
                if (this.isLoadingUsers || this.isSaving || this.isImporting || this.roleEnrichmentInProgress) return;

                const token = localStorage.getItem('access_token');
                if (!token) return;

                try {
                    console.log(`üîÑ Auto-refresh usuarios (${reason})`);
                    await this.loadUsers(token, false, { silent: true });
                } catch (error) {
                    console.warn('‚ö†Ô∏è Auto-refresh omitido por error:', error?.message || error);
                }
            },

            setupAutoRefresh() {
                if (!this.autoRefreshEnabled) return;

                if (this.autoRefreshTimerId) {
                    clearInterval(this.autoRefreshTimerId);
                    this.autoRefreshTimerId = null;
                }

                this.autoRefreshTimerId = setInterval(() => {
                    if (document.hidden) return;
                    void this.refreshUsersSilently('interval');
                }, this.autoRefreshIntervalMs);

                if (!this._onWindowFocus) {
                    this._onWindowFocus = () => {
                        void this.refreshUsersSilently('focus');
                    };
                    window.addEventListener('focus', this._onWindowFocus);
                }

                if (!this._onVisibilityChange) {
                    this._onVisibilityChange = () => {
                        if (!document.hidden) {
                            void this.refreshUsersSilently('visible');
                        }
                    };
                    document.addEventListener('visibilitychange', this._onVisibilityChange);
                }

                window.addEventListener('beforeunload', () => {
                    if (this.autoRefreshTimerId) {
                        clearInterval(this.autoRefreshTimerId);
                        this.autoRefreshTimerId = null;
                    }
                }, { once: true });
            },

            async init() {
                // Verificar autenticaci√≥n
                console.log('========================================');
                console.log('üîç ROLES.ASTRO - Verificando autenticaci√≥n');
                console.log('========================================');
                console.log('üìã Todas las keys en localStorage:', Object.keys(localStorage));
                console.log('üì¶ Valores en localStorage:');
                for (let key of Object.keys(localStorage)) {
                    const value = localStorage.getItem(key);
                    console.log(`   - ${key}: ${value ? value.substring(0, 50) + '...' : 'null'}`);
                }
                
                const token = localStorage.getItem('access_token');
                console.log('üîë Token access_token:', token ? `ENCONTRADO (${token.length} chars)` : '‚ùå NO ENCONTRADO');
                
                if (!token) {
                    console.error('‚ùå NO HAY TOKEN DE AUTENTICACI√ìN');
                    console.log('üí° Posibles causas:');
                    console.log('   1. No has iniciado sesi√≥n');
                    console.log('   2. El backend no devolvi√≥ el token');
                    console.log('   3. El token no se guard√≥ correctamente');
                    console.log('');
                    console.log('üîß SOLUCI√ìN: Ve a la p√°gina principal y vuelve a iniciar sesi√≥n');
                    console.log('üìß Usa: admin@uni.edu / password123');
                    console.log('');
                    console.log('‚è∞ Redirigiendo al login en 3 segundos...');
                    
                    this.apiError = 'Sin autenticaci√≥n';
                    this.isLoadingUsers = false;
                    
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                    return;
                }

                console.log('‚úÖ Token encontrado, procediendo a cargar usuarios...');
                console.log('========================================');
                
                // Cargar usuarios desde la API
                await this.loadUsers(token);

                // Configurar auto-actualizaci√≥n silenciosa
                this.setupAutoRefresh();

                // Cargar roles para filtro (aunque no se abra el modal)
                await this.loadAvailableRolesForFilter();
            },

            async loadAvailableRolesForFilter(force = false) {
                if (this.roleOptionsLoaded && !force) return;

                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/find-roles`,
                        {
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'view.roles'
                            }
                        }
                    );

                    const result = await response.json();
                    if (response.ok && result.success) {
                        const roles = result.data?.roles || [];
                        this.availableRoles = roles.map(role => ({
                            id: role.id,
                            name: role.name,
                            displayName: this.getRoleDisplayName(role.name)
                        }));
                        this.roleOptionsLoaded = true;
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è No se pudieron cargar roles para el filtro:', error);
                }
            },

            async refreshAuthToken() {
                const refreshToken = localStorage.getItem('refresh_token');
                if (!refreshToken) {
                    console.error('‚ùå No hay refresh token disponible');
                    return null;
                }

                console.log('üîÑ Intentando refrescar token...');
                try {
                    const response = await fetch(`${this.apiBaseUrl}/v1/refresh-token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        body: JSON.stringify({ refresh_token: refreshToken })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const tokenBundle = data?.data?.user_tokens || data?.data || {};
                        const newAccessToken = tokenBundle.access_token || data?.access_token;
                        const newRefreshToken = tokenBundle.refresh_token || data?.refresh_token;

                        if (newAccessToken) {
                            localStorage.setItem('access_token', newAccessToken);
                            console.log('‚úÖ Token refrescado exitosamente');
                            
                            if (newRefreshToken) {
                                localStorage.setItem('refresh_token', newRefreshToken);
                            }
                            
                            return newAccessToken;
                        }
                    }

                    console.error('‚ùå No se pudo refrescar el token');
                    return null;
                } catch (error) {
                    console.error('‚ùå Error al refrescar token:', error);
                    return null;
                }
            },

            async loadUsers(token, isRetry = false, options = {}) {
                const { silent = false } = options;
                try {
                    // Si no hay token, obtenerlo del localStorage
                    if (!token) {
                        token = localStorage.getItem('access_token');
                        console.log('‚ö†Ô∏è Token no pasado como par√°metro, obteniendo del localStorage');
                    }
                    
                    if (!token) {
                        console.error('‚ùå No hay token de autenticaci√≥n disponible');
                        this.apiError = 'No hay token de autenticaci√≥n';
                        if (!silent) {
                            this.showNotify('No hay token de autenticaci√≥n. Por favor, inicia sesi√≥n nuevamente.', 'error');
                        }
                        return;
                    }
                    
                    const params = new URLSearchParams({
                        page: '1',
                        perPage: '200',
                        forceRefresh: 'true'
                    });
                    const endpoint = `${this.apiBaseUrl}/v1/admin-actions/show-users?${params}`;
                    console.log('========================================');
                    console.log('üîÑ CARGANDO USUARIOS DESDE LA API');
                    console.log('========================================');
                    console.log('üìç URL completa:', endpoint);
                    console.log('üîë Token (primeros 30 chars):', token.substring(0, 30) + '...');
                    console.log('üîë Token (√∫ltimos 10 chars):', '...' + token.substring(token.length - 10));
                    console.log('üìè Longitud del token:', token.length);
                    console.log('üîÑ Es reintento despu√©s de refresh:', isRetry ? 'S√ç' : 'NO');
                    console.log('‚è∞ Timestamp:', new Date().toISOString());
                    
                    console.log('üì° Enviando petici√≥n GET con auto-refresh...');
                    const requestStartTime = Date.now();
                    
                    // Usar authenticatedFetch que maneja refresh autom√°ticamente
                    const response = await this.authenticatedFetch(endpoint, { method: 'GET' }, isRetry);
                    
                    const requestDuration = Date.now() - requestStartTime;
                    
                    console.log('‚è±Ô∏è Respuesta recibida en:', requestDuration, 'ms');
                    console.log('üì° Response status:', response.status);
                    console.log('üì° Response ok:', response.ok);
                    console.log('========================================');
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('üì¶ Response data:', result);

                        const responseSummary = this.extractUsersSummary(result);
                        if (responseSummary) {
                            this.usersSummary = responseSummary;
                            console.log('‚úÖ Resumen de usuarios detectado en respuesta de show-users');
                        }
                        
                        // Backend devuelve {success: true, data: {users: {items: [...]}}, message: '...'}
                        if (result.success && result.data && result.data.users && result.data.users.items) {
                            console.log('üîç RAW USERS desde backend (primeros 2):');
                            console.log(JSON.stringify(result.data.users.items.slice(0, 2), null, 2));
                            
                            // ‚ö†Ô∏è VERIFICAR SI LOS ROLES VIENEN DESDE EL BACKEND
                            const firstUser = result.data.users.items[0];
                            if (firstUser) {
                                console.log('========================================');
                                console.log('üî¨ AN√ÅLISIS DEL PRIMER USUARIO DEL BACKEND:');
                                console.log('========================================');
                                console.log('üìß Email:', firstUser.email);
                                console.log('üÜî ID:', firstUser.id);
                                console.log('üîç Tiene propiedad roles?', 'roles' in firstUser);
                                console.log('üîç Valor de roles:', firstUser.roles);
                                console.log('üîç Tipo de roles:', Array.isArray(firstUser.roles) ? `array[${firstUser.roles.length}]` : typeof firstUser.roles);
                                console.log('üîç roles_count:', firstUser.roles_count);
                                console.log('üîç JSON.stringify de roles:', JSON.stringify(firstUser.roles));
                                console.log('========================================');
                            }
                            
                            // ‚ö†Ô∏è ADVERTENCIA: Backend no incluye roles
                            if (result.data.users.items.length > 0 && !result.data.users.items[0].roles) {
                                console.warn('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è');
                                console.warn('‚ö†Ô∏è EL BACKEND NO EST√Å ENVIANDO LOS ROLES');
                                console.warn('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è');
                                console.warn('');
                                console.warn('El backend devuelve roles_count pero NO el array de roles');
                                console.warn('');
                                console.warn('üîß SOLUCI√ìN EN EL BACKEND:');
                                console.warn('   Archivo: backend/school-management/app/Http/Controllers/AdminActionsController.php');
                                console.warn('   M√©todo: showUsers()');
                                console.warn('   L√≠nea a modificar:');
                                console.warn('      ANTES: $users = User::select(...)->get();');
                                console.warn('      DESPU√âS: $users = User::select(...)->with("roles")->get();');
                                console.warn('');
                                console.warn('üí° Agregar ->with("roles") antes de ->get()');
                                console.warn('');
                            }
                            
                            this.users = result.data.users.items.map(u => this.mapUser(u));
                        } else if (Array.isArray(result)) {
                            console.log('üîç RAW USERS desde backend (primeros 2):');
                            console.log(JSON.stringify(result.slice(0, 2), null, 2));
                            this.users = result.map(u => this.mapUser(u));
                        } else {
                            this.users = [];
                        }

                        this.roleFilterAutoBatchDone = false;

                        if (!this.usersSummary) {
                            await this.loadUsersSummary(token, isRetry);
                        }

                        console.log(`‚úÖ ${this.users.length} usuarios cargados correctamente`);
                        console.log('üìã Estructura del primer usuario:');
                        if (this.users.length > 0) {
                            console.log(JSON.stringify(this.users[0], null, 2));
                        }
                        
                        // Guardar en localStorage para que otras p√°ginas puedan usar el cache
                        try {
                            localStorage.setItem('studentsList', JSON.stringify(this.users));
                            console.log('üíæ Lista de usuarios guardada en localStorage para otras p√°ginas');
                        } catch (e) {
                            console.warn('‚ö†Ô∏è No se pudo guardar en localStorage:', e);
                        }
                        
                        // Mostrar roles de cada usuario
                        console.log('========================================');
                        console.log('üë• ROLES DE USUARIOS:');
                        console.log('========================================');
                        this.users.forEach((user, index) => {
                            const rolesStr = user.roles && user.roles.length > 0 
                                ? user.roles.join(', ') 
                                : 'Sin roles';
                            console.log(`${index + 1}. ${user.name} (${user.email}) ‚Üí Roles: ${rolesStr}`);
                        });
                        console.log('========================================');
                        
                        this.apiError = null;
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('‚ùå Error al cargar usuarios:', response.status, errorData);
                        console.error('üìã Error completo:', JSON.stringify(errorData, null, 2));
                        
                        if (response.status === 500) {
                            this.apiError = `Error del servidor (500)`;
                            const errorMsg = errorData.message || errorData.error || 'Error interno del servidor';
                            if (!silent) {
                                this.showNotify(`‚ùå Error 500: ${errorMsg}`, 'error');
                            }
                            
                            console.error('');
                            console.error('üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®');
                            console.error('üö® ERROR 500 = ERROR DEL BACKEND (NO FRONTEND)');
                            console.error('üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®');
                            console.error('');
                            console.error('‚úÖ EL FRONTEND EST√Å HACIENDO TODO BIEN:');
                            console.error('   ‚úÖ Token se guard√≥ correctamente');
                            console.error('   ‚úÖ Token se env√≠a en Authorization header');
                            console.error('   ‚úÖ Endpoint es el correcto: /v1/admin-actions/showUsers');
                            console.error('   ‚úÖ M√©todo HTTP correcto: GET');
                            console.error('   ‚úÖ Headers correctos (Accept, Content-Type, Authorization)');
                            console.error('');
                            console.error('‚ùå EL BACKEND EST√Å FALLANDO:');
                            console.error('   ‚ùå Error 500 = Internal Server Error');
                            console.error('   ‚ùå El servidor recibi√≥ la petici√≥n pero tuvo un error al procesarla');
                            console.error('   ‚ùå Mensaje del backend:', errorMsg);
                            console.error('   ‚ùå Error code:', errorData.error_code);
                            console.error('');
                            console.error('üîß SOLUCI√ìN (ANGEL DEBE HACER ESTO):');
                            console.error('   1. Ir a Railway ‚Üí Project ‚Üí Deployments');
                            console.error('   2. Click en el √∫ltimo deployment ‚Üí View Logs');
                            console.error('   3. Buscar logs con error al hacer GET /v1/admin-actions/showUsers');
                            console.error('   4. Revisar el archivo: app/Http/Controllers/AdminActionsController.php');
                            console.error('   5. Verificar m√©todo showUsers()');
                            console.error('   6. Verificar que la base de datos tiene la tabla users');
                            console.error('   7. Verificar middleware auth:sanctum');
                            console.error('');
                            console.error('üìã INFO PARA ANGEL:');
                            console.error('   - Endpoint que falla:', endpoint);
                            console.error('   - Token enviado:', token ? 'S√ç (v√°lido)' : 'NO');
                            console.error('   - Headers enviados:', 'Accept, Content-Type, Authorization Bearer');
                            console.error('   - El error NO es del frontend');
                            console.error('');
                            console.error('üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®');
                            console.error('');
                        } else {
                            this.apiError = `Error ${response.status}`;
                            if (!silent) {
                                this.showNotify(`Error al cargar usuarios: ${errorData.message || response.statusText}`, 'error');
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error de conexi√≥n:', error);
                    
                    if (error.name === 'AbortError') {
                        this.apiError = 'Tiempo de espera agotado';
                        if (!silent) {
                            this.showNotify('La solicitud tard√≥ demasiado tiempo', 'error');
                        }
                    } else {
                        this.apiError = error.message;
                        if (!silent) {
                            this.showNotify(`Error de conexi√≥n: ${error.message}`, 'error');
                        }
                    }
                } finally {
                    this.isLoadingUsers = false;
                }
            },

            get filteredUsers() {
                let filtered = this.users;
                
                // Filtrar por t√©rmino de b√∫squeda
                if (this.searchTerm) {
                    const search = this.searchTerm.toLowerCase();
                    filtered = filtered.filter(u => 
                        (u.fullName?.toLowerCase().includes(search)) ||
                        (u.email?.toLowerCase().includes(search)) ||
                        (u.curp?.toLowerCase().includes(search)) ||
                        (u.id?.toString().includes(search))
                    );
                }
                
                // Filtrar por estado
                if (this.filterStatus) {
                    filtered = filtered.filter(u => u.status === this.filterStatus);
                }

                // Filtrar por rol
                if (this.filterRole) {
                    filtered = filtered.filter(u => {
                        const normalizedRoles = this.extractUserRoleKeys(u);
                        return normalizedRoles.includes(this.filterRole);
                    });
                }
                
                return filtered;
            },

            toggleSelectAll() {
                if (this.selectedUsers.length === this.filteredUsers.length) {
                    this.selectedUsers = [];
                } else {
                    this.selectedUsers = this.filteredUsers.map(u => u.id);
                }
            },

            toggleUserSelection(userId) {
                const index = this.selectedUsers.indexOf(userId);
                if (index > -1) {
                    this.selectedUsers.splice(index, 1);
                } else {
                    this.selectedUsers.push(userId);
                }
            },

            async bulkDelete() {
                if (!confirm(`¬øMarcar como eliminados ${this.selectedUsers.length} usuarios?`)) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/delete-users`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'delete.users'
                            },
                            body: JSON.stringify({ ids: this.selectedUsers })
                        }
                    );

                    const result = await response.json();
                    if (response.ok) {
                        this.showNotify(result.message || 'Usuarios marcados como eliminados', 'success');
                        this.selectedUsers = [];
                        // Recargar lista para reflejar cambios
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al eliminar usuarios', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error en bulkDelete:', error);
                    this.showNotify('Error al eliminar usuarios', 'error');
                }
            },

            async bulkDisable() {
                if (!confirm(`¬øEst√°s seguro de dar de baja a ${this.selectedUsers.length} usuarios?`)) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/disable-users`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'disable.users'
                            },
                            body: JSON.stringify({ ids: this.selectedUsers })
                        }
                    );

                    const result = await response.json();
                    if (response.ok) {
                        this.showNotify(result.message || 'Usuarios dados de baja', 'success');
                        this.selectedUsers = [];
                        // Recargar lista para reflejar cambios
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al dar de baja', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error en bulkDisable:', error);
                    this.showNotify('Error al dar de baja usuarios', 'error');
                }
            },

            async bulkTemporaryDisable() {
                if (!confirm(`¬øEst√°s seguro de dar de baja temporal a ${this.selectedUsers.length} usuarios?`)) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/temporary-disable-users`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'disable.users'
                            },
                            body: JSON.stringify({ ids: this.selectedUsers })
                        }
                    );

                    const result = await response.json();
                    if (response.ok) {
                        this.showNotify(result.message || 'Baja temporal aplicada', 'success');
                        this.selectedUsers = [];
                        // Recargar lista para reflejar cambios
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al dar de baja temporal', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error en bulkTemporaryDisable:', error);
                    this.showNotify('Error al dar de baja temporal', 'error');
                }
            },

            async activateUsers() {
                if (this.selectedUsers.length === 0) {
                    this.showNotify('Selecciona al menos un usuario', 'error');
                    return;
                }
                
                if (!confirm(`¬øActivar ${this.selectedUsers.length} usuario(s)?`)) {
                    return;
                }
                
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }
                
                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/activate-users`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'activate.users'
                            },
                            body: JSON.stringify({ ids: this.selectedUsers })
                        }
                    );
                    
                    const result = await response.json();
                    if (response.ok && result.success) {
                        this.showNotify(result.message || 'Usuarios activados correctamente', 'success');
                        this.selectedUsers = [];
                        // Recargar lista para reflejar cambios
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al activar usuarios', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al activar usuarios:', error);
                    this.showNotify('Error de conexi√≥n', 'error');
                }
            },

            async promoteStudents() {
                if (!confirm('¬øEst√°s seguro de promover a TODOS los estudiantes? Se incrementar√° el semestre y se dar√°n de baja los que sobrepasen el semestre 12.')) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    this.isLoadingUsers = true;
                    console.log('üì§ Enviando solicitud de promoci√≥n...');
                    
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/promote`,
                        {
                            method: 'PATCH',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'promote.student'
                            }
                        }
                    );

                    console.log('üì• Respuesta recibida:', response.status);
                    const result = await response.json();
                    
                    console.log('üìã Resultado:', result);
                    
                    // Show debug info if present
                    if (result.debug) {
                        console.error('üêõ Debug Info:', result.debug);
                    }
                    
                    if (response.ok && result.success) {
                        const affected = result.data?.affected || result.data?.data?.affected || {};
                        const promoted =
                            affected.usuarios_promovidos ??
                            affected.promoted ??
                            affected.updated ??
                            null;
                        const dropped =
                            affected.usuarios_baja ??
                            affected.deactivated ??
                            affected.dropped ??
                            null;

                        if (promoted === null && dropped === null) {
                            this.showNotify(
                                result.message || 'Promoci√≥n iniciada en segundo plano.',
                                'success'
                            );
                        } else {
                            this.showNotify(
                                `‚úÖ Promoci√≥n completada: ${promoted ?? 0} promovidos, ${dropped ?? 0} dados de baja`,
                                'success'
                            );
                        }

                        await this.loadUsers(token);
                    } else {
                        const errorMsg = result.message || `Error: ${result.error_code || 'desconocido'}`;
                        console.error('‚ùå Error en respuesta:', errorMsg);
                        console.error('‚ùå Detalles:', result);
                        
                        // Usar modal de error en lugar de notificaci√≥n
                        this.showError(
                            '‚ùå Error en Promoci√≥n de Estudiantes',
                            errorMsg,
                            {
                                error_code: result.error_code,
                                status: response.status,
                                debug: result.debug,
                                errors: result.errors,
                                data: result.data
                            }
                        );
                    }
                } catch (error) {
                    console.error('‚ùå Error en promoteStudents:', error);
                    const errorMsg = error?.message || 'Error desconocido al promover estudiantes';
                    
                    // Usar modal de error en lugar de notificaci√≥n
                    this.showError(
                        '‚ùå Error de Operaci√≥n',
                        'No fue posible promover los estudiantes. Por favor, intenta nuevamente.'
                    );
                } finally {
                    this.isLoadingUsers = false;
                }
            },

            openImportStudentsModal() {
                this.isImportingStudents = true;
            },

            closeImportStudentsModal() {
                this.isImportingStudents = false;
                this.selectedFile = null;
                this.importedData = [];
            },

            async processImportStudents() {
                if (!this.selectedFile) return;

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    this.isSaving = true;
                    this.importStudentsError = '';
                    this.importStudentsErrorDetails = [];
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);

                    console.log('üì§ Enviando archivo de estudiantes:', this.selectedFile.name);

                    const response = await fetch(`${this.apiBaseUrl}/v1/admin-actions/import-students`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json',
                            'X-User-Role': 'admin',
                            'X-User-Permission': 'import.users'
                        },
                        body: formData
                    });

                    const result = await response.json();
                    console.log('üì• Respuesta del servidor:', response.status, result);

                    if (response.ok && result.success) {
                        const summary = result.data?.summary?.summary;
                        const hasErrors = result.data?.summary?.has_errors;
                        const hasWarnings = result.data?.summary?.has_warnings;
                        
                        this.showNotify(
                            `‚úÖ Importaci√≥n completada: ${summary?.rows_inserted || 0} insertados, ${summary?.rows_failed || 0} fallidos`,
                            'success'
                        );
                        
                        // Si hay errores, mostrar modal con detalles
                        if (hasErrors || hasWarnings) {
                            const errorDetails = result.data?.summary?.errors;
                            const warnings = result.data?.summary?.warnings;
                            
                            let detailedMessage = `Resumen de importaci√≥n de estudiantes:\n\n`;
                            detailedMessage += `‚úÖ Filas insertadas: ${summary?.rows_inserted || 0}\n`;
                            detailedMessage += `‚ùå Filas fallidas: ${summary?.rows_failed || 0}\n`;
                            detailedMessage += `üìä Tasa de √©xito: ${summary?.success_rate || 0}%\n\n`;
                            
                            if (errorDetails?.row_errors?.length > 0) {
                                detailedMessage += `Errores encontrados:\n`;
                                errorDetails.row_errors.slice(0, 5).forEach(err => {
                                    detailedMessage += `- Fila ${err.row_number}: ${err.message}\n`;
                                });
                                if (errorDetails.row_errors.length > 5) {
                                    detailedMessage += `... y ${errorDetails.row_errors.length - 5} errores m√°s.\n`;
                                }
                            }
                            
                            this.showError(
                                '‚ö†Ô∏è Importaci√≥n de Estudiantes con Errores',
                                detailedMessage,
                                {
                                    summary: summary,
                                    errors: errorDetails,
                                    warnings: warnings
                                }
                            );
                        }
                        
                        this.closeImportStudentsModal();
                        await this.loadUsers(token);
                    } else {
                        console.error('‚ùå Error de validaci√≥n:', result);
                        
                        const validation = result.errors ? Object.values(result.errors).flat().join(', ') : '';
                        const message = validation || result.message || `Error ${response.status} al importar`;
                        
                        const validationList = result.errors
                            ? Object.entries(result.errors).map(([k, v]) => `${k}: ${(v || []).join(', ')}`)
                            : [];
                        const rowErrors = Array.isArray(result.data?.summary?.errors?.row_errors)
                            ? result.data.summary.errors.row_errors.map(e => `Fila ${e.row_number}: ${e.message}`)
                            : [];
                        
                        this.importStudentsError = message;
                        this.importStudentsErrorDetails = [...validationList, ...rowErrors];
                        
                        // Usar modal de error en lugar de solo notificaci√≥n
                        this.showError(
                            '‚ùå Error al Importar Estudiantes',
                            message,
                            {
                                error_code: result.error_code,
                                status: response.status,
                                errors: result.errors,
                                validation_errors: validationList,
                                row_errors: rowErrors
                            }
                        );
                    }
                } catch (error) {
                    console.error('‚ùå Error al importar estudiantes:', error);
                    
                    this.showError(
                        '‚ùå Error de Importaci√≥n',
                        'No fue posible importar los detalles de estudiantes. Verifica el archivo y intenta nuevamente.'
                    );
                } finally {
                    this.isSaving = false;
                }
            },

            openPanelForAdd() {
                this.isEditing = false;
                this.hasStudentDetails = false;
                this.newUser = { 
                    id: null, name: '', last_name: '', email: '', phone_number: '',
                    birthdate: '', gender: 'hombre', curp: '', address: ['', '', ''],
                    blood_type: 'O+', registration_date: new Date().toISOString().split('T')[0],
                    status: 'activo', role: 'admin',
                    studentDetail: {
                        user_id: null,
                        career_id: '',
                        n_control: '',
                        semestre: 1,
                        group: '',
                        workshop: ''
                    }
                };
                this.isPanelOpen = true;
            },

            openPanelForEdit(user) {
                console.log('üìù openPanelForEdit - Usuario original COMPLETO:', JSON.stringify(user, null, 2));
                
                this.isEditing = true;
                this.hasStudentDetails = false;
                
                // Verificar qu√© campos tiene el usuario original
                console.log('üîç Campos del usuario original:');
                console.log('  - phone_number:', user.phone_number);
                console.log('  - birthdate:', user.birthdate);
                console.log('  - gender:', user.gender);
                console.log('  - address:', user.address);
                console.log('  - blood_type:', user.blood_type);
                
                // Mapear el usuario
                const mapped = this.mapUser(user) || user || {};
                console.log('üìù Usuario mapeado:', mapped);
                
                // Ensegurar que address sea un array
                let addressArray = ['', '', ''];
                if (Array.isArray(mapped.address)) {
                    addressArray = [...mapped.address];
                } else if (Array.isArray(user?.address)) {
                    addressArray = [...user.address];
                }
                
                console.log('üìù Address final:', addressArray);
                
                // Asignar todos los datos en un objeto nuevo
                const userData = {
                    id: mapped.id || user?.id,
                    name: mapped.name || user?.name || '',
                    last_name: mapped.last_name || user?.last_name || '',
                    email: mapped.email || user?.email || '',
                    phone_number: mapped.phone_number || user?.phone_number || '',
                    birthdate: mapped.birthdate || user?.birthdate || '',
                    gender: mapped.gender || user?.gender || 'hombre',
                    curp: (mapped.curp === 'N/A' ? '' : mapped.curp) || user?.curp || '',
                    blood_type: mapped.blood_type || user?.blood_type || 'O+',
                    address: addressArray,
                    registration_date: mapped.registration_date || user?.registration_date || new Date().toISOString().split('T')[0],
                    status: mapped.status || user?.status || 'activo',
                    role: this.normalizeRoleForApi(mapped.roleKey || mapped.role || mapped.roleLabel || user?.role || user?.role_name || user?.roles?.[0] || ''),
                    studentDetail: {
                        user_id: mapped.id || user?.id,
                        career_id: '',
                        n_control: '',
                        semestre: 1,
                        group: '',
                        workshop: ''
                    }
                };
                
                console.log('üìù Datos preparados para formulario:', JSON.stringify(userData, null, 2));
                
                // Reemplazar newUser completamente con los nuevos datos
                this.newUser = userData;
                console.log('‚úÖ newUser actualizado:', this.newUser);
                
                // Mostrar el panel despu√©s de actualizar los datos
                this.isPanelOpen = true;
                
                // Cargar detalles de estudiante en background
                this.loadStudentDetailsForEdit(mapped.id || user?.id);
            },

            async loadStudentDetailsForEdit(userId) {
                const token = localStorage.getItem('access_token');
                if (!token || !userId) {
                    console.log('‚ö†Ô∏è No hay token o userId para cargar detalles de estudiante');
                    return;
                }

                // Verificar si el usuario actual tiene rol de estudiante
                const userRole = (this.newUser.role || '').toLowerCase();
                const isStudent = userRole === 'student' || userRole === 'estudiante';
                
                if (!isStudent) {
                    console.log('‚ÑπÔ∏è Usuario no es estudiante, no se cargan detalles');
                    this.hasStudentDetails = false;
                    return;
                }

                // Cargar carreras si no est√°n cargadas
                if (!this.careers || this.careers.length === 0) {
                    console.log('üìö Cargando carreras...');
                    await this.loadCareers();
                }

                try {
                    console.log(`üîç Cargando detalles de estudiante para usuario ID: ${userId}`);
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/get-student/${userId}`,
                        { 
                            method: 'GET',
                            headers: {
                                'X-User-Permission': 'view.student'
                            }
                        }
                    );

                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.success && result.data && result.data.user) {
                            const studentDetail = result.data.user;
                            console.log('üéì Detalles de estudiante encontrados:', studentDetail);
                            
                            // Buscar career_id por careerName si es necesario
                            let careerIdValue = studentDetail.career_id || '';
                            if (!careerIdValue && studentDetail.careerName) {
                                const foundCareer = this.careers.find(c => c.name === studentDetail.careerName || c.career_name === studentDetail.careerName);
                                careerIdValue = foundCareer ? foundCareer.id : '';
                            }
                            
                            // Asignar datos de estudiante
                            Object.assign(this.newUser.studentDetail, {
                                user_id: studentDetail.user_id || userId,
                                career_id: careerIdValue,
                                n_control: studentDetail.n_control || '',
                                semestre: studentDetail.semestre || 1,
                                group: studentDetail.group || '',
                                workshop: studentDetail.workshop || ''
                            });
                            
                            // Marcar que el usuario tiene detalles de estudiante
                            this.hasStudentDetails = true;
                            console.log('‚úÖ Datos de estudiante cargados en el formulario:', this.newUser.studentDetail);
                        } else {
                            console.log('‚ÑπÔ∏è El usuario no es estudiante o sin detalles acad√©micos');
                            this.hasStudentDetails = false;
                            // Mantener studentDetail como objeto vac√≠o
                            Object.assign(this.newUser.studentDetail, {
                                user_id: userId,
                                career_id: '',
                                n_control: '',
                                semestre: 1,
                                group: '',
                                workshop: ''
                            });
                        }
                    } else if (response.status === 404) {
                        console.log('‚ÑπÔ∏è No hay detalles de estudiante para este usuario');
                        this.hasStudentDetails = false;
                        Object.assign(this.newUser.studentDetail, {
                            user_id: userId,
                            career_id: '',
                            n_control: '',
                            semestre: 1,
                            group: '',
                            workshop: ''
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Error al cargar detalles de estudiante:', error);
                }
            },

            async viewUserDetails(userId) {
                const resolvedUserId = (userId && typeof userId === 'object') ? userId.id : userId;
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                if (!resolvedUserId) {
                    this.showNotify('No se pudo identificar el usuario', 'error');
                    return;
                }

                try {
                    console.log(`üîç Obteniendo detalles completos del usuario ID: ${resolvedUserId}`);
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/show-users/${resolvedUserId}`,
                        { method: 'GET' }
                    );

                    if (response.ok) {
                        const result = await response.json();
                        console.log('üì¶ Detalles completos del usuario:', result);
                        
                        if (result.success && result.data && result.data.user) {
                            const userDetails = result.data.user;
                            
                            // Mostrar detalles en consola
                            console.log('üë§ Informaci√≥n B√°sica:', userDetails.basicInfo);
                            console.log('üé≠ Roles:', userDetails.roles);
                            console.log('üîí Permisos:', userDetails.permissions);
                            if (userDetails.studentDetail) {
                                console.log('üéì Detalles de Estudiante:', userDetails.studentDetail);
                            }

                            const detailSources = [
                                userDetails,
                                userDetails?.basicInfo || {},
                                userDetails?.profile || {},
                                userDetails?.extraData || userDetails?.extra_data || {}
                            ];

                            const resolvedEmail = this.getFirstDetailValue(detailSources, ['email', 'correo']);
                            
                            // Mostrar notificaci√≥n
                            this.userDetailsPreview = {
                                show: true,
                                userId: userDetails?.id || resolvedUserId,
                                email: resolvedEmail || userDetails?.email || '',
                                roles: Array.isArray(userDetails?.roles) ? userDetails.roles : [],
                                permissions: Array.isArray(userDetails?.permissions) ? userDetails.permissions : [],
                                extraDetails: this.buildUserExtraDetails(userDetails)
                            };

                            this.showNotify('Detalles de usuario cargados', 'success');
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        this.showNotify(errorData.message || 'Error al cargar detalles', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al cargar detalles:', error);
                    this.showNotify('Error de conexi√≥n', 'error');
                }
            },

            closePanel() { 
                this.isPanelOpen = false;
                this.hasStudentDetails = false;
            },

            async saveUser() {
                this.isSaving = true;
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    this.isSaving = false;
                    return;
                }
                
                try {
                    // Validar campos requeridos en creaci√≥n
                    if (!this.isEditing) {
                        const requiredFields = ['name', 'last_name', 'email', 'phone_number', 'birthdate', 'gender', 'curp'];
                        const missing = requiredFields.filter(f => !this.newUser[f]);
                        if (missing.length > 0) {
                            this.showNotify(`Campos requeridos: ${missing.join(', ')}`, 'error');
                            this.isSaving = false;
                            return;
                        }
                    }
                    
                    // Construir payload
                    const userData = {
                        name: this.newUser.name || undefined,
                        last_name: this.newUser.last_name || undefined,
                        email: this.newUser.email || undefined,
                        phone_number: this.newUser.phone_number || undefined,
                        birthdate: this.normalizeDate(this.newUser.birthdate) || undefined,
                        gender: this.newUser.gender || undefined,
                        curp: this.newUser.curp || undefined,
                        address: this.newUser.address || undefined,
                        role: this.normalizeRoleForApi(this.newUser.role) || undefined
                    };
                    
                    // En creaci√≥n, agregar blood_type
                    if (!this.isEditing) {
                        userData.blood_type = this.newUser.blood_type || 'O+';
                    }
                    
                    // Eliminar claves undefined para no enviar campos vac√≠os
                    Object.keys(userData).forEach(k => userData[k] === undefined && delete userData[k]);
                    
                    if (this.isEditing) {
                        console.log('üîÑ Actualizando usuario ID:', this.newUser.id);
                        console.log('üì§ Payload enviado:', JSON.stringify(userData, null, 2));
                        
                        // Attempt actual update
                        const response = await this.authenticatedFetch(
                            `${this.apiBaseUrl}/v1/admin-actions/update-user/${this.newUser.id}`,
                            {
                                method: 'PUT',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'X-User-Role': 'admin',
                                    'X-User-Permission': 'update.users'
                                },
                                body: JSON.stringify(userData)
                            }
                        );
                        let result = {};
                        try {
                            result = await response.json();
                        } catch (_) {
                            result = {};
                        }

                        if (response.ok && result.success) {
                            const updatedUser = this.mapUser(result.data?.user || result.data || result);
                            const index = this.users.findIndex(u => u.id === this.newUser.id);
                            if (index !== -1) this.users[index] = updatedUser;
                            
                            // Guardar datos de estudiante si existen
                            if (this.newUser.studentDetail) {
                                await this.saveStudentDetailsFromEditPanel();
                            }
                            
                            this.showNotify(result.message || 'Usuario actualizado');
                            this.closePanel();
                        } else {
                            console.error('‚ùå Error al actualizar usuario:', {
                                status: response.status,
                                statusText: response.statusText,
                                result: result,
                                errors: result.errors
                            });
                            console.error('üìã Response body completo:', result);
                            
                            // Mostrar errores de validaci√≥n si existen
                            let msg = result.message || result.error || `Error ${response.status}`;
                            if (result.errors) {
                                const errorList = Object.entries(result.errors)
                                    .map(([field, msgs]) => `${field}: ${Array.isArray(msgs) ? msgs.join(', ') : msgs}`)
                                    .join('; ');
                                msg = errorList || msg;
                            }
                            // Si es error 500 sin mensaje, sugerir contactar soporte
                            if (response.status === 500) {
                                msg = (msg && msg !== 'Error 500') ? msg : 'Error interno del servidor. Contacte al soporte.';
                            }
                            this.showNotify(msg, 'error');
                        }
                    } else {
                        // Creaci√≥n de nuevo usuario
                        // Agregar campos requeridos para registro
                        userData.registration_date = this.normalizeDate(this.newUser.registration_date) || new Date().toISOString().split('T')[0];
                        userData.status = this.newUser.status || 'activo';
                        userData.address = this.newUser.address || ['', '', ''];
                        userData.blood_type = this.newUser.blood_type || 'O+';
                        
                        // NO generar password - el backend lo hace autom√°ticamente
                        // Formatear tel√©fono con +52 si no lo tiene
                        if (userData.phone_number && !userData.phone_number.startsWith('+52')) {
                            userData.phone_number = '+52' + userData.phone_number.replace(/\D/g, '');
                        }
                        
                        console.log('üì§ Enviando datos de nuevo usuario:');
                        console.log(JSON.stringify(userData, null, 2));
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);
                        const response = await fetch(`${this.apiBaseUrl}/v1/admin-actions/register`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json', 
                                'Accept': 'application/json',
                                'Authorization': `Bearer ${token}`,
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'create.user'
                            },
                            body: JSON.stringify(userData),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const result = await response.json();
                        
                        console.log('üì• Respuesta del servidor:');
                        console.log(JSON.stringify(result, null, 2));
                        
                        if (response.status === 201 && result.success) {
                            const newUser = this.mapUser(result.data?.user || result.data || result || userData);
                            this.users.push(newUser);
                            this.showNotify(result.message || 'Usuario creado correctamente');
                            this.closePanel();
                        } else {
                            console.error('‚ùå Error de validaci√≥n:', result);
                            const errorMsg = result.message || 'Error al crear usuario';
                            const errors = result.errors ? '\n' + Object.entries(result.errors).map(([k,v]) => `${k}: ${v.join(', ')}`).join('\n') : '';
                            this.showNotify(errorMsg + errors, 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error en saveUser:', error);
                    if (error.name === 'AbortError') {
                        this.showNotify('La solicitud tard√≥ demasiado', 'error');
                    } else {
                        this.showNotify(`Error de conexi√≥n: ${error.message}`, 'error');
                    }
                } finally {
                    this.isSaving = false;
                }
            },

            async saveStudentDetailsFromEditPanel() {
                const token = localStorage.getItem('access_token');
                if (!token || !this.newUser.studentDetail) {
                    console.log('‚ö†Ô∏è No hay datos de estudiante para guardar');
                    return;
                }

                try {
                    const studentData = this.newUser.studentDetail;
                    
                    // Verificar si el estudiante ya existe
                    const checkResponse = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/get-student/${studentData.user_id}`,
                        { method: 'GET' }
                    );

                    if (checkResponse.ok) {
                        // Actualizar estudiante existente
                        console.log('üîÑ Actualizando detalles de estudiante...');
                        const updateResponse = await this.authenticatedFetch(
                            `${this.apiBaseUrl}/v1/admin-actions/update-student/${studentData.user_id}`,
                            {
                                method: 'PATCH',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'X-User-Role': 'admin',
                                    'X-User-Permission': 'update.student'
                                },
                                // Incluimos n_control y semestre para permitir editar tambi√©n esos campos
                                body: JSON.stringify({
                                    career_id: studentData.career_id,
                                    n_control: studentData.n_control,
                                    semestre: studentData.semestre,
                                    group: studentData.group,
                                    workshop: studentData.workshop
                                })
                            }
                        );

                        if (updateResponse.ok) {
                            console.log('‚úÖ Detalles de estudiante actualizados');
                        } else {
                            console.error('‚ùå Error al actualizar detalles de estudiante');
                        }
                    } else {
                        // Crear nuevo registro de estudiante
                        console.log('‚ûï Creando nuevo registro de estudiante...');
                        const createResponse = await this.authenticatedFetch(
                            `${this.apiBaseUrl}/v1/admin-actions/attach-student`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(studentData)
                            }
                        );

                        if (createResponse.ok) {
                            console.log('‚úÖ Detalles de estudiante creados');
                        } else {
                            console.error('‚ùå Error al crear detalles de estudiante');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error al guardar detalles de estudiante:', error);
                }
            },

            confirmDeleteUser(user) {
                this.userToDeleteId = user.id;
                this.userToDeleteName = `${user.name} ${user.last_name}`;
                this.isDeleting = true;
            },

            async deleteUser(id) {
                if (!id) {
                    console.error('‚ùå ID undefined en deleteUser');
                    this.showNotify('Error: ID de usuario no v√°lido', 'error');
                    this.isDeleting = false;
                    return;
                }
                
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    this.isDeleting = false;
                    return;
                }
                
                try {
                    const endpoint = `${this.apiBaseUrl}/v1/admin-actions/delete-users`;
                    console.log('========================================');
                    console.log('üóëÔ∏è ELIMINANDO USUARIO');
                    console.log('========================================');
                    console.log('üë§ Usuario ID:', id);
                    console.log('üìç Endpoint:', endpoint);
                    console.log('üîë Token (primeros 30 chars):', token.substring(0, 30) + '...');
                    console.log('üì° M√©todo: POST');
                    console.log('üì¶ Payload:', JSON.stringify({ ids: [id] }));
                    console.log('‚è∞ Timestamp:', new Date().toISOString());
                    
                    const response = await this.authenticatedFetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'X-User-Role': 'admin',
                            'X-User-Permission': 'delete.users'
                        },
                        body: JSON.stringify({ ids: [id] })
                    });
                    
                    console.log('üì° Status recibido:', response.status);
                    console.log('üì° Status ok:', response.ok);
                    
                    const result = await response.json();
                    console.log('üì¶ Respuesta completa:', JSON.stringify(result, null, 2));
                    
                    if (response.ok) {
                        console.log('‚úÖ Usuario marcado como eliminado');
                        this.showNotify(result.message || 'Usuario eliminado correctamente', 'success');
                        // Recargar lista para reflejar cambios
                        await this.loadUsers(token);
                    } else if (response.status === 409) {
                        // Usuario ya estaba eliminado, removerlo de la lista
                        console.log('‚ö†Ô∏è Usuario ya estaba eliminado, removiendo de la lista');
                        this.users = this.users.filter(u => u.id !== id);
                        this.showNotify('Usuario ya estaba eliminado', 'success');
                    } else {
                        console.error('‚ùå Error al eliminar:', response.status, result);
                        this.showNotify(result.message || 'Error al eliminar usuario', 'error');
                    }
                    console.log('========================================');
                } catch (error) {
                    console.error('‚ùå Error en deleteUser:', error);
                    this.showNotify(`Error al eliminar: ${error.message}`, 'error');
                }
                this.isDeleting = false;
            },

            openImportModal() { this.isImporting = true; },
            closeImportModal() { this.isImporting = false; },

            handleFileDrop(event) {
                const file = event.dataTransfer?.files[0];
                if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                    this.selectedFile = file;
                    this.readExcelFile(file);
                }
            },

            handleFileSelect(event) {
                const file = event.target.files?.[0];
                if (file) {
                    this.selectedFile = file;
                    this.readExcelFile(file);
                }
            },

            readExcelFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target?.result);
                        const workbook = window.XLSX.read(data, { type: 'array' });
                        const rows = window.XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        this.importedData = rows.map(row => ({
                            name: row.name || '',
                            last_name: row.last_name || '',
                            email: row.email || '',
                            phone_number: row.phone_number || '',
                            birthdate: row.birthdate || '',
                            gender: row.gender || 'hombre',
                            curp: row.curp || '',
                            address: [row.address_line1 || '', row.address_line2 || '', row.address_line3 || ''],
                            blood_type: row.blood_type || 'O+',
                            registration_date: new Date().toISOString().split('T')[0],
                            status: 'activo',
                            role: row.role || 'Maestro'
                        }));
                    } catch (error) { this.showNotify('Error al leer Excel', 'error'); }
                };
                reader.readAsArrayBuffer(file);
            },

            async processImport() {
                if (!this.selectedFile) {
                    this.showNotify('Selecciona un archivo Excel', 'error');
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    this.isSaving = true;
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);

                    const response = await fetch(`${this.apiBaseUrl}/v1/admin-actions/import`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json',
                            'X-User-Role': 'admin',
                            'X-User-Permission': 'import.users'
                        },
                        body: formData
                    });

                    const result = await response.json();
                    console.log('üì• Resultado de importaci√≥n:', result);
                    
                    if (response.ok && result.success) {
                        const summary = result.data?.summary?.summary;
                        const hasErrors = result.data?.summary?.has_errors;
                        const hasWarnings = result.data?.summary?.has_warnings;
                        
                        // Mostrar resumen b√°sico
                        const message = hasErrors
                            ? `‚ö†Ô∏è Importaci√≥n con errores: ${summary?.rows_inserted || 0} insertados, ${summary?.rows_failed || 0} fallidos`
                            : `‚úÖ Importaci√≥n completada: ${summary?.rows_inserted || 0} usuarios importados`;
                        
                        this.showNotify(message, hasErrors ? 'error' : 'success');
                        
                        // Si hay errores o warnings, mostrar modal con detalles
                        if (hasErrors || hasWarnings) {
                            const errorDetails = result.data?.summary?.errors;
                            const warnings = result.data?.summary?.warnings;
                            
                            // Construir mensaje detallado
                            let detailedMessage = `Resumen de importaci√≥n:\n\n`;
                            detailedMessage += `‚úÖ Filas procesadas: ${summary?.rows_processed || 0}\n`;
                            detailedMessage += `‚úÖ Filas insertadas: ${summary?.rows_inserted || 0}\n`;
                            detailedMessage += `‚ùå Filas fallidas: ${summary?.rows_failed || 0}\n`;
                            detailedMessage += `üìä Tasa de √©xito: ${summary?.success_rate || 0}%\n\n`;
                            
                            if (errorDetails?.row_errors?.length > 0) {
                                detailedMessage += `Errores por fila:\n`;
                                errorDetails.row_errors.slice(0, 5).forEach(err => {
                                    detailedMessage += `- Fila ${err.row_number}: ${err.message}\n`;
                                });
                                if (errorDetails.row_errors.length > 5) {
                                    detailedMessage += `... y ${errorDetails.row_errors.length - 5} errores m√°s.\n`;
                                }
                            }
                            
                            this.showError(
                                hasErrors ? '‚ö†Ô∏è Importaci√≥n con Errores' : '‚ÑπÔ∏è Importaci√≥n con Advertencias',
                                detailedMessage,
                                {
                                    summary: summary,
                                    errors: errorDetails,
                                    warnings: warnings,
                                    timestamp: result.data?.summary?.timestamp
                                }
                            );
                        }
                        
                        this.closeImportModal();
                        await this.loadUsers(token);
                    } else {
                        // Error general de la API
                        this.showError(
                            '‚ùå Error al Importar Usuarios',
                            result.message || 'Error al importar usuarios',
                            {
                                error_code: result.error_code,
                                status: response.status,
                                errors: result.errors
                            }
                        );
                    }
                } catch (error) {
                    console.error('‚ùå Error al importar:', error);
                    
                    this.showError(
                        '‚ùå Error de Importaci√≥n',
                        'No fue posible importar los usuarios. Verifica el archivo y intenta nuevamente.'
                    );
                } finally {
                    this.isSaving = false;
                }
            },

            downloadTemplate() {
                const template = [{
                    name: 'Juan',
                    last_name: 'P√©rez L√≥pez',
                    email: 'juan.perez@example.com',
                    phone_number: '5512345678',
                    birthdate: '2000-05-12',
                    gender: 'hombre',
                    curp: 'PELJ000512HDFRPN09',
                    street: 'Calle Hidalgo #123',
                    city: 'Col. Centro',
                    state: 'CDMX',
                    zip_code: '06000',
                    stripe_customer_id: '',
                    blood_type: 'O+',
                    registration_date: '2025-01-01',
                    status: 'activo',
                    career_id: 1,
                    n_control: '20250001',
                    semestre: 1,
                    group: 'A',
                    workshop: 'Programaci√≥n'
                }];
                const ws = window.XLSX.utils.json_to_sheet(template);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, 'Usuarios');
                window.XLSX.writeFile(wb, 'plantilla_usuarios_completos.xlsx');
            },

            showNotify(msg, type = 'success') {
                this.notification = { show: true, message: msg, type };
                setTimeout(() => this.notification.show = false, 3000);
            },

            showError(title, message, details = null) {
                this.errorModalTitle = title || 'Error';
                this.errorModalMessage = message || 'Ha ocurrido un error';
                this.errorModalDetails = details;
                this.showErrorModal = true;
                
                // Tambi√©n mostrar en consola para debugging
                console.error('üö® Error Modal:', { title, message, details });
            },

            async testAuth() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('‚ùå No hay token de autenticaci√≥n');
                    return;
                }

                console.log('üß™ PROBANDO AUTENTICACI√ìN...');
                console.log('üìç Endpoint: /v1/test-auth');
                console.log('üîë Token:', token.substring(0, 30) + '...');

                try {
                    const response = await fetch(`${this.apiBaseUrl}/v1/test-auth`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    console.log('üì° Status:', response.status);
                    const data = await response.json();
                    console.log('üì¶ Response:', data);

                    if (response.ok) {
                        alert(`‚úÖ Autenticaci√≥n funcionando!\n\nUsuario: ${data.user.name}\nEmail: ${data.user.email}\nRoles: ${data.user.roles.join(', ')}`);
                    } else {
                        alert(`‚ùå Error ${response.status}\n\n${JSON.stringify(data, null, 2)}`);
                    }
                } catch (error) {
                    console.error('‚ùå Error:', error);
                    alert(`‚ùå Error de red: ${error.message}`);
                }
            },

            // ==================== GESTI√ìN DE ESTUDIANTES ====================
            
            async openStudentPanel(userId) {
                // Si no se proporciona userId, usar el primer usuario seleccionado
                if (!userId) {
                    if (this.selectedUsers.length === 0) {
                        this.showNotify('Selecciona un usuario desde la tabla', 'error');
                        return;
                    }
                    userId = this.selectedUsers[0];
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                // Obtener los datos del usuario para mostrar en la modal
                const normalizedUserId = Number(userId);
                this.currentStudentUser = this.users.find(u => Number(u.id) === normalizedUserId) || null;
                this.hasStudentDetails = false;

                // Asegurar que las carreras est√©n cargadas antes de mostrar el modal
                await this.loadCareers();
                
                try {
                    // SIEMPRE consultar el backend primero para obtener datos frescos
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/get-student/${normalizedUserId}`,
                        {
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'view.student'
                            }
                        }
                    );
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        const student = result.data?.student_details || {};
                        
                        // Usar los datos del backend directamente
                        this.studentDetails = {
                            user_id: normalizedUserId,
                            career_id: student.career_id || '',
                            n_control: student.n_control || '',
                            semestre: student.semestre || 1,
                            group: student.group || '',
                            workshop: student.workshop || ''
                        };
                        this.hasStudentDetails = Boolean(
                            String(student.n_control || '').trim()
                            || String(student.career_id || '').trim()
                        );
                    } else if (response.status === 404) {
                        // No tiene detalles a√∫n, crear uno nuevo (con fallback desde tabla si existe)
                        this.studentDetails = {
                            user_id: normalizedUserId,
                            career_id: this.currentStudentUser?.career_id || '',
                            n_control: this.currentStudentUser?.n_control || '',
                            semestre: this.currentStudentUser?.semestre || 1,
                            group: this.currentStudentUser?.group || '',
                            workshop: this.currentStudentUser?.workshop || ''
                        };
                        this.hasStudentDetails = false;
                    } else {
                        // Error inesperado
                        throw new Error(`Error ${response.status} al consultar detalles`);
                    }
                    
                    this.showStudentModal = true;
                } catch (error) {
                    this.showNotify(`Error al cargar detalles: ${error.message}`, 'error');
                }
            },

            async saveStudentDetails() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                if (!this.studentDetails.user_id) {
                    this.showNotify('Usuario no v√°lido', 'error');
                    return;
                }

                if (!this.studentDetails.career_id || !this.studentDetails.n_control) {
                    this.showNotify('Completa carrera y n√∫mero de control', 'error');
                    return;
                }

                try {
                    this.isSaving = true;
                    
                    // Verificar si ya tiene detalles (UPDATE) o es nuevo (ATTACH)
                    const checkResponse = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/get-student/${this.studentDetails.user_id}`,
                        {
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'view.student'
                            }
                        }
                    );

                    let endpoint, method, permission, payload;
                    if (checkResponse.ok) {
                        // Ya existe, actualizar (PATCH - solo career_id, group, workshop)
                        endpoint = `${this.apiBaseUrl}/v1/admin-actions/update-student/${this.studentDetails.user_id}`;
                        method = 'PATCH';
                        permission = 'update.student';
                        payload = {
                            career_id: Number(this.studentDetails.career_id)
                        };
                        // Solo incluir campos opcionales si tienen valor
                        if (this.studentDetails.group && String(this.studentDetails.group).trim()) {
                            payload.group = String(this.studentDetails.group).trim();
                        }
                        if (this.studentDetails.workshop && String(this.studentDetails.workshop).trim()) {
                            payload.workshop = String(this.studentDetails.workshop).trim();
                        }
                    } else {
                        // No existe, crear (POST - requiere user_id, career_id, n_control, semestre)
                        endpoint = `${this.apiBaseUrl}/v1/admin-actions/attach-student`;
                        method = 'POST';
                        permission = 'attach.student';
                        payload = {
                            user_id: Number(this.studentDetails.user_id),
                            career_id: Number(this.studentDetails.career_id),
                            n_control: String(this.studentDetails.n_control).trim(),
                            semestre: Number(this.studentDetails.semestre)
                        };
                        // Solo incluir campos opcionales si tienen valor
                        if (this.studentDetails.group && String(this.studentDetails.group).trim()) {
                            payload.group = String(this.studentDetails.group).trim();
                        }
                        if (this.studentDetails.workshop && String(this.studentDetails.workshop).trim()) {
                            payload.workshop = String(this.studentDetails.workshop).trim();
                        }
                    }

                    console.log(`üì§ ${method} ${endpoint}`);
                    console.log('üì¶ Payload completo:', JSON.stringify(payload, null, 2));

                    const response = await this.authenticatedFetch(endpoint, {
                        method,
                        headers: {
                            'X-User-Role': 'admin',
                            'X-User-Permission': permission
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    console.log('üì• Status:', response.status);
                    console.log('üì• Respuesta completa:', JSON.stringify(result, null, 2));

                    if (response.ok && result.success) {
                        this.showNotify(result.message || 'Detalles de estudiante guardados', 'success');
                        this.showStudentModal = false;
                        
                        // Obtener los datos completos del usuario para enviar con el evento
                        const studentUser = this.users.find(u => u.id === this.studentDetails.user_id);
                        console.log('üîç Buscando usuario con ID:', this.studentDetails.user_id);
                        console.log('üë• Usuarios disponibles:', this.users);
                        console.log('‚úì Usuario encontrado:', studentUser);
                        
                        // Obtener el nombre de la carrera
                        const careerData = this.careers.find(c => c.id === Number(this.studentDetails.career_id) || c.name === this.studentDetails.career_id);
                        const careerName = careerData?.name || this.studentDetails.career_id;
                        console.log('üè´ Carrera encontrada:', careerData, 'Nombre:', careerName);
                        
                        if (studentUser) {
                            const studentData = {
                                id: studentUser.id,
                                numControl: this.studentDetails.n_control,
                                nombre: studentUser.nombre || studentUser.name || '',
                                apellidoP: studentUser.apellidoP || studentUser.apellidoPaterno || studentUser.apellido_paterno || '',
                                apellidoM: studentUser.apellidoM || studentUser.apellidoMaterno || studentUser.apellido_materno || '',
                                semestre: Number(this.studentDetails.semestre),
                                carrera: careerName,
                                correo: studentUser.correo || studentUser.email || '',
                                group: this.studentDetails.group || '',
                                workshop: this.studentDetails.workshop || ''
                            };
                            
                            console.log('üì¶ Datos del estudiante a enviar:', studentData);
                            
                            // Guardar en localStorage tambi√©n para sincronizaci√≥n persistente
                            try {
                                let studentsList = [];
                                const stored = localStorage.getItem('studentsList');
                                if (stored) {
                                    try {
                                        studentsList = JSON.parse(stored);
                                        if (!Array.isArray(studentsList)) studentsList = [];
                                    } catch (e) {
                                        studentsList = [];
                                    }
                                }
                                
                                // Buscar si ya existe
                                const existingIndex = studentsList.findIndex(s => s.id === studentData.id);
                                if (existingIndex !== -1) {
                                    // Actualizar
                                    studentsList[existingIndex] = studentData;
                                    console.log('üíæ Estudiante actualizado en localStorage');
                                } else {
                                    // Agregar nuevo
                                    studentsList.unshift(studentData);
                                    console.log('üíæ Nuevo estudiante guardado en localStorage');
                                }
                                
                                localStorage.setItem('studentsList', JSON.stringify(studentsList));
                                console.log('‚úÖ StudentList actualizado en localStorage');
                            } catch (storageError) {
                                console.warn('‚ö†Ô∏è Error al guardar en localStorage:', storageError);
                            }
                            
                            // Enviar evento personalizado a estudiante_lista.astro
                            window.dispatchEvent(new CustomEvent('student-associated', {
                                detail: {
                                    student: studentData,
                                    action: checkResponse.ok ? 'update' : 'create'
                                }
                            }));
                            console.log('üì¢ Evento student-associated enviado:', studentData);
                        } else {
                            console.warn('‚ö†Ô∏è No se encontr√≥ el usuario, posible sincronizaci√≥n lenta');
                        }
                        
                        await this.loadUsers(token);
                    } else {
                        console.error('‚ùå Error desde API:', JSON.stringify(result, null, 2));
                        
                        // Mostrar errores de validaci√≥n detallados
                        if (result.errors) {
                            const errorMessages = Object.entries(result.errors)
                                .map(([field, msgs]) => `${field}: ${msgs.join(', ')}`)
                                .join('\n');
                            console.error('üìã Errores de validaci√≥n:\n' + errorMessages);
                            this.showNotify(`Error de validaci√≥n:\n${errorMessages}`, 'error');
                        } else {
                            this.showNotify(result.message || `Error: ${response.status}`, 'error');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error al guardar estudiante:', error);
                    this.showNotify('Error al guardar detalles del estudiante', 'error');
                } finally {
                    this.isSaving = false;
                }
            },

            // ==================== GESTI√ìN DE CARRERAS ====================

            openCareerModal() {
                this.careerForm = { career_name: '' };
                this.careerError = '';
                this.loadCareers();
                this.showCareerModal = true;
            },

            closeCareerModal() {
                this.showCareerModal = false;
                this.careerError = '';
                this.resetCareerForm();
            },

            startEditCareer(career) {
                this.careerEditingId = career.id;
                this.careerForm = { career_name: career.career_name };
                this.careerError = '';
                this.showCareerModal = true;
            },

            resetCareerForm() {
                this.careerEditingId = null;
                this.careerForm = { career_name: '' };
                this.careerError = '';
            },

            async saveCareer() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                const careerName = (this.careerForm.career_name || '').trim();
                if (!careerName) {
                    this.careerError = 'Ingresa el nombre de la carrera';
                    return;
                }

                this.isSavingCareer = true;
                this.careerError = '';

                try {
                    const isEditing = !!this.careerEditingId;
                    const url = isEditing
                        ? `${this.apiBaseUrl}/v1/careers/${this.careerEditingId}`
                        : `${this.apiBaseUrl}/v1/careers`;
                    const method = isEditing ? 'PATCH' : 'POST';

                    console.log(`üì§ ${isEditing ? 'Actualizando' : 'Creando'} carrera:`, { url, method, careerName });

                    const response = await this.authenticatedFetch(url, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Role': 'admin'
                        },
                        body: JSON.stringify({ career_name: careerName })
                    });

                    console.log(`üì• Respuesta del servidor (status: ${response.status}):`, response);
                    
                    let result = {};
                    try {
                        result = await response.json();
                        console.log('üì¶ JSON respuesta:', result);
                    } catch (parseError) {
                        console.error('‚ùå Error al parsear JSON:', parseError);
                        result = { success: false, message: 'Error al procesar respuesta del servidor' };
                    }

                    if ((response.status === 201 || response.status === 200) && result.success) {
                        const updated = result.data?.updated || result.data?.career || result.data;
                        if (isEditing) {
                            this.showNotify(result.message || 'Carrera actualizada', 'success');
                            if (updated?.id) {
                                this.careers = this.careers.map(c =>
                                    c.id === updated.id
                                        ? { ...c, career_name: updated.career_name || careerName }
                                        : c
                                );
                            }
                            this.closeCareerModal();
                        } else {
                            this.showNotify(result.message || 'Carrera creada exitosamente', 'success');
                            if (updated) {
                                // Mantener la lista actualizada sin recargar
                                this.careers = [{ id: updated.id, career_name: updated.career_name }, ...this.careers];
                            }
                            this.closeCareerModal();
                        }
                    } else if (response.status === 404) {
                        this.careerError = 'Carrera no encontrada. ID inv√°lido o no existe.';
                        this.showNotify(this.careerError, 'error');
                    } else if (response.status === 409) {
                        const message = result.message || 'La carrera ya existe';
                        this.careerError = message;
                        this.showNotify(message, 'error');
                    } else if (response.status === 422) {
                        const validation = result.errors ? Object.entries(result.errors).map(([k,v]) => `${k}: ${Array.isArray(v) ? v.join(', ') : v}`).join('; ') : '';
                        const message = validation || result.message || 'Error de validaci√≥n';
                        this.careerError = message;
                        this.showNotify(message, 'error');
                    } else if (response.status === 500) {
                        console.error('‚ùå Error 500 del servidor:', result);
                        const errMsg = result.message || 'Error interno del servidor';
                        this.careerError = errMsg;
                        this.showNotify(errMsg + (result.error_detail ? ' - ' + result.error_detail : ''), 'error');
                    } else {
                        const validation = result.errors ? Object.values(result.errors).flat().join(', ') : '';
                        const message = validation || result.message || 'Error al guardar la carrera';
                        this.careerError = message;
                        this.showNotify(message, 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al guardar carrera:', error);
                    this.careerError = 'Error de conexi√≥n: ' + error.message;
                    this.showNotify(this.careerError, 'error');
                } finally {
                    this.isSavingCareer = false;
                }
            },

            async loadCareers(forceRefresh = false) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                this.isLoadingCareers = true;
                try {
                    const url = forceRefresh
                        ? `${this.apiBaseUrl}/v1/careers?forceRefresh=true`
                        : `${this.apiBaseUrl}/v1/careers`;
                    const response = await this.authenticatedFetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'X-User-Role': 'admin'
                        }
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        this.careers = result.data?.careers || result.data || [];
                    } else if (response.status === 429) {
                        this.showNotify('Demasiadas solicitudes, intenta de nuevo en unos segundos', 'error');
                    } else {
                        this.careers = [];
                        this.showNotify(result.message || 'No se pudieron cargar las carreras', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al cargar carreras:', error);
                    this.showNotify('Error al cargar carreras', 'error');
                } finally {
                    this.isLoadingCareers = false;
                }
            },

            async deleteCareer(id) {
                if (!id) return;

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                if (!confirm('¬øEliminar esta carrera? Esta acci√≥n es irreversible.')) {
                    return;
                }

                this.careerDeletingId = id;
                try {
                    const response = await this.authenticatedFetch(`${this.apiBaseUrl}/v1/careers/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Accept': 'application/json',
                            'X-User-Role': 'admin'
                        }
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        this.careers = this.careers.filter(c => c.id !== id);
                        this.showNotify(result.message || 'Carrera eliminada con √©xito', 'success');
                    } else {
                        this.showNotify(result.message || 'No se pudo eliminar la carrera', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al eliminar carrera:', error);
                    this.showNotify('Error al eliminar la carrera', 'error');
                } finally {
                    this.careerDeletingId = null;
                }
            },

            // ==================== GESTI√ìN DE ROLES ====================

            async openRolesPanel() {
                if (this.selectedUsers.length === 0) {
                    this.showNotify('Selecciona al menos un usuario', 'error');
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    await this.loadAvailableRolesForFilter(true);

                    if (!this.availableRoles.length) {
                        this.showNotify('No se pudieron cargar roles disponibles', 'error');
                        return;
                    }

                    this.rolesToAdd = [];
                    this.rolesToRemove = [];
                    this.showRolesModal = true;
                } catch (error) {
                    console.error('‚ùå Error al cargar roles:', error);
                    this.showNotify('Error al cargar roles disponibles', 'error');
                }
            },

            async updateRoles() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                // VALIDACI√ìN MEJORADA: Verificar que haya roles seleccionados
                if (this.rolesToAdd.length === 0 && this.rolesToRemove.length === 0) {
                    this.showError(
                        '‚ö†Ô∏è Roles No Seleccionados',
                        'Debes seleccionar al menos un rol para agregar O eliminar antes de actualizar.',
                        {
                            soluci√≥n: 'Marca uno o m√°s checkboxes en las columnas "Agregar Roles" o "Eliminar Roles"',
                            rolesToAdd: this.rolesToAdd,
                            rolesToRemove: this.rolesToRemove
                        }
                    );
                    return;
                }

                try {
                    this.isSaving = true;

                    // Obtener CURPs de usuarios seleccionados, filtrando aquellos sin CURP v√°lido
                    const curps = this.users
                        .filter(u => this.selectedUsers.includes(u.id))
                        .map(u => u.curp)
                        .filter(curp => curp && curp !== 'N/A' && curp.length === 18);

                    if (curps.length === 0) {
                        this.showNotify('Los usuarios seleccionados no tienen CURP v√°lido (18 caracteres)', 'error');
                        this.isSaving = false;
                        return;
                    }

                    // üîç VALIDACI√ìN: Detectar roles duplicados entre add y remove
                    const duplicateRoles = this.rolesToAdd.filter(role => this.rolesToRemove.includes(role));
                    
                    if (duplicateRoles.length > 0) {
                        this.showError(
                            '‚ö†Ô∏è Conflicto de Roles',
                            `Los siguientes roles est√°n marcados para agregar Y eliminar: ${duplicateRoles.join(', ')}`,
                            {
                                duplicates: duplicateRoles,
                                suggestion: 'Desmarca el rol de una de las columnas (Agregar o Eliminar)'
                            }
                        );
                        this.isSaving = false;
                        return;
                    }

                    console.log('üì§ updateRoles - Enviando:');
                    console.log('  CURPs v√°lidos:', curps);
                    console.log('  Roles para agregar (before filter):', this.rolesToAdd);
                    console.log('  Roles para eliminar (before filter):', this.rolesToRemove);

                    // Asegurar que siempre sean arrays y filtrar strings vac√≠os y __NO_ROLE__
                    const rolesToAdd = (Array.isArray(this.rolesToAdd) ? this.rolesToAdd : [])
                        .filter(r => r && r.trim() !== '' && r !== '__NO_ROLE__');
                    const rolesToRemove = (Array.isArray(this.rolesToRemove) ? this.rolesToRemove : [])
                        .filter(r => r && r.trim() !== '' && r !== '__NO_ROLE__');
                    
                    console.log('  Roles para agregar (after filter):', rolesToAdd);
                    console.log('  Roles para eliminar (after filter):', rolesToRemove);

                    // Usar AdminAPI para actualizar roles
                    const result = await window.AdminAPI.updateMultipleUsersRoles(
                        curps,
                        rolesToAdd,
                        rolesToRemove,
                        token
                    );

                    console.log('üì• updateRoles - Respuesta:', result);

                    if (result.success) {
                        const summary = result.data?.users_roles?.summary;
                        const totalUpdated = summary?.totalUpdated || curps.length;
                        const totalFailed = summary?.totalFailed || 0;
                        
                        let message = `‚úÖ Roles actualizados: ${totalUpdated} usuario(s) afectado(s)`;
                        if (totalFailed > 0) {
                            message += ` (${totalFailed} fallido(s))`;
                        }
                        
                        this.showNotify(message, totalFailed > 0 ? 'warning' : 'success');
                        this.showRolesModal = false;
                        this.selectedUsers = [];
                        await this.loadUsers(token);
                    } else {
                        console.error('‚ùå Error en respuesta:', result);
                        
                        // Log detailed validation errors
                        if (result.errors) {
                            console.error('üìã Validation Errors:', result.errors);
                        }
                        
                        this.showError(
                            '‚ùå Error al Actualizar Roles',
                            'No fue posible actualizar los roles. Por favor, intenta nuevamente.'
                        );
                    }
                } catch (error) {
                    console.error('‚ùå Error al actualizar roles:', error);
                    if (error.validationErrors) {
                        console.error('üìã Validation Errors Detalles:', error.validationErrors);
                    }
                    
                    this.showError(
                        '‚ùå Error al Actualizar Roles',
                        'No fue posible actualizar los roles. Por favor, intenta nuevamente.'
                    );
                } finally {
                    this.isSaving = false;
                }
            },

            // ==================== GESTI√ìN DE PERMISOS ====================

            async openPermissionsPanel() {
                if (this.selectedUsers.length === 0 && !this.permissionTargetRole) {
                    this.showNotify('Selecciona usuarios o un rol', 'error');
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    console.log('üîé Cargando permisos desde endpoints de Angel...');

                    // Obtener datos de los usuarios seleccionados
                    const selectedUsersData = this.users.filter(u => this.selectedUsers.includes(u.id));
                    
                    // Filtrar solo CURPs v√°lidos (18 caracteres)
                    const curps = selectedUsersData
                        .map(u => u.curp)
                        .filter(curp => curp && curp.length === 18);
                    
                    console.log('üë• Usuarios seleccionados:', selectedUsersData.length);
                    console.log('üìã CURPs v√°lidos (18 chars):', curps.length);
                    
                    if (curps.length === 0 && selectedUsersData.length > 0) {
                        this.showNotify('Los usuarios seleccionados no tienen CURP v√°lido (requiere 18 caracteres)', 'error');
                        return;
                    }
                    
                    let allPermissions = [];
                    let currentPermissions = new Set();
                    let endpoint = '';
                    let requestBody = {};

                    // ESCENARIO 1: Un solo usuario seleccionado (m√°s controlado)
                    if (selectedUsersData.length === 1) {
                        const userId = selectedUsersData[0].id;
                        let userRoles = [];
                        
                        // DEBUG: Mostrar toda la estructura del usuario
                        console.log('üîç ESTRUCTURA COMPLETA DEL USUARIO:', {
                            ...selectedUsersData[0],
                            roles: selectedUsersData[0].roles,
                            role: selectedUsersData[0].role,
                            user_roles: selectedUsersData[0].user_roles,
                            permissions: selectedUsersData[0].permissions,
                            allKeys: Object.keys(selectedUsersData[0])
                        });
                        
                        // SOLUCI√ìN TEMPORAL: Si no hay roles en la lista, obtenerlos del endpoint de detalles
                        let detailedUserData = null;
                        if (!selectedUsersData[0].roles || selectedUsersData[0].roles.length === 0) {
                            console.log('‚ö†Ô∏è No hay roles en la lista, obteniendo del endpoint de detalles...');
                            try {
                                const detailsResponse = await this.authenticatedFetch(
                                    `${this.apiBaseUrl}/v1/admin-actions/show-users/${userId}`,
                                    { 
                                        method: 'GET',
                                        headers: {
                                            'X-User-Role': 'admin',
                                            'X-User-Permission': 'view.users'
                                        }
                                    }
                                );
                                if (detailsResponse.ok) {
                                    const detailsResult = await detailsResponse.json();
                                    console.log('üì¶ Detalles del usuario obtenidos:', detailsResult);
                                    if (detailsResult.success && detailsResult.data?.user) {
                                        detailedUserData = detailsResult.data.user;
                                        if (detailedUserData.roles && detailedUserData.roles.length > 0) {
                                            console.log('‚úÖ Roles obtenidos de detalles:', detailedUserData.roles);
                                            selectedUsersData[0].roles = detailedUserData.roles;
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error('‚ùå Error obteniendo detalles del usuario:', error);
                            }
                        }
                        
                        // Extraer roles correctamente (puede venir como array, string, o en diferentes propiedades)
                        if (Array.isArray(selectedUsersData[0].roles)) {
                            // Si roles es un array de objetos, extraer los nombres
                            userRoles = selectedUsersData[0].roles.map(r => {
                                if (typeof r === 'string') return String(r).toLowerCase().trim();
                                if (typeof r === 'object' && r.name) return String(r.name).toLowerCase().trim();
                                return String(r).toLowerCase().trim();
                            });
                            console.log('‚úÖ Roles encontrados como array:', userRoles);
                        } else if (selectedUsersData[0].role) {
                            if (Array.isArray(selectedUsersData[0].role)) {
                                userRoles = selectedUsersData[0].role.map(r => {
                                    if (typeof r === 'object' && r.name) return String(r.name).toLowerCase().trim();
                                    return String(r).toLowerCase().trim();
                                });
                                console.log('‚úÖ Roles encontrados en .role (array):', userRoles);
                            } else {
                                userRoles = [String(selectedUsersData[0].role).toLowerCase().trim()];
                                console.log('‚úÖ Roles encontrados en .role (string):', userRoles);
                            }
                        } else if (typeof selectedUsersData[0].roles === 'string') {
                            userRoles = [selectedUsersData[0].roles.toLowerCase().trim()];
                            console.log('‚úÖ Roles encontrados como string:', userRoles);
                        } else if (selectedUsersData[0].user_roles) {
                            if (Array.isArray(selectedUsersData[0].user_roles)) {
                                userRoles = selectedUsersData[0].user_roles.map(r => {
                                    if (typeof r === 'object' && r.name) return String(r.name).toLowerCase().trim();
                                    return String(r).toLowerCase().trim();
                                });
                            }
                            console.log('‚úÖ Roles encontrados en .user_roles:', userRoles);
                        }
                        
                        // Lista de roles v√°lidos del sistema - EXPANDIR para incluir variaciones comunes
                        const validRoles = ['admin', 'student', 'financial staff', 'parent', 'teacher', 'supervisor', 'financial', 'staff', 'director', 'financial-staff', 'applicant', 'solicitante'];
                        
                        // Guardar roles originales ANTES de normalizar (para enviar al backend)
                        const originalRoles = [...userRoles];
                        
                        // Filtrar solo roles v√°lidos y eliminar valores inv√°lidos
                        userRoles = userRoles.filter(r => {
                            // Permitir tambi√©n variaciones (ej: "financial staff" o solo "financial" o "financial-staff")
                            const normalizedRole = r.toLowerCase().replace('-', ' ').trim();
                            const isValid = r && r !== 'n/a' && r !== 'sin rol' && r !== '' && 
                                           (validRoles.includes(r) || 
                                            validRoles.includes(normalizedRole) ||
                                            validRoles.some(vr => vr.includes(normalizedRole) || normalizedRole.includes(vr)));
                            if (!isValid && r) {
                                console.warn(`‚ö†Ô∏è Rol inv√°lido filtrado: "${r}"`);
                            }
                            return isValid;
                        });
                        
                        // ‚ö†Ô∏è NO normalizar aqu√≠ - mantener roles en formato original para enviar al backend
                        console.log('üìã Roles despu√©s de filtrado (SIN NORMALIZAR para backend):', userRoles);
                        
                        if (userRoles.length === 0) {
                            this.showNotify('El usuario no tiene roles v√°lidos asignados. Asigna un rol primero.', 'error');
                            console.error('‚ùå No hay roles v√°lidos para el usuario. Datos disponibles:', {
                                id: selectedUsersData[0].id,
                                name: selectedUsersData[0].name,
                                roles: selectedUsersData[0].roles,
                                role: selectedUsersData[0].role,
                                user_roles: selectedUsersData[0].user_roles,
                                rolesType: typeof selectedUsersData[0].roles
                            });
                            return; // NO abrir modal si no hay rol v√°lido
                        }
                        
                        endpoint = `${this.apiBaseUrl}/v1/admin-actions/permissions/by-user/${userId}`;
                        requestBody = {
                            roles: userRoles,
                            forceRefresh: false
                        };
                        console.log('üìå Escenario 1: Usuario individual');
                        console.log('   User ID:', userId);
                        console.log('   Roles v√°lidos:', userRoles);
                    }
                    // ESCENARIO 2: M√∫ltiples usuarios seleccionados (masivo por CURPs)
                    else if (selectedUsersData.length > 1 && curps.length > 0) {
                        endpoint = `${this.apiBaseUrl}/v1/admin-actions/permissions/by-curps`;
                        requestBody = {
                            curps: curps
                        };
                        console.log('üìå Escenario 2: M√∫ltiples usuarios por CURPs');
                        console.log('   CURPs:', curps);
                    }
                    // ESCENARIO 3: Por rol (masivo por rol)
                    else if (this.permissionTargetRole) {
                        endpoint = `${this.apiBaseUrl}/v1/admin-actions/permissions/by-role`;
                        requestBody = {
                            curps: [] // Vac√≠o para obtener todos del rol
                        };
                        console.log('üìå Escenario 3: Por rol');
                        console.log('   Rol:', this.permissionTargetRole);
                    } else {
                        this.showNotify('No se pudo determinar el escenario correcto para cargar permisos', 'error');
                        return;
                    }

                    console.log('üì§ Request:', {
                        endpoint,
                        body: requestBody,
                        headers: {
                            'X-User-Role': 'admin',
                            'X-User-Permission': 'view.permissions'
                        }
                    });

                    // Llamar al endpoint correspondiente
                    let apiSuccess = false;
                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`,
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'view.permissions'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        const result = await response.json();
                        console.log('üì• Response Status:', response.status);
                        console.log('üì• Response Data:', result);
                        
                        if (response.ok) {
                            // Procesar seg√∫n el tipo de respuesta
                            let permissionsData = null;
                            
                            console.log('üîç ANALIZANDO ESTRUCTURA DE RESPUESTA:');
                            console.log('   result.data:', result.data);
                            console.log('   result.data?.permissions:', result.data?.permissions);
                            console.log('   result.data?.permissions?.permissions:', result.data?.permissions?.permissions);
                            
                            // Intentar m√∫ltiples estructuras
                            if (result.data?.permissions?.permissions && Array.isArray(result.data.permissions.permissions)) {
                                permissionsData = result.data.permissions.permissions;
                                console.log('‚úÖ Permisos encontrados en: result.data.permissions.permissions');
                            } else if (result.data?.permissions && Array.isArray(result.data.permissions)) {
                                permissionsData = result.data.permissions;
                                console.log('‚úÖ Permisos encontrados en: result.data.permissions');
                            } else if (result.permissions && Array.isArray(result.permissions)) {
                                permissionsData = result.permissions;
                                console.log('‚úÖ Permisos encontrados en: result.permissions');
                            } else if (Array.isArray(result.data)) {
                                permissionsData = result.data;
                                console.log('‚úÖ Permisos encontrados en: result.data (como array)');
                            }

                            if (permissionsData && permissionsData.length > 0) {
                                allPermissions = permissionsData.map((p, idx) => ({
                                    id: p.id || idx + 1,
                                    name: p.name,
                                    displayName: p.label || p.name,
                                    type: p.type,
                                    group: p.group
                                }));
                                apiSuccess = true; // Marcar como √©xito
                                console.log(`‚úÖ ${allPermissions.length} permisos cargados desde API de Angel (YA FILTRADOS POR ROL)`);
                                console.log('üìã Primeros 3 permisos:', allPermissions.slice(0, 3));
                            } else {
                                console.warn('‚ö†Ô∏è API retorn√≥ 0 permisos - El rol puede no tener permisos asignados');
                                console.warn('   Estructura recibida:', JSON.stringify(result, null, 2));
                                apiSuccess = true; // Es v√°lido tener 0 permisos
                            }
                        } else if (response.status === 422) {
                            // Error de validaci√≥n - NO usar fallback
                            const errorMsg = result.message || 'Error de validaci√≥n';
                            const errors = result.errors || {};
                            console.error('‚ùå Error 422:', errorMsg, errors);
                            
                            let detailedError = errorMsg;
                            if (Object.keys(errors).length > 0) {
                                detailedError += '\n' + Object.entries(errors)
                                    .map(([field, msgs]) => `${field}: ${Array.isArray(msgs) ? msgs.join(', ') : msgs}`)
                                    .join('\n');
                            }
                            
                            this.showNotify(detailedError, 'error');
                            return; // Salir completamente, NO mostrar modal
                        } else {
                            console.warn('‚ö†Ô∏è Error en respuesta de API:', response.status, result);
                        }
                    } catch (apiError) {
                        console.error('‚ö†Ô∏è Error llamando a endpoint de permisos:', apiError);
                    }
                    
                    // Solo usar fallback si el API fall√≥ completamente (no 422)
                    if (!apiSuccess && allPermissions.length === 0) {
                        console.log('‚ö†Ô∏è API no disponible, usando fallback de emergencia');
                        this.showNotify('No se pudieron cargar permisos del servidor. Contacta al administrador.', 'error');
                        return; // NO mostrar modal con datos incorrectos
                    }
                    
                    // Obtener permisos actuales de los usuarios seleccionados
                    selectedUsersData.forEach(user => {
                        if (Array.isArray(user.permissions)) {
                            user.permissions.forEach(p => currentPermissions.add(p));
                        }
                    });

                    console.log('üë§ Permisos actuales de usuarios:', Array.from(currentPermissions).length);

                    // Separar permisos en "disponibles para agregar" y "disponibles para eliminar"
                    this.availablePermissions = allPermissions;
                    this.permissionsAvailableToAdd = allPermissions.filter(p => !currentPermissions.has(p.name));
                    this.permissionsAvailableToRemove = allPermissions.filter(p => currentPermissions.has(p.name));

                    console.log('‚ûï Permisos disponibles para agregar:', this.permissionsAvailableToAdd.length);
                    console.log('üîç Detalle de permisos para agregar:', this.permissionsAvailableToAdd);
                    this.permissionsAvailableToAdd.forEach((p, idx) => {
                        console.log(`   [${idx}] id:`, p.id, 'name:', p.name, 'displayName:', p.displayName);
                    });
                    console.log('‚ûñ Permisos disponibles para eliminar:', this.permissionsAvailableToRemove.length);

                    this.permissionsToAdd = [];
                    this.permissionsToRemove = [];
                    
                    // Forzar reactividad en Alpine
                    this.$nextTick(() => {
                        this.showPermissionsModal = true;
                    });
                } catch (error) {
                    console.error('‚ùå Error al cargar permisos:', error);
                    this.showNotify('Error al cargar permisos: ' + error.message, 'error');
                }
            },

            async updatePermissions() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                if (this.permissionsToAdd.length === 0 && this.permissionsToRemove.length === 0) {
                    this.showNotify('Selecciona al menos un permiso para agregar o eliminar', 'error');
                    return;
                }

                try {
                    this.isSaving = true;

                    // Obtener CURPs de usuarios seleccionados
                    const selectedUserCurps = this.users
                        .filter(u => this.selectedUsers.includes(u.id))
                        .map(u => u.curp)
                        .filter(curp => curp);
                    
                    console.log('üîç updatePermissions - CURPs de usuarios:', selectedUserCurps);
                    
                    if (selectedUserCurps.length === 0) {
                        this.showNotify('No hay usuarios seleccionados o sin CURP', 'error');
                        this.isSaving = false;
                        return;
                    }

                    // Preparar arrays de permisos
                    let addArray = Array.isArray(this.permissionsToAdd) ? this.permissionsToAdd : [];
                    let removeArray = Array.isArray(this.permissionsToRemove) ? this.permissionsToRemove : [];

                    // Validar que todos los elementos sean strings
                    addArray = addArray.filter(p => p != null).map(p => typeof p === 'string' ? p : (p.name || String(p)));
                    removeArray = removeArray.filter(p => p != null).map(p => typeof p === 'string' ? p : (p.name || String(p)));

                    // Filtrar permisos inv√°lidos usando la lista disponible
                    const validPermissionNames = new Set((this.availablePermissions || []).map(p => p.name));
                    addArray = addArray.filter(p => validPermissionNames.has(p));
                    removeArray = removeArray.filter(p => validPermissionNames.has(p));

                    if (addArray.length === 0 && removeArray.length === 0) {
                        this.showNotify('Selecciona al menos un permiso para agregar o eliminar', 'error');
                        this.isSaving = false;
                        return;
                    }

                    console.log('üì§ updatePermissions - Permisos a agregar:', addArray);
                    console.log('üì§ updatePermissions - Permisos a eliminar:', removeArray);
                    console.log('üì§ updatePermissions - CURPs a actualizar:', selectedUserCurps);

                    // Actualizar permisos para todos los usuarios de una vez
                    const result = await window.AdminAPI.updateMultipleUsersPermissions(
                        selectedUserCurps,
                        addArray,
                        removeArray,
                        token,
                        true  // isCurps = true
                    );

                    console.log('üì• Respuesta de actualizaci√≥n de permisos:', result);

                    const totalUpdated = result.success ? selectedUserCurps.length : 0;
                    const totalFailed = result.success ? 0 : selectedUserCurps.length;
                    const errors = result.success ? [] : [result.message || 'Error al actualizar permisos'];

                    // Mostrar resultado
                    if (totalUpdated > 0) {
                        let message = `‚úÖ Permisos actualizados: ${totalUpdated} usuario(s)`;
                        if (totalFailed > 0) {
                            message += ` (${totalFailed} fallido(s))`;
                        }
                        
                        this.showNotify(message, totalFailed > 0 ? 'warning' : 'success');
                        this.showPermissionsModal = false;
                        this.selectedUsers = [];
                        await this.loadUsers(token);
                    } else {
                        const errorMsg = errors.length > 0 ? errors.join('\n') : 'No se pudo actualizar ning√∫n usuario';
                        this.showNotify(`‚ùå ${errorMsg}`, 'error');
                    }

                } catch (error) {
                    console.error('‚ùå Error al actualizar permisos:', error);
                    this.showNotify(`Error al actualizar permisos: ${error.message}`, 'error');
                } finally {
                    this.isSaving = false;
                }
            },

            /**
             * Actualizar permisos de un usuario individual por userId
             * @param {number} userId - ID del usuario
             * @param {string[]} permissionsToAdd - Array de permisos a agregar
             * @param {string[]} permissionsToRemove - Array de permisos a eliminar
             */
            async updateUserPermissions(userId, permissionsToAdd = [], permissionsToRemove = []) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return { success: false, message: 'No autenticado' };
                }

                if (!userId) {
                    this.showNotify('ID de usuario requerido', 'error');
                    return { success: false, message: 'ID de usuario requerido' };
                }

                if (permissionsToAdd.length === 0 && permissionsToRemove.length === 0) {
                    this.showNotify('Selecciona al menos un permiso para agregar o eliminar', 'error');
                    return { success: false, message: 'Sin cambios de permisos' };
                }

                try {
                    this.isSaving = true;

                    const payload = {
                        permissionsToAdd: permissionsToAdd,
                        permissionsToRemove: permissionsToRemove
                    };

                    console.log(`üì§ updateUserPermissions - Enviando para userId ${userId}:`, payload);

                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/update-permissions/${userId}`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'sync.permissions'
                            },
                            body: JSON.stringify(payload)
                        }
                    );

                    const result = await response.json();
                    console.log('üì• updateUserPermissions - Respuesta:', result);

                    if (response.ok && result.success) {
                        const updatedUser = result.data?.updated?.[0];
                        const addedCount = updatedUser?.permissions?.added?.length || 0;
                        const removedCount = updatedUser?.permissions?.removed?.length || 0;
                        
                        this.showNotify(
                            `‚úÖ Permisos actualizados: ${addedCount} agregados, ${removedCount} eliminados`,
                            'success'
                        );
                        
                        // Recargar usuarios para reflejar los cambios
                        await this.loadUsers(token);
                        
                        return { success: true, data: result.data };
                    } else {
                        console.error('‚ùå Error en respuesta:', result);
                        
                        let errorMsg = result.message || 'Error al actualizar permisos';
                        
                        // Mostrar errores de validaci√≥n si existen
                        if (result.errors) {
                            const errorDetails = Object.entries(result.errors)
                                .map(([field, msgs]) => `${field}: ${Array.isArray(msgs) ? msgs.join(', ') : msgs}`)
                                .join('\n');
                            errorMsg = errorDetails || errorMsg;
                        }
                        
                        this.showNotify(`‚ùå ${errorMsg}`, 'error');
                        return { success: false, message: errorMsg, errors: result.errors };
                    }
                } catch (error) {
                    console.error('‚ùå Error al actualizar permisos del usuario:', error);
                    this.showNotify(`Error: ${error.message}`, 'error');
                    return { success: false, message: error.message };
                } finally {
                    this.isSaving = false;
                }
            },

            /**
             * Actualizar roles de un usuario individual por userId
             * @param {number} userId - ID del usuario
             * @param {string[]} rolesToAdd - Array de roles a agregar
             * @param {string[]} rolesToRemove - Array de roles a eliminar
             */
            async updateUserRoles(userId, rolesToAdd = [], rolesToRemove = []) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return { success: false, message: 'No autenticado' };
                }

                if (!userId) {
                    this.showNotify('ID de usuario requerido', 'error');
                    return { success: false, message: 'ID de usuario requerido' };
                }

                if (rolesToAdd.length === 0 && rolesToRemove.length === 0) {
                    this.showNotify('Selecciona al menos un rol para agregar o eliminar', 'error');
                    return { success: false, message: 'Sin cambios de roles' };
                }

                try {
                    this.isSaving = true;

                    const payload = {
                        rolesToAdd: rolesToAdd,
                        rolesToRemove: rolesToRemove
                    };

                    console.log(`üì§ updateUserRoles - Enviando para userId ${userId}:`, payload);

                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/updated-roles/${userId}`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'sync.roles'
                            },
                            body: JSON.stringify(payload)
                        }
                    );

                    const result = await response.json();
                    console.log('üì• updateUserRoles - Respuesta:', result);

                    if (response.ok && result.success) {
                        const updatedUser = result.data?.updated;
                        const addedCount = updatedUser?.roles?.added?.length || 0;
                        const removedCount = updatedUser?.roles?.removed?.length || 0;
                        
                        this.showNotify(
                            `‚úÖ Roles actualizados: ${addedCount} agregados, ${removedCount} eliminados`,
                            'success'
                        );
                        
                        // Recargar usuarios para reflejar los cambios
                        await this.loadUsers(token);
                        
                        return { success: true, data: result.data };
                    } else {
                        console.error('‚ùå Error en respuesta:', result);
                        
                        let errorMsg = result.message || 'Error al actualizar roles';
                        
                        // Mostrar errores de validaci√≥n si existen
                        if (result.errors) {
                            const errorDetails = Object.entries(result.errors)
                                .map(([field, msgs]) => `${field}: ${Array.isArray(msgs) ? msgs.join(', ') : msgs}`)
                                .join('\n');
                            errorMsg = errorDetails || errorMsg;
                        }
                        
                        this.showNotify(`‚ùå ${errorMsg}`, 'error');
                        return { success: false, message: errorMsg, errors: result.errors };
                    }
                } catch (error) {
                    console.error('‚ùå Error al actualizar roles del usuario:', error);
                    this.showNotify(`Error: ${error.message}`, 'error');
                    return { success: false, message: error.message };
                } finally {
                    this.isSaving = false;
                }
            },

            // ==================== IMPORTACI√ìN DE USUARIOS ====================
            
            openImportModal() {
                this.showImportModal = true;
                this.importFile = null;
                this.importResult = null;
                this.importError = null;
            },

            closeImportModal() {
                this.showImportModal = false;
                this.importFile = null;
                this.importResult = null;
                this.importError = null;
            },

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validar que sea un archivo Excel
                const validTypes = [
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'application/vnd.ms-excel'
                ];
                
                const fileName = file.name.toLowerCase();
                if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                    this.showNotify('Solo se permiten archivos Excel (.xlsx o .xls)', 'error');
                    return;
                }

                if (!validTypes.includes(file.type) && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                    this.showNotify('Tipo de archivo inv√°lido. Por favor, selecciona un archivo Excel', 'error');
                    return;
                }

                this.importFile = file;
                this.importError = null;
            },

            async importUsersFromFile() {
                if (!this.importFile) {
                    this.showNotify('Por favor selecciona un archivo', 'error');
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                this.isImporting = true;
                this.importError = null;
                this.importResult = null;

                try {
                    // Preflight: verificar que el archivo tenga filas con datos en la primera hoja
                    if (window.XLSX) {
                        const buffer = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = () => reject(new Error('No se pudo leer el archivo'));
                            reader.readAsArrayBuffer(this.importFile);
                        });

                        if (!buffer) {
                            throw new Error('No se pudo leer el contenido del archivo');
                        }

                        const data = buffer instanceof ArrayBuffer ? new Uint8Array(buffer) : buffer;
                        const workbook = window.XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames?.[0];
                        const sheet = sheetName ? workbook.Sheets[sheetName] : null;
                        const rows = sheet ? window.XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' }) : [];

                        const headerRow = Array.isArray(rows[0]) ? rows[0] : [];
                        const headerCount = headerRow.filter(cell => String(cell).trim() !== '').length;

                        const dataRows = rows.slice(1).filter(row =>
                            Array.isArray(row) && row.some(cell => String(cell).trim() !== '')
                        );

                        console.log('üìÑ Import preflight:', {
                            sheetName,
                            totalRows: rows.length,
                            headerCount,
                            dataRows: dataRows.length,
                            firstDataRow: dataRows[0] || null
                        });

                        if (!sheetName || rows.length === 0) {
                            this.showNotify('No se pudo leer la primera hoja del Excel', 'error');
                            this.isImporting = false;
                            return;
                        }

                        if (headerCount < 19) {
                            this.showNotify('El archivo no tiene las 19 columnas requeridas en la primera fila', 'error');
                            this.isImporting = false;
                            return;
                        }

                        if (dataRows.length === 0) {
                            this.showNotify('El archivo no tiene filas con datos en la primera hoja', 'error');
                            this.isImporting = false;
                            return;
                        }
                    } else {
                        console.warn('‚ö†Ô∏è XLSX no esta disponible; se omite validacion previa de filas');
                    }

                    // Crear FormData para enviar el archivo
                    const formData = new FormData();
                    formData.append('file', this.importFile);

                    console.log('üì• Importando archivo:', {
                        fileName: this.importFile.name,
                        fileSize: this.importFile.size,
                        fileType: this.importFile.type
                    });

                    // Realizar la solicitud
                    const response = await fetch(
                        `${this.apiBaseUrl}/v1/admin-actions/import-users`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'import.users'
                            },
                            body: formData
                        }
                    );

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Conservar summary y errores completos si vienen en el payload
                        this.importResult = result.data || result;
                        console.log('‚úÖ Importaci√≥n exitosa (payload completo):', result);
                        this.showNotify('‚úì Usuarios importados correctamente', 'success');
                        
                        // Recargar usuarios despu√©s de la importaci√≥n
                        setTimeout(() => {
                            this.loadUsers();
                        }, 1000);

                        // Cerrar modal despu√©s de 2 segundos si la importaci√≥n fue exitosa
                        setTimeout(() => {
                            this.closeImportModal();
                        }, 3000);
                    } else {
                        // Error en la validaci√≥n
                        console.error('‚ùå Error response:', {
                            status: response.status, 
                            result: JSON.stringify(result, null, 2)
                        });
                        console.log('Full error object:', result);
                        const errorMsg = result.message || 'Error en la importaci√≥n';
                        this.importError = {
                            message: errorMsg,
                            errors: result.errors || null,
                            hasDetails: !!result.errors
                        };
                        this.showNotify(`Error: ${errorMsg}`, 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al importar usuarios:', error);
                    this.importError = {
                        message: error.message,
                        hasDetails: false
                    };
                    this.showNotify(`Error: ${error.message}`, 'error');
                } finally {
                    this.isImporting = false;
                }
            },

            async promoteStudents() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                // Confirmar la acci√≥n
                if (!confirm('‚ö†Ô∏è Esto va a incrementar el semestre de todos los estudiantes activos y dar de baja a los que sobrepasan el semestre 12.\n\n¬øDeseas continuar?')) {
                    return;
                }

                try {
                    this.isSaving = true;
                    this.showNotify('Procesando promoci√≥n de estudiantes...', 'info');

                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/promote`,
                        {
                            method: 'PATCH',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'promote.student'
                            },
                            body: JSON.stringify({})
                        }
                    );

                    const result = await response.json();
                    console.log('üìä Respuesta de promoci√≥n:', result);

                    if (response.ok && result.success) {
                        const { usuarios_promovidos, usuarios_baja } = result.data?.affected || {};
                        this.showNotify(
                            `‚úÖ Promoci√≥n completada!\nüìö Estudiantes promovidos: ${usuarios_promovidos || 0}\nüëã Estudiantes dados de baja: ${usuarios_baja || 0}`,
                            'success'
                        );
                        
                        // Recargar usuarios
                        await this.loadUsers(token);
                    } else {
                        // Usar modal de error con todos los detalles
                        this.showError(
                            '‚ùå Error en Promoci√≥n',
                            result.message || 'Error al ejecutar la promoci√≥n',
                            {
                                error_code: result.error_code,
                                status: response.status,
                                errors: result.errors,
                                data: result.data,
                                debug: result.debug
                            }
                        );
                    }
                } catch (error) {
                    console.error('‚ùå Error en promoci√≥n:', error);
                    
                    // Usar modal de error
                    this.showError(
                        '‚ùå Error de Operaci√≥n',
                        'No fue posible promover los estudiantes. Por favor, intenta nuevamente.'
                    );
                } finally {
                    this.isSaving = false;
                }
            },

            // ==================== OBTENER DETALLES DE USUARIO ====================

            async fetchUserDetailsRaw(userId) {
                const response = await this.authenticatedFetch(
                    `${this.apiBaseUrl}/v1/admin-actions/show-users/${userId}`,
                    {
                        headers: {
                            'X-User-Role': 'admin',
                            'X-User-Permission': 'view.users'
                        }
                    }
                );

                const result = await response.json().catch(() => ({}));
                return {
                    ok: response.ok && result?.success,
                    status: response.status,
                    user: result?.data?.user || null,
                    message: result?.message || ''
                };
            },

            async getUserDetailsWithRetry(userId, options = {}) {
                const {
                    silent = true,
                    maxRetries = 3,
                    baseDelayMs = 700
                } = options;

                let attempt = 0;
                while (attempt <= maxRetries) {
                    try {
                        const result = await this.fetchUserDetailsRaw(userId);
                        if (result.ok) return result.user;

                        if (result.status === 429 && attempt < maxRetries) {
                            const backoff = baseDelayMs * (attempt + 1);
                            await this.sleep(backoff);
                            attempt += 1;
                            continue;
                        }

                        if (!silent && result.message) {
                            this.showNotify(result.message, 'error');
                        }
                        return null;
                    } catch (error) {
                        if (attempt < maxRetries) {
                            const backoff = baseDelayMs * (attempt + 1);
                            await this.sleep(backoff);
                            attempt += 1;
                            continue;
                        }

                        if (!silent) {
                            this.showNotify('Error al obtener detalles del usuario', 'error');
                        }
                        return null;
                    }
                }

                return null;
            },

            async getUserDetails(userId, silent = false) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    if (!silent) this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return null;
                }

                try {
                    const result = await this.fetchUserDetailsRaw(userId);
                    if (result.ok) {
                        return result.user;
                    } else {
                        if (!silent) this.showNotify('Error al obtener detalles del usuario', 'error');
                        return null;
                    }
                } catch (error) {
                    console.error('‚ùå Error al obtener detalles:', error);
                    if (!silent) this.showNotify('Error al obtener detalles del usuario', 'error');
                    return null;
                }
            },

            showDebugInfo() {
                const token = localStorage.getItem('access_token');
                const userData = localStorage.getItem('user_data');
                const refreshToken = localStorage.getItem('refresh_token');
                
                console.log('=== DEBUG INFO ===');
                console.log('üîë Access Token:', token ? `Presente (${token.length} caracteres)` : 'NO ENCONTRADO');
                console.log('üîÑ Refresh Token:', refreshToken ? 'Presente' : 'No encontrado');
                console.log('üë§ User Data:', userData || 'No encontrado');
                console.log('üìã Todas las keys en localStorage:', Object.keys(localStorage));
                console.log('üåê API Base URL:', this.apiBaseUrl);
                console.log('üë• Usuarios cargados:', this.users.length);
                console.log('‚ùå Error actual:', this.apiError || 'Ninguno');
                console.log('‚è≥ Cargando:', this.isLoadingUsers);
                
                alert(`Debug Info (ver consola para detalles):\n\n` +
                    `Token: ${token ? '‚úÖ Presente' : '‚ùå NO ENCONTRADO'}\n` +
                    `Usuarios cargados: ${this.users.length}\n` +
                    `Error: ${this.apiError || 'Ninguno'}\n` +
                    `Estado: ${this.isLoadingUsers ? 'Cargando...' : 'Completo'}\n\n` +
                    `Revisa la consola del navegador (F12) para m√°s detalles.`
                );
            }
        }));
        }
        
        // Registrar cuando Alpine est√© disponible
        if (typeof Alpine !== 'undefined') {
            registerComponent();
        } else {
            document.addEventListener('alpine:init', registerComponent);
        }
    })();
</script>