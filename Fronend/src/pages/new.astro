---
// src/pages/new.astro
import Layout from '../layouts/Layout.astro';
---

<Layout title="Crear Concepto - CBTA 71">
    <style>
      [x-cloak] {
        display: none !important;
      }
      body {
        font-family: 'Inter', sans-serif;
        background-color: #eef2f5; /* Fondo más suave */
      }
      :root {
        --primary-color: #2e594d; /* Verde/Teal principal */
      }
      .text-primary { color: var(--primary-color); }
      .bg-primary { background-color: var(--primary-color); }
      .focus\:ring-primary:focus { --tw-ring-color: var(--primary-color); }
      .focus\:border-primary:focus { border-color: var(--primary-color); }
      /* Sombra para la tarjeta principal */
      .card-shadow {
        box-shadow: 0 10px 30px -5px rgba(46, 89, 77, 0.15), 0 5px 15px -5px rgba(46, 89, 77, 0.05);
      }
      /* Custom gradient y border para el botón principal */
      .btn-primary-gradient {
        background: linear-gradient(145deg, var(--primary-color), #23453b);
        border: none;
      }
      .btn-primary-gradient:hover {
        background: linear-gradient(145deg, #4c7c6e, var(--primary-color));
      }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <div class="p-4 sm:p-8">
      <div
        x-data="{
          careers: [
            { id: 'AGR', name: 'Técnico Agropecuario' },
            { id: 'OFI', name: 'Técnico en Ofimática' },
            { id: 'SMEC', name: 'Técnico en Soporte y Mantenimiento de Equipo de Cómputo' },
          ],
          semesters: [
            { id: '1', name: 'Primer Semestre' },
            { id: '3', name: 'Tercer Semestre' },
            { id: '5', name: 'Quinto Semestre' },
          ],

          // lista de alumnos poblada desde localStorage (/estudiante_lista) o fallback
          allStudents: [],

          formData: {
            title: '',
            amount: 0,
            career: '',
            semester: '',
            description: '',
            status: 'inactive',
            scope: 'all',
            selectedStudents: []
          },
          searchTerm: '',
          isSearching: false,
          errorMessage: '',

          // Cargar alumnos desde localStorage o API; mapear a {id,name}
          loadStudents() {
            try {
              const raw = localStorage.getItem('studentsList');
              if (raw) {
                const parsed = JSON.parse(raw);
                this.allStudents = parsed.map(s => ({
                  id: String(s.id ?? s.numControl ?? s.num_control ?? s.studentId ?? ''),
                  name: String(s.nombre ?? s.name ?? (s.nombreCompleto || '')).trim() || ('Alumno ' + (s.id || ''))
                })).filter(s => s.id);
                return;
              }
            } catch (e) {
              console.warn('No se pudo leer studentsList de localStorage', e);
            }

            // Fallback local (mientras no haya studentsList)
            this.allStudents = [
              { id: '1001', name: 'Esteban Martínez' },
              { id: '1002', name: 'Fernanda López' },
              { id: '1003', name: 'Gabriel Soto' },
              { id: '1004', name: 'Hilda Vázquez' },
              { id: '1005', name: 'Iván Ramírez' },
              { id: '1006', name: 'Juan Hernández' },
              { id: '1007', name: 'Karla García' },
              { id: '1008', name: 'Laura Mendoza' },
              { id: '1009', name: 'Miguel Torres' },
              { id: '1010', name: 'Natalia Ruiz' },
            ];
          },

          toggleStudent(student) {
            const index = this.formData.selectedStudents.findIndex(s => s.id === student.id);
            if (index === -1) {
              this.formData.selectedStudents.push(student);
            } else {
              this.formData.selectedStudents.splice(index, 1);
            }
            this.searchTerm = '';
            this.isSearching = false;
            this.errorMessage = '';
          },

          get filteredStudents() {
            if (!this.searchTerm) return this.allStudents.slice(0, 10);
            const searchLower = this.searchTerm.toLowerCase();
            return this.allStudents.filter(student =>
              student.name.toLowerCase().includes(searchLower) ||
              student.id.includes(searchLower)
            ).slice(0, 10);
          },

          removeStudent(studentId) {
            this.formData.selectedStudents = this.formData.selectedStudents.filter(s => s.id !== studentId);
          },

          submitForm() {
            this.errorMessage = '';
            if (!this.formData.title || !this.formData.amount || parseFloat(this.formData.amount) <= 0) {
              this.errorMessage = 'Por favor, complete el Título y la Cantidad (debe ser mayor a $0.00) correctamente.';
              return;
            }
            if (this.formData.scope === 'semester' && !this.formData.semester) {
              this.errorMessage = 'Debe seleccionar un Semestre específico para aplicar este concepto.';
              return;
            }
            if (this.formData.scope === 'career' && !this.formData.career) {
              this.errorMessage = 'Debe seleccionar una Carrera específica para aplicar este concepto.';
              return;
            }
            if (this.formData.scope === 'students' && this.formData.selectedStudents.length === 0) {
              this.errorMessage = 'Debe seleccionar al menos un Alumno específico para aplicar este concepto.';
              return;
            }
            
            const newConcept = {
              id: Date.now().toString(),
              title: this.formData.title,
              amount: parseFloat(this.formData.amount),
              status: this.formData.status,
              scope: this.formData.scope,
              description: this.formData.description,
              career: this.formData.career,
              semester: this.formData.semester,
              selectedStudents: this.formData.selectedStudents,
              createdAt: new Date().toISOString()
            };

            // Guardar en localStorage
            try {
              const stored = JSON.parse(localStorage.getItem('conceptsList') || '[]');
              stored.unshift(newConcept); // agregar al inicio
              localStorage.setItem('conceptsList', JSON.stringify(stored));
              
              // Notificar éxito
              this.errorMessage = 'Concepto guardado correctamente.';
              
              // Redireccionar después de 1s
              setTimeout(() => {
                window.location.href = '/concepts';
              }, 1000);

            } catch(e) {
              this.errorMessage = 'Error guardando el concepto.';
              console.error(e);
            }
          },
          cancel() {
            // Redirige al usuario a la ruta /concepts, asumiendo que es la URL de concepts.astro
            window.location.href = '/concepts'; 
          },
          handleScopeChange(scope) {
            this.formData.scope = scope;
            // Limpiar otros campos de alcance al cambiar
            if (scope !== 'semester') this.formData.semester = '';
            if (scope !== 'career') this.formData.career = '';
            if (scope !== 'students') this.formData.selectedStudents = [];
            this.errorMessage = '';
          }
        }"
        x-init="loadStudents()"
        class="space-y-8 max-w-4xl mx-auto bg-white p-6 md:p-10 card-shadow rounded-2xl border border-gray-100"
      >
        <header class="pb-4 border-b-2 border-primary/20">
          <h1 class="text-3xl font-extrabold text-gray-800">Crear Nuevo Concepto de Cobro</h1>
          <p class="text-gray-500 mt-1">Defina los detalles y el alcance de este nuevo concepto que se aplicará a los alumnos.</p>
        </header>

        <!-- Mensaje de Error/Éxito con mejores colores -->
        <div x-cloak x-show="errorMessage" 
              :class="{ 
                'bg-red-100 border-red-400 text-red-700': errorMessage.includes('Por favor') || errorMessage.includes('cancelada'),
                'bg-green-100 border-green-400 text-green-700': errorMessage.includes('éxito')
              }"
              class="border p-4 rounded-lg transition duration-300 ease-in-out font-medium"
        >
          <span x-text="errorMessage"></span>
        </div>

        <!-- Formulario Principal -->
        <form @submit.prevent="submitForm" class="space-y-6">

          <!-- Sección 1: Detalles Básicos -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="col-span-1 md:col-span-2">
              <label for="title" class="block text-sm font-bold text-gray-700 mb-1">Título del Concepto</label>
              <input type="text" id="title" x-model="formData.title" placeholder="Ejemplo: Inscripción Semestral / Cuota de Laboratorio"
                      class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary transition duration-150" required>
            </div>

            <div>
              <label for="amount" class="block text-sm font-bold text-gray-700 mb-1">Monto ($)</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 font-semibold">$</span>
                <input type="number" id="amount" x-model.number="formData.amount" min="0.01" step="0.01" placeholder="0.00"
                        class="w-full p-3 pl-8 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary transition duration-150" required>
              </div>
            </div>
          </div>

          <!-- Sección 2: Estado (Status) - Mejora visual con sombreado y borde -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Estado Inicial</label>
            <div class="flex flex-wrap gap-4">
              <div @click="formData.status = 'active'"
                :class="formData.status === 'active' ? 'bg-green-600 text-white shadow-lg shadow-green-600/30' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-green-600'"
                class="px-5 py-3 rounded-full cursor-pointer transition duration-300 text-sm font-bold flex items-center">
                <i class="fas fa-check-circle mr-2"></i> Activo (Listo para usar)
              </div>
              <div @click="formData.status = 'inactive'"
                :class="formData.status === 'inactive' ? 'bg-primary text-white shadow-lg shadow-primary/30' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-primary'"
                class="px-5 py-3 rounded-full cursor-pointer transition duration-300 text-sm font-bold flex items-center">
                <i class="fas fa-edit mr-2"></i> Inactivo (Borrador)
              </div>
            </div>
          </div>

          <!-- Sección 3: Ámbito de Aplicación (Scope) - Tarjetas con íconos -->
          <div class="pt-4 border-t border-gray-100">
            <label class="block text-lg font-bold text-primary mb-3">Ámbito de Aplicación</label>
            <p class="text-sm text-gray-500 mb-4">Seleccione a quién se aplicará este concepto de cobro.</p>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              
              <!-- Opción: Todos -->
              <label class="relative block cursor-pointer">
                <input type="radio" name="scope" value="all" x-model="formData.scope" @change="handleScopeChange('all')" class="sr-only">
                <div :class="formData.scope === 'all' ? 'ring-2 ring-offset-2 ring-primary border-primary bg-primary/5' : 'border-gray-300 hover:border-primary'"
                  class="p-4 border-2 rounded-xl transition duration-200 shadow-md h-full">
                  <i class="fas fa-globe-americas text-3xl" :class="formData.scope === 'all' ? 'text-primary' : 'text-gray-400'"></i>
                  <p class="font-bold text-gray-800 mt-2">Todos</p>
                  <p class="text-xs text-gray-500">Aplica a todos los estudiantes activos.</p>
                </div>
              </label>
              
              <!-- Opción: Por Carrera -->
              <label class="relative block cursor-pointer">
                <input type="radio" name="scope" value="career" x-model="formData.scope" @change="handleScopeChange('career')" class="sr-only">
                <div :class="formData.scope === 'career' ? 'ring-2 ring-offset-2 ring-primary border-primary bg-primary/5' : 'border-gray-300 hover:border-primary'"
                  class="p-4 border-2 rounded-xl transition duration-200 shadow-md h-full">
                  <i class="fas fa-graduation-cap text-3xl" :class="formData.scope === 'career' ? 'text-primary' : 'text-gray-400'"></i>
                  <p class="font-bold text-gray-800 mt-2">Por Carrera</p>
                  <p class="text-xs text-gray-500">Solo alumnos de una carrera específica.</p>
                </div>
              </label>

              <!-- Opción: Por Semestre -->
              <label class="relative block cursor-pointer">
                <input type="radio" name="scope" value="semester" x-model="formData.scope" @change="handleScopeChange('semester')" class="sr-only">
                <div :class="formData.scope === 'semester' ? 'ring-2 ring-offset-2 ring-primary border-primary bg-primary/5' : 'border-gray-300 hover:border-primary'"
                  class="p-4 border-2 rounded-xl transition duration-200 shadow-md h-full">
                  <i class="fas fa-layer-group text-3xl" :class="formData.scope === 'semester' ? 'text-primary' : 'text-gray-400'"></i>
                  <p class="font-bold text-gray-800 mt-2">Por Semestre</p>
                  <p class="text-xs text-gray-500">Solo alumnos en un semestre específico.</p>
                </div>
              </label>

              <!-- Opción: Alumnos Específicos -->
              <label class="relative block cursor-pointer">
                <input type="radio" name="scope" value="students" x-model="formData.scope" @change="handleScopeChange('students')" class="sr-only">
                <div :class="formData.scope === 'students' ? 'ring-2 ring-offset-2 ring-primary border-primary bg-primary/5' : 'border-gray-300 hover:border-primary'"
                  class="p-4 border-2 rounded-xl transition duration-200 shadow-md h-full">
                  <i class="fas fa-user-tag text-3xl" :class="formData.scope === 'students' ? 'text-primary' : 'text-gray-400'"></i>
                  <p class="font-bold text-gray-800 mt-2">Específicos</p>
                  <p class="text-xs text-gray-500">Alumnos seleccionados manualmente.</p>
                </div>
              </label>
            </div>
          </div>

          <!-- Campos Condicionales -->
          <div class="space-y-6">
            <!-- Selección de Carrera -->
            <div x-cloak x-show="formData.scope === 'career'">
              <label for="career-select" class="block text-sm font-bold text-gray-700 mb-1">Seleccionar Carrera</label>
              <select id="career-select" x-model="formData.career"
                      class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary transition duration-150">
                        <option value="" disabled>-- Seleccione una Carrera --</option>
                        <template x-for="career in careers" :key="career.id">
                          <option :value="career.id" x-text="career.name"></option>
                        </template>
                      </select>
            </div>

            <!-- Selección de Semestre -->
            <div x-cloak x-show="formData.scope === 'semester'">
              <label for="semester-select" class="block text-sm font-bold text-gray-700 mb-1">Seleccionar Semestre</label>
              <select id="semester-select" x-model="formData.semester"
                      class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary transition duration-150">
                        <option value="" disabled>-- Seleccione un Semestre --</option>
                        <template x-for="semester in semesters" :key="semester.id">
                          <option :value="semester.id" x-text="semester.name"></option>
                        </template>
                      </select>
            </div>

            <!-- Selección de Alumnos Específicos -->
            <div x-cloak x-show="formData.scope === 'students'" class="bg-gray-50 p-6 rounded-xl border border-dashed border-primary/40">
              <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center"><i class="fas fa-search mr-2 text-primary"></i> Buscar y Seleccionar Alumnos</h3>
              
              <div class="relative" x-data="{ open: false }" @click.away="open = false">
                <input type="text" x-model="searchTerm" @focus="open = true" @input="isSearching = true; open = true"
                        placeholder="Buscar por nombre o ID de alumno..."
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-2 focus:ring-primary focus:border-primary transition duration-150">
                
                <div x-show="open && searchTerm.length > 0" x-transition:enter.duration.150ms x-transition:leave.duration.100ms
                      class="absolute z-10 w-full mt-2 bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto">
                  <template x-if="filteredStudents.length > 0">
                    <ul class="divide-y divide-gray-100">
                      <template x-for="student in filteredStudents" :key="student.id">
                        <li @click="toggleStudent(student); open = false" class="p-3 hover:bg-primary/10 cursor-pointer flex justify-between items-center text-sm">
                          <span x-text="student.name + ' (' + student.id + ')'" class="font-medium text-gray-700"></span>
                          <span x-show="formData.selectedStudents.some(s => s.id === student.id)" class="text-primary text-xs font-bold bg-primary/20 px-2 py-0.5 rounded-full">
                            <i class="fas fa-check"></i>
                          </span>
                        </li>
                      </template>
                    </ul>
                  </template>
                  <template x-if="filteredStudents.length === 0">
                    <p class="p-4 text-center text-gray-500 text-sm">No se encontraron resultados para "<span x-text="searchTerm"></span>".</p>
                  </template>
                </div>
              </div>

              <div x-cloak x-show="formData.selectedStudents.length > 0" class="mt-6 pt-4 border-t border-gray-200">
                <p class="text-sm font-bold text-gray-700 mb-3">Alumnos seleccionados (<span x-text="formData.selectedStudents.length"></span>):</p>
                <div class="flex flex-wrap gap-2">
                  <template x-for="student in formData.selectedStudents" :key="student.id">
                    <div class="flex items-center bg-primary text-white px-3 py-1 rounded-full text-xs font-semibold shadow-md">
                      <span x-text="student.name"></span>
                      <button type="button" @click="removeStudent(student.id)" class="ml-2 text-white/80 hover:text-white transition duration-150">
                        <i class="fas fa-times text-xs"></i>
                      </button>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </div>

          <!-- Sección 4: Descripción -->
          <div>
            <label for="description" class="block text-sm font-bold text-gray-700 mb-1">Descripción del Concepto (Opcional)</label>
            <textarea id="description" x-model="formData.description" rows="3" placeholder="Detalles sobre la aplicación, período de validez, o notas importantes."
                      class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary transition duration-150"></textarea>
          </div>

          <!-- Sección 5: Botones de Acción -->
          <div class="pt-6 flex justify-end space-x-4 border-t border-gray-100">
            <button type="button" @click="cancel"
                      class="px-8 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 font-bold shadow-sm hover:shadow-md">
                        Cancelar
                      </button>
            <button type="submit"
                      class="px-8 py-3 text-white rounded-lg transition duration-300 font-bold btn-primary-gradient shadow-lg shadow-primary/40 hover:shadow-xl hover:shadow-primary/50">
                        <i class="fas fa-save mr-2"></i> Guardar Concepto
                      </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module" client:load>
(function () {
  function qs(sel){ return document.querySelector(sel); }
  function setValue(el, value){
    if (!el) return;
    if (el.type === 'checkbox') { el.checked = Boolean(value); el.dispatchEvent(new Event('change',{bubbles:true})); return; }
    if (el.type === 'radio') { el.checked = Boolean(value); el.dispatchEvent(new Event('change',{bubbles:true})); return; }
    el.value = value ?? '';
    el.dispatchEvent(new Event('input',{bubbles:true})); 
    el.dispatchEvent(new Event('change',{bubbles:true}));
  }

  try {
    const raw = localStorage.getItem('editingConcept');
    if (!raw) return;
    const concept = JSON.parse(raw);

    // 1) Rellenar inputs/selecciones que sí existen en el DOM (IDs del formulario)
    setValue(qs('#title'), concept.title || '');
    setValue(qs('#amount'), concept.amount ?? '');
    setValue(qs('#description'), concept.description || '');

    // scope: marcar el radio correspondiente
    if (concept.scope) {
      const scopeRadio = qs(`input[name="scope"][value="${concept.scope}"]`);
      if (scopeRadio) { scopeRadio.checked = true; scopeRadio.dispatchEvent(new Event('change',{bubbles:true})); }
    }

    // career / semester selects (tus ids reales)
    setValue(qs('#career-select'), concept.career || '');
    setValue(qs('#semester-select'), concept.semester || '');

    // 2) Esperar a Alpine e inyectar directamente en formData para que se refleje la UI (estado, scope, selectedStudents)
    const maxTries = 30;
    let tries = 0;
    const interval = setInterval(() => {
      tries++;
      const alpineRoot = document.querySelector('[x-data]');
      // Alpine v3 suele exponer _x_dataStack o __x (varía); probamos ambas opciones
      const alpineData = alpineRoot && (alpineRoot._x_dataStack ? alpineRoot._x_dataStack[0] : (alpineRoot.__x && alpineRoot.__x.$data ? alpineRoot.__x.$data : null));
      if (alpineData && alpineData.formData) {
        // Fusionar conservando propiedades existentes de formData
        alpineData.formData.title = concept.title ?? alpineData.formData.title;
        alpineData.formData.amount = concept.amount ?? alpineData.formData.amount;
        alpineData.formData.description = concept.description ?? alpineData.formData.description;
        alpineData.formData.scope = concept.scope ?? alpineData.formData.scope;
        alpineData.formData.career = concept.career ?? alpineData.formData.career;
        alpineData.formData.semester = concept.semester ?? alpineData.formData.semester;
        // selectedStudents en tu app son objetos {id,name}; si vienen como ids, convertimos a objetos básicos
        if (Array.isArray(concept.selectedStudents)) {
          alpineData.formData.selectedStudents = concept.selectedStudents.map(s => (typeof s === 'string' || typeof s === 'number') ? { id: String(s), name: String(s) } : s);
        }
        // estado (active/inactive)
        if (concept.status) alpineData.formData.status = concept.status;

        // Disparar cambio para que UI reactiva se actualice (si usa getters)
        try {
          const ev = new Event('input', { bubbles: true });
          (qs('#title') || document.body).dispatchEvent(ev);
        } catch(e){}
        clearInterval(interval);
        return;
      }
      if (tries >= maxTries) {
        clearInterval(interval);
      }
    }, 100);

    // 3) Asegurar hidden id para identificar edición (opcional, facilita submit si quieres actualizar)
    let hid = qs('#concept-id') || qs('input[name="id"]');
    if (!hid) {
      hid = document.createElement('input');
      hid.type = 'hidden';
      hid.id = 'concept-id';
      hid.name = 'id';
      (qs('form') || document.body).appendChild(hid);
    }
    hid.value = concept.id || '';

  } catch (e) {
    console.error('No se pudo prellenar el formulario de concepto:', e);
  }
})();
</script>
</Layout>