---
// 1. ASTRO FRONTMATTER
import Layout from "../layouts/Layout.astro"; 

const pageTitle = "Lista de Estudiantes";
---

<!-- 2. Uso del Layout con el título definido -->
<Layout title={pageTitle}>
    <div 
        x-data="{ 
            // Estado para el Modal de Validación (simulado)
            showValidationModal: false, 

            // Estado inicial de la tabla, que se restablece en cada carga de página (navegación)
            searchTerm: '',
            sortBy: 'id',
            sortDir: 'asc', // 'asc' o 'desc'
            currentPage: 1,
            studentsPerPage: 10,
            allStudents: [ 
                { id: '22739', name: 'Dwight', semester: 3, status: 'Pendiente', due: 492.00 },
                { id: '39635', name: 'Arlene', semester: 2, status: 'Pagado', due: 0.00 },
                { id: '39635', name: 'Courtney', semester: 8, status: 'Pendiente', due: 922.00 },
                { id: '70668', name: 'Kristin', semester: 9, status: 'En proceso', due: 357.00 },
                { id: '22739', name: 'Cody', semester: 9, status: 'Pendiente', due: 447.00 },
                { id: '39635', name: 'Ronald', semester: 2, status: 'Pendiente', due: 196.00 },
                { id: '39635', name: 'Eduardo', semester: 6, status: 'Pendiente', due: 429.00 },
                { id: '39635', name: 'Arlene', semester: 9, status: 'Pendiente', due: 492.00 },
                { id: '97174', name: 'Aubrey', semester: 3, status: 'Pendiente', due: 703.00 },
                { id: '22739', name: 'Shawn', semester: 8, status: 'En proceso', due: 154.00 },
                { id: '11111', name: 'Alice', semester: 1, status: 'Pagado', due: 0.00 },
                { id: '22222', name: 'Bob', semester: 3, status: 'Pendiente', due: 250.50 },
                { id: '33333', name: 'Charlie', semester: 5, status: 'En proceso', due: 100.00 },
                { id: '44444', name: 'Diana', semester: 7, status: 'Pendiente', due: 800.00 },
                { id: '55555', name: 'Eve', semester: 1, status: 'Pagado', due: 0.00 },
                { id: '66666', name: 'Frank', semester: 3, status: 'Pendiente', due: 300.00 },
                { id: '77777', name: 'Grace', semester: 5, status: 'En proceso', due: 50.00 },
            ],
            
            // Función para ordenar la tabla
            sort(column) {
                // Siempre que se ordena, se regresa a la primera página para una mejor UX
                this.currentPage = 1; 
                if (this.sortBy === column) {
                    this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortBy = column;
                    this.sortDir = 'asc';
                }
            },

            // Lógica de filtrado, ordenamiento y paginación
            get filteredAndSortedStudents() {
                // 1. Filtrado
                const searchLower = this.searchTerm.toLowerCase();
                let results = this.allStudents.filter(student => 
                    student.name.toLowerCase().includes(searchLower) || 
                    student.id.includes(searchLower)
                );
                
                // Reiniciar página a 1 cuando el filtro cambia
                
                // 2. Ordenamiento
                results.sort((a, b) => {
                    const aVal = a[this.sortBy];
                    const bVal = b[this.sortBy];

                    let comparison = 0;
                    if (typeof aVal === 'string') {
                        comparison = aVal.localeCompare(bVal);
                    } else {
                        if (aVal > bVal) comparison = 1;
                        else if (aVal < bVal) comparison = -1;
                    }

                    return this.sortDir === 'asc' ? comparison : comparison * -1;
                });

                return results;
            },

            get paginatedStudents() {
                const start = (this.currentPage - 1) * this.studentsPerPage;
                const end = start + this.studentsPerPage;
                return this.filteredAndSortedStudents.slice(start, end);
            },

            get totalPages() {
                return Math.ceil(this.filteredAndSortedStudents.length / this.studentsPerPage);
            },

            get paginationRange() {
                // Lógica de rango de paginación
                const total = this.totalPages;
                const current = this.currentPage;
                const delta = 2;
                const range = [];

                for (let i = 1; i <= total; i++) {
                    if (i === 1 || i === total || (i >= current - delta && i <= current + delta)) {
                        range.push(i);
                    }
                }

                const finalRange = [];
                let last = 0;
                for (let i of range) {
                    if (last) {
                        if (i - last === 2) {
                            finalRange.push(last + 1);
                        } else if (i - last !== 1) {
                            finalRange.push('...');
                        }
                    }
                    finalRange.push(i);
                    last = i;
                }
                return finalRange;
            }
        }" 
        x-init="$watch('searchTerm', () => { currentPage = 1 })" 
        class="space-y-8 max-w-5xl mx-auto bg-white p-6 md:p-10 shadow-xl rounded-xl" 
    > 
        <header class="pb-4 border-b border-gray-100 flex items-center space-x-4"> 
            <!-- Icono de Font Awesome para Estudiantes -->
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-users text-4xl text-[#2e594d]" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
                <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                <path d="M16 3.161a3 3 0 1 0 3.839 3.839" />
                <path d="M16 14v-1a4 4 0 0 1 4 -4h1" />
            </svg>
            <div>
                <h1 class="text-3xl font-extrabold text-[#2e594d]">Estudiantes</h1> 
                <p class="text-gray-500 mt-1">Gestión y visualización de la lista completa de alumnos.</p>
            </div>
        </header> 
        
        <!-- Sección de Filtro, Título de Tabla y Botón Validar -->
        <div class="space-y-4">
            <h2 class="text-xl font-bold text-gray-700 flex items-center space-x-2">
                <!-- Icono de Font Awesome para Lista -->
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-list-details text-[#2e594d]" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M13 5h8" />
                    <path d="M13 9h5" />
                    <path d="M13 15h8" />
                    <path d="M13 19h5" />
                    <path d="M3 4m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" />
                    <path d="M3 14m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" />
                </svg>
                <span>Todos los estudiantes</span>
            </h2>

            <!-- Campo de Búsqueda y Botón de Validar -->
            <div class="flex items-center space-x-4">
                <div class="relative max-w-sm flex-grow">
                    <input type="text" x-model="searchTerm" placeholder="Nombre o ID de estudiante"
                        class="w-full p-2 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-[#2e594d] focus:border-[#2e594d] transition duration-150">
                    <!-- Icono de Font Awesome para Búsqueda -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                        <path d="M21 21l-6 -6" />
                    </svg>
                </div>
                
                <!-- Botón Validar (Abre el modal) -->
                <button @click="showValidationModal = true"
                    class="flex items-center space-x-2 px-4 py-2 border border-[#2e594d] text-[#2e594d] rounded-lg font-semibold hover:bg-[#e0f2f1] transition duration-150 shadow-sm">
                    <!-- Icono de Font Awesome para Lápiz (Editar/Validar) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                       <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                       <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4"></path>
                       <path d="M13.5 6.5l4 4"></path>
                    </svg>
                    <span>Validar</span>
                </button>
            </div>
        </div>

        <!-- Tabla de Estudiantes -->
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-lg">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-[#2e594d]/10">
                    <tr>
                        <!-- Encabezados con función de ordenamiento -->
                        <th class="px-4 py-3 text-left text-xs font-bold text-[#2e594d] uppercase tracking-wider cursor-pointer" @click="sort('id')">
                            ID 
                            <span x-show="sortBy === 'id'">
                                <svg xmlns="http://www.w3.org/2000/svg" :class="sortDir === 'asc' ? 'rotate-180' : ''" class="icon icon-tabler icon-tabler-caret-up-filled inline-block ml-1 transition-transform" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M18 14h-12a1 1 0 0 1 -.781 -1.625l6 -8a1 1 0 0 1 1.562 0l6 8a1 1 0 0 1 -.781 1.625" />
                                </svg>
                            </span>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-[#2e594d] uppercase tracking-wider cursor-pointer" @click="sort('name')">
                            Nombre
                            <span x-show="sortBy === 'name'">
                                <svg xmlns="http://www.w3.org/2000/svg" :class="sortDir === 'asc' ? 'rotate-180' : ''" class="icon icon-tabler icon-tabler-caret-up-filled inline-block ml-1 transition-transform" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M18 14h-12a1 1 0 0 1 -.781 -1.625l6 -8a1 1 0 0 1 1.562 0l6 8a1 1 0 0 1 -.781 1.625" />
                                </svg>
                            </span>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-[#2e594d] uppercase tracking-wider cursor-pointer" @click="sort('semester')">
                            Semestre
                            <span x-show="sortBy === 'semester'">
                                <svg xmlns="http://www.w3.org/2000/svg" :class="sortDir === 'asc' ? 'rotate-180' : ''" class="icon icon-tabler icon-tabler-caret-up-filled inline-block ml-1 transition-transform" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M18 14h-12a1 1 0 0 1 -.781 -1.625l6 -8a1 1 0 0 1 1.562 0l6 8a1 1 0 0 1 -.781 1.625" />
                                </svg>
                            </span>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-[#2e594d] uppercase tracking-wider cursor-pointer" @click="sort('status')">
                            St. Pagos
                            <span x-show="sortBy === 'status'">
                                <svg xmlns="http://www.w3.org/2000/svg" :class="sortDir === 'asc' ? 'rotate-180' : ''" class="icon icon-tabler icon-tabler-caret-up-filled inline-block ml-1 transition-transform" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M18 14h-12a1 1 0 0 1 -.781 -1.625l6 -8a1 1 0 0 1 1.562 0l6 8a1 1 0 0 1 -.781 1.625" />
                                </svg>
                            </span>
                        </th>
                        <th class="px-4 py-3 text-right text-xs font-bold text-[#2e594d] uppercase tracking-wider cursor-pointer" @click="sort('due')">
                            Adeudo
                            <span x-show="sortBy === 'due'">
                                <svg xmlns="http://www.w3.org/2000/svg" :class="sortDir === 'asc' ? 'rotate-180' : ''" class="icon icon-tabler icon-tabler-caret-up-filled inline-block ml-1 transition-transform" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M18 14h-12a1 1 0 0 1 -.781 -1.625l6 -8a1 1 0 0 1 1.562 0l6 8a1 1 0 0 1 -.781 1.625" />
                                </svg>
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <template x-for="student in paginatedStudents" :key="student.id">
                        <tr class="text-sm text-gray-700 odd:bg-white even:bg-[#f0fff4] hover:bg-[#e0f2f1] transition duration-200 cursor-pointer">
                            <td x-text="student.id" class="px-4 py-2 whitespace-nowrap font-mono"></td>
                            <td x-text="student.name" class="px-4 py-2 whitespace-nowrap"></td>
                            <td x-text="student.semester" class="px-4 py-2 whitespace-nowrap"></td>
                            <td class="px-4 py-2 whitespace-nowrap">
                                <span x-text="student.status"
                                      :class="{
                                          'text-green-800 bg-green-100': student.status === 'Pagado',
                                          'text-yellow-800 bg-yellow-100': student.status === 'Pendiente',
                                          'text-blue-800 bg-blue-100': student.status === 'En proceso',
                                      }"
                                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                </span>
                            </td>
                            <td x-text="'$' + student.due.toFixed(2)" class="px-4 py-2 whitespace-nowrap text-right font-semibold"></td>
                        </tr>
                    </template>
                    <tr x-show="paginatedStudents.length === 0">
                        <td colspan="5" class="text-center py-4 text-gray-500">No se encontraron estudiantes que coincidan con la búsqueda.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Paginación -->
        <div class="flex flex-col sm:flex-row justify-between items-center pt-4">
            <p class="text-sm text-gray-600 mb-2 sm:mb-0">
                Mostrando <span x-text="paginatedStudents.length"></span> de <span x-text="filteredAndSortedStudents.length"></span> estudiantes
            </p>
            
            <nav class="flex items-center space-x-1" aria-label="Pagination">
                <button @click="currentPage = Math.max(1, currentPage - 1)" :disabled="currentPage === 1"
                        :class="currentPage === 1 ? 'text-gray-400 cursor-not-allowed' : 'text-[#2e594d] hover:bg-gray-100'"
                        class="px-3 py-1 rounded-lg text-sm font-medium transition duration-150">
                    <!-- Icono de Flecha Izquierda -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-narrow-left inline-block mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M5 12l14 0" />
                        <path d="M5 12l4 4" />
                        <path d="M5 12l4 -4" />
                    </svg> Previous
                </button>

                <template x-for="page in paginationRange" :key="page">
                    <span x-if="page === '...'" class="px-3 py-1 text-gray-500">...</span>
                    <button x-else @click="currentPage = page"
                            :class="page === currentPage ? 'bg-[#2e594d] text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'"
                            class="px-3 py-1 rounded-lg text-sm font-medium transition duration-150">
                        <span x-text="page"></span>
                    </button>
                </template>

                <button @click="currentPage = Math.min(totalPages, currentPage + 1)" :disabled="currentPage === totalPages"
                        :class="currentPage === totalPages ? 'text-gray-400 cursor-not-allowed' : 'text-[#2e594d] hover:bg-gray-100'"
                        class="px-3 py-1 rounded-lg text-sm font-medium transition duration-150">
                    Next <!-- Icono de Flecha Derecha -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-narrow-right inline-block ml-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M5 12l14 0" />
                        <path d="M15 16l4 -4" />
                        <path d="M15 8l4 4" />
                    </svg>
                </button>
            </nav>
        </div>

        <!-- Modal de Validación Simulado -->
        <div x-show="showValidationModal" 
             class="fixed inset-0 z-50 overflow-y-auto" 
             style="display: none;"
             x-transition:enter="ease-out duration-300" 
             x-transition:enter-start="opacity-0" 
             x-transition:enter-end="opacity-100" 
             x-transition:leave="ease-in duration-200" 
             x-transition:leave-start="opacity-100" 
             x-transition:leave-end="opacity-0">
            
            <!-- Fondo Oscuro -->
            <div @click="showValidationModal = false" class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity"></div>

            <!-- Contenido del Modal -->
            <div class="flex items-center justify-center min-h-screen p-4">
                <div x-show="showValidationModal" 
                     x-transition:enter="ease-out duration-300" 
                     x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
                     x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
                     x-transition:leave="ease-in duration-200" 
                     x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
                     x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                     class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 space-y-4 relative">
                    
                    <h3 class="text-xl font-bold text-[#2e594d] border-b pb-2">Proceso de Validación de Estudiantes</h3>
                    
                    <p class="text-gray-700">Aquí se realizaría la lógica para validar o aplicar cambios masivos a los estudiantes seleccionados o a los resultados de la búsqueda.</p>

                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg">
                        <p class="text-sm text-blue-700 font-medium">Nota: Esta es una ventana de simulación. En una aplicación real, se manejaría la lógica de negocio aquí.</p>
                    </div>

                    <div class="flex justify-end space-x-3 pt-2">
                        <button @click="showValidationModal = false" 
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150">
                            Cancelar
                        </button>
                        <button @click="showValidationModal = false" 
                                class="px-4 py-2 bg-[#2e594d] text-white rounded-lg hover:bg-[#25483d] transition duration-150 shadow-md">
                            Confirmar Validación
                        </button>
                    </div>

                    <!-- Botón de Cerrar (X) -->
                    <button @click="showValidationModal = false" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                           <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                           <path d="M18 6l-12 12"></path>
                           <path d="M6 6l12 12"></path>
                        </svg>
                    </button>

                </div>
            </div>
        </div>

    </div> 
</Layout>