---
// src/pages/pago_estado.astro
import Layout from "../layouts/Layout.astro"; 

const pageTitle = "Estado de Pagos - CBTA 71";
---
<Layout title={pageTitle}>
ย <div class="max-w-7xl xl:max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-10 bg-gray-50/50 min-h-screen">

ย ย <header class="flex justify-between items-center mb-10 pb-4 border-b-2 border-green-700/10">
ย ย ย <div class="flex items-center">
ย ย ย ย <div class="p-3 bg-[#2e594d] rounded-xl shadow-lg mr-3">
ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
ย ย ย ย ย ย ย <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V6m0 4v2m0 2v2m0 0V4m-7 8a7 7 0 1114 0 7 7 0 01-14 0z" />
ย ย ย ย ย </svg>
ย ย ย ย </div>
ย ย ย ย <div>
ย ย ย ย ย <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">
ย ย ย ย ย ย Estado de Pagos
ย ย ย ย ย </h1>
ย ย ย ย ย <p class="text-sm text-gray-500 mt-1">Monitoreo y gestiรณn de transacciones de estudiantes.</p>
ย ย ย ย </div>
ย ย ย </div>

ย ย ย <div class="flex gap-3 items-center">
ย ย ย ย <button id="open-pay-modal-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out flex items-center text-sm font-medium">
ย ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
ย ย ย ย ย ย ย ย <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
ย ย ย ย ย ย </svg>
ย ย ย ย ย ย Registrar Pago Manual
ย ย ย ย </button>

ย ย ย ย <select id="method-filter" class="border border-gray-300 rounded-lg px-4 py-2.5 text-sm bg-white shadow-sm focus:ring-green-500 focus:border-green-500 transition">
ย ย ย ย ย <option value="all">Todos los mรฉtodos</option>
ย ย ย ย ย <option value="tarjeta">๐ณ Tarjeta</option>
ย ย ย ย ย <option value="referenciado">๐ Pago referenciado</option>
ย ย ย ย ย <option value="transferencia">๐ฆ Transferencia</option>
ย ย ย ย ย <option value="otro">Otro / Efectivo</option>
ย ย ย ย </select>
ย ย ย </div>
ย ย </header>

ย ย <div class="bg-white rounded-xl shadow-2xl border border-gray-100 overflow-x-auto mb-6">
ย ย ย <table class="min-w-full divide-y divide-gray-200">
ย ย ย ย <thead class="bg-[#2e594d] sticky top-0 z-10">
ย ย ย ย ย <tr>
ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Fecha</th>
ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Concepto</th>
ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Monto</th>
ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Mรฉtodo</th>
ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">N. Control</th>
ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Nombre del Alumno</th>
ย ย ย ย ย ย <th class="px-6 py-3 text-right text-xs font-bold text-white uppercase tracking-wider">Acciones</th>
ย ย ย ย ย </tr>
ย ย ย ย </thead>
ย ย ย ย <tbody id="payments-table-body" class="bg-white divide-y divide-gray-100">
ย ย ย ย ย </tbody>
ย ย ย </table>
ย ย </div>

ย ย <div id="pay-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 transition-opacity duration-300 ease-out opacity-0">
ย ย ย <div class="bg-white rounded-xl w-full max-w-lg p-8 shadow-2xl transform scale-95 transition-transform duration-300 ease-out">
ย ย ย ย <h3 class="text-xl font-bold text-gray-900 mb-6 border-b pb-2">Registrar Pago Manual โ๏ธ</h3>
ย ย ย ย <form id="pay-form" class="space-y-4">
ย ย ย ย ย 
ย ย ย ย ย <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย <label for="pay-student-id" class="block text-sm font-medium text-gray-700 mb-1">Matrรญcula / N. Control</label>
ย ย ย ย ย ย ย <input id="pay-student-id" type="text" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 shadow-sm focus:ring-green-500 focus:border-green-500 placeholder-gray-400 transition" placeholder="Matrรญcula o N. Control" required />
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย <label for="pay-amount" class="block text-sm font-medium text-gray-700 mb-1">Monto (MXN)</label>
ย ย ย ย ย ย ย <input id="pay-amount" type="number" step="0.01" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 shadow-sm focus:ring-green-500 focus:border-green-500 transition" placeholder="Ej: 1500.00" required />
ย ย ย ย ย ย </div>
ย ย ย ย ย </div>

ย ย ย ย ย <div>
ย ย ย ย ย ย <label for="pay-method" class="block text-sm font-medium text-gray-700 mb-1">Mรฉtodo de Pago</label>
ย ย ย ย ย ย <select id="pay-method" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 shadow-sm focus:ring-green-500 focus:border-green-500 bg-white transition">
ย ย ย ย ย ย ย <option value="tarjeta">๐ณ Tarjeta (Fรญsico)</option>
ย ย ย ย ย ย ย <option value="referencia">๐ Referencia Bancaria (Manual)</option>
ย ย ย ย ย ย ย <option value="transferencia">๐ฆ Transferencia / SPEI</option>
ย ย ย ย ย ย ย <option value="efectivo">๐ต Efectivo (Caja)</option>
ย ย ย ย ย ย ย <option value="otro">Otro</option>
ย ย ย ย ย ย </select>
ย ย ย ย ย </div>
ย ย ย ย ย 
ย ย ย ย ย <div>
ย ย ย ย ย ย <label for="pay-ref" class="block text-sm font-medium text-gray-700 mb-1">Referencia / Folio (opcional)</label>
ย ย ย ย ย ย <input id="pay-ref" type="text" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 shadow-sm focus:ring-green-500 focus:border-green-500 placeholder-gray-400 transition" placeholder="Folio de transferencia o referencia" />
ย ย ย ย ย </div>

ย ย ย ย ย <div class="flex justify-end gap-3 pt-6">
ย ย ย ย ย ย <button type="button" id="pay-cancel" class="px-5 py-2 border border-gray-300 text-gray-700 rounded-lg shadow-sm hover:bg-gray-100 transition font-medium">Cancelar</button>
ย ย ย ย ย ย <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition font-medium flex items-center">
ย ย ย ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h-2v5.586l-.293-.293z" /><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm-5-8a1 1 0 011-1h8a1 1 0 011 1v1a1 1 0 01-1 1H6a1 1 0 01-1-1v-1z" /></svg>
ย ย ย ย ย ย ย ย Guardar Pago
ย ย ย ย ย ย </button>
ย ย ย ย ย </div>
ย ย ย ย </form>
ย ย ย </div>
ย ย </div>
ย ย 
ย ย <div id="detail-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 transition-opacity duration-300 ease-out opacity-0">
ย ย ย ย <div class="bg-white rounded-xl w-full max-w-xl p-8 shadow-2xl transform scale-95 transition-transform duration-300 ease-out">
ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-900 mb-6 border-b pb-2 flex items-center">
ย ย ย ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
ย ย ย ย ย ย ย ย Detalle de Transacciรณn
ย ย ย ย ย ย </h3>
ย ย ย ย ย ย 
ย ย ย ย ย ย <div class="space-y-6">
ย ย ย ย ย ย ย ย <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
ย ย ย ย ย ย ย ย ย ย <h4 class="text-base font-bold text-blue-800 flex items-center mb-2">
ย ย ย ย ย ย ย ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.98 5.98 0 0010 16a5.979 5.979 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" /></svg>
ย ย ย ย ย ย ย ย ย ย ย ย Datos del Estudiante
ย ย ย ย ย ย ย ย ย ย </h4>
ย ย ย ย ย ย ย ย ย ย <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dt class="text-gray-500 font-medium">Nombre Completo:</dt>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dd id="detail-student-name" class="text-gray-900 font-semibold"></dd>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dt class="text-gray-500 font-medium">N. Control / Matrรญcula:</dt>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dd id="detail-student-control" class="text-gray-900"></dd>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dt class="text-gray-500 font-medium">Carrera:</dt>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dd id="detail-student-carrera" class="text-gray-900"></dd>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dt class="text-gray-500 font-medium">Adeudo Pendiente Total:</dt>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dd id="detail-student-adeudo" class="text-2xl font-extrabold text-red-600"></dd>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </dl>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย <div class="border-t pt-4">
ย ย ย ย ย ย ย ย ย ย <h4 class="text-base font-bold text-gray-800 flex items-center mb-2">
ย ย ย ย ย ย ย ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V6m0 4v2m0 2v2m0 0V4m-7 8a7 7 0 1114 0 7 7 0 01-14 0z" /></svg>
ย ย ย ย ย ย ย ย ย ย ย ย Detalles de la Transacciรณn
ย ย ย ย ย ย ย ย ย ย </h4>
ย ย ย ย ย ย ย ย ย ย <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dt class="text-gray-500 font-medium">Monto Pagado:</dt>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dd id="detail-payment-amount" class="text-gray-900 font-bold text-lg"></dd>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dt class="text-gray-500 font-medium">Fecha de Pago:</dt>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dd id="detail-payment-date" class="text-gray-900"></dd>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dt class="text-gray-500 font-medium">Concepto:</dt>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dd id="detail-payment-concept" class="text-gray-900"></dd>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dt class="text-gray-500 font-medium">Mรฉtodo:</dt>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dd id="detail-payment-method" class="text-gray-900"></dd>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-span-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dt class="text-gray-500 font-medium">Referencia/Folio:</dt>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <dd id="detail-payment-reference" class="text-gray-900 italic"></dd>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </dl>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

            ย ย ย ย ย ย <div class="flex justify-between pt-6 border-t mt-6">
                <button type="button" id="detail-delete-btn" class="px-5 py-2 bg-red-100 border border-red-300 text-red-700 rounded-lg shadow-sm hover:bg-red-200 transition font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    Eliminar Transacciรณn
                </button>
ย ย ย ย ย ย ย ย <button type="button" id="detail-close" class="px-5 py-2 bg-gray-100 border border-gray-300 text-gray-700 rounded-lg shadow-sm hover:bg-gray-200 transition font-medium">Cerrar</button>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย </div>

ย <script type="module" client:load>
ย ย // Mapeo de carreras (debe ser el mismo que uses en la vista de alumnos)
ย ย const CARRERA_MAP = {
ย ย ย ย 'AGR': 'Agronomรญa',
ย ย ย ย 'INF': 'Informรกtica',
ย ย ย ย 'ADM': 'Administraciรณn',
ย ย ย ย 'TEC': 'Ofimรกtica',
ย ย ย ย '': 'Sin Carrera',
ย ย ย ย '0': 'Sin Carrera',
ย ย };

ย ย // Variable para almacenar el ID del cargo que se estรก viendo/editando
    let currentChargeId = null; 

ย ย // --- UTILERIAS DE DATOS ---
ย ย const getCharges = () => { try { return JSON.parse(localStorage.getItem('chargesList') || '[]'); } catch(e){ return []; } };
ย ย const getStudents = () => { try { return JSON.parse(localStorage.getItem('studentsList') || '[]'); } catch(e){ return []; } };
ย ย const getConcepts = () => { try { return JSON.parse(localStorage.getItem('conceptsList') || '[]'); } catch(e){ return []; } };
ย ย const saveCharges = (arr) => { localStorage.setItem('chargesList', JSON.stringify(arr)); try{ localStorage.setItem('chargesLastUpdate', Date.now().toString()); }catch(e){} };

ย ย const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
ย ย const fmtCurrency = n => { const v = Number(n || 0); return '$' + v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); };
ย ย 
ย ย // Funciรณn mejorada para formatear la fecha
ย ย const parseDate = d => { 
ย ย ย ย try { 
ย ย ย ย ย ย if (!d) return '-'; 
ย ย ย ย ย ย const dt = new Date(d); 
ย ย ย ย ย ย if (isNaN(dt.getTime())) return String(d).slice(0, 16); 
ย ย ย ย ย ย return dt.toLocaleString('es-MX', { 
ย ย ย ย ย ย ย ย year: 'numeric', month: '2-digit', day: '2-digit', 
ย ย ย ย ย ย ย ย hour: '2-digit', minute: '2-digit', second: '2-digit',
ย ย ย ย ย ย ย ย hour12: true
ย ย ย ย ย ย }); 
ย ย ย ย } catch(e){ return String(d); } 
ย ย };
ย ย 
ย ย // Funciรณn NUEVA: Calcula el total de adeudo (cargos pendientes) para un estudiante
ย ย function getStudentAdeudo(studentId) {
ย ย ย ย try {
ย ย ย ย ย ย const charges = getCharges();
ย ย ย ย ย ย // Filtrar solo los cargos que NO han sido pagados (status != 'paid')
ย ย ย ย ย ย return charges
ย ย ย ย ย ย ย .filter(c => 
ย ย ย ย ย ย ย ย (String(c.studentId) === String(studentId)) && 
ย ย ย ย ย ย ย ย (String(c.status || 'pending').toLowerCase() !== 'paid' && String(c.status || 'pending').toLowerCase() !== 'pagado')
ย ย ย ย ย ย ย )
ย ย ย ย ย ย ย .reduce((sum, c) => sum + (Number(c.amount) || 0), 0);
ย ย ย ย } catch (e) {
ย ย ย ย ย ย return 0;
ย ย ย ย }
ย ย }


ย ย // --- CONSTRUCCIรN DE LA LISTA UNIFICADA ---
ย ย function buildPaymentsList() {
ย ย ย const charges = getCharges();
ย ย ย const students = getStudents();
ย ย ย const concepts = getConcepts();
ย ย ย 
ย ย ย if (!Array.isArray(charges) || charges.length === 0) return [];
ย ย ย 
ย ย ย const list = charges.map(ch => {
ย ย ย ย // Buscar estudiante por ID, N. Control o matrรญcula
ย ย ย ย const student = students.find(s => 
ย ย ย ย ย ย String(s.id) === String(ch.studentId) || 
ย ย ย ย ย ย String(s.numControl) === String(ch.studentId) || 
ย ย ย ย ย ย String(s.matricula) === String(ch.studentId)
ย ย ย ย ) || {};
ย ย ย ย 
ย ย ย ย // Buscar concepto por ID
ย ย ย ย const concept = concepts.find(c => String(c.id) === String(ch.conceptId)) || {};
ย ย ย ย 
ย ย ย ย const methodRaw = (ch.method || ch.paymentMethod || ch.metodo || '').toString().toLowerCase();

ย ย ย ย return {
ย ย ย ย ย id: ch.id || ('chg_' + Math.random().toString(36).slice(2,8)),
ย ย ย ย ย date: ch.paidAt || ch.createdAt || ch.created || ch.date || null,
ย ย ย ย ย conceptTitle: concept.title || concept.concept || ch.conceptTitle || 'Pago Genรฉrico',
ย ย ย ย ย amount: ch.amount ?? ch.monto ?? concept.amount ?? concept.monto ?? 0,
ย ย ย ย ย method: methodRaw,
ย ย ย ย ย reference: ch.reference || '-', // Aรฑadir referencia al objeto
ย ย ย ย ย studentControl: student.numControl ?? student.matricula ?? ch.studentId ?? '-',
ย ย ย ย ย studentName: [student.nombre, student.apellidoP, student.apellidoM].filter(Boolean).join(' ') || student.fullName || student.name || 'Alumno Desconocido',
ย ย ย ย ย studentCarrera: student.carrera || student.career || '-', // Aรฑadir carrera
ย ย ย ย ย studentId: student.id || ch.studentId, // Asegurar el ID del estudiante
ย ย ย ย ย status: (ch.status || 'paid').toLowerCase()
ย ย ย ย };
ย ย ย });

ย ย ย // Ordenar por fecha, el mรกs reciente primero
ย ย ย return list.sort((a,b) => {
ย ย ย ย const da = a.date ? new Date(a.date).getTime() : 0;
ย ย ย ย const db = b.date ? new Date(b.date).getTime() : 0;
ย ย ย ย return db - da;
ย ย ย });
ย ย }

ย ย // --- LรGICA DE FILTRADO (MANTENIDA) ---
ย ย function methodMatchesFilter(method, filter) {
ย ย ย if (!filter || filter === 'all') return true;
ย ย ย if (!method) return (filter === 'otro'); 

ย ย ย const m = method.toLowerCase();
ย ย ย 
ย ย ย if (filter === 'tarjeta') return m.includes('tarjeta') || m.includes('card');
ย ย ย if (filter === 'referenciado') return m.includes('referen'); 
ย ย ย if (filter === 'transferencia') return m.includes('transfer') || m.includes('spei') || m.includes('bank');
ย ย ย 
ย ย ย if (filter === 'otro') {
ย ย ย ย ย return !methodMatchesFilter(method, 'tarjeta') && 
ย ย ย ย ย ย ย ย ย!methodMatchesFilter(method, 'referenciado') && 
ย ย ย ย ย ย ย ย ย!methodMatchesFilter(method, 'transferencia');
ย ย ย }

ย ย ย return false;
ย ย }

ย ย // --- RENDERIZADO DE LA TABLA ---
ย ย function renderPayments(filter = 'all') {
ย ย ย const tbody = document.getElementById('payments-table-body');
ย ย ย if (!tbody) return;

ย ย ย const list = buildPaymentsList();
ย ย ย const filtered = list.filter(item => methodMatchesFilter(item.method, filter));
ย ย ย 
ย ย ย if (!filtered.length) {
ย ย ย ย tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500 font-medium text-base">๐ No hay registros de pagos para el filtro seleccionado.</td></tr>';
ย ย ย ย return;
ย ย ย }
ย ย ย 
ย ย ย tbody.innerHTML = filtered.map(r => {
ย ย ย ย const rowClass = 'hover:bg-green-50/20'; 
ย ย ย ย 
ย ย ย ย return `
ย ย ย ย ย <tr class="${rowClass} transition duration-150 ease-in-out">
ย ย ย ย ย ย <td class="px-6 py-4 text-sm text-gray-600">${esc(parseDate(r.date))}</td>
ย ย ย ย ย ย <td class="px-6 py-4 text-sm text-gray-800 font-medium">${esc(r.conceptTitle)}</td>
ย ย ย ย ย ย <td class="px-6 py-4 text-sm text-green-700 font-bold">${esc(fmtCurrency(r.amount))}</td>
ย ย ย ย ย ย <td class="px-6 py-4 text-sm text-gray-700">${esc(r.method)}</td>
ย ย ย ย ย ย <td class="px-6 py-4 text-sm text-gray-600">${esc(r.studentControl)}</td>
ย ย ย ย ย ย <td class="px-6 py-4 text-sm text-gray-800">${esc(r.studentName)}</td>
ย ย ย ย ย ย <td class="px-6 py-4 text-right text-sm">
ย ย ย ย ย ย ย <button data-id="${esc(r.id)}" data-student-id="${esc(r.studentId)}" class="px-3 py-1 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition view-payment">Ver Detalle</button>
ย ย ย ย ย ย </td>
ย ย ย ย ย </tr>
ย ย ย ย `;
ย ย ย }).join('');
ย ย }

ย ย // --- LรGICA DE MODALES ---
ย ย const payModal = document.getElementById('pay-modal');
ย ย const payForm = document.getElementById('pay-form');
ย ย 
ย ย const detailModal = document.getElementById('detail-modal');
    const detailDeleteBtn = document.getElementById('detail-delete-btn');
ย ย 
ย ย // Funciรณn genรฉrica para abrir modal
ย ย const openModal = (modalEl) => {
ย ย ย ย modalEl.classList.remove('hidden', 'opacity-0'); 
ย ย ย ย modalEl.classList.add('flex');
ย ย ย ย // Usamos setTimeout para asegurar que la clase 'scale-95' se remova despuรฉs de que 'flex' sea aplicado.
ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย modalEl.classList.remove('opacity-0');
ย ย ย ย ย ย modalEl.querySelector('.scale-95')?.classList.remove('scale-95');
ย ย ย ย ย ย modalEl.querySelector('.scale-95')?.classList.add('scale-100');
ย ย ย ย }, 10);
ย ย };
ย ย 
ย ย // Funciรณn genรฉrica para cerrar modal
ย ย const closeModal = (modalEl) => {
ย ย ย ย modalEl.querySelector('.scale-100')?.classList.remove('scale-100');
ย ย ย ย modalEl.querySelector('.scale-95')?.classList.add('scale-95');
ย ย ย ย modalEl.classList.add('opacity-0');
        // Limpiar el ID de la transacciรณn al cerrar el modal de detalle
        if (modalEl === detailModal) {
            currentChargeId = null;
        }
ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย modalEl.classList.add('hidden'); 
ย ย ย ย ย ย modalEl.classList.remove('flex');
ย ย ย ย }, 300); 
ย ย };

ย ย // Abre el modal de Registro de Pago
ย ย const openPayModal = (sid = '') => {
ย ย ย ย document.getElementById('pay-student-id').value = sid;
ย ย ย ย document.getElementById('pay-amount').value = '';
ย ย ย ย document.getElementById('pay-ref').value = '';
ย ย ย ย document.getElementById('pay-method').value = 'efectivo';
ย ย ย ย openModal(payModal);
ย ย ย ย document.getElementById('pay-student-id').focus();
ย ย };

ย ย // Cierra el modal de Registro de Pago
ย ย document.getElementById('pay-cancel')?.addEventListener('click', () => closeModal(payModal));
ย ย 
ย ย // Cierra el modal de Detalle
ย ย document.getElementById('detail-close')?.addEventListener('click', () => closeModal(detailModal));

ย ย // Funciรณn para mostrar los detalles
ย ย function showDetailModal(chargeId) {
ย ย ย ย const list = buildPaymentsList();
ย ย ย ย const charge = list.find(c => c.id === chargeId);
ย ย ย ย 
ย ย ย ย if (!charge) {
ย ย ย ย ย ย alert('Error: No se encontrรณ el detalle de pago.');
ย ย ย ย ย ย return;
ย ย ย ย }

        // ESTABLECER EL ID DEL PAGO ACTUAL
        currentChargeId = chargeId;

ย ย ย ย // Obtener datos del estudiante y el adeudo
ย ย ย ย const totalAdeudo = getStudentAdeudo(charge.studentId);
ย ย ย ย const carreraDisplay = CARRERA_MAP[charge.studentCarrera] || charge.studentCarrera;

ย ย ย ย // Rellenar datos del ESTUDIANTE y ADEUDO
ย ย ย ย document.getElementById('detail-student-name').textContent = esc(charge.studentName);
ย ย ย ย document.getElementById('detail-student-control').textContent = esc(charge.studentControl);
ย ย ย ย document.getElementById('detail-student-carrera').textContent = esc(carreraDisplay);
ย ย ย ย document.getElementById('detail-student-adeudo').textContent = fmtCurrency(totalAdeudo);
ย ย ย ย 
ย ย ย ย // Rellenar datos del PAGO
ย ย ย ย document.getElementById('detail-payment-amount').textContent = fmtCurrency(charge.amount);
ย ย ย ย document.getElementById('detail-payment-date').textContent = parseDate(charge.date);
ย ย ย ย document.getElementById('detail-payment-concept').textContent = esc(charge.conceptTitle);
ย ย ย ย document.getElementById('detail-payment-method').textContent = esc(charge.method);
ย ย ย ย document.getElementById('detail-payment-reference').textContent = esc(charge.reference);
ย ย ย ย 
ย ย ย ย openModal(detailModal);
ย ย }

    // Funciรณn para manejar la eliminaciรณn de un pago
    function handleDeleteCharge(chargeId) {
        if (!chargeId) {
            alert('Error: ID de pago no vรกlido.');
            return;
        }

        if (!confirm('โ๏ธ CONFIRMACIรN: ยฟEstรก seguro de que desea ELIMINAR permanentemente esta transacciรณn de pago? Esta acciรณn no se puede deshacer.')) {
            return;
        }
        
        let charges = getCharges();
        const initialLength = charges.length;
        
        // Filtrar y eliminar el cargo con el ID correspondiente
        charges = charges.filter(c => c.id !== chargeId);

        if (charges.length === initialLength) {
             alert('Error: No se encontrรณ la transacciรณn para eliminar.');
             return;
        }

        saveCharges(charges);
        closeModal(detailModal); 
        renderPayments(document.getElementById('method-filter')?.value || 'all'); 
        alert('๐๏ธ Transacciรณn eliminada con รฉxito.');
    }
ย ย 
ย ย // --- LISTENERS ---

ย ย // 1. Filtro
ย ย document.getElementById('method-filter')?.addEventListener('change', (e) => renderPayments(e.target.value));
ย ย 
ย ย // 2. Botรณn Abrir Modal (principal)
ย ย document.getElementById('open-pay-modal-btn')?.addEventListener('click', () => openPayModal());

ย ย // 3. Delegaciรณn para botรณn 'Ver Detalle' (AHORA ABRE EL NUEVO MODAL)
ย ย document.addEventListener('click', (ev) => {
ย ย ย const btn = ev.target.closest && ev.target.closest('.view-payment');
ย ย ย if (btn) {
ย ย ย ย const id = btn.getAttribute('data-id');
ย ย ย ย showDetailModal(id);
ย ย ย }
ย ย });

    // 4. Botรณn Eliminar en el Modal de Detalle
    detailDeleteBtn?.addEventListener('click', () => {
        if (currentChargeId) {
            handleDeleteCharge(currentChargeId);
        } else {
            alert('Error: No hay transacciรณn seleccionada para eliminar.');
        }
    });


ย ย // 5. Submit del Formulario
ย ย payForm?.addEventListener('submit', (e) => {
ย ย ย e.preventDefault();
ย ย ย const studentId = document.getElementById('pay-student-id').value.trim();
ย ย ย const amount = parseFloat(document.getElementById('pay-amount').value) || 0;
ย ย ย const method = document.getElementById('pay-method').value || 'efectivo';
ย ย ย const reference = document.getElementById('pay-ref').value || '';
ย ย ย 
ย ย ย if (!studentId || amount <= 0) { 
ย ย ย ย ย alert('โ๏ธ Complete Matrรญcula/N. Control y un Monto vรกlido.'); 
ย ย ย ย ย return; 
ย ย ย }
ย ย ย 
ย ย ย const charges = getCharges();
ย ย ย const now = new Date().toISOString();
ย ย ย 
ย ย ย const newCharge = {
ย ย ย ย id: 'chg_' + (Date.now().toString(36) + Math.random().toString(36).slice(2,6)),
ย ย ย ย studentId,
ย ย ย ย amount,
ย ย ย ย method,
ย ย ย ย reference,
ย ย ย ย status: 'paid', 
ย ย ย ย paidAt: now,
ย ย ย ย createdAt: now
ย ย ย };
ย ย ย 
ย ย ย charges.push(newCharge);
ย ย ย saveCharges(charges); 
ย ย ย 
ย ย ย closeModal(payModal); 
ย ย ย renderPayments(document.getElementById('method-filter')?.value || 'all'); 
ย ย ย alert('โ Pago registrado exitosamente.');
ย ย });

ย ย // 6. Re-render en cambios de localStorage (para sincronizar con otras pantallas)
ย ย window.addEventListener('storage', (e) => {
ย ย ย if (['chargesList','studentsList','conceptsList','chargesLastUpdate'].includes(e.key)) {
ย ย ย ย renderPayments(document.getElementById('method-filter')?.value || 'all');
ย ย ย }
ย ย });

ย ย // ๐ Inicializaciรณn
ย ย renderPayments(document.getElementById('method-filter')?.value || 'all');
ย </script>
</Layout>