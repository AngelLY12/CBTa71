---
import Layout from '../layouts/Layout.astro'; 
const pageTitle = "Conceptos de Cobro"; 
---

<Layout title={pageTitle}>  

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 bg-gray-50/50 min-h-screen">    

  <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 pb-4 border-b border-green-700/50">
    <div class="flex items-start">
      <div class="p-3 bg-[#154335] rounded-xl shadow-lg mr-3 flex-shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
      </div>
      <div>
        <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 tracking-tight">Gesti√≥n de Conceptos de Cobro üè∑Ô∏è</h1>
        <p class="text-sm text-gray-500 mt-1">Definici√≥n y asignaci√≥n de adeudos a grupos de estudiantes.</p>
      </div>
    </div>
    
    <a href="/new" class="mt-4 sm:mt-0 px-4 py-2 sm:px-6 sm:py-2 bg-green-700 text-white font-bold rounded-lg shadow-md hover:bg-green-800 transition-colors duration-300 text-sm sm:text-base">
      <i class="fas fa-plus-circle mr-2"></i> Crear Nuevo Concepto
    </a>    
  </header>    

  <!-- Grid responsivo tipo tabla -->
  <div id="concepts-grid" class="grid gap-4 sm:gap-6" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));"></div>  

</div>  

<script type="module" client:load>  
const CONCEPTS_KEY = 'conceptsList';
const STUDENTS_KEY = 'studentsList';
const CHARGES_KEY = 'chargesList';

function getStudents() { return JSON.parse(localStorage.getItem(STUDENTS_KEY)||'[]'); }     
function getCharges() { return JSON.parse(localStorage.getItem(CHARGES_KEY)||'[]'); }     
function getConcepts() { return JSON.parse(localStorage.getItem(CONCEPTS_KEY)||'[]'); }     
function saveConcepts(c){ localStorage.setItem(CONCEPTS_KEY, JSON.stringify(c)); }     
function saveCharges(c){ localStorage.setItem(CHARGES_KEY, JSON.stringify(c)); }     
function saveStudents(s){ localStorage.setItem(STUDENTS_KEY, JSON.stringify(s)); }     

function escapeHtml(str=''){ 
  return String(str).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); 
}     

function getTargetStudentsForConcept(concept){       
  const students=getStudents().filter(s=>!['inactive','inactivo'].includes(String(s.status||'').toLowerCase()));       
  const scope=(concept.scope||'all').toLowerCase();       
  const selectedStudentsIds = (concept.selectedStudents||[]).map(x=>String(x.id||x));
  switch(scope){         
    case 'all': return students;         
    case 'career': return students.filter(s=>(s.carrera||s.career||'').toLowerCase() === (concept.career||'').toLowerCase());         
    case 'semester': return students.filter(s=>Number(s.semestre||s.semester||0) === Number(concept.semester||0));         
    case 'students': return students.filter(s=>selectedStudentsIds.includes(String(s.id)));         
    default: return [];       
  }     
}     

function getScopeText(concept){       
  const scope=(concept.scope||'all').toLowerCase();       
  switch(scope){         
    case 'all': return 'Todos Activos';         
    case 'career': return `Carrera: ${escapeHtml(concept.career||'N/A')}`;         
    case 'semester': return `${concept.semester||'??'}¬∞ Semestre`;         
    case 'students': return `${concept.selectedStudents?.length||0} Alumnos Espec√≠ficos`;         
    default: return 'No Definido';       
  }     
}     

function assignConceptToScope(concept){       
  const targets=getTargetStudentsForConcept(concept);       
  if(!targets.length){ alert('No hay alumnos objetivo para asignar este concepto.'); return 0; }         
  
  if(!confirm(`¬øDesea asignar el concepto "${concept.title}" ($${Number(concept.amount||0).toFixed(2)}) a ${targets.length} alumnos?`)){
      return 0;
  }

  const charges=getCharges();       
  const now=new Date().toISOString();       
  const amount=Number(concept.amount)||0;        

  const toAdd=targets.map(s=>{         
    if((s.charges||[]).some(ch=>ch.conceptId===concept.id && ch.status==='pending')){
        return null; 
    }

    s.charges = s.charges || [];         
    const charge = {           
      id: 'chg_'+(Date.now().toString(36)+Math.random().toString(36).slice(2,6)),           
      conceptId: concept.id,           
      amount,           
      status: 'pending', 
      studentId: s.id, 
      conceptTitle: concept.title, 
      createdAt: now           
    };         
    s.charges.push(charge);         
    return charge;       
  }).filter(c => c !== null); 
  
  if(!toAdd.length){
      alert('Todos los alumnos objetivo ya tienen este cargo pendiente. No se a√±adi√≥ ning√∫n adeudo.');
      return 0;
  }

  saveStudents(getStudents());       
  saveCharges(charges.concat(toAdd));       
  alert(`‚úÖ Asignados ${toAdd.length} nuevos adeudos con √©xito.`);       
  return toAdd.length;     
}     

function editConcept(id){       
  const c=getConcepts().find(x=>x.id===id);       
  if(!c) return alert('Concepto no encontrado');       
  localStorage.setItem('editingConcept', JSON.stringify(c));       
  window.location.href='/new?edit='+encodeURIComponent(id);     
}     

function deleteConcept(id){       
  if(!confirm('‚ö†Ô∏è ¬øEst√° seguro que desea ELIMINAR este concepto y TODOS los ADEUDOS PENDIENTES asociados? Esta acci√≥n es irreversible.')) return;       
  saveConcepts(getConcepts().filter(c=>c.id!==id));       
  const students=getStudents().map(s=>{         
    s.charges = (s.charges||[]).filter(ch=>ch.conceptId!==id);         
    return s;       
  });       
  saveStudents(students);       
  saveCharges(getCharges().filter(ch=>ch.conceptId!==id));       
  renderConcepts(); 
  alert('üóëÔ∏è Concepto y adeudos asociados eliminados con √©xito.');
}     

function formatCurrency(amount) {
  return new Intl.NumberFormat('es-MX', { style:'currency', currency:'MXN', minimumFractionDigits:2 }).format(amount);
}

function renderConcepts(){       
  const grid=document.getElementById('concepts-grid');       
  if(!grid) return;        

  const list=getConcepts().sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));       

  if(!list.length){         
    grid.innerHTML=`
      <div class="col-span-2 text-center py-16 bg-white rounded-xl shadow border border-gray-200">
        <i class="fas fa-folder-open text-5xl mb-4 text-gray-400"></i>
        <p class="text-lg text-gray-700 font-semibold mb-3">A√∫n no hay conceptos de cobro creados.</p>
        <p class="text-sm text-gray-500 mb-6">Utiliza el bot√≥n para empezar a definir tus cuotas.</p>
        <a href="/new" class="inline-block px-5 py-2.5 bg-green-700 text-white rounded-xl shadow-md hover:bg-green-800 transition-colors text-base font-medium">
          <i class="fas fa-plus-circle mr-2"></i> Crear Primer Concepto
        </a>
      </div>`;
    return;       
  }        

  grid.innerHTML=list.map(c=>{         
    const amount=Number(c.amount)||0;         
    const targets=getTargetStudentsForConcept(c);
    const targetCount=targets.length; 
    const pendingCharges = getCharges().filter(ch => ch.conceptId === c.id && ch.status === 'pending').length;

    return `           
      <div class="concept-card bg-white rounded-xl shadow border border-gray-100 p-3 flex flex-col justify-between hover:shadow-md transition duration-200">
        <div class="space-y-1 flex-grow overflow-hidden"> 
          <div class="flex justify-between items-start border-b pb-1 border-gray-100">
            <h3 class="font-bold text-sm line-clamp-2">${escapeHtml(c.title)}</h3>
            <div class="text-lg font-bold text-amber-600 ml-2 flex-shrink-0">${formatCurrency(amount)}</div>
          </div>

          <div class="text-xs text-gray-700 mt-1 space-y-0.5">
            <p class="flex items-center"><strong class="text-gray-500 mr-1">Objetivo:</strong> ${getScopeText(c)}</p>
            <p class="flex items-center"><strong class="text-gray-500 mr-1">Pendientes:</strong> 
              <span class="font-bold ${pendingCharges > 0 ? 'text-red-600' : 'text-green-600'}">${pendingCharges}</span>
            </p>
          </div>

          <div class="pt-1 border-t border-gray-100">
            <div class="text-[0.65rem] text-gray-500 italic hidden details mb-1" id="details-${c.id}">             
              <p class="line-clamp-2">${c.description ? escapeHtml(c.description) : 'Sin descripci√≥n detallada.'}</p>             
            </div>               
            <button data-concept-id="${c.id}" class="toggle-desc text-green-700 hover:text-green-900 transition text-[0.6rem] font-semibold">Ver m√°s</button>              
          </div>
        </div>         

        <div class="mt-2 pt-2 border-t border-gray-100 space-y-1">         
          <button data-concept-id="${c.id}" class="assign-all w-full px-2 py-1.5 text-xs font-medium bg-green-700 text-white rounded-lg hover:bg-green-800 shadow-md transition">
            <i class="fas fa-money-bill-wave mr-1"></i> Asignar
          </button>         
          <div class="flex space-x-1">
            <button data-concept-id="${c.id}" class="edit-concept w-1/2 px-2 py-1.5 text-xs font-medium border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition">
              <i class="fas fa-edit"></i> Editar
            </button>         
            <button data-concept-id="${c.id}" class="delete-concept w-1/2 px-2 py-1.5 text-xs font-medium bg-red-50 text-red-700 rounded-lg hover:bg-red-100 border border-red-200 transition">
              <i class="fas fa-trash-alt"></i> Eliminar
            </button>
          </div>
        </div>         
      </div>`;       
  }).join('');

  document.querySelectorAll('.toggle-desc').forEach(btn=>{         
    btn.onclick=()=>{           
      const id=btn.dataset.conceptId;           
      const details=document.getElementById(`details-${id}`);           
      if(details.classList.contains('hidden')){             
        details.classList.remove('hidden');             
        btn.textContent='Ocultar';           
      } else {             
        details.classList.add('hidden');             
        btn.textContent='Ver m√°s';           
      }         
    };       
  });     
}       

document.addEventListener('click', ev=>{       
  const assignBtn=ev.target.closest?.('.assign-all');       
  if(assignBtn){ 
      const concept = getConcepts().find(c=>c.id===assignBtn.dataset.conceptId);
      assignConceptToScope(concept); 
      renderConcepts(); 
      return; 
  }         

  const editBtn=ev.target.closest?.('.edit-concept');       
  if(editBtn){ editConcept(editBtn.dataset.conceptId); return; }         

  const delBtn=ev.target.closest?.('.delete-concept');       
  if(delBtn){ deleteConcept(delBtn.dataset.conceptId); return; }     
});       

renderConcepts();     
window.addEventListener('storage', ()=>renderConcepts());   
</script>     

<style>     
.hidden { display: none; }     
.line-clamp-2 { 
    overflow: hidden; 
    display: -webkit-box; 
    -webkit-box-orient: vertical; 
    -webkit-line-clamp: 2;
    white-space: normal;
}
.concept-card button { cursor: pointer; }
</style> 

</Layout>
