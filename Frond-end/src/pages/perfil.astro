---
import Layout from '../layouts/Layout.astro';
const API_BASE_URL = (import.meta.env.PUBLIC_API_BASE_URL ?? (() => { throw new Error('Falta PUBLIC_API_BASE_URL'); })()).replace(/\/$/, '');
---

<Layout title="Mi Perfil">
    <div x-data="perfilData" x-cloak class="max-w-4xl mx-auto px-4 sm:px-0 overflow-x-hidden">
        <!-- Encabezado -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-5 flex flex-wrap items-center gap-3 md:gap-4 mb-4">
            <div class="flex items-center gap-3 md:gap-4 flex-1 min-w-0">
                <div class="w-16 h-16 md:w-20 md:h-20 bg-gradient-to-br from-emerald-400 via-teal-500 to-cyan-600 rounded-2xl flex items-center justify-center shadow-xl shrink-0">
                    <svg class="w-9 h-9 md:w-10 md:h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-3.5 0-7 1.8-7 4v1h14v-1c0-2.2-3.5-4-7-4Z" />
                    </svg>
                </div>
                <div class="min-w-0">
                    <h1 class="text-2xl md:text-3xl font-bold text-institucional mb-1 break-words" x-text="userName || 'Cargando...'"></h1>
                    <p class="text-gray-500 text-xs mt-1 break-all" x-text="'Correo: ' + (userEmail || 'No disponible')"></p>
                    <div class="flex flex-wrap items-center gap-2 mt-2">
                        <template x-for="role in userRoles" :key="role">
                            <span class="px-2.5 py-1.5 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-full text-xs font-semibold shadow-md" x-text="role"></span>
                        </template>
                    </div>
                </div>
            </div>
            <div class="ml-auto flex flex-wrap items-center gap-2">
                <button @click="editProfile()" class="h-8 px-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-md hover:from-indigo-600 hover:to-purple-700 transition-all shadow-md text-xs font-semibold whitespace-nowrap">
                    Editar Perfil
                </button>
                <button @click="changePassword()" class="h-8 px-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white rounded-md hover:from-gray-700 hover:to-gray-800 transition-all shadow-md text-xs font-semibold whitespace-nowrap">
                    Cambiar Contrase√±a
                </button>
            </div>
        </div>

        <!-- Tarjeta de Informaci√≥n -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="bg-institucional text-white p-6 flex items-center gap-3">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-xl md:text-2xl font-bold">Informaci√≥n de Perfil</h2>
            </div>
            
            <div class="p-4 md:p-6">
                <div class="grid md:grid-cols-2 gap-4 md:gap-6">
                    <!-- Informaci√≥n Personal -->
                    <div>
                        <h3 class="text-xl font-bold text-institucional mb-4">Datos Personales</h3>
                        
                        <div class="space-y-3">
                            <div class="border-l-4 border-purple-500 rounded-lg p-3.5 bg-gradient-to-r from-purple-50 to-pink-50">
                                <label class="text-sm font-semibold text-purple-700">Nombre Completo</label>
                                <p class="text-base md:text-lg mt-1 text-gray-800 font-medium break-words" x-text="userName || 'No disponible'"></p>
                            </div>
                            
                            <div class="border-l-4 border-blue-500 rounded-lg p-3.5 bg-gradient-to-r from-blue-50 to-cyan-50">
                                <label class="text-sm font-semibold text-blue-700">Correo Electr√≥nico</label>
                                <p class="text-base md:text-lg mt-1 text-gray-800 font-medium break-all" x-text="userEmail || 'No disponible'"></p>
                            </div>
                            
                            <div class="border-l-4 border-indigo-500 rounded-lg p-3.5 bg-gradient-to-r from-indigo-50 to-purple-50">
                                <label class="text-sm font-semibold text-indigo-700">ID de Usuario</label>
                                <p class="text-base md:text-lg mt-1 font-mono text-gray-700 font-semibold break-all" x-text="userId || 'No disponible'"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n de Acceso -->
                    <div>
                        <h3 class="text-xl font-bold text-institucional mb-4">Informaci√≥n de Acceso</h3>
                        
                        <div class="space-y-3">
                            <div class="border-l-4 border-green-500 rounded-lg p-3.5 bg-gradient-to-r from-green-50 to-emerald-50">
                                <label class="text-sm font-semibold text-green-700">Roles Asignados</label>
                                <div class="mt-2 flex flex-wrap gap-2">
                                    <template x-for="role in userRoles" :key="role">
                                        <span class="px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg text-sm font-semibold flex items-center shadow-md">
                                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                            </svg>
                                            <span x-text="role"></span>
                                        </span>
                                    </template>
                                    <span x-show="userRoles.length === 0" class="text-gray-500 italic">Sin roles asignados</span>
                                </div>
                            </div>
                            
                            <div class="border-l-4 border-orange-500 rounded-lg p-3.5 bg-gradient-to-r from-orange-50 to-amber-50">
                                <label class="text-sm font-semibold text-orange-700">√öltimo Acceso</label>
                                <p class="text-base md:text-lg mt-1 text-gray-800 font-medium break-words" x-text="lastLogin || 'Primera sesi√≥n'"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-5 pt-5 border-t border-slate-200">
                    <h3 class="text-xl font-bold text-institucional mb-4">Datos Complementarios</h3>
                    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        <template x-for="item in getVisibleExtraDetails()" :key="item.label">
                            <div class="border-l-4 rounded-lg p-3.5 bg-gradient-to-r" :class="item.className">
                                <label class="text-sm font-semibold" :class="item.labelClass" x-text="item.label"></label>
                                <p class="text-base mt-1 text-gray-800 font-medium break-words" x-text="item.value"></p>
                            </div>
                        </template>
                    </div>
                    <div x-show="getVisibleExtraDetails().length === 0" class="text-center py-6 text-gray-500">
                        No hay datos complementarios disponibles para este usuario.
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Permisos -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mt-4 md:mt-5">
            <div class="bg-institucional text-white p-6 flex items-center gap-3">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                <h2 class="text-2xl font-bold">Permisos del Sistema</h2>
            </div>
            
            <div class="p-6 md:p-8">
                <div class="grid md:grid-cols-3 gap-3">
                    <template x-for="permission in userPermissions" :key="permission">
                        <div class="flex items-center p-3 bg-gradient-to-r from-teal-50 to-cyan-50 rounded-lg border-l-4 border-teal-500 hover:shadow-md transition-shadow">
                            <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            <span class="font-medium text-gray-800" x-text="permission"></span>
                        </div>
                    </template>
                </div>
                <div x-show="userPermissions.length === 0" class="text-center py-8 text-gray-500">
                    <p>No hay permisos asignados</p>
                </div>
            </div>
        </div>

        <!-- Modal de Edici√≥n de Perfil -->
        <div x-show="showEditModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true" style="z-index: 9999;">
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:p-0">
                <!-- Overlay -->
                <div x-show="showEditModal" 
                     x-transition:enter="ease-out duration-300" 
                     x-transition:enter-start="opacity-0" 
                     x-transition:enter-end="opacity-100" 
                     x-transition:leave="ease-in duration-200" 
                     x-transition:leave-start="opacity-100" 
                     x-transition:leave-end="opacity-0" 
                     @click="showEditModal = false"
                     class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" 
                     style="z-index: 1;"
                     aria-hidden="true"></div>

                <!-- Modal Panel -->
                <div x-show="showEditModal" 
                     x-transition:enter="ease-out duration-300" 
                     x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
                     x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
                     x-transition:leave="ease-in duration-200" 
                     x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
                     x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
                     @click.stop
                     class="relative inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full"
                     style="z-index: 10;">
                    
                    <!-- Header del Modal -->
                    <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 px-6 py-5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </div>
                                <h3 class="text-2xl font-bold text-white" id="modal-title">Editar Perfil</h3>
                            </div>
                            <button @click="showEditModal = false" class="text-white/80 hover:text-white transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Body del Modal -->
                    <div class="bg-gradient-to-br from-slate-50 to-gray-100 px-6 py-6">
                        <!-- Mensajes de √©xito/error -->
                        <div x-show="successMessage" class="mb-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 rounded-lg">
                            <p class="text-green-700 font-semibold" x-text="successMessage"></p>
                        </div>
                        <div x-show="errorMessage" class="mb-4 p-4 bg-gradient-to-r from-red-50 to-orange-50 border-l-4 border-red-500 rounded-lg">
                            <p class="text-red-700 font-semibold" x-text="errorMessage"></p>
                        </div>

                        <form @submit.prevent="updateProfile" class="space-y-5">
                            <!-- Grid de campos -->
                            <div class="grid md:grid-cols-2 gap-5">
                                <!-- Nombre -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Nombre</label>
                                    <input type="text" x-model="formData.name" 
                                           class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white transition-all">
                                    <p x-show="errors.name" x-text="errors.name && errors.name[0]" class="mt-1 text-sm text-red-600"></p>
                                </div>

                                <!-- Apellido -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Apellido</label>
                                    <input type="text" x-model="formData.last_name" 
                                           class="w-full px-4 py-3 border-2 border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white transition-all">
                                    <p x-show="errors.last_name" x-text="errors.last_name && errors.last_name[0]" class="mt-1 text-sm text-red-600"></p>
                                </div>

                                <!-- Email -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Correo Electr√≥nico</label>
                                    <input type="email" x-model="formData.email" 
                                           class="w-full px-4 py-3 border-2 border-cyan-200 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 bg-white transition-all">
                                    <p x-show="errors.email" x-text="errors.email && errors.email[0]" class="mt-1 text-sm text-red-600"></p>
                                </div>

                                <!-- Tel√©fono -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Tel√©fono</label>
                                    <input type="tel" x-model="formData.phone_number" 
                                           class="w-full px-4 py-3 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white transition-all"
                                           placeholder="+5215512345678">
                                    <p x-show="errors.phone_number" x-text="errors.phone_number && errors.phone_number[0]" class="mt-1 text-sm text-red-600"></p>
                                </div>

                                <!-- Fecha de Nacimiento -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Fecha de Nacimiento</label>
                                    <input type="date" x-model="formData.birthdate" 
                                           class="w-full px-4 py-3 border-2 border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 bg-white transition-all">
                                    <p x-show="errors.birthdate" x-text="errors.birthdate && errors.birthdate[0]" class="mt-1 text-sm text-red-600"></p>
                                </div>

                                <!-- G√©nero -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">G√©nero</label>
                                    <select x-model="formData.gender" 
                                            class="w-full px-4 py-3 border-2 border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white transition-all">
                                        <option value="">Seleccionar...</option>
                                        <option value="hombre">Hombre</option>
                                        <option value="mujer">Mujer</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                    <p x-show="errors.gender" x-text="errors.gender && errors.gender[0]" class="mt-1 text-sm text-red-600"></p>
                                </div>

                                <!-- Tipo de Sangre -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Tipo de Sangre</label>
                                    <select x-model="formData.blood_type" 
                                            class="w-full px-4 py-3 border-2 border-red-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 bg-white transition-all">
                                        <option value="">Seleccionar...</option>
                                        <option value="O+">O+</option>
                                        <option value="O-">O-</option>
                                        <option value="A+">A+</option>
                                        <option value="A-">A-</option>
                                        <option value="B+">B+</option>
                                        <option value="B-">B-</option>
                                        <option value="AB+">AB+</option>
                                        <option value="AB-">AB-</option>
                                    </select>
                                    <p x-show="errors.blood_type" x-text="errors.blood_type && errors.blood_type[0]" class="mt-1 text-sm text-red-600"></p>
                                </div>
                            </div>

                            <!-- Direcci√≥n (campo completo) -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Direcci√≥n</label>
                                <textarea x-model="formData.address" rows="3"
                                          class="w-full px-4 py-3 border-2 border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white transition-all"
                                          placeholder="Calle, n√∫mero, colonia, ciudad..."></textarea>
                                <p x-show="errors.address" x-text="errors.address && errors.address[0]" class="mt-1 text-sm text-red-600"></p>
                            </div>

                            <!-- Botones de acci√≥n -->
                            <div class="flex flex-wrap gap-3 pt-4">
                                <button type="submit" 
                                        :disabled="isUpdating"
                                        class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                    <svg x-show="!isUpdating" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    <svg x-show="isUpdating" class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span x-text="isUpdating ? 'Guardando...' : 'Guardar Cambios'"></span>
                                </button>
                                <button type="button" @click="showEditModal = false"
                                        class="px-6 py-3 bg-gray-200 text-gray-800 font-bold rounded-lg hover:bg-gray-300 transition-colors">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Cambio de Contrase√±a -->
        <div x-show="showPasswordModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="password-modal-title" role="dialog" aria-modal="true" style="z-index: 9999;">
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:p-0">
                <!-- Overlay -->
                <div x-show="showPasswordModal" 
                     x-transition:enter="ease-out duration-300" 
                     x-transition:enter-start="opacity-0" 
                     x-transition:enter-end="opacity-100" 
                     x-transition:leave="ease-in duration-200" 
                     x-transition:leave-start="opacity-100" 
                     x-transition:leave-end="opacity-0" 
                     @click="showPasswordModal = false"
                     class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" 
                     style="z-index: 1;"
                     aria-hidden="true"></div>

                <!-- Modal Panel -->
                <div x-show="showPasswordModal" 
                     x-transition:enter="ease-out duration-300" 
                     x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
                     x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
                     x-transition:leave="ease-in duration-200" 
                     x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
                     x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
                     @click.stop
                     class="relative inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
                     style="z-index: 10;">
                    
                    <!-- Header del Modal -->
                    <div class="bg-gradient-to-r from-amber-600 via-orange-600 to-red-600 px-6 py-5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                                    </svg>
                                </div>
                                <h3 class="text-2xl font-bold text-white" id="password-modal-title">Cambiar Contrase√±a</h3>
                            </div>
                            <button @click="showPasswordModal = false" class="text-white/80 hover:text-white transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Body del Modal -->
                    <div class="bg-gradient-to-br from-slate-50 to-gray-100 px-6 py-6">
                        <!-- Mensajes de √©xito/error -->
                        <div x-show="passwordSuccessMessage" class="mb-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 rounded-lg">
                            <p class="text-green-700 font-semibold" x-text="passwordSuccessMessage"></p>
                        </div>
                        <div x-show="passwordErrorMessage" class="mb-4 p-4 bg-gradient-to-r from-red-50 to-orange-50 border-l-4 border-red-500 rounded-lg">
                            <p class="text-red-700 font-semibold" x-text="passwordErrorMessage"></p>
                        </div>

                        <form @submit.prevent="submitChangePassword" class="space-y-5">
                            <input type="text"
                                   name="username"
                                   autocomplete="username"
                                   :value="userEmail || formData.email || ''"
                                   class="hidden"
                                   tabindex="-1"
                                   aria-hidden="true">
                            <!-- Contrase√±a Actual -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Contrase√±a Actual</label>
                                <input type="password" x-model="passwordData.currentPassword" 
                                       class="w-full px-4 py-3 border-2 border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white transition-all"
                                       placeholder="Ingresa tu contrase√±a actual"
                                        autocomplete="current-password"
                                       required>
                                <p x-show="passwordErrors.currentPassword" x-text="passwordErrors.currentPassword && passwordErrors.currentPassword[0]" class="mt-1 text-sm text-red-600"></p>
                            </div>

                            <!-- Nueva Contrase√±a -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Nueva Contrase√±a</label>
                                <input type="password" x-model="passwordData.newPassword" 
                                       class="w-full px-4 py-3 border-2 border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white transition-all"
                                       placeholder="M√≠nimo 8 caracteres"
                                        autocomplete="new-password"
                                       minlength="8"
                                       required>
                                <p x-show="passwordErrors.newPassword" x-text="passwordErrors.newPassword && passwordErrors.newPassword[0]" class="mt-1 text-sm text-red-600"></p>
                                <p class="mt-1 text-xs text-gray-500">La contrase√±a debe tener al menos 8 caracteres</p>
                            </div>

                            <!-- Confirmar Nueva Contrase√±a -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Confirmar Nueva Contrase√±a</label>
                                <input type="password" x-model="passwordData.confirmPassword" 
                                       class="w-full px-4 py-3 border-2 border-red-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 bg-white transition-all"
                                       placeholder="Repite la nueva contrase√±a"
                                        autocomplete="new-password"
                                       minlength="8"
                                       required>
                                <p x-show="passwordErrors.confirmPassword" x-text="passwordErrors.confirmPassword && passwordErrors.confirmPassword[0]" class="mt-1 text-sm text-red-600"></p>
                            </div>

                            <!-- Botones de acci√≥n -->
                            <div class="flex flex-wrap gap-3 pt-4">
                                <button type="submit" 
                                        :disabled="isChangingPassword"
                                        class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-600 to-orange-600 text-white font-bold rounded-lg hover:from-amber-700 hover:to-orange-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                    <svg x-show="!isChangingPassword" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    <svg x-show="isChangingPassword" class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span x-text="isChangingPassword ? 'Cambiando...' : 'Cambiar Contrase√±a'"></span>
                                </button>
                                <button type="button" @click="showPasswordModal = false"
                                        class="px-6 py-3 bg-gray-200 text-gray-800 font-bold rounded-lg hover:bg-gray-300 transition-colors">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script is:inline define:vars={{ API_BASE_URL }}>
        document.addEventListener('alpine:init', () => {
            Alpine.data('perfilData', () => ({
                userName: '',
                userEmail: '',
                userRole: '',
                userId: '',
                userRoles: [],
                userPermissions: [],
                lastLogin: '',
                showEditModal: false,
                showPasswordModal: false,
                isUpdating: false,
                successMessage: '',
                errorMessage: '',
                errors: {},

                formData: {
                    name: '',
                    last_name: '',
                    email: '',
                    phone_number: '',
                    birthdate: '',
                    gender: '',
                    blood_type: '',
                    address: ''
                },

                originalFormData: {
                    name: '',
                    last_name: '',
                    email: '',
                    phone_number: '',
                    birthdate: '',
                    gender: '',
                    blood_type: '',
                    address: ''
                },

                extraUserData: {
                    phoneNumber: '',
                    birthdate: '',
                    gender: '',
                    bloodType: '',
                    address: '',
                    employeeNumber: '',
                    department: '',
                    position: '',
                    rfc: '',
                    curp: '',
                    nControl: '',
                    semestre: '',
                    grupo: '',
                    workshop: '',
                    career: '',
                    status: ''
                },

                getVisibleExtraDetails() {
                    const entries = [
                        { label: 'Tel√©fono', value: this.extraUserData.phoneNumber, className: 'border-cyan-500 from-cyan-50 to-sky-50', labelClass: 'text-cyan-700' },
                        { label: 'Puesto', value: this.extraUserData.position, className: 'border-indigo-500 from-indigo-50 to-blue-50', labelClass: 'text-indigo-700' },
                        { label: 'Departamento', value: this.extraUserData.department, className: 'border-emerald-500 from-emerald-50 to-teal-50', labelClass: 'text-emerald-700' },
                        { label: 'No. Empleado', value: this.extraUserData.employeeNumber, className: 'border-violet-500 from-violet-50 to-fuchsia-50', labelClass: 'text-violet-700' },
                        { label: 'Estatus', value: this.extraUserData.status, className: 'border-gray-500 from-gray-50 to-slate-50', labelClass: 'text-gray-700' },
                        { label: 'RFC', value: this.extraUserData.rfc, className: 'border-rose-500 from-rose-50 to-pink-50', labelClass: 'text-rose-700' },
                        { label: 'Direcci√≥n', value: this.extraUserData.address, className: 'border-amber-500 from-amber-50 to-yellow-50 sm:col-span-2 lg:col-span-2', labelClass: 'text-amber-700' },
                        { label: 'Fecha de Nacimiento', value: this.extraUserData.birthdate, className: 'border-pink-500 from-pink-50 to-rose-50', labelClass: 'text-pink-700' },
                        { label: 'G√©nero', value: this.extraUserData.gender, className: 'border-purple-500 from-purple-50 to-fuchsia-50', labelClass: 'text-purple-700' },
                        { label: 'Tipo de Sangre', value: this.extraUserData.bloodType, className: 'border-red-500 from-red-50 to-rose-50', labelClass: 'text-red-700' },
                        { label: 'CURP', value: this.extraUserData.curp, className: 'border-cyan-600 from-cyan-50 to-sky-50', labelClass: 'text-cyan-700' },
                        { label: 'No. de Control', value: this.extraUserData.nControl, className: 'border-sky-500 from-sky-50 to-blue-50', labelClass: 'text-sky-700' },
                        { label: 'Semestre', value: this.extraUserData.semestre, className: 'border-fuchsia-500 from-fuchsia-50 to-purple-50', labelClass: 'text-fuchsia-700' },
                        { label: 'Grupo', value: this.extraUserData.grupo, className: 'border-lime-500 from-lime-50 to-green-50', labelClass: 'text-lime-700' },
                        { label: 'Taller / Especialidad', value: this.extraUserData.workshop, className: 'border-cyan-600 from-cyan-50 to-sky-50', labelClass: 'text-cyan-700' },
                        { label: 'Carrera', value: this.extraUserData.career, className: 'border-indigo-600 from-indigo-50 to-blue-50 sm:col-span-2 lg:col-span-2', labelClass: 'text-indigo-700' }
                    ];

                    return entries.filter((entry) => {
                        const value = String(entry.value || '').trim();
                        return value.length > 0;
                    });
                },

                passwordData: {
                    currentPassword: '',
                    newPassword: '',
                    confirmPassword: ''
                },
                passwordErrors: {},
                isChangingPassword: false,
                passwordSuccessMessage: '',
                passwordErrorMessage: '',

                init() {
                    this.loadUserData();
                },

                async loadUserData() {
                    const token = localStorage.getItem('access_token');
                    
                    console.log('üîÑ Starting user data load process...');
                    console.log('üìã Token status:', token ? '‚úÖ Present' : '‚ùå Missing');
                    
                    if (!token) {
                        console.warn('‚ö†Ô∏è No token found, attempting to load from localStorage...');
                        const hasLocalData = this.loadUserDataFromStorage();
                        if (!hasLocalData) {
                            this.showErrorState('Token no encontrado. Por favor inicia sesi√≥n.');
                        }
                        return;
                    }

                    try {
                        console.log('üîÑ Fetching user data from API: ' + API_BASE_URL + '/v1/users/user');
                        const response = await fetch(API_BASE_URL + '/v1/users/user', {
                            method: 'GET',
                            headers: {
                                'Authorization': 'Bearer ' + token,
                                'Accept': 'application/json'
                            }
                        });

                        console.log('üì° API Response Status:', response.status);

                        if (response.ok) {
                            const data = await response.json();
                            console.log('üì• API Response Data:', JSON.stringify(data).substring(0, 200) + '...');
                            
                            if (data.success && data.data?.user) {
                                const user = data.data.user;
                                console.log('‚úÖ Valid user data received from API');
                                console.log('üë§ User Details:', {
                                    id: user.id,
                                    name: user.name,
                                    last_name: user.last_name,
                                    email: user.email,
                                    hasRoles: Array.isArray(user.roles),
                                    hasPermissions: Array.isArray(user.permissions)
                                });
                                const storedRaw = localStorage.getItem('user_data');
                                const storedUser = storedRaw ? JSON.parse(storedRaw) : {};
                                const mergedUser = { ...storedUser, ...user };

                                if ((!mergedUser.roles || mergedUser.roles.length === 0) && storedUser?.roles?.length) {
                                    mergedUser.roles = storedUser.roles;
                                }
                                if (!mergedUser.role && storedUser?.role) {
                                    mergedUser.role = storedUser.role;
                                }
                                if ((!mergedUser.permissions || mergedUser.permissions.length === 0) && storedUser?.permissions?.length) {
                                    mergedUser.permissions = storedUser.permissions;
                                }

                                localStorage.setItem('user_data', JSON.stringify(mergedUser));
                                this.populateUserData(mergedUser);
                                console.log('‚úÖ User data loaded and populated from API');
                            } else {
                                console.warn('‚ö†Ô∏è Invalid API response structure');
                                const hasLocalData = this.loadUserDataFromStorage();
                                if (!hasLocalData) {
                                    this.showErrorState('Error al cargar datos del perfil. Intenta de nuevo.');
                                }
                            }
                        } else if (response.status === 401 || response.status === 403) {
                            console.warn('‚ö†Ô∏è Unauthorized (status: ' + response.status + ') - Token may be expired');
                            localStorage.removeItem('token');
                            this.showErrorState('Tu sesi√≥n ha expirado. Por favor inicia sesi√≥n de nuevo.');
                        } else {
                            console.warn('‚ö†Ô∏è API error (status: ' + response.status + ')');
                            const hasLocalData = this.loadUserDataFromStorage();
                            if (!hasLocalData) {
                                this.showErrorState('Error al conectar con el servidor. Intenta de nuevo.');
                            }
                        }
                    } catch (err) {
                        console.error('‚ùå Error fetching user data from API:', err);
                        const hasLocalData = this.loadUserDataFromStorage();
                        if (!hasLocalData) {
                            this.showErrorState('Error de conexi√≥n. Por favor verifica tu conexi√≥n a internet.');
                        }
                    }
                },

                loadUserDataFromStorage() {
                    const userData = localStorage.getItem('user_data');
                    console.log('üì¶ Checking localStorage - user_data status:', userData ? '‚úÖ Found' : '‚ùå Missing');
                    
                    if (!userData) {
                        console.warn('‚ö†Ô∏è No user data found in localStorage');
                        return false;
                    }

                    try {
                        const user = JSON.parse(userData);
                        
                        // Validate that user object has required fields
                        if (!user.id || !user.email) {
                            console.warn('‚ö†Ô∏è Invalid user data in localStorage - missing required fields');
                            return false;
                        }
                        
                        console.log('‚úÖ Loading user from localStorage');
                        console.log('üë§ User:', { id: user.id, name: user.name, email: user.email });
                        this.populateUserData(user);
                        console.log('‚úÖ User data loaded and populated from localStorage');
                        return true;
                    } catch (e) {
                        console.error('‚ùå Error parsing user data from localStorage:', e);
                        localStorage.removeItem('user_data');
                        return false;
                    }
                },

                firstNonEmpty(...values) {
                    for (const value of values) {
                        if (value === null || value === undefined) continue;
                        if (Array.isArray(value)) {
                            const item = value.find((entry) => typeof entry === 'string' && entry.trim().length > 0);
                            if (item) return item.trim();
                            continue;
                        }
                        if (typeof value === 'object') continue;
                        const text = String(value).trim();
                        if (text.length > 0) return text;
                    }
                    return '';
                },

                getPathValue(obj, path) {
                    if (!obj || typeof obj !== 'object' || !path) return undefined;
                    return path.split('.').reduce((acc, key) => {
                        if (acc && typeof acc === 'object' && key in acc) {
                            return acc[key];
                        }
                        return undefined;
                    }, obj);
                },

                pickFromCandidates(candidates, paths) {
                    for (const candidate of candidates) {
                        if (!candidate || typeof candidate !== 'object') continue;
                        for (const path of paths) {
                            const value = this.getPathValue(candidate, path);
                            const normalized = this.firstNonEmpty(value);
                            if (normalized) return normalized;
                        }
                    }
                    return '';
                },

                normalizeRoleNames(candidates) {
                    const roleSource = [];
                    for (const user of candidates) {
                        if (!user || typeof user !== 'object') continue;
                        if (Array.isArray(user.roles)) roleSource.push(...user.roles);
                        if (user.role) roleSource.push(user.role);
                        if (user.role_name) roleSource.push(user.role_name);
                        if (user.type) roleSource.push(user.type);
                    }

                    const names = roleSource
                        .map((roleItem) => {
                            if (typeof roleItem === 'string') return roleItem.trim();
                            if (roleItem && typeof roleItem === 'object') {
                                return this.firstNonEmpty(roleItem.name, roleItem.role_name, roleItem.label);
                            }
                            return '';
                        })
                        .filter(Boolean);

                    return [...new Set(names)];
                },

                normalizePermissionNames(candidates) {
                    const permissionSource = [];
                    for (const user of candidates) {
                        if (!user || typeof user !== 'object') continue;
                        if (Array.isArray(user.permissions)) permissionSource.push(...user.permissions);
                        if (Array.isArray(user.permisos)) permissionSource.push(...user.permisos);
                    }

                    const names = permissionSource
                        .map((permissionItem) => {
                            if (typeof permissionItem === 'string') return permissionItem.trim();
                            if (permissionItem && typeof permissionItem === 'object') {
                                return this.firstNonEmpty(permissionItem.name, permissionItem.permission, permissionItem.key, permissionItem.slug);
                            }
                            return '';
                        })
                        .filter(Boolean);

                    return [...new Set(names)];
                },

                normalizeAddress(candidates) {
                    let addressValue = null;
                    for (const user of candidates) {
                        if (!user || typeof user !== 'object') continue;
                        addressValue = user.address ?? user.addresses ?? user.direccion ?? user.domicilio ?? user.address_line ?? user.street;
                        if (addressValue) break;
                    }

                    if (Array.isArray(addressValue) && addressValue.length > 0) {
                        return addressValue.filter(Boolean).join(', ');
                    }

                    if (addressValue && typeof addressValue === 'object') {
                        return [
                            addressValue.street,
                            addressValue.number,
                            addressValue.neighborhood,
                            addressValue.city,
                            addressValue.state,
                            addressValue.zip,
                            addressValue.postal_code
                        ].filter(Boolean).join(', ');
                    }

                    return this.firstNonEmpty(addressValue);
                },

                normalizeBirthdate(value) {
                    const birthdateRaw = this.firstNonEmpty(value);
                    if (!birthdateRaw) return '';

                    if (birthdateRaw.includes('T')) {
                        return birthdateRaw.split('T')[0];
                    }

                    const ddmmyyyyMatch = birthdateRaw.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
                    if (ddmmyyyyMatch) {
                        const [, day, month, year] = ddmmyyyyMatch;
                        return `${year}-${month}-${day}`;
                    }

                    return birthdateRaw;
                },

                normalizeUserPayload(user) {
                    const directCandidates = [
                        user,
                        user?.profile,
                        user?.student_profile,
                        user?.studentProfile,
                        user?.details,
                        user?.contact,
                        user?.personal_data,
                        user?.personalData,
                        user?.metadata,
                        user?.data,
                        user?.extra,
                        user?.extra_data
                    ].filter((entry) => entry && typeof entry === 'object');

                    const nestedCandidates = [];
                    for (const candidate of directCandidates) {
                        if (candidate.profile) nestedCandidates.push(candidate.profile);
                        if (candidate.student_profile) nestedCandidates.push(candidate.student_profile);
                        if (candidate.studentProfile) nestedCandidates.push(candidate.studentProfile);
                        if (candidate.details) nestedCandidates.push(candidate.details);
                        if (candidate.contact) nestedCandidates.push(candidate.contact);
                        if (candidate.personal_data) nestedCandidates.push(candidate.personal_data);
                        if (candidate.personalData) nestedCandidates.push(candidate.personalData);
                        if (candidate.metadata) nestedCandidates.push(candidate.metadata);
                        if (candidate.data && typeof candidate.data === 'object') nestedCandidates.push(candidate.data);
                    }

                    const candidates = [...new Set([...directCandidates, ...nestedCandidates])];

                    const firstName = this.pickFromCandidates(candidates, ['name', 'first_name', 'nombre']);
                    const lastName = this.pickFromCandidates(candidates, ['last_name', 'lastname', 'second_name', 'surname', 'apellidos']);
                    const fullName = this.firstNonEmpty(
                        [firstName, lastName].filter(Boolean).join(' '),
                        this.pickFromCandidates(candidates, ['full_name', 'fullName', 'display_name', 'username'])
                    );

                    const normalized = {
                        firstName,
                        lastName,
                        fullName: fullName || 'Usuario',
                        email: this.pickFromCandidates(candidates, ['email', 'correo', 'mail']) || 'No disponible',
                        userId: this.pickFromCandidates(candidates, ['id', 'user_id', 'uuid', 'matricula']) || 'N/A',
                        roleNames: this.normalizeRoleNames(candidates),
                        permissionNames: this.normalizePermissionNames(candidates),
                        phoneNumber: this.pickFromCandidates(candidates, ['phone_number', 'phone', 'telefono', 'mobile', 'contact_phone', 'phoneNumber']),
                        birthdate: this.normalizeBirthdate(this.pickFromCandidates(candidates, ['birthdate', 'birth_date', 'fecha_nacimiento', 'dob', 'date_of_birth'])),
                        gender: this.pickFromCandidates(candidates, ['gender', 'sexo', 'sex']),
                        bloodType: this.pickFromCandidates(candidates, ['blood_type', 'tipo_sangre', 'bloodType']),
                        addressText: this.normalizeAddress(candidates),
                        employeeNumber: this.pickFromCandidates(candidates, ['employee_number', 'employeeNumber', 'numero_empleado', 'no_empleado', 'staff_id']),
                        department: this.pickFromCandidates(candidates, ['department', 'departamento', 'area', 'area_name']),
                        position: this.pickFromCandidates(candidates, ['position', 'puesto', 'job_title', 'cargo']),
                        rfc: this.pickFromCandidates(candidates, ['rfc', 'tax_id', 'taxId']),
                        curp: this.pickFromCandidates(candidates, ['curp', 'CURP']),
                        nControl: this.pickFromCandidates(candidates, ['n_control', 'nControl', 'control_number', 'numero_control', 'matricula']),
                        semestre: this.pickFromCandidates(candidates, ['semestre', 'semester', 'period', 'periodo']),
                        grupo: this.pickFromCandidates(candidates, ['group', 'grupo', 'class_group', 'group_name']),
                        workshop: this.pickFromCandidates(candidates, ['workshop', 'taller', 'specialty', 'especialidad']),
                        career: this.pickFromCandidates(candidates, ['career_name', 'career.name', 'career', 'carrera', 'carrera_nombre']),
                        status: this.pickFromCandidates(candidates, ['status', 'estado']),
                        lastLogin: this.firstNonEmpty(
                            this.pickFromCandidates(candidates, ['last_login_human', 'last_login', 'lastLogin', 'last_access', 'updated_at', 'created_at'])
                        )
                    };

                    return normalized;
                },

                showErrorState(message) {
                    this.userName = 'Error al cargar datos';
                    this.userEmail = message;
                    this.userId = 'N/A';
                    this.userRole = 'Usuario';
                    this.userRoles = [];
                    this.userPermissions = [];
                    console.error('üö® ERROR STATE:', message);
                },

                populateUserData(user) {
                    console.log('üîç Populating user data from object:', {
                        hasName: !!user.name,
                        hasLastName: !!user.last_name,
                        hasEmail: !!user.email,
                        hasId: !!user.id
                    });

                    const normalized = this.normalizeUserPayload(user);

                    this.userName = normalized.fullName;
                    this.userEmail = normalized.email;
                    this.userId = normalized.userId;
                    
                    console.log('üìù Name mapping:', {
                        firstName: normalized.firstName,
                        lastName: normalized.lastName,
                        fullName: this.userName,
                        email: this.userEmail,
                        id: this.userId
                    });
                    
                    if (normalized.roleNames.length > 0) {
                        this.userRole = normalized.roleNames[0];
                        this.userRoles = normalized.roleNames;
                        console.log('üë• Roles loaded:', this.userRoles);
                    } else {
                        this.userRole = 'Usuario';
                        this.userRoles = [];
                        console.log('üë• No roles found');
                    }
                    
                    if (normalized.permissionNames.length > 0) {
                        this.userPermissions = normalized.permissionNames;
                        console.log('üîê Permissions loaded:', this.userPermissions.length, 'items');
                    } else {
                        this.userPermissions = [];
                        console.log('üîê No permissions found');
                    }
                    
                    this.lastLogin = normalized.lastLogin
                        ? normalized.lastLogin
                        : new Date().toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                    // Populate form data
                    this.formData.name = normalized.firstName;
                    this.formData.last_name = normalized.lastName;
                    this.formData.email = normalized.email === 'No disponible' ? '' : normalized.email;
                    this.formData.phone_number = normalized.phoneNumber;
                    this.formData.birthdate = normalized.birthdate;
                    this.formData.gender = normalized.gender;
                    this.formData.blood_type = normalized.bloodType;
                    this.formData.address = normalized.addressText;
                    this.originalFormData = { ...this.formData };

                    this.extraUserData.phoneNumber = normalized.phoneNumber;
                    this.extraUserData.birthdate = normalized.birthdate;
                    this.extraUserData.gender = normalized.gender;
                    this.extraUserData.bloodType = normalized.bloodType;
                    this.extraUserData.address = normalized.addressText;
                    this.extraUserData.employeeNumber = normalized.employeeNumber;
                    this.extraUserData.department = normalized.department;
                    this.extraUserData.position = normalized.position;
                    this.extraUserData.rfc = normalized.rfc;

                    this.extraUserData.curp = normalized.curp;
                    this.extraUserData.nControl = normalized.nControl;
                    this.extraUserData.semestre = normalized.semestre;
                    this.extraUserData.grupo = normalized.grupo;
                    this.extraUserData.workshop = normalized.workshop;
                    this.extraUserData.career = normalized.career;
                    this.extraUserData.status = normalized.status;

                    console.log('‚úÖ User data population complete:', {
                        userName: this.userName,
                        userEmail: this.userEmail,
                        userId: this.userId,
                        rolesCount: this.userRoles.length,
                        permissionsCount: this.userPermissions.length
                    });
                },

                closeAllModals() {
                    this.showEditModal = false;
                    this.showPasswordModal = false;
                },

                editProfile() {
                    // Cargar datos actuales en el formulario
                    this.closeAllModals();
                    const userData = localStorage.getItem('user_data');
                    if (userData) {
                        try {
                            const user = JSON.parse(userData);
                            const normalized = this.normalizeUserPayload(user);

                            this.formData = {
                                name: normalized.firstName,
                                last_name: normalized.lastName,
                                email: normalized.email === 'No disponible' ? '' : normalized.email,
                                phone_number: normalized.phoneNumber,
                                birthdate: normalized.birthdate,
                                gender: normalized.gender,
                                blood_type: normalized.bloodType,
                                address: normalized.addressText
                            };
                            this.originalFormData = { ...this.formData };
                            console.log('üìù Form data loaded for editing:', this.formData);
                        } catch (e) {
                            console.error('‚ùå Error loading form data:', e);
                            this.errorMessage = 'Error al cargar los datos del perfil';
                        }
                    }
                    this.showEditModal = true;
                },

                async updateProfile() {
                    this.isUpdating = true;
                    this.successMessage = '';
                    this.errorMessage = '';
                    this.errors = {};

                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        this.errorMessage = 'No est√°s autenticado. Por favor inicia sesi√≥n.';
                        this.isUpdating = false;
                        console.error('‚ùå No token found');
                        return;
                    }

                    const normalizePhoneNumber = (value) => {
                        if (!value) return '';
                        const trimmed = value.trim();
                        if (!trimmed) return '';
                        if (trimmed.startsWith('+')) return trimmed;
                        const digits = trimmed.replace(/\D/g, '');
                        if (digits.length === 10) return `+52${digits}`;
                        if (digits.length === 12 && digits.startsWith('52')) return `+${digits}`;
                        if (digits.length === 13 && digits.startsWith('521')) return `+${digits}`;
                        return trimmed;
                    };

                    const normalizeText = (value) => String(value ?? '').trim();

                    const current = {
                        name: normalizeText(this.formData.name),
                        last_name: normalizeText(this.formData.last_name),
                        email: normalizeText(this.formData.email),
                        phone_number: normalizePhoneNumber(this.formData.phone_number),
                        birthdate: normalizeText(this.formData.birthdate),
                        gender: normalizeText(this.formData.gender),
                        blood_type: normalizeText(this.formData.blood_type),
                        address: normalizeText(this.formData.address)
                    };

                    const original = {
                        name: normalizeText(this.originalFormData.name),
                        last_name: normalizeText(this.originalFormData.last_name),
                        email: normalizeText(this.originalFormData.email),
                        phone_number: normalizePhoneNumber(this.originalFormData.phone_number),
                        birthdate: normalizeText(this.originalFormData.birthdate),
                        gender: normalizeText(this.originalFormData.gender),
                        blood_type: normalizeText(this.originalFormData.blood_type),
                        address: normalizeText(this.originalFormData.address)
                    };

                    const requestData = {};

                    if (current.name && current.name !== original.name) requestData.name = current.name;
                    if (current.last_name && current.last_name !== original.last_name) requestData.last_name = current.last_name;
                    if (current.email && current.email !== original.email) requestData.email = current.email;
                    if (current.phone_number && current.phone_number !== original.phone_number) {
                        const phoneValid = /^\+\d{10,15}$/.test(current.phone_number);
                        if (!phoneValid) {
                            this.errorMessage = 'El telefono debe incluir codigo de pais. Ejemplo: +5215512345678.';
                            this.isUpdating = false;
                            return;
                        }
                        requestData.phone_number = current.phone_number;
                    }
                    if (current.birthdate && current.birthdate !== original.birthdate) requestData.birthdate = current.birthdate;
                    if (current.gender && current.gender !== original.gender) requestData.gender = current.gender;
                    if (current.blood_type && current.blood_type !== original.blood_type) requestData.blood_type = current.blood_type;

                    if (current.address && current.address !== original.address) {
                        requestData.address = [current.address];
                    }

                    const requiredName = current.name || original.name;
                    const requiredLastName = current.last_name || original.last_name;
                    const requiredPhone = current.phone_number || original.phone_number;

                    if (!requiredName || !requiredLastName || !requiredPhone) {
                        this.errorMessage = 'Nombre, apellido y telefono son obligatorios.';
                        this.isUpdating = false;
                        return;
                    }

                    const requiredPhoneValid = /^\+\d{10,15}$/.test(requiredPhone);
                    if (!requiredPhoneValid) {
                        this.errorMessage = 'El telefono debe incluir codigo de pais. Ejemplo: +5215512345678.';
                        this.isUpdating = false;
                        return;
                    }

                    requestData.name = requiredName;
                    requestData.last_name = requiredLastName;
                    requestData.phone_number = requiredPhone;

                    const hasChanges =
                        current.name !== original.name ||
                        current.last_name !== original.last_name ||
                        current.email !== original.email ||
                        current.phone_number !== original.phone_number ||
                        current.birthdate !== original.birthdate ||
                        current.gender !== original.gender ||
                        current.blood_type !== original.blood_type ||
                        current.address !== original.address;

                    if (!hasChanges) {
                        this.errorMessage = 'No hay cambios para guardar.';
                        this.isUpdating = false;
                        return;
                    }

                    console.log('üì§ Sending profile update:', requestData);

                    try {
                        const response = await fetch(API_BASE_URL + '/v1/users/update', {
                            method: 'PATCH',
                            headers: {
                                'Authorization': 'Bearer ' + token,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });

                        const data = await response.json();
                        console.log('üì• Response status:', response.status);
                        console.log('üì• Response data:', data);

                        if (response.ok && data.success) {
                            this.successMessage = data.message || 'Perfil actualizado correctamente';
                            
                            // Actualizar datos en localStorage - manejar estructura de respuesta
                            const updatedUser = data.data?.user || data.user;
                            if (updatedUser) {
                                const storedRaw = localStorage.getItem('user_data');
                                const storedUser = storedRaw ? JSON.parse(storedRaw) : {};
                                const mergedUser = { ...storedUser, ...updatedUser };

                                if ((!mergedUser.roles || mergedUser.roles.length === 0) && storedUser?.roles?.length) {
                                    mergedUser.roles = storedUser.roles;
                                }
                                if (!mergedUser.role && storedUser?.role) {
                                    mergedUser.role = storedUser.role;
                                }
                                if ((!mergedUser.permissions || mergedUser.permissions.length === 0) && storedUser?.permissions?.length) {
                                    mergedUser.permissions = storedUser.permissions;
                                }

                                localStorage.setItem('user_data', JSON.stringify(mergedUser));
                                this.populateUserData(mergedUser);
                                this.originalFormData = { ...this.formData };
                                console.log('‚úÖ Perfil actualizado exitosamente');
                            }
                            
                            // Cerrar modal despu√©s de 2 segundos
                            setTimeout(() => {
                                this.showEditModal = false;
                                this.successMessage = '';
                            }, 2000);
                        } else {
                            // Manejar errores de validaci√≥n
                            if (data.errors && typeof data.errors === 'object') {
                                this.errors = data.errors;
                                const firstErrorKey = Object.keys(data.errors)[0];
                                const firstError = data.errors[firstErrorKey];
                                this.errorMessage = Array.isArray(firstError) ? firstError[0] : firstError;
                            } else {
                                this.errorMessage = data.message || 'Error al actualizar el perfil. Por favor, intenta de nuevo.';
                            }
                            console.error('‚ùå Error en la actualizaci√≥n:', data);
                        }
                    } catch (err) {
                        console.error('‚ùå Error updating profile:', err);
                        this.errorMessage = 'Error de conexi√≥n con el servidor. Verifica tu conexi√≥n a internet.';
                    } finally {
                        this.isUpdating = false;
                    }
                },

                changePassword() {
                    this.closeAllModals();
                    this.showPasswordModal = true;
                    this.passwordData = { currentPassword: '', newPassword: '', confirmPassword: '' };
                    this.passwordErrors = {};
                    this.passwordSuccessMessage = '';
                    this.passwordErrorMessage = '';
                },

                async submitChangePassword() {
                    this.isChangingPassword = true;
                    this.passwordSuccessMessage = '';
                    this.passwordErrorMessage = '';
                    this.passwordErrors = {};

                    // Validaci√≥n del lado del cliente
                    if (!this.passwordData.currentPassword?.trim()) {
                        this.passwordErrorMessage = 'La contrase√±a actual es requerida';
                        this.isChangingPassword = false;
                        console.warn('‚ö†Ô∏è Current password is empty');
                        return;
                    }

                    if (!this.passwordData.newPassword?.trim()) {
                        this.passwordErrorMessage = 'La nueva contrase√±a es requerida';
                        this.isChangingPassword = false;
                        console.warn('‚ö†Ô∏è New password is empty');
                        return;
                    }

                    if (this.passwordData.newPassword.length < 8) {
                        this.passwordErrorMessage = 'La contrase√±a debe tener al menos 8 caracteres';
                        this.isChangingPassword = false;
                        console.warn('‚ö†Ô∏è New password is too short');
                        return;
                    }

                    if (this.passwordData.newPassword !== this.passwordData.confirmPassword) {
                        this.passwordErrorMessage = 'Las contrase√±as no coinciden';
                        this.isChangingPassword = false;
                        console.warn('‚ö†Ô∏è Passwords do not match');
                        return;
                    }

                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        this.passwordErrorMessage = 'No est√°s autenticado. Por favor inicia sesi√≥n.';
                        this.isChangingPassword = false;
                        console.error('‚ùå No token found');
                        return;
                    }

                    console.log('üîê Attempting to change password...');

                    try {
                        const response = await fetch(API_BASE_URL + '/v1/users/update/password', {
                            method: 'PATCH',
                            headers: {
                                'Authorization': 'Bearer ' + token,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({
                                currentPassword: this.passwordData.currentPassword,
                                newPassword: this.passwordData.newPassword
                            })
                        });

                        const data = await response.json();
                        console.log('üì• Password change response:', response.status);

                        if (response.ok && data.success) {
                            this.passwordSuccessMessage = data.message || 'Contrase√±a actualizada correctamente';
                            console.log('‚úÖ Contrase√±a actualizada exitosamente');
                            
                            setTimeout(() => {
                                this.showPasswordModal = false;
                                this.passwordData = { currentPassword: '', newPassword: '', confirmPassword: '' };
                                this.passwordSuccessMessage = '';
                            }, 2000);
                        } else {
                            // Manejar errores
                            if (data.errors && typeof data.errors === 'object') {
                                this.passwordErrors = data.errors;
                                const firstErrorKey = Object.keys(data.errors)[0];
                                const firstError = data.errors[firstErrorKey];
                                this.passwordErrorMessage = Array.isArray(firstError) ? firstError[0] : firstError;
                            } else if (response.status === 400) {
                                this.passwordErrorMessage = 'La contrase√±a actual es incorrecta';
                            } else {
                                this.passwordErrorMessage = data.message || 'Error al cambiar la contrase√±a';
                            }
                            console.error('‚ùå Error changing password:', data);
                        }
                    } catch (err) {
                        console.error('‚ùå Error changing password:', err);
                        this.passwordErrorMessage = 'Error de conexi√≥n con el servidor';
                    } finally {
                        this.isChangingPassword = false;
                    }
                }
            }));
        });
    </script>

    <style is:global>
        [x-cloak] { display: none !important; }
    </style>
</Layout>
