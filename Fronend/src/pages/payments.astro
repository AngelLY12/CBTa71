---
// 1. ASTRO FRONTMATTER
import Layout from "../layouts/Layout.astro"; 

const pageTitle = "Estado de Pagos - CBTA 71";
---

<!-- 2. Uso del Layout con el título definido -->
<Layout title={pageTitle}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Estado de Pagos</h1>
        <p class="text-sm text-gray-500 mt-1">Monitoreo de pagos de estudiantes</p>
      </div>

      <!-- Filtros -->
      <div class="flex gap-3">
        <select id="status-filter" class="border rounded-lg px-3 py-2 text-sm">
          <option value="all">Todos los estados</option>
          <option value="current">Al corriente</option>
          <option value="pending">Pendientes</option>
        </select>
      </div>
    </div>

    <!-- Grid de tarjetas de estudiantes -->
    <div id="students-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Se renderiza en cliente -->
    </div>
  </div>

  <script type="module" client:load>
    function getStudentsWithPayments() {
      try {
        // Obtener estudiantes
        const students = JSON.parse(localStorage.getItem('studentsList') || '[]');
        // Obtener conceptos de pago
        const concepts = JSON.parse(localStorage.getItem('conceptsList') || '[]');
        
        // Calcular estado de pagos para cada estudiante
        return students.map(student => {
          const applicableConcepts = concepts.filter(c => {
            if (!c.status === 'active') return false;
            
            switch(c.scope) {
              case 'all':
                return true;
              case 'career':
                return c.career === student.carrera;
              case 'semester':
                return c.semester === student.semestre;
              case 'students':
                return c.selectedStudents?.some(s => s.id === student.id);
              default:
                return false;
            }
          });

          const totalDebt = applicableConcepts.reduce((sum, c) => sum + c.amount, 0);
          
          return {
            ...student,
            paymentStatus: totalDebt > 0 ? 'pending' : 'current',
            totalDebt
          };
        });
      } catch (e) {
        console.error('Error loading data:', e);
        return [];
      }
    }

    function renderStudents(filter = 'all') {
      const grid = document.getElementById('students-grid');
      if (!grid) return;

      const students = getStudentsWithPayments();
      const filtered = filter === 'all' ? 
        students : 
        students.filter(s => s.paymentStatus === filter);

      if (filtered.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12 text-gray-500">
            <i class="fas fa-folder-open text-4xl mb-3"></i>
            <p>No hay estudiantes ${filter === 'current' ? 'al corriente' : 'con pagos pendientes'}.</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = filtered.map(student => `
        <div class="bg-white rounded-lg border shadow-sm hover:shadow-md transition-shadow p-5">
          <div class="flex justify-between items-start mb-3">
            <div>
              <h3 class="font-bold text-gray-800">
                ${escapeHtml(student.nombre)} ${escapeHtml(student.apellidoP)} ${escapeHtml(student.apellidoM)}
              </h3>
              <p class="text-sm text-gray-500">#${escapeHtml(student.numControl)}</p>
            </div>
            <span class="px-3 py-1 text-xs rounded-full ${
              student.paymentStatus === 'current' 
                ? 'bg-green-100 text-green-800' 
                : 'bg-yellow-100 text-yellow-800'
            }">
              ${student.paymentStatus === 'current' ? 'Al corriente' : 'Pendiente'}
            </span>
          </div>

          <div class="space-y-2 text-sm">
            <div class="flex items-center text-gray-600">
              <i class="fas fa-graduation-cap w-5"></i>
              <span class="ml-2">${escapeHtml(student.carrera)}</span>
            </div>
            
            <div class="flex items-center text-gray-600">
              <i class="fas fa-layer-group w-5"></i>
              <span class="ml-2">${escapeHtml(String(student.semestre))}° Semestre</span>
            </div>

            <div class="flex items-center ${student.totalDebt > 0 ? 'text-red-600 font-semibold' : 'text-green-600'}">
              <i class="fas fa-money-bill w-5"></i>
              <span class="ml-2">
                ${student.totalDebt > 0 
                  ? `Adeudo: $${student.totalDebt.toFixed(2)}` 
                  : 'Sin adeudos'}
              </span>
            </div>
          </div>

          <div class="mt-4 pt-4 border-t flex justify-end space-x-2">
            <button class="px-3 py-1 text-sm border rounded hover:bg-gray-50">
              <i class="fas fa-history mr-1"></i> Historial
            </button>
            <button class="px-3 py-1 text-sm bg-[#2e594d] text-white rounded hover:bg-[#234539]">
              <i class="fas fa-file-invoice-dollar mr-1"></i> Registrar Pago
            </button>
          </div>
        </div>
      `).join('');
    }

    // Helpers
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[m]);
    }

    // Event Listeners
    document.getElementById('status-filter')?.addEventListener('change', (e) => {
      renderStudents(e.target.value);
    });

    // Initial render
    renderStudents('all');

    // Re-render on storage changes
    window.addEventListener('storage', (e) => {
      if (e.key === 'studentsList' || e.key === 'conceptsList') {
        renderStudents(document.getElementById('status-filter')?.value || 'all');
      }
    });
  </script>
</Layout>