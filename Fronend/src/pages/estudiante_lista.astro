---
import Layout from '../layouts/Layout.astro';

// Configuraciones: Color de acento institucional (VERDE OSCURO: EMERALD)
const ACCENT_COLOR_CLASS = 'emerald'; 

// --- CONFIGURACI√ìN ACTUALIZADA DE SEMESTRES Y CARRERAS ---
const MAX_SEMESTER = 8;
const SEMESTERS = Array.from({ length: MAX_SEMESTER }, (_, i) => i + 1);

const CAREERS = [
    { code: 'RMA', name: 'Rehabilitaci√≥n y Mejoramiento Ambiental' },
    { code: 'AGR', name: 'Agronom√≠a' },
    { code: 'AGO', name: 'Agroindustrias' },
    { code: 'AHO', name: 'Agropecuario (Horticultura)' },
    { code: 'VET', name: 'Veterinaria' },
    { code: 'ZOO', name: 'Zootecnia' },
    { code: 'SIL', name: 'Silvicultura' },
    { code: 'PES', name: 'Pesca' },
    { code: 'CPA', name: 'Ciencias Pol√≠ticas y Adm. P√∫blica' },
    { code: 'TRS', name: 'Trabajo Social' },
    { code: 'TUR', name: 'Turismo' },
    { code: 'ADM', name: 'Administraci√≥n de Empresas' },
    { code: 'ECO', name: 'Econom√≠a' },
];

// Mapeo para normalizaci√≥n y visualizaci√≥n
const CAREER_MAP = CAREERS.reduce((acc, curr) => {
    acc[curr.code] = curr.name;
    return acc;
}, { '': 'Sin Carrera', '0': 'Sin Carrera' });
// -------------------------------------------------------------------


// L√≥gica de carga de datos (Lado del Servidor)
let students = [];
try {
  // 1. Intenta cargar desde la API
  const res = await fetch('/api/students');
  if (res.ok) {
    const json = await res.json();
    students = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
  }
} catch (e) {
  // 2. Si la API falla, intenta cargar desde el archivo local de datos
  if (!students || !students.length) {
    try {
      const mod = await import('../data/students.js');
      students = mod.default || mod.students || [];
    } catch (e) {
      students = [];
    }
  }
}

// 3. Normalizaci√≥n de los datos iniciales (excluyendo password)
students = students.map((s, i) => ({
  id: s.id ?? String(Date.now() + i),
  numControl: (s.numControl ?? s.id ?? '').toUpperCase(),
  nombre: s.nombre ?? s.name ?? '',
  apellidoP: s.apellidoP ?? s.apellidoPaterno ?? s.apellido_paterno ?? '',
  apellidoM: s.apellidoM ?? s.apellidoMaterno ?? s.apellido_materno ?? '',
  semestre: s.semestre ?? s.sem ?? 0,
  carrera: (s.carrera ?? s.career ?? '').toUpperCase(),
  correo: s.correo ?? s.email ?? '',
}));

// Preparar los datos para pasarlos al cliente de forma segura
const initialJSON = JSON.stringify(students).replace(/</g, '\\u003c');
---

<Layout title="Gesti√≥n de Estudiantes">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js" type="text/javascript" defer></script>

  <div class="max-w-7xl xl:max-w-screen-xl mx-auto px-4 py-12 bg-white min-h-screen font-sans">
    
    <header class="flex items-center justify-between mb-10 pb-4 border-b-2 border-emerald-100">
      <div>
        <h1 class="text-4xl font-extrabold text-gray-900 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-emerald-700 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M9 20l-2.003-.594A4 4 0 003 15.25V7a4 4 0 014-4h10a4 4 0 014 4v8.25c0 .59-.234 1.157-.659 1.571L17 20m-2 1a2 2 0 100-4 2 2 0 000 4zM8 10h.01M12 10h.01M16 10h.01M9 16h.01M13 16h.01" />
          </svg>
          Gesti√≥n Acad√©mica de Estudiantes
        </h1>
        <p class="text-sm text-gray-500 mt-2 ml-12">Plataforma centralizada para la administraci√≥n de la matr√≠cula estudiantil.</p>
      </div>
      <div>
        <a href="/Dashboard" class="text-base font-semibold text-emerald-600 hover:text-emerald-800 transition duration-150 ease-in-out flex items-center p-2 rounded-lg hover:bg-emerald-50">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Volver al Panel
        </a>
      </div>
    </header>

    <div class="mb-8">
      <button id="show-form-btn" class="px-8 py-3 bg-emerald-700 text-white font-semibold rounded-xl shadow-lg hover:bg-emerald-800 transition duration-150 ease-in-out transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-emerald-300">
        + Registrar Nuevo Estudiante
      </button>
    </div>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <div id="form-container" class="bg-white p-8 rounded-xl shadow-2xl col-span-1 hidden relative border border-gray-100 h-fit sticky top-10">
        <h2 id="form-title" class="font-bold text-xl mb-6 text-gray-800 border-b pb-2">Registro de Estudiante</h2>
        <form id="add-student-form" class="space-y-4">
          <button id="close-form-btn" type="button" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition duration-150 ease-in-out">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>

          <input type="hidden" name="id" id="student-id-input" value="" />

          <input name="numControl" id="numControl-input" placeholder="N√∫mero de control (Matr√≠cula)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 text-sm shadow-sm" />
          <div class="grid grid-cols-2 gap-4">
            <input name="nombre" id="nombre-input" placeholder="Nombre(s)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 text-sm shadow-sm" />
            <input name="apellidoP" id="apellidoP-input" placeholder="Apellido paterno" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 text-sm shadow-sm" />
          </div>
          <input name="apellidoM" id="apellidoM-input" placeholder="Apellido materno (Opcional)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 text-sm shadow-sm" />

          <div class="grid grid-cols-2 gap-4">
            <select name="semestre" id="semestre-input" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-emerald-500 focus:border-emerald-500 text-sm shadow-sm">
              <option value="0">Semestre</option>
              {SEMESTERS.map(s => <option value={s}>{s}ro</option>)}
            </select>

            <select name="carrera" id="carrera-input" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-emerald-500 focus:border-emerald-500 text-sm shadow-sm">
              <option value="">Programa Educativo</option>
              {CAREERS.map(c => <option value={c.code}>{c.name}</option>)}
            </select>
          </div>

          <input name="correo" id="correo-input" type="email" placeholder="Correo electr√≥nico institucional" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 text-sm shadow-sm" />
          
          <div class="flex gap-3 pt-4">
            <button type="submit" id="submit-btn" class="flex-1 px-4 py-3 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 transition duration-150 text-sm shadow-md">Registrar</button>
            <button id="reset-btn" type="button" class="px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition duration-150 text-sm shadow-sm">Reiniciar</button>
          </div>
          <p id="form-msg" class="text-sm text-center pt-2 hidden"></p>
        </form>

        <hr class="my-6 border-emerald-100" />

        <div class="bg-emerald-50 p-4 rounded-lg border border-dashed border-emerald-200 shadow-inner">
          <label class="block text-sm font-medium text-gray-700 mb-2">Carga Masiva (Excel)</label>
          <input id="import-file" type="file" accept=".xlsx,.xls,.csv" class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-100 file:text-emerald-700 hover:file:bg-emerald-200 transition duration-150"/>
          <p class="text-xs text-gray-500 mt-2">Formato de columnas requerido: numControl,nombre,apellidoP,apellidoM,semestre,carrera,correo</p>
        </div>
      </div>

      <div id="table-container" class="bg-white p-8 rounded-xl shadow-2xl col-span-1 lg:col-span-3 flex flex-col border border-gray-100 relative">
        <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
          <h2 class="font-bold text-2xl text-gray-800">Listado de Matr√≠cula <span id="students-total" class="text-base font-semibold text-emerald-600">({students.length})</span></h2>

          <div class="flex gap-3 relative">

            {/* BARRA DE B√öSQUEDA */}
            <div class="relative w-56">
              <input id="search-input" type="text" placeholder="Buscar por Nombre, Control, Correo..." class="w-full p-2 pl-9 border border-gray-300 rounded-lg text-sm focus:ring-emerald-500 focus:border-emerald-500 shadow-sm transition" />
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>

            {/* BOT√ìN Y POPUP DE FILTROS (Verde) */}
            <button id="toggle-filters-btn" class="flex items-center px-4 py-2 rounded-lg bg-emerald-100 border border-emerald-300 text-emerald-700 text-sm font-medium hover:bg-emerald-200 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-50">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707v3.414l-4 4v-4.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
              </svg>
              <span id="filters-status">Filtros</span>
            </button>


            <div id="filters-popover" class="absolute z-20 top-full right-0 mt-2 w-72 bg-white rounded-xl shadow-2xl p-5 border border-gray-200 hidden transform origin-top-right transition duration-200 ease-out scale-95 opacity-0">
              <h3 class="text-sm font-bold text-gray-700 mb-3 border-b pb-2">Opciones de Filtrado</h3>
              <div class="space-y-3">
                <div>
                  <label for="filter-carrera" class="block text-xs font-medium text-gray-500 mb-1">Programa Educativo:</label>
                  <select id="filter-carrera" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-gray-800 shadow-sm focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500 transition text-sm">
                    <option value="">Todos los Programas</option>
                    {CAREERS.map(c => <option value={c.code}>{c.name}</option>)}
                  </select>
                </div>

                <div>
                  <label for="filter-semestre" class="block text-xs font-medium text-gray-500 mb-1">Nivel Semestral:</label>
                  <select id="filter-semestre" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-gray-800 shadow-sm focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500 transition text-sm">
                    <option value="">Todos los Semestres</option>
                    {SEMESTERS.map(s => <option value={s}>{s}ro</option>)}
                    <option value="0">N/A</option>
                  </select>
                </div>
              </div>
              <button id="clear-filters-btn" class="w-full mt-4 px-3 py-2 bg-red-50 text-red-700 border border-red-200 rounded-lg shadow-sm hover:bg-red-100 transition duration-150 flex items-center justify-center text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Limpiar Filtros
              </button>
            </div>

            {/* BOTONES DE EXPORTACI√ìN Y LIMPIEZA */}
            <button id="export-xlsx" class="flex items-center px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-700 text-sm hover:bg-gray-100 transition duration-150 shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>XLSX</button>
            <button id="export-csv" class="flex items-center px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-700 text-sm hover:bg-gray-100 transition duration-150 shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>CSV</button>
            <button id="clear-storage" class="px-3 py-2 rounded-lg bg-red-100 text-red-700 text-sm font-medium hover:bg-red-200 transition duration-150 shadow-sm">Borrar Local</button>
          </div>
        </div>

        {/* CONTENEDOR DE LA TABLA CON SCROLL */}
        <div class="overflow-x-auto rounded-xl border border-gray-200 max-h-[70vh] shadow-inner">
          <table class="min-w-full text-sm divide-y divide-gray-200">
            <thead class="bg-gray-100 text-left sticky top-0 z-10">
              <tr>
                <th class="px-4 py-3 font-bold text-gray-700 w-[12%]">N. Control</th>
                <th class="px-4 py-3 font-bold text-gray-700 w-[17%]">Nombre</th>
                <th class="px-4 py-3 font-bold text-gray-700 w-[17%]">Apellido P.</th>
                <th class="px-4 py-3 font-bold text-gray-700 w-[17%]">Apellido M.</th>
                <th class="px-4 py-3 font-bold text-gray-700 text-center w-[10%]">Semestre</th>
                <th class="px-4 py-3 font-bold text-gray-700 w-[12%]">Carrera</th>
                <th class="px-4 py-3 font-bold text-gray-700 w-[15%]">Correo</th>
                <th class="px-4 py-3 font-bold text-gray-700 text-center w-[8%] min-w-[120px]">Acciones</th>
              </tr>
            </thead>
            <tbody id="students-tbody" class="bg-white divide-y divide-gray-100">
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    window.__INITIAL_STUDENTS = JSON.parse('${initialJSON}');
    // Inyectar el mapa de carreras para uso en el cliente
    window.__CAREER_MAP = JSON.parse('${JSON.stringify(CAREER_MAP)}');
  </script>

  <script type="module" client:load>
    (function () { 
      const STORAGE_KEY = 'studentsList';
      const initial = Array.isArray(window.__INITIAL_STUDENTS) ? window.__INITIAL_STUDENTS : [];
      // Se utiliza el mapa de carreras inyectado
      const CARRERA_MAP = window.__CAREER_MAP || {};


      // Estado de los filtros
      const currentFilters = {
        semestre: '',
        carrera: ''
      };


      // Funciones de utilidad (lectura/escritura local)
      const readLocal = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return initial.slice();
          const arr = JSON.parse(raw);
          return Array.isArray(arr) ? arr : initial.slice();
        } catch (e) {
          return initial.slice();
        }
      };
      const writeLocal = (arr) => {
        try {
          // Eliminamos cualquier propiedad 'password' antes de guardar.
          const cleanedArr = arr.map(s => {
            const { password, ...rest } = s;
            return rest;
          });
          localStorage.setItem(STORAGE_KEY, JSON.stringify(cleanedArr));
        } catch (e) {}
      };

      // Elementos del DOM (omitiendo la redifnici√≥n de todos por concisi√≥n)
      const tbody = document.getElementById('students-tbody');
      const totalEl = document.getElementById('students-total');
      const form = document.getElementById('add-student-form');
      const submitBtn = document.getElementById('submit-btn');
      const formTitle = document.getElementById('form-title');
      const resetBtn = document.getElementById('reset-btn');
      const msg = document.getElementById('form-msg');
      const importFile = document.getElementById('import-file');
      const exportXlsx = document.getElementById('export-xlsx');
      const exportCsv = document.getElementById('export-csv');
      const clearBtn = document.getElementById('clear-storage');
      const formContainer = document.getElementById('form-container');
      const tableContainer = document.getElementById('table-container');
      const showFormBtn = document.getElementById('show-form-btn');
      const closeFormBtn = document.getElementById('close-form-btn');
      const idInput = document.getElementById('student-id-input');
      const numControlInput = document.getElementById('numControl-input');
      const nombreInput = document.getElementById('nombre-input');
      const apellidoPInput = document.getElementById('apellidoP-input');
      const apellidoMInput = document.getElementById('apellidoM-input');
      const semestreInput = document.getElementById('semestre-input');
      const carreraInput = document.getElementById('carrera-input');
      const correoInput = document.getElementById('correo-input');

      // Elementos de B√∫squeda
      const searchInput = document.getElementById('search-input');

      // Elementos de Filtro
      const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
      const filtersPopover = document.getElementById('filters-popover');
      const filtersStatusEl = document.getElementById('filters-status');
      const filterSemestreEl = document.getElementById('filter-semestre');
      const filterCarreraEl = document.getElementById('filter-carrera');
      const clearFiltersBtn = document.getElementById('clear-filters-btn');


      // Funci√≥n de escape HTML
      function escapeHtml(s) {
        if (!s) return '';
        return String(s).replace(/[&<>"']/g, function (m) {
          return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m];
        });
      }

      // Mostrar mensaje breve
      function showMsg(text, isError) {
        msg.textContent = text;
        msg.classList.remove('text-red-600', 'text-green-600');
        msg.classList.toggle('text-red-600', !!isError);
        msg.classList.toggle('text-green-600', !isError);
        msg.classList.remove('hidden');
        setTimeout(() => msg.classList.add('hidden'), 3000);
      }

      // Funci√≥n de capitalizaci√≥n (primera letra de cada palabra)
      function capitalizeName(str) {
        if (!str) return '';
        return String(str).toLowerCase().trim().replace(/\b\w/g, l => l.toUpperCase());
      }


      // Funci√≥n de filtrado
      const applyFilters = (list) => {
        const searchTerm = searchInput.value.toLowerCase().trim();

        return list.filter(s => {
          const matchesSemestre = currentFilters.semestre === '' || String(s.semestre) === currentFilters.semestre;
          const matchesCarrera = currentFilters.carrera === '' || s.carrera === currentFilters.carrera;

          // L√≥gica de B√∫squeda
          const matchesSearch = searchTerm === '' ||
              s.numControl.toLowerCase().includes(searchTerm) ||
              s.nombre.toLowerCase().includes(searchTerm) ||
              s.apellidoP.toLowerCase().includes(searchTerm) ||
              s.apellidoM.toLowerCase().includes(searchTerm) ||
              (CARRERA_MAP[s.carrera] || s.carrera).toLowerCase().includes(searchTerm) ||
              s.correo.toLowerCase().includes(searchTerm);

          return matchesSemestre && matchesCarrera && matchesSearch;
        });
      }

      // Funci√≥n para obtener la lista que se est√° viendo (filtrada)
      const getExportList = () => {
          const rawList = readLocal();
          return applyFilters(rawList);
      }

      // Funci√≥n para actualizar el estado visual del bot√≥n de filtros (Verde)
      const updateFiltersStatus = (filteredCount, totalCount) => {
          const isActive = currentFilters.semestre !== '' || currentFilters.carrera !== '';

          if (isActive || searchInput.value.trim() !== '') {
              // Bot√≥n activo (Verde m√°s oscuro)
              toggleFiltersBtn.classList.add('bg-emerald-700', 'text-white', 'border-emerald-700');
              toggleFiltersBtn.classList.remove('bg-emerald-100', 'text-emerald-700', 'border-emerald-300');
              filtersStatusEl.textContent = `Filtros: ${filteredCount}/${totalCount}`;
          } else {
              // Bot√≥n inactivo (Verde claro)
              toggleFiltersBtn.classList.remove('bg-emerald-700', 'text-white', 'border-emerald-700');
              toggleFiltersBtn.classList.add('bg-emerald-100', 'text-emerald-700', 'border-emerald-300');
              filtersStatusEl.textContent = 'Filtros';
          }
      }


      // --- L√ìGICA DE VISIBILIDAD DEL FORMULARIO ---
      function setFormVisibility(isVisible) {
        if (isVisible) {
          filtersPopover.classList.add('hidden'); // Ocultar filtros si se abre el form
          formContainer.classList.remove('hidden');
          tableContainer.classList.remove('lg:col-span-3');
          tableContainer.classList.add('lg:col-span-2');
          showFormBtn.classList.add('hidden');
          if (window.innerWidth >= 1024) {
              formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        } else {
          formContainer.classList.add('hidden');
          tableContainer.classList.remove('lg:col-span-2');
          tableContainer.classList.add('lg:col-span-3');
          showFormBtn.classList.remove('hidden');
          resetForm();
        }
      }

      // Funci√≥n para limpiar formulario y volver a modo "Agregar"
      function resetForm() {
        form.reset();
        idInput.value = '';
        formTitle.textContent = 'Registro de Estudiante';
        submitBtn.textContent = 'Registrar';
        msg.classList.add('hidden');
        msg.classList.remove('text-red-600', 'text-green-600');
      }

      // Funci√≥n para precargar el formulario con datos de edici√≥n
      function handleEdit(e) {
        e.preventDefault();
        const studentId = e.currentTarget.getAttribute('data-id');
        const list = readLocal();
        const student = list.find(s => s.id === studentId);

        if (!student) {
          showMsg('Estudiante no encontrado para editar.', true);
          return;
        }

        setFormVisibility(true);

        // Llenar el formulario con los datos del estudiante
        idInput.value = student.id;
        numControlInput.value = student.numControl;
        nombreInput.value = student.nombre;
        apellidoPInput.value = student.apellidoP;
        apellidoMInput.value = student.apellidoM;
        semestreInput.value = String(student.semestre || '0');
        carreraInput.value = student.carrera;
        correoInput.value = student.correo;

        // Cambiar el t√≠tulo y el bot√≥n
        formTitle.textContent = `Editar Estudiante: ${student.nombre}`;
        submitBtn.textContent = 'Actualizar Datos';
      }

      // Funci√≥n para manejar la eliminaci√≥n
      function handleDelete(e) {
          e.preventDefault();
          const studentId = e.currentTarget.getAttribute('data-id');
          const list = readLocal();
          const student = list.find(s => s.id === studentId);

          if (!student) {
              showMsg('Error: Estudiante no encontrado.', true);
              return;
          }

          if (!confirm(`‚ö†Ô∏è Advertencia: ¬øEst√° seguro de que desea ELIMINAR permanentemente al estudiante: ${student.nombre} ${student.apellidoP}?`)) {
              return;
          }

          const newList = list.filter(s => s.id !== studentId);
          writeLocal(newList);
          render();
          setFormVisibility(false);
          showMsg('Estudiante eliminado con √©xito. ‚ùå');
      }

      // Funci√≥n de renderizado de la tabla - Compacta y con Filtro
      const render = () => {
        // 1. Leer y Filtrar
        const rawList = readLocal();
        const filteredList = applyFilters(rawList);

        tbody.innerHTML = '';

        if (filteredList.length === 0) {
          // Colspan ajustado a 8 (n√∫mero total de columnas)
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="px-4 py-8 text-center text-gray-500 italic">
                No se encontraron registros de estudiantes que coincidan con los criterios de b√∫squeda o filtro.
              </td>
            </tr>
          `;
        } else {
          // 2. Renderizar la lista filtrada
          filteredList.forEach((s, i) => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            // Texto de carrera en color verde
            tr.innerHTML = `
              <td class="px-4 py-3 font-medium text-gray-900">${escapeHtml(s.numControl)}</td>
              <td class="px-4 py-3">${escapeHtml(s.nombre)}</td>
              <td class="px-4 py-3">${escapeHtml(s.apellidoP)}</td>
              <td class="px-4 py-3">${escapeHtml(s.apellidoM)}</td>
              <td class="px-4 py-3 text-center font-semibold">${s.semestre === 0 ? '-' : s.semestre}</td>
              <td class="px-4 py-3 text-emerald-700 font-medium">${CARRERA_MAP[s.carrera] || s.carrera}</td>
              <td class="px-4 py-3 text-xs text-gray-600">${escapeHtml(s.correo)}</td>
              <td class="px-4 py-3 flex justify-center space-x-2 min-w-[120px]">
                  <button data-id="${s.id}" class="edit-btn text-emerald-600 hover:text-emerald-800 p-2 rounded-full hover:bg-emerald-50 transition" title="Editar Registro">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7 1l4-4m-4 4l5.5-5.5a1 1 0 000-1.414l-2.5-2.5a1 1 0 00-1.414 0L10 13z" />
                      </svg>
                  </button>
                  <button data-id="${s.id}" class="delete-btn text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 transition" title="Eliminar Registro">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                  </button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }

        totalEl.textContent = `(${rawList.length}) / Mostrando: ${filteredList.length}`;

        updateFiltersStatus(filteredList.length, rawList.length);

        // Actualizar eventos de edici√≥n/eliminaci√≥n
        document.querySelectorAll('.edit-btn').forEach(button => {
          button.removeEventListener('click', handleEdit);
          button.addEventListener('click', handleEdit);
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
          button.removeEventListener('click', handleDelete);
          button.addEventListener('click', handleDelete);
        });
      };

      // --- MANEJO DE EVENTOS ---

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        const fd = new FormData(form);
        const isEdit = !!idInput.value;

        let list = readLocal();

        // Normalizaci√≥n de datos al ingresar/editar (sin password)
        const newS = {
          id: isEdit ? idInput.value : Date.now().toString(),
          numControl: (fd.get('numControl') || '').toString().trim().toUpperCase(),
          nombre: capitalizeName(fd.get('nombre') || ''),
          apellidoP: capitalizeName(fd.get('apellidoP') || ''),
          apellidoM: capitalizeName(fd.get('apellidoM') || ''),
          semestre: Number(fd.get('semestre') || 0),
          carrera: (fd.get('carrera') || '').toString().trim().toUpperCase(),
          correo: (fd.get('correo') || '').toString().trim().toLowerCase(),
        };

        if (!newS.numControl || !newS.nombre || !newS.apellidoP || !newS.correo) {
          showMsg('Rellene todos los campos obligatorios.', true);
          return;
        }

        if (isEdit) {
          const index = list.findIndex(s => s.id === newS.id);
          if (index !== -1) {
            list[index] = newS;
            showMsg('Estudiante editado y actualizado. ‚úîÔ∏è');
          }
        } else {
          // Verificar duplicado por numControl al agregar
          const duplicate = list.some(s => s.numControl === newS.numControl);
          if (duplicate) {
            showMsg(`El N√∫mero de Control ${newS.numControl} ya se encuentra registrado.`, true);
            return;
          }
          list.unshift(newS);
          window.dispatchEvent(new CustomEvent('students:added', { detail: newS }));
          showMsg('Estudiante registrado con √©xito. ‚ú®');
        }

        writeLocal(list);
        render();
        setFormVisibility(false);
      });

      // Visibilidad del formulario
      showFormBtn.addEventListener('click', () => setFormVisibility(true));
      closeFormBtn.addEventListener('click', () => setFormVisibility(false));
      resetBtn.addEventListener('click', resetForm);

      // --- L√ìGICA DE VISIBILIDAD DEL POP-OVER DE FILTROS ---
      toggleFiltersBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isHidden = filtersPopover.classList.contains('hidden');
        if (isHidden) {
            filtersPopover.classList.remove('hidden');
            setTimeout(() => {
                filtersPopover.classList.add('scale-100', 'opacity-100');
                filtersPopover.classList.remove('scale-95', 'opacity-0');
            }, 10);
        } else {
            filtersPopover.classList.remove('scale-100', 'opacity-100');
            filtersPopover.classList.add('scale-95', 'opacity-0');
            filtersPopover.addEventListener('transitionend', function handler() {
                filtersPopover.classList.add('hidden');
                filtersPopover.removeEventListener('transitionend', handler);
            }, { once: true });
        }
      });

      // Ocultar el pop-over si se hace clic fuera de √©l
      document.addEventListener('click', (e) => {
          if (!filtersPopover.contains(e.target) && !toggleFiltersBtn.contains(e.target)) {
              filtersPopover.classList.remove('scale-100', 'opacity-100');
              filtersPopover.classList.add('scale-95', 'opacity-0');
              setTimeout(() => {
                  filtersPopover.classList.add('hidden');
              }, 200); // 200ms para que la transici√≥n termine
          }
      });


      // --- MANEJO DE EVENTOS DE FILTRADO ---
      const updateFilters = () => {
          currentFilters.semestre = filterSemestreEl.value;
          currentFilters.carrera = filterCarreraEl.value;
          render(); // Vuelve a renderizar la tabla con los nuevos filtros
      }

      filterSemestreEl.addEventListener('change', updateFilters);
      filterCarreraEl.addEventListener('change', updateFilters);

      // Funci√≥n para limpiar ambos filtros y actualizar
      clearFiltersBtn.addEventListener('click', (e) => {
          e.preventDefault();
          filterSemestreEl.value = '';
          filterCarreraEl.value = '';
          updateFilters();
          filtersPopover.classList.remove('scale-100', 'opacity-100');
          filtersPopover.classList.add('scale-95', 'opacity-0');
          setTimeout(() => {
              filtersPopover.classList.add('hidden');
          }, 200);
      });
      // --- FIN MANEJO DE EVENTOS DE FILTRADO ---

      // --- MANEJO DE EVENTOS DE B√öSQUEDA ---
      searchInput.addEventListener('input', () => {
          render();
      });
      // --- FIN MANEJO DE EVENTOS DE B√öSQUEDA ---


      // --- L√ìGICA DE EXPORTACI√ìN ---

      // exportar XLSX
      exportXlsx.addEventListener('click', () => {
        try {
          if (typeof XLSX === 'undefined') {
              showMsg('Error: La librer√≠a XLSX no se ha cargado correctamente.', true);
              return;
          }

          const list = getExportList().map((s, i) => ({
            '#': i + 1,
            'N√∫mero de Control': s.numControl,
            Nombre: s.nombre,
            'Apellido Paterno': s.apellidoP,
            'Apellido Materno': s.apellidoM,
            Semestre: s.semestre,
            Carrera: (CARRERA_MAP[s.carrera] || s.carrera),
            Correo: s.correo,
          }));

          const ws = XLSX.utils.json_to_sheet(list);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'students');
          const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

          function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
          }

          const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'matr√≠cula_estudiantil.xlsx'; a.click(); URL.revokeObjectURL(url);

          showMsg('Listado exportado a Excel. üìä', false);
        } catch (err) {
          console.error(err); showMsg('Error al exportar a XLSX.', true);
        }
      });

      // exportar CSV simple
      exportCsv.addEventListener('click', () => {
        try {
          const list = getExportList();
          // Encabezados sin 'password'
          const headers = ['numControl','nombre','apellidoP','apellidoM','semestre','carrera','correo'];

          const rows = [headers.join(',')].concat(list.map(s =>
            headers.map(h => `"${String(s[h] ?? '').replace(/"/g,'""')}"`).join(',')
          ));

          const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'matr√≠cula_estudiantil.csv'; a.click(); URL.revokeObjectURL(url);

          showMsg('Listado exportado a CSV. üìù', false);
        } catch (err) {
          console.error(err); showMsg('Error al exportar a CSV.', true);
        }
      });

      // importar Excel/CSV
      importFile.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        if (typeof XLSX === 'undefined') {
              showMsg('Error: La librer√≠a XLSX no se ha cargado correctamente.', true);
              e.target.value = ''; // Limpiar el input
              return;
        }

        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = ev.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const first = workbook.SheetNames[0];
            const sheet = workbook.Sheets[first];
            const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
            let added = 0;
            let updated = 0;
            const list = readLocal();

            rows.forEach(r => {
              const newId = Date.now().toString() + Math.random().toString(36).slice(2,7);

              const numControlRaw = (r.numControl || r['N√∫mero de Control'] || r['numcontrol'] || r.id || '').toString().trim().toUpperCase();

              const s = {
                id: newId,
                numControl: numControlRaw,
                nombre: capitalizeName(r.nombre || r.name || ''),
                apellidoP: capitalizeName(r.apellidoP || r.apellidoPaterno || ''),
                apellidoM: capitalizeName(r.apellidoM || r.apellidoMaterno || ''),
                semestre: Math.max(0, Number(r.semestre || r.sem || 0)),
                carrera: (r.carrera || r.Carrera || '').toString().trim().toUpperCase(),
                correo: (r.correo || r.email || '').toString().trim().toLowerCase(),
              };

              // Validaci√≥n simple
              if (!s.numControl || !s.nombre) return;

              const existingIndex = list.findIndex(existing => existing.numControl === s.numControl);

              if (existingIndex !== -1) {
                  const existing = list[existingIndex];
                  s.id = existing.id; // Mantener el ID existente
                  list[existingIndex] = s;
                  updated++;
              } else {
                  if (s.numControl && s.nombre) {
                      list.unshift(s);
                      added++;
                  }
              }
            });

            if (added > 0 || updated > 0) {
              writeLocal(list);
              render();
              showMsg(`Carga Masiva Finalizada: ${added} agregados, ${updated} actualizados. üíæ`);
              window.dispatchEvent(new CustomEvent('students:imported', { detail: { added, updated } }));
            } else {
              showMsg('No se importaron ni actualizaron filas v√°lidas. Verifique su archivo.', true);
            }
          } catch (err) {
            console.error(err); showMsg('Error al procesar el archivo. ¬øEs el formato correcto?', true);
          } finally { e.target.value = ''; }
        };
        reader.readAsBinaryString(file);
      });


      // Limpiar localStorage
      clearBtn.addEventListener('click', () => {
        if (!confirm('‚ö†Ô∏è Advertencia: ¬øEst√° seguro de que quiere ELIMINAR TODOS los datos locales de estudiantes? Esta acci√≥n es irreversible.')) return;
        localStorage.removeItem(STORAGE_KEY);
        render();
        setFormVisibility(false);
        showMsg('Datos de la matr√≠cula borrados del almacenamiento local. üóëÔ∏è', false);
      });

      // Inicializaci√≥n
      render();
      setFormVisibility(false);
    })();
  </script>
</Layout>