---
// src/components/ConceptsTable.astro
interface Concept {
  id?: string;
  title?: string;
  concept?: string;
  amount?: number | string;
  monto?: number;
  status?: string;      // puede ser 'active', 'inactive', 'Activa', etc.
  scope?: string;       // 'all' | 'career' | 'semester' | 'students'
  career?: string;
  semester?: number | string;
  selectedStudents?: Array<any>;
  assignedAll?: boolean;
}

interface Props {
  concepts?: Concept[]; // server props (no render server-side)
}

const { concepts = [] } = Astro.props;
---
<div class="overflow-x-auto rounded-xl shadow-lg border border-gray-200">
  <table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-[#2e594d]">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">Título del Concepto</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">Monto ($)</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">Estado Inicial</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">Ámbito de Aplicación</th>
        <th class="relative px-6 py-3"><span class="sr-only">Acciones</span></th>
      </tr>
    </thead>

    <!-- tbody vacío hasta que haya conceptsList en localStorage -->
    <tbody id="concepts-table-body" class="bg-white divide-y divide-gray-200"></tbody>
  </table>
</div>

<script type="module" client:load>
(() => {
  const tbody = document.getElementById('concepts-table-body');
  if (!tbody) return;

  const esc = (s = '') => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  const fmtAmount = (a) => {
    if (a == null) return '$0.00';
    const n = typeof a === 'number' ? a : Number(String(a).replace(/[$,]/g, '')) || 0;
    return '$' + n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  };

  const mapScopeText = (c) => {
    const sc = String(c?.scope || c?.scope?.toLowerCase() || '').toLowerCase();
    switch(sc) {
      case 'all':
      case 'todos':
        return 'Todos — Aplica a todos los estudiantes activos.';
      case 'career':
      case 'carrera':
        return `Por Carrera — ${c.career || 'No especificada'}`;
      case 'semester':
      case 'semestre':
        return `Por Semestre — ${c.semester ? c.semester + '° Semestre' : 'No especificado'}`;
      case 'students':
      case 'especificos':
        const count = Array.isArray(c.selectedStudents) ? c.selectedStudents.length : (c.selectedStudents ? c.selectedStudents.length || 0 : 0);
        return `Específicos — ${count} estudiante(s) seleccionado(s)`;
      default:
        // Fallback: si assignedAll true, mostrar Todos
        if (c.assignedAll) return 'Todos — Aplica a todos los estudiantes activos.';
        return '-';
    }
  };

  const mapEstadoInicial = (c) => {
    const s = String(c.status || '').toLowerCase();
    if (s.includes('act') || s.includes('activo') || s === 'active') return 'Activo';
    if (s.includes('inac') || s.includes('inactivo') || s === 'inactive') return 'Inactivo';
    // fallback: si assignedAll true tratamos como Activo por defecto
    return c.assignedAll ? 'Activo' : 'Inactivo';
  };

  const renderRows = (list) => {
    if (!Array.isArray(list) || list.length === 0) {
      tbody.innerHTML = ''; // permanecer vacío
      return;
    }

    const rows = list.map(c => {
      const title = c.title || c.concept || c.name || 'Sin título';
      const amount = fmtAmount(c.amount ?? c.monto);
      const estado = mapEstadoInicial(c);
      const scopeText = mapScopeText(c);
      const id = c.id || ('c_' + Math.random().toString(36).slice(2,8));

      return `
        <tr class="hover:bg-gray-50 transition duration-150 ease-in-out">
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium">${esc(title)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${esc(amount)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${esc(estado)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${esc(scopeText)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <a href="/conceptos/${encodeURIComponent(id)}" class="text-[#2e594d] hover:text-[#3b7666]">Ver detalles</a>
          </td>
        </tr>
      `;
    }).join('');

    tbody.innerHTML = rows;
  };

  const loadLocal = () => {
    try {
      const raw = localStorage.getItem('conceptsList');
      if (!raw) {
        renderRows([]);
        return false;
      }
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed) && parsed.length) {
        renderRows(parsed);
        return true;
      } else {
        renderRows([]);
        return false;
      }
    } catch (e) {
      console.warn('Error leyendo conceptsList:', e);
      renderRows([]);
      return false;
    }
  };

  // Inicial: cargar desde localStorage (tabla permanece vacía si no hay datos)
  loadLocal();

  // Actualizar cuando conceptsList cambie (otra pestaña o acción)
  window.addEventListener('storage', (ev) => {
    if (ev.key === 'conceptsList' || ev.key === 'conceptsLastUpdate') {
      loadLocal();
    }
  });
})();
</script>
