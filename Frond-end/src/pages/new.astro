---
// src/pages/new.astro
import Layout from '../layouts/Layout.astro';
// Asume Tailwind configurado
const API_BASE_URL = (import.meta.env.PUBLIC_API_BASE_URL ?? (() => { throw new Error('Falta PUBLIC_API_BASE_URL'); })()).replace(/\/$/, '');
---

<Layout title="Crear Concepto - CBTA 71">
  <script is:inline define:vars={{ API_BASE_URL }}>
    window.__API_BASE_URL__ = API_BASE_URL;
    window.conceptFormData = {
      __version: '2.2.2_REAL_IDS', // IDs actualizados con los reales de la BD
      CAREERS: [
        { id: 13, code: 'TAG-E', name: 'TÃ©cnico Agropecuario' },
        { id: 7, code: 'TOF', name: 'TÃ©c. en OfimÃ¡tica' },
        { id: 12, code: 'TEM', name: 'TÃ©cnico en AdministraciÃ³n para el Emprendimiento' },
        { id: 9, code: 'TAG-M', name: 'TÃ©c. Agropecuario (Mixta)' },
        { id: 10, code: 'TRH', name: 'TÃ©c. AdmÃ³n. R. Humanos (Mixta)' },
        { id: 11, code: 'TI', name: 'TÃ©cnico en InformÃ¡tica' },
      ],
      // Inicializar con IDs numÃ©ricos reales (coinciden con la BD)
      careers: [
        { id: 13, name: 'TÃ©cnico Agropecuario' },
        { id: 7, name: 'TÃ©c. en OfimÃ¡tica' },
        { id: 12, name: 'TÃ©cnico en AdministraciÃ³n para el Emprendimiento' },
        { id: 9, name: 'TÃ©c. Agropecuario (Mixta)' },
        { id: 10, name: 'TÃ©c. AdmÃ³n. R. Humanos (Mixta)' },
        { id: 11, name: 'TÃ©cnico en InformÃ¡tica' },
      ],
      // Inicializar con semestres 1-12
      semesters: [
        { id: '1', name: '1Â°' }, { id: '2', name: '2Â°' }, { id: '3', name: '3Â°' },
        { id: '4', name: '4Â°' }, { id: '5', name: '5Â°' }, { id: '6', name: '6Â°' },
        { id: '7', name: '7Â°' }, { id: '8', name: '8Â°' }, { id: '9', name: '9Â°' },
        { id: '10', name: '10Â°' }, { id: '11', name: '11Â°' }, { id: '12', name: '12Â°' }
      ],
      allStudents: [], // Lista de todos los estudiantes cargados
      isSaving: false,
      formData: {
        id: null,
        title: '',
        amount: 0,
        description: '',
        status: 'active',
        startDate: '',
        endDate: '',
        allStudents: true,
        scopeType: 'carrera',
        selectedCareers: [],
        selectedSemesters: [],
        selectedSpecificStudents: [],
        exceptionStudents: [],
        applicantTags: [],
        replaceRelations: false,
        removeAllExceptions: false,
        replaceExceptions: false
      },
      searchTerm: '',
      searchTermException: '',
      searchResults: [],
      searchResultsException: [],
      isSearching: false,
      errorMessage: '',
      
      apiBaseUrl: '',
      
      loadCareers() {
        const careersToken = localStorage.getItem('access_token');
        
        if (!careersToken) {
          console.warn('âš ï¸ No hay token, usando carreras de fallback');
          this.careers = this.CAREERS.map(c => ({ id: c.id, name: c.name }));
          return Promise.resolve();
        }
        
        const url = new URL(this.apiBaseUrl + '/v1/careers');
        url.searchParams.set('forceRefresh', 'false');
        
        return fetch(url.toString(), {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${careersToken}`,
            'X-User-Role': 'financial-staff'
          }
        })
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }
          return res.json();
        })
        .then(json => {
          if (json.success && json.data?.careers) {
            this.careers = json.data.careers.map(c => ({ id: c.id, name: c.career_name }));
            console.log('âœ… Carreras cargadas desde API:', this.careers.length);
            console.log('ðŸ“‹ IDs disponibles:', this.careers.map(c => c.id).join(', '));
          } else {
            console.warn('âš ï¸ Respuesta del API sin careers, usando fallback');
            this.careers = this.CAREERS.map(c => ({ id: c.id, name: c.name }));
          }
        })
        .catch(err => {
          console.warn('âš ï¸ Error cargando carreras desde API, usando fallback:', err.message);
          this.careers = this.CAREERS.map(c => ({ id: c.id, name: c.name }));
        });
      },

      async loadStudents() {
        const token = localStorage.getItem('access_token');
        const mapStudents = (items = []) => {
          this.allStudents = items.map(item => {
            const fullName = (
              item.name || item.fullName || item.nombre || [
                String(item.nombre ?? '').trim(),
                String(item.apellidoP ?? item.apellidoPaterno ?? '').trim(),
                String(item.apellidoM ?? item.apellidoMaterno ?? '').trim()
              ].filter(n => n).join(' ')
            ).trim();
            const studentDetailsId = item.student_details_id ?? item.studentDetailsId ?? item.student_id ?? null;
            const userId = item.user_id ?? item.userId ?? item.id ?? null;
            const control = item.n_control ?? item.numControl ?? item.num_control ?? '';
            const careerId = item.career_id ?? item.careerId ?? null;
            const careerName = item.career_name ?? item.carrera ?? item.career ?? '';
            const normalizedCareerId = careerId !== null && careerId !== undefined ? String(careerId) : (careerName ? String(careerName) : '');
            const semester = item.semestre ?? item.semester ?? '';
            return {
              id: studentDetailsId ? String(studentDetailsId) : (userId ? String(userId) : ''),
              studentDetailsId: studentDetailsId ? String(studentDetailsId) : '',
              userId: userId ? String(userId) : '',
              control: String(control || ''),
              name: fullName || 'Sin nombre',
              careerId: normalizedCareerId,
              careerName: String(careerName || ''),
              semester: String(semester || '')
            };
          }).filter(s => s.id);
          const semesterSet = new Set();
          this.allStudents.forEach(s => {
            if (s.semester) semesterSet.add(String(s.semester));
          });
          // Si no hay semestres en los estudiantes, usar 1-12 como respaldo
          if (semesterSet.size === 0) {
            for (let i = 1; i <= 12; i++) {
              semesterSet.add(String(i));
            }
          }
          this.semesters = Array.from(semesterSet)
            .sort((a, b) => Number(a) - Number(b))
            .map(id => ({ id, name: id + 'Â°' }));
        };
        
        // Intentar cargar desde localStorage primero (mÃ¡s rÃ¡pido)
        const loadFromLocalStorage = () => {
          const raw = localStorage.getItem('studentsList');
          if (raw) {
            try {
              const parsed = JSON.parse(raw);
              if (Array.isArray(parsed) && parsed.length) {
                mapStudents(parsed);
                return true;
              }
            } catch (e) {
              // Error parsing - ignorar y retornar false
              return false;
            }
          }
          return false;
        };

        // Si hay datos en localStorage, usarlos
        if (loadFromLocalStorage()) {
          return Promise.resolve();
        }

        // Si no hay localStorage, inicializar vacÃ­o
        // El formulario funcionarÃ¡ con bÃºsqueda por API en tiempo real
        mapStudents([]);
        return Promise.resolve();
      },

      mergeRelationsIntoConcept(concept, relationsResponse) {
        const sources = [
          relationsResponse?.data?.relations,
          relationsResponse?.data?.scopeRules,
          relationsResponse?.data?.concept_relations,
          relationsResponse?.data,
          relationsResponse?.relations,
          relationsResponse?.scopeRules,
          relationsResponse
        ].filter(Boolean);

        const collectDeepByKeys = (node, keys, bucket = []) => {
          if (node === null || node === undefined) return bucket;

          if (Array.isArray(node)) {
            for (const item of node) collectDeepByKeys(item, keys, bucket);
            return bucket;
          }

          if (typeof node !== 'object') return bucket;

          for (const key of keys) {
            if (Object.prototype.hasOwnProperty.call(node, key)) {
              bucket.push(node[key]);
            }
          }

          for (const value of Object.values(node)) {
            collectDeepByKeys(value, keys, bucket);
          }

          return bucket;
        };

        const readFirst = (keys) => {
          for (const source of sources) {
            if (!source || typeof source !== 'object') continue;
            for (const key of keys) {
              if (source[key] === undefined || source[key] === null) continue;
              if (Array.isArray(source[key]) && source[key].length === 0) continue;
              return source[key];
            }
          }
          for (const source of sources) {
            if (!source || typeof source !== 'object') continue;
            for (const key of keys) {
              if (source[key] !== undefined && source[key] !== null) {
                return source[key];
              }
            }
          }

          const deepMatches = sources.flatMap(source => collectDeepByKeys(source, keys, []));
          for (const value of deepMatches) {
            if (value === undefined || value === null) continue;
            if (Array.isArray(value) && value.length === 0) continue;
            return value;
          }
          for (const value of deepMatches) {
            if (value !== undefined && value !== null) return value;
          }

          return undefined;
        };

        const careersRaw = readFirst(['careers', 'carreras', 'careerIds', 'career_ids', 'career']);
        const semestersRaw = readFirst(['semestres', 'semesters', 'semesterIds', 'semester_ids', 'target_semester', 'semester', 'semestre']);
        const studentsRaw = readFirst([
          'students',
          'specificStudents',
          'specific_students',
          'users',
          'studentUsers',
          'student_users',
          'userIds',
          'user_ids',
          'studentIds',
          'student_ids',
          'controls',
          'student_controls',
          'user_controls',
          'n_controls'
        ]);
        const exceptionsRaw = readFirst(['exceptionStudents', 'exception_students']);
        const tagsRaw = readFirst([
          'applicantTags',
          'applicant_tags',
          'applicantTag',
          'applicant_tag',
          'tags',
          'tag',
          'special_tags',
          'scope_tags'
        ]);
        const appliesToRaw = readFirst(['applies_to', 'appliesTo', 'scopeType', 'scope_type']);
        const allStudentsRaw = readFirst(['allStudents', 'is_global', 'isGlobal']);

        concept.scopeRules = concept.scopeRules || {};

        if (careersRaw !== undefined) {
          concept.careers = careersRaw;
          concept.scopeRules.careers = careersRaw;
        }
        if (semestersRaw !== undefined) {
          concept.semestres = semestersRaw;
          concept.semesters = semestersRaw;
          concept.scopeRules.semestres = semestersRaw;
          concept.scopeRules.semesters = semestersRaw;
        }
        if (studentsRaw !== undefined) {
          concept.students = studentsRaw;
          concept.scopeRules.specificStudents = studentsRaw;
        }
        if (exceptionsRaw !== undefined) {
          concept.exceptionStudents = exceptionsRaw;
          concept.scopeRules.exceptionStudents = exceptionsRaw;
        }
        if (tagsRaw !== undefined) {
          concept.applicantTags = tagsRaw;
          concept.scopeRules.applicantTags = tagsRaw;
        }
        if (appliesToRaw !== undefined && appliesToRaw !== '') {
          concept.applies_to = appliesToRaw;
        }
        if (allStudentsRaw !== undefined && allStudentsRaw !== null) {
          concept.scopeRules.allStudents = Boolean(allStudentsRaw);
          concept.is_global = Boolean(allStudentsRaw);
        }
      },

      populateForm(concept) {
        console.log('ðŸ“‹ Poblando formulario con concepto:', concept);
        const toArray = (value) => {
          if (Array.isArray(value)) return value;
          if (value === null || value === undefined || value === '') return [];
          return [value];
        };

        const normalizeAppliesTo = (value) => {
          const raw = String(value || '').trim().toLowerCase();
          const map = {
            all: 'todos',
            todos: 'todos',
            carrera: 'carrera',
            career: 'carrera',
            semestre: 'semestre',
            semester: 'semestre',
            carrera_semestre: 'carrera_semestre',
            career_semester: 'carrera_semestre',
            'career-semester': 'carrera_semestre',
            estudiantes: 'estudiantes',
            students: 'estudiantes',
            tag: 'tags',
            tags: 'tags',
            special_tags: 'tags',
            'special-tags': 'tags'
          };
          return map[raw] || raw;
        };
        
        // Asignar campos bÃ¡sicos
        this.formData.id = concept.id;
        this.formData.title = concept.title || '';
        this.formData.amount = parseFloat(concept.amount) || 0;
        this.formData.description = concept.description || '';
        
        // Mapear status del API (activo/inactivo) al formato del formulario (active/inactive)
        const statusMap = {
          'activo': 'active',
          'active': 'active',
          'inactivo': 'inactive',
          'inactive': 'inactive',
          'finalizado': 'inactive',
          'finalized': 'inactive'
        };
        this.formData.status = statusMap[(concept.status || '').toLowerCase()] || 'active';
        console.log('âœ… Status mapeado:', concept.status, 'â†’', this.formData.status);
        
        // Formatear fechas para input type="date" (YYYY-MM-DD)
        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          // Si ya estÃ¡ en formato YYYY-MM-DD, retornar tal cual
          if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
          // Intentar parsear y formatear
          try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0];
          } catch {
            return '';
          }
        };
        
        this.formData.startDate = formatDate(concept.start_date || concept.startDate);
        this.formData.endDate = formatDate(concept.end_date || concept.endDate);
        console.log('âœ… Fechas formateadas:', this.formData.startDate, 'â†’', this.formData.endDate);
        
        // Reiniciar selecciÃ³n de alcance para no arrastrar estado previo
        this.formData.selectedCareers = [];
        this.formData.selectedSemesters = [];
        this.formData.selectedSpecificStudents = [];
        this.formData.exceptionStudents = [];
        this.formData.applicantTags = [];

        const scopeRules = concept.scopeRules || {};
        const normalizedAppliesTo = normalizeAppliesTo(concept.applies_to || concept.appliesTo);

        // allStudents puede venir por scopeRules o is_global,
        // pero si el applies_to indica alcance restringido, debe quedar en false
        const restrictedScopes = ['carrera', 'semestre', 'carrera_semestre', 'estudiantes', 'tags'];
        const isRestrictedScope = restrictedScopes.includes(normalizedAppliesTo);
        this.formData.allStudents = isRestrictedScope
          ? false
          : Boolean(
              scopeRules.allStudents === true ||
              concept.is_global === true ||
              normalizedAppliesTo === 'todos'
            );

        // Carreras: soportar variants del endpoint/localStorage
        const careersRaw =
          scopeRules.careers ??
          scopeRules.carreras ??
          concept.careers ??
          concept.carreras ??
          concept.careerIds ??
          concept.career_ids ??
          concept.career;
        const normalizeCareerId = (value) => {
          if (value === null || value === undefined) return null;
          if (typeof value === 'number' || typeof value === 'string') return String(value);
          if (typeof value === 'object') {
            const candidate =
              value.id ??
              value.career_id ??
              value.careerId ??
              value.carrera_id ??
              value.carreraId ??
              value.career ??
              value.carrera ??
              value.value;
            if (candidate !== undefined && candidate !== null) return String(candidate);
          }
          return null;
        };

        this.formData.selectedCareers = [...new Set(
          toArray(careersRaw)
            .map(normalizeCareerId)
            .filter(c => c !== null && c !== '')
        )];

        // Semestres: soportar variants y mantener strings (x-model usa string)
        const semestersRaw =
          scopeRules.semesters ??
          scopeRules.semestres ??
          concept.semesters ??
          concept.semestres ??
          concept.semesterIds ??
          concept.semester_ids ??
          concept.target_semester ??
          concept.semester ??
          concept.semestre;
        const normalizeSemesterId = (value) => {
          if (value === null || value === undefined) return null;
          if (typeof value === 'number' || typeof value === 'string') return String(value);
          if (typeof value === 'object') {
            const candidate =
              value.id ??
              value.semester_id ??
              value.semesterId ??
              value.semestre_id ??
              value.semestreId ??
              value.semester ??
              value.semestre ??
              value.value;
            if (candidate !== undefined && candidate !== null) return String(candidate);
          }
          return null;
        };

        this.formData.selectedSemesters = [...new Set(
          toArray(semestersRaw)
            .map(normalizeSemesterId)
            .filter(s => s !== null && s !== '' && !Number.isNaN(Number(s)))
        )];

        console.log('âœ… Carreras seleccionadas:', this.formData.selectedCareers);
        console.log('âœ… Semestres seleccionados:', this.formData.selectedSemesters);

        // Estudiantes especÃ­ficos
        const specificStudentsRaw =
          scopeRules.specificStudents ??
          scopeRules.specific_students ??
          scopeRules.students ??
          scopeRules.users ??
          scopeRules.studentUsers ??
          scopeRules.student_users ??
          scopeRules.controls ??
          scopeRules.student_controls ??
          scopeRules.user_controls ??
          concept.students ??
          concept.users ??
          concept.studentUsers ??
          concept.student_users ??
          concept.specific_students ??
          concept.controls ??
          concept.student_controls ??
          concept.user_controls ??
          concept.userIds ??
          concept.user_ids ??
          concept.studentIds ??
          concept.student_ids;

        const resolveStudentCollection = (value) => {
          if (value === null || value === undefined || value === '') return [];
          if (Array.isArray(value)) return value;
          if (typeof value === 'object') {
            if (Array.isArray(value.items)) return value.items;
            if (Array.isArray(value.data)) return value.data;
            if (Array.isArray(value.students)) return value.students;
            if (Array.isArray(value.users)) return value.users;
            if (Array.isArray(value.controls)) return value.controls;
            if (Array.isArray(value.user_ids)) return value.user_ids;
            if (Array.isArray(value.student_ids)) return value.student_ids;
            if (Array.isArray(value.ids)) return value.ids;
          }
          return [value];
        };

        const normalizeStudentForSelection = (value) => {
          if (value === null || value === undefined) return null;

          let rawId = value;
          let rawControl = value;
          let rawName = value;
          let rawEmail = '';
          let rawCareer = '';
          let rawSemester = '';

          if (typeof value === 'object') {
            rawId = value.id ?? value.user_id ?? value.userId ?? value.student_id ?? value.studentId ?? value.n_control ?? value.control ?? '';
            rawControl = value.n_control ?? value.control ?? value.numControl ?? value.num_control ?? rawId;
            rawName = value.name ?? value.fullName ?? value.nombre ?? rawControl ?? rawId;
            rawEmail = value.email ?? '';
            rawCareer = value.career_name ?? value.career ?? value.carrera ?? '';
            rawSemester = value.semestre ?? value.semester ?? '';
          }

          const lookup = this.allStudents.find(s =>
            String(s.id) === String(rawId) ||
            String(s.control || '') === String(rawControl)
          );

          return {
            id: String(lookup?.id || rawId || rawControl || ''),
            control: String(lookup?.control || rawControl || rawId || ''),
            name: String(lookup?.name || rawName || rawControl || rawId || 'Sin nombre'),
            email: String(lookup?.email || rawEmail || ''),
            career: String(lookup?.careerName || rawCareer || ''),
            semestre: String(lookup?.semester || rawSemester || '')
          };
        };

        const normalizedSpecificStudentsRaw = resolveStudentCollection(specificStudentsRaw);

        if (normalizedSpecificStudentsRaw.length > 0) {
          this.formData.selectedSpecificStudents = normalizedSpecificStudentsRaw
            .map(item => normalizeStudentForSelection(item))
            .filter(item => item && (item.id || item.control));
          console.log('âœ… Estudiantes especÃ­ficos:', this.formData.selectedSpecificStudents.length);
        }

        if (this.formData.scopeType === 'estudiantes' && this.formData.selectedSpecificStudents.length === 0) {
          console.warn('âš ï¸ Scope estudiantes sin estudiantes precargados. specificStudentsRaw:', specificStudentsRaw);
        }

        // Excepciones
        const exceptionRaw =
          scopeRules.exceptionStudents ??
          scopeRules.exception_students ??
          concept.exceptionStudents ??
          concept.exception_students;
        const normalizeExceptionStudent = (value) => {
          if (value === null || value === undefined) return null;
          const exceptionId = typeof value === 'object'
            ? (value.id ?? value.user_id ?? value.userId ?? value.student_id ?? value.studentId ?? value.n_control ?? value.control)
            : value;
          if (exceptionId === null || exceptionId === undefined || exceptionId === '') return null;

          const student = this.allStudents.find(s =>
            String(s.id) === String(exceptionId) ||
            String(s.control || '') === String(exceptionId)
          );

          if (student) {
            return { id: student.id, name: student.name, control: student.control };
          }

          return { id: String(exceptionId), name: 'ID: ' + exceptionId, control: '' };
        };

        if (toArray(exceptionRaw).length > 0) {
          this.formData.exceptionStudents = toArray(exceptionRaw)
            .map(item => normalizeExceptionStudent(item))
            .filter(Boolean);
          console.log('âœ… Excepciones:', this.formData.exceptionStudents.length);
        }

        // Tags especiales
        const tagsRaw =
          scopeRules.applicantTags ??
          scopeRules.applicant_tags ??
          scopeRules.tags ??
          scopeRules.tag ??
          concept.applicantTags ??
          concept.applicant_tags ??
          concept.tags ??
          concept.tag;
        const normalizeTagValue = (value) => {
          if (value === null || value === undefined || value === '') return null;
          const normalizeRawTag = (raw) => {
            const tag = String(raw || '').trim().toLowerCase();
            const map = {
              applicant: 'applicant',
              applicants: 'applicant',
              aspirante: 'applicant',
              aspirantes: 'applicant',
              no_student_details: 'no_student_details',
              'no-student-details': 'no_student_details',
              no_student_detail: 'no_student_details',
              without_student_details: 'no_student_details',
              sin_detalles: 'no_student_details',
              sin_detalle: 'no_student_details',
              sin_datos: 'no_student_details',
              sin_datos_estudiante: 'no_student_details'
            };
            return map[tag] || (tag || null);
          };

          if (typeof value === 'string' || typeof value === 'number') {
            return normalizeRawTag(value);
          }
          if (typeof value === 'object') {
            const candidate = value.tag ?? value.value ?? value.name ?? value.code ?? value.type ?? value.slug;
            return candidate !== undefined && candidate !== null ? normalizeRawTag(candidate) : null;
          }
          return null;
        };

        this.formData.applicantTags = [...new Set(
          toArray(tagsRaw)
            .map(tag => normalizeTagValue(tag))
            .filter(tag => tag)
        )];
        if (this.formData.applicantTags.length > 0) {
          console.log('âœ… Applicant Tags:', this.formData.applicantTags);
        } else if (this.formData.scopeType === 'tags' || normalizedAppliesTo === 'tags') {
          console.warn('âš ï¸ Scope tags sin tags precargados. tagsRaw:', tagsRaw);
        }

        // Tipo de Ã¡mbito final: prioridad scopeType -> applies_to normalizado -> inferencia
        const explicitScopeType = String(concept.scopeType || '').trim();
        if (explicitScopeType) {
          this.formData.scopeType = explicitScopeType;
          console.log('ðŸŽ¯ scopeType cargado desde editingConcept:', this.formData.scopeType);
        } else if (normalizedAppliesTo === 'tags') {
          this.formData.scopeType = 'tags';
        } else if (normalizedAppliesTo === 'estudiantes') {
          this.formData.scopeType = 'estudiantes';
        } else if (normalizedAppliesTo === 'carrera_semestre') {
          this.formData.scopeType = 'carrera_semestre';
        } else if (normalizedAppliesTo === 'semestre') {
          this.formData.scopeType = 'semestre';
        } else if (normalizedAppliesTo === 'carrera') {
          this.formData.scopeType = 'carrera';
        } else if (this.formData.selectedSpecificStudents.length > 0) {
          this.formData.scopeType = 'estudiantes';
        } else if (this.formData.selectedCareers.length > 0 && this.formData.selectedSemesters.length > 0) {
          this.formData.scopeType = 'carrera_semestre';
        } else if (this.formData.selectedSemesters.length > 0) {
          this.formData.scopeType = 'semestre';
        } else if (this.formData.selectedCareers.length > 0) {
          this.formData.scopeType = 'carrera';
        } else if (this.formData.applicantTags.length > 0) {
          this.formData.scopeType = 'tags';
        }

        console.log('âœ… Tipo de Ã¡mbito final:', this.formData.scopeType);

        if (this.formData.scopeType === 'estudiantes') {
          this.formData.exceptionStudents = [];
          this.formData.removeAllExceptions = false;
          this.formData.replaceExceptions = false;
        }
        
        console.log('âœ… Formulario poblado completamente:', this.formData);
      },

      getCareerDisplayName(careerId) {
        const id = String(careerId || '');
        const career = (this.careers || []).find(c => String(c.id) === id);
        return career ? `${career.name} (ID: ${id})` : `ID: ${id}`;
      },

      getScopeLabel() {
        if (this.formData.allStudents) return 'Todos los estudiantes';

        const labels = {
          carrera: 'Por carrera',
          semestre: 'Por semestre',
          carrera_semestre: 'Carrera + semestre',
          estudiantes: 'Estudiantes especÃ­ficos',
          tags: 'Tags especiales'
        };

        return labels[this.formData.scopeType] || 'Sin definir';
      },

      getScopeSummary() {
        if (this.formData.allStudents) {
          return 'Se aplicarÃ¡ a toda la matrÃ­cula activa.';
        }

        if (this.formData.scopeType === 'carrera') {
          if (!this.formData.selectedCareers.length) return 'Sin carreras seleccionadas.';
          return this.formData.selectedCareers.map(id => this.getCareerDisplayName(id)).join(' | ');
        }

        if (this.formData.scopeType === 'semestre') {
          if (!this.formData.selectedSemesters.length) return 'Sin semestres seleccionados.';
          return this.formData.selectedSemesters.map(s => `${s}Â°`).join(', ');
        }

        if (this.formData.scopeType === 'carrera_semestre') {
          const careers = this.formData.selectedCareers.length
            ? this.formData.selectedCareers.map(id => this.getCareerDisplayName(id)).join(', ')
            : 'Sin carreras';
          const semesters = this.formData.selectedSemesters.length
            ? this.formData.selectedSemesters.map(s => `${s}Â°`).join(', ')
            : 'Sin semestres';
          return `Carreras: ${careers} | Semestres: ${semesters}`;
        }

        if (this.formData.scopeType === 'estudiantes') {
          const total = this.formData.selectedSpecificStudents.length;
          if (!total) return 'Sin estudiantes seleccionados.';
          const preview = this.formData.selectedSpecificStudents
            .slice(0, 3)
            .map(s => s.name || s.control || s.id)
            .join(', ');
          return total > 3 ? `${preview} y ${total - 3} mÃ¡s` : preview;
        }

        if (this.formData.scopeType === 'tags') {
          if (!this.formData.applicantTags.length) return 'Sin tags seleccionados.';
          return this.formData.applicantTags.join(', ');
        }

        return 'Sin reglas de alcance configuradas.';
      },

      getExceptionsSummary() {
        if (this.formData.scopeType === 'estudiantes') return '';
        if (!this.formData.exceptionStudents.length) return 'Sin excepciones.';
        return `${this.formData.exceptionStudents.length} excepciÃ³n(es) configurada(s).`;
      },

      toggleSpecificStudent(student) {
        const studentControl = student.control || student.n_control;
        const index = this.formData.selectedSpecificStudents.findIndex(s => s.control === studentControl);
        if (index === -1) {
          this.formData.selectedSpecificStudents.push({
            control: studentControl,
            name: student.name,
          });
        } else {
          this.formData.selectedSpecificStudents.splice(index, 1);
        }
        this.searchTerm = '';
      },
      
      async addStudentByControl() {
        const input = this.searchTerm.trim();
        if (!input) return;

        this.formData.allStudents = false;
        this.formData.scopeType = 'estudiantes';
        
        // Verificar si ya existe
        const exists = this.formData.selectedSpecificStudents.some(s => 
          s.control === input || String(s.control) === input
        );
        
        if (exists) {
          this.errorMessage = 'âš ï¸ Esta matrÃ­cula ya fue agregada.';
          setTimeout(() => this.errorMessage = '', 2000);
          return;
        }
        
        // Buscar el estudiante en el API para obtener su n_control
        this.isSearching = true;
        try {
          const token = localStorage.getItem('access_token');
          if (!token) {
            this.errorMessage = 'âš ï¸ No hay sesiÃ³n activa.';
            setTimeout(() => this.errorMessage = '', 2000);
            this.isSearching = false;
            return;
          }

          const userDataRaw = localStorage.getItem('user_data');
          const userData = userDataRaw ? JSON.parse(userDataRaw) : null;
          const userRole = userData?.roles?.[0] || 'student';

          const url = new URL(this.apiBaseUrl + '/v1/concepts/search/controls');
          url.searchParams.set('search', input);
          url.searchParams.set('limit', '1');

          const res = await fetch(url.toString(), {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`,
              'X-User-Role': userRole
            }
          });

          if (!res.ok) {
            this.errorMessage = 'âŒ No se encontrÃ³ el estudiante con esa matrÃ­cula.';
            setTimeout(() => this.errorMessage = '', 3000);
            this.isSearching = false;
            return;
          }

          const json = await res.json();
          const searchResults = json.data?.search || (json.data?.concept ? [json.data.concept] : []);
          
          if (searchResults.length > 0) {
            const student = searchResults[0];
            const nControl = student.n_control || student.control;
            
            if (!nControl) {
              this.errorMessage = 'âŒ El estudiante no tiene nÃºmero de control.';
              setTimeout(() => this.errorMessage = '', 3000);
              this.isSearching = false;
              return;
            }
            
            // Verificar nuevamente con el n_control
            const existsByControl = this.formData.selectedSpecificStudents.some(s => 
              String(s.control) === String(nControl)
            );
            
            if (existsByControl) {
              this.errorMessage = 'âš ï¸ Este estudiante ya fue agregado.';
              setTimeout(() => this.errorMessage = '', 2000);
              this.isSearching = false;
              return;
            }

            // Agregar usando solo el n_control
            this.formData.selectedSpecificStudents.push({
              control: nControl,
              name: student.name || nControl,
              email: '',
              career: '',
              semestre: ''
            });
            
            console.log('âœ… Estudiante agregado por Enter:', {
              n_control: nControl,
              name: student.name
            });
            this.searchTerm = '';
          } else {
            this.errorMessage = 'âš ï¸ No se encontrÃ³ el estudiante con esa matrÃ­cula.';
            setTimeout(() => this.errorMessage = '', 2000);
          }
        } catch (err) {
          console.error('Error buscando estudiante:', err);
          this.errorMessage = 'âš ï¸ Error al buscar el estudiante.';
          setTimeout(() => this.errorMessage = '', 2000);
        } finally {
          this.isSearching = false;
        }
      },
      
      toggleExceptionStudent(student) {
        const index = this.formData.exceptionStudents.findIndex(s => s.id === student.id);
        if (index === -1) {
          this.formData.exceptionStudents.push({
            id: student.id,
            name: student.name,
            control: student.control
          });
        } else {
          this.formData.exceptionStudents.splice(index, 1);
        }
        this.searchTermException = '';
      },

      get filteredStudents() {
        if (!this.searchTerm) return [];
        const searchLower = this.searchTerm.toLowerCase();
        const careerFilter = this.formData.selectedCareers;
        const semesterFilter = this.formData.selectedSemesters;
        return this.allStudents.filter(student => {
          const matchesSearch =
            student.name.toLowerCase().includes(searchLower) ||
            String(student.control || '').includes(searchLower) ||
            String(student.id || '').includes(searchLower);
          const matchesCareer = !careerFilter.length || careerFilter.includes(student.careerId);
          const matchesSemester = !semesterFilter.length || semesterFilter.includes(student.semester);
          return matchesSearch && matchesCareer && matchesSemester;
        }).slice(0, 8);
      },
      
      get filteredExceptionStudents() {
        if (!this.searchTermException) return [];
        const searchLower = this.searchTermException.toLowerCase();
        return this.allStudents.filter(student => {
          const matchesSearch =
            student.name.toLowerCase().includes(searchLower) ||
            String(student.control || '').includes(searchLower) ||
            String(student.id || '').includes(searchLower);
          return matchesSearch;
        }).slice(0, 8);
      },

      removeSpecificStudent(studentControl) {
        this.formData.selectedSpecificStudents = this.formData.selectedSpecificStudents.filter(s => s.control !== studentControl);
      },
      
      removeExceptionStudent(studentId) {
        this.formData.exceptionStudents = this.formData.exceptionStudents.filter(s => s.id !== studentId);
      },

      async searchStudentsRealTime() {
        const input = this.searchTerm.trim();
        // Requiere mÃ­nimo 3 caracteres
        if (!input || input.length < 3) {
          this.searchResults = [];
          return;
        }

        this.isSearching = true;
        
        // Primero buscar en localStorage si hay estudiantes cacheados (mÃ¡s rÃ¡pido)
        if (this.allStudents && this.allStudents.length > 0) {
          const searchLower = input.toLowerCase();
          const filtered = this.allStudents
            .filter(student => 
              String(student.control || '').toLowerCase().includes(searchLower) ||
              student.name.toLowerCase().includes(searchLower) ||
              String(student.id || '').includes(searchLower)
            )
            .slice(0, 15);
          
          if (filtered.length > 0) {
            this.searchResults = filtered.map(s => {
              const studentDetailsId = s.studentDetailsId || '';
              const userId = s.userId || (studentDetailsId ? '' : s.id);
              return {
                id: studentDetailsId || s.id,
                student_details_id: studentDetailsId,
                user_id: userId,
                fullName: s.name,
                control: s.control,
                email: s.email || '',
                career_name: s.careerName || '',
                semestre: s.semester || ''
              };
            });
            this.isSearching = false;
            console.log('âœ… Resultados desde cache:', this.searchResults.length);
            return;
          }
        }
        
        // Si no hay cache o no encontrÃ³, buscar en API por prefijo
        const token = localStorage.getItem('access_token');
        if (!token) {
          this.searchResults = [];
          this.isSearching = false;
          return;
        }

        try {
          let userRole = 'financial-staff';
          const rawUserData = localStorage.getItem('user_data');
          if (rawUserData) {
            try {
              const parsedUser = JSON.parse(rawUserData);
              if (parsedUser && Array.isArray(parsedUser.roles) && parsedUser.roles.length > 0) {
                userRole = String(parsedUser.roles[0] || userRole);
              }
            } catch {
              // If parsing fails, keep default role.
            }
          }
          // El endpoint busca por PREFIJO, no nÃºmero completo
          // Intentar con parÃ¡metro includeUserId o full para obtener user_id
          const url = new URL(this.apiBaseUrl + '/v1/concepts/search/controls');
          url.searchParams.set('search', input);
          url.searchParams.set('limit', '15');
          url.searchParams.set('includeUserId', 'true'); // Intentar obtener user_id

          const res = await fetch(url.toString(), {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Authorization': `Bearer ${token}`,
              'X-User-Role': userRole,
              'X-User-Permission': 'search.concepts.controls'
            }
          });

          if (!res.ok) {
            // Error 403 = sin permisos, 404 = no encontrado
            if (res.status === 403) {
              console.warn('âš ï¸ Error 403 en /concepts/search/controls: Sin permisos. Intentando con /payments/students...');
              
              // FALLBACK: Usar endpoint de payments que sÃ­ tiene permisos
              try {
                const paymentsUrl = new URL(this.apiBaseUrl + '/v1/payments/students');
                paymentsUrl.searchParams.set('search', input);
                paymentsUrl.searchParams.set('perPage', '15');
                
                const paymentsRes = await fetch(paymentsUrl.toString(), {
                  method: 'GET',
                  headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'X-User-Role': userRole,
                    'X-User-Permission': 'view.payments.student.summary'
                  }
                });
                
                if (paymentsRes.ok) {
                  const paymentsJson = await paymentsRes.json();
                  console.log('âœ… Usando endpoint alternativo /payments/students');
                  
                  if (paymentsJson.data?.students?.items && paymentsJson.data.students.items.length > 0) {
                    this.searchResults = paymentsJson.data.students.items.map(item => {
                      const studentDetailsId = item.student_id || item.student_details_id || item.studentDetailsId || '';
                      const userId = item.userId || item.user_id || item.id || '';
                      return {
                        id: studentDetailsId || userId,
                        student_details_id: studentDetailsId,
                        user_id: userId,
                        fullName: item.fullName || item.name,
                        control: item.n_control || item.control,
                        email: '',
                        career_name: item.career_name || '',
                        semestre: item.semestre || ''
                      };
                    });
                    console.log('âœ… Resultados desde /payments/students:', this.searchResults.length);
                    this.isSearching = false;
                    return;
                  }
                } else if (paymentsRes.status === 403) {
                  console.warn('âš ï¸ Error 403 tambiÃ©n en /payments/students. Solo estÃ¡ disponible bÃºsqueda en cachÃ© local.');
                  console.warn('ðŸ’¡ TIP: Si no aparecen resultados, verifica que los estudiantes estÃ©n cargados en cachÃ© (aparece al inicio de la consola)');
                }
              } catch (fallbackErr) {
                console.error('âŒ Error en fallback:', fallbackErr);
              }
            }
            // No hay permisos para buscar por API - solo usar cachÃ©
            console.info('â„¹ï¸ BÃºsqueda por API no disponible. Solo se puede buscar en estudiantes cargados en cachÃ©.');
            this.searchResults = [];
            this.isSearching = false;
            return;
          }

          const json = await res.json();
          if (json.success && json.data) {
            const searchResults = json.data.search || (json.data.concept ? [json.data.concept] : []);
            
            console.log('ðŸ” Respuesta del API de bÃºsqueda:', json.data);
            console.log('ðŸ” Primer resultado completo:', searchResults[0]);
            
            if (searchResults.length > 0) {
              this.searchResults = searchResults.map(item => {
                console.log('ðŸ‘¤ Mapeando estudiante:', {
                  id: item.id,
                  student_id: item.student_id,
                  user_id: item.user_id,
                  userId: item.userId,
                  name: item.name,
                  n_control: item.n_control,
                  fullItem: item
                });
                
                const studentDetailsId = item.student_details_id || item.student_id || '';
                const userId = item.user_id || item.userId || (studentDetailsId ? '' : item.id);
                return {
                  id: studentDetailsId || item.id,
                  student_details_id: studentDetailsId,
                  user_id: userId,
                  fullName: item.name,
                  control: item.n_control,
                  email: item.email || '',
                  career_name: item.career_name || '',
                  semestre: item.semestre || ''
                };
              });
              console.log('âœ… Resultados desde API:', this.searchResults.length);
              console.log('âœ… Primer resultado mapeado:', this.searchResults[0]);
            } else {
              this.searchResults = [];
            }
          } else {
            this.searchResults = [];
          }
        } catch (err) {
          // Error de red - manejar silenciosamente
          this.searchResults = [];
        } finally {
          this.isSearching = false;
        }
      },

      selectStudentFromSearch(student) {
        console.log('ðŸŽ¯ Estudiante seleccionado del dropdown:', student);
        
        // Obtener el n_control que ya viene en la respuesta de bÃºsqueda
        const nControl = student.n_control || student.control;
        
        if (!nControl) {
          console.error('âŒ No se pudo obtener el nÃºmero de control del estudiante');
          this.errorMessage = 'âŒ El estudiante no tiene nÃºmero de control. Contacte al administrador.';
          setTimeout(() => this.errorMessage = '', 5000);
          return;
        }
        
        console.log('âœ… NÃºmero de control obtenido:', nControl);
        
        // Verificar si ya estÃ¡ agregado
        const exists = this.formData.selectedSpecificStudents.some(s => 
          String(s.control) === String(nControl)
        );
        
        if (exists) {
          this.errorMessage = 'âš ï¸ Este estudiante ya fue agregado.';
          setTimeout(() => this.errorMessage = '', 2000);
          return;
        }

        this.formData.allStudents = false;
        this.formData.scopeType = 'estudiantes';

        // Solo guardar el n_control y datos de visualizaciÃ³n
        this.formData.selectedSpecificStudents.push({
          control: nControl,
          name: student.name || student.fullName || nControl,
          email: student.email || '',
          career: student.career_name || '',
          semestre: student.semestre || ''
        });

        this.searchTerm = '';
        this.searchResults = [];
        console.log('âœ… Estudiante agregado:', {
          n_control: nControl,
          name: student.name || student.fullName,
          total_students: this.formData.selectedSpecificStudents.length
        });
      },

      submitForm() {
        console.log('ðŸš€ Iniciando submitForm...');
        console.log('ðŸ“‹ Estado del formulario:', {
          allStudents: this.formData.allStudents,
          scopeType: this.formData.scopeType,
          selectedCareers: this.formData.selectedCareers,
          selectedSemesters: this.formData.selectedSemesters,
          selectedSpecificStudents: this.formData.selectedSpecificStudents.length,
          title: this.formData.title,
          amount: this.formData.amount
        });
        
        this.errorMessage = '';
        if (this.isSaving) return;

        if (this.formData.scopeType === 'estudiantes') {
          this.formData.allStudents = false;
        }
        if (!this.formData.title || !this.formData.amount || parseFloat(this.formData.amount) <= 0) {
          this.errorMessage = 'âš ï¸ Rellene TÃ­tulo y Monto (mayor a $0).';
          return;
        }
        if (!this.formData.startDate || !this.formData.endDate) {
          this.errorMessage = 'âš ï¸ Las fechas de inicio y fin son obligatorias.';
          return;
        }

        const now = new Date();
        const todayISO = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

        if (this.formData.endDate < this.formData.startDate) {
          this.errorMessage = 'âš ï¸ La fecha de fin no puede ser anterior a la fecha de inicio.';
          return;
        }

        if (!this.formData.id && this.formData.endDate < todayISO) {
          this.errorMessage = `âš ï¸ La fecha de fin no puede ser anterior a hoy (${todayISO}). Actualiza la fecha para continuar.`;
          return;
        }
        
        // ValidaciÃ³n especÃ­fica segÃºn el Ã¡mbito seleccionado
        if (!this.formData.allStudents) {
          if (this.formData.scopeType === 'carrera') {
            if (this.formData.selectedCareers.length === 0) {
              this.errorMessage = 'âš ï¸ Seleccione al menos una Carrera.';
              return;
            }
          } else if (this.formData.scopeType === 'semestre') {
            if (this.formData.selectedSemesters.length === 0) {
              this.errorMessage = 'âš ï¸ Seleccione al menos un Semestre.';
              return;
            }
          } else if (this.formData.scopeType === 'carrera_semestre') {
            if (this.formData.selectedCareers.length === 0 || this.formData.selectedSemesters.length === 0) {
              this.errorMessage = 'âš ï¸ Seleccione al menos una Carrera y un Semestre.';
              return;
            }
          } else if (this.formData.scopeType === 'estudiantes') {
            if (this.formData.selectedSpecificStudents.length === 0) {
              this.errorMessage = 'âš ï¸ Debe agregar al menos un estudiante. Use el campo de bÃºsqueda abajo ingresando el nÃºmero de control y seleccionando del resultado (mÃ­nimo 3 caracteres).';
              return;
            }
          } else if (this.formData.scopeType === 'tags') {
            if (this.formData.applicantTags.length === 0) {
              this.errorMessage = 'âš ï¸ Seleccione al menos un Caso Especial.';
              return;
            }
          }
        }
        const normalizedDescription = String(this.formData.description || '').trim();
        const safeDescription = normalizedDescription || 'Sin descripciÃ³n';
        const isCreateMode = !this.formData.id;
        const shouldDisableAfterCreate = isCreateMode && this.formData.status === 'inactive';

        const payload = {
          concept_name: this.formData.title,
          description: safeDescription,
          status: isCreateMode ? 'activo' : (this.formData.status === 'active' ? 'activo' : 'inactivo'),
          amount: parseFloat(this.formData.amount),
          start_date: this.formData.startDate,
          end_date: this.formData.endDate,
          is_global: Boolean(this.formData.allStudents)
        };
        
        // Agregar excepciones si existen (solo en alcance restringido y no estudiantes especÃ­ficos)
        if (!this.formData.allStudents && this.formData.scopeType !== 'estudiantes' && this.formData.exceptionStudents.length > 0) {
          payload.exceptionStudents = this.formData.exceptionStudents.map(s => String(s.id));
        }
        
        // Agregar booleanos de control solo en modo ediciÃ³n
        if (this.formData.id && !this.formData.allStudents) {
          payload.replaceRelations = Boolean(this.formData.replaceRelations);
          if (this.formData.scopeType !== 'estudiantes') {
            payload.removeAllExceptions = Boolean(this.formData.removeAllExceptions);
            payload.replaceExceptions = Boolean(this.formData.replaceExceptions);
          }
        }
        
        // Construir applies_to y campos relacionados segÃºn alcance
        if (this.formData.allStudents) {
          // Para todos - NO incluir campos de filtro
          console.log('âœ… Modo: Aplicar a TODOS los estudiantes (sin filtros)');
          payload.applies_to = 'todos';
          // ExplÃ­citamente NO incluir campos de filtro
          delete payload.students;
          delete payload.student;
          delete payload.semestre;
          delete payload.semestres;
          delete payload.career;
          delete payload.carrera;
          delete payload.careers;
          delete payload.carreras;
          delete payload.exceptionStudents;
          delete payload.applicantTags;
          delete payload.applicant_tags;
          delete payload.replaceRelations;
          delete payload.removeAllExceptions;
          delete payload.replaceExceptions;
        } else {
          // Alcance restringido - incluir solo los filtros especificados
          if (this.formData.scopeType === 'tags') {
            // Casos especiales - aplica solo a usuarios con esos tags
            payload.applies_to = 'tag';
            // SegÃºn documentaciÃ³n OpenAPI: applicantTags debe ser un array con valores singulares
            // Valores vÃ¡lidos: ["applicant", "no_student_details"]
            if (this.formData.applicantTags.length === 0) {
              this.errorMessage = 'âš ï¸ Seleccione al menos un Caso Especial.';
              this.isSaving = false;
              return;
            } else {
              payload.applicantTags = this.formData.applicantTags;
            }
            
            // LIMPIAR TODOS LOS OTROS CAMPOS de filtro para evitar conflictos
            delete payload.students;
            delete payload.student;
            delete payload.semestre;
            delete payload.semestres;
            delete payload.career;
            delete payload.carrera;
            delete payload.careers;
            delete payload.carreras;
            delete payload.exceptionStudents;
            delete payload.applicant_tags; // Eliminar versiÃ³n snake_case si existe
            delete payload.replaceRelations;
            delete payload.removeAllExceptions;
            delete payload.replaceExceptions;
            
            console.log('ðŸ·ï¸  Agregando applicantTags al payload:', {
              valoresEnviados: payload.applicantTags,
              esArray: Array.isArray(payload.applicantTags),
              cantidad: payload.applicantTags.length
            });
          } else if (this.formData.selectedSpecificStudents.length > 0) {
            payload.applies_to = 'estudiantes';
            
            console.log('ðŸ“„ Estudiantes seleccionados:', this.formData.selectedSpecificStudents);
            
            // El API espera los n_control (nÃºmeros de control) como strings
            payload.students = this.formData.selectedSpecificStudents
              .map(s => {
                const nControl = String(s.control);
                console.log('ðŸ“‹ Estudiante:', { 
                  n_control: nControl,
                  name: s.name
                });
                return nControl;
              })
              .filter(control => control && control !== 'undefined' && control !== 'null' && control.trim() !== '');
            
            console.log('ðŸ“¤ NÃºmeros de control a enviar:', payload.students);
            console.log('ðŸ“Š Total:', payload.students.length);
            
            if (payload.students.length === 0) {
              this.errorMessage = 'âŒ No se pudieron obtener los nÃºmeros de control. Por favor, vuelva a agregar los estudiantes.';
              this.isSaving = false;
              return;
            }
            
            delete payload.exceptionStudents;
            delete payload.removeAllExceptions;
            delete payload.replaceExceptions;
            console.log('âœ… Modo: Estudiantes EspecÃ­ficos');
          } else if (this.formData.selectedSemesters.length > 0 && this.formData.selectedCareers.length > 0) {
            // Ambas carreras y semestres seleccionados
            payload.applies_to = 'carrera_semestre';
            console.log('ðŸ§© Selecciones crudas (carrera+semestre):', {
              selectedCareers: this.formData.selectedCareers,
              selectedSemesters: this.formData.selectedSemesters
            });
            payload.careers = this.formData.selectedCareers
              .map(c => parseInt(c, 10))
              .filter(id => Number.isInteger(id));
            payload.semestres = this.formData.selectedSemesters
              .map(s => parseInt(s, 10))
              .filter(id => Number.isInteger(id));
            if (payload.careers.length === 0) {
              this.errorMessage = 'âŒ Debes seleccionar al menos una carrera valida (ID numerico). Si no aparecen IDs, recarga la pagina.';
              this.isSaving = false;
              return;
            }
            
            // Validar que las carreras seleccionadas existen en la lista cargada del API
            const availableCareerIds = this.careers.map(c => c.id);
            const invalidCareerIds = payload.careers.filter(id => !availableCareerIds.includes(id));
            if (invalidCareerIds.length > 0) {
              console.error('âŒ IDs de carreras no vÃ¡lidos:', invalidCareerIds);
              console.log('ðŸ“‹ IDs disponibles:', availableCareerIds);
              this.errorMessage = `âŒ Error: Las carreras con ID [${invalidCareerIds.join(', ')}] no existen en la base de datos. IDs vÃ¡lidos: [${availableCareerIds.join(', ')}]. Recarga la pÃ¡gina para actualizar la lista.`;
              this.isSaving = false;
              return;
            }
            
            if (payload.semestres.length === 0) {
              this.errorMessage = 'âŒ Debes seleccionar al menos un semestre valido.';
              this.isSaving = false;
              return;
            }
            console.log('âœ… Modo: Carrera + Semestre | Carreras:', payload.careers, '| Semestres:', payload.semestres);
          } else if (this.formData.selectedSemesters.length > 0) {
            payload.applies_to = 'semestre';
            payload.semestres = this.formData.selectedSemesters
              .map(s => parseInt(s, 10))
              .filter(id => Number.isInteger(id));
            if (payload.semestres.length === 0) {
              this.errorMessage = 'âŒ Debes seleccionar al menos un semestre valido.';
              this.isSaving = false;
              return;
            }
            console.log('âœ… Modo: Semestre | Semestres seleccionados:', payload.semestres);
          } else if (this.formData.selectedCareers.length > 0) {
            payload.applies_to = 'carrera';
            payload.careers = this.formData.selectedCareers
              .map(c => parseInt(c, 10))
              .filter(id => Number.isInteger(id));
            if (payload.careers.length === 0) {
              this.errorMessage = 'âŒ Debes seleccionar al menos una carrera valida (ID numerico). Si no aparecen IDs, recarga la pagina.';
              this.isSaving = false;
              return;
            }
            
            // Validar que las carreras seleccionadas existen en la lista cargada del API
            const availableCareerIds = this.careers.map(c => c.id);
            const invalidCareerIds = payload.careers.filter(id => !availableCareerIds.includes(id));
            if (invalidCareerIds.length > 0) {
              console.error('âŒ IDs de carreras no vÃ¡lidos:', invalidCareerIds);
              console.log('ðŸ“‹ IDs disponibles:', availableCareerIds);
              this.errorMessage = `âŒ Error: Las carreras con ID [${invalidCareerIds.join(', ')}] no existen en la base de datos. IDs vÃ¡lidos: [${availableCareerIds.join(', ')}]. Recarga la pÃ¡gina para actualizar la lista.`;
              this.isSaving = false;
              return;
            }
            
            console.log('âœ… Modo: Carrera | Carreras seleccionadas:', payload.careers);
          } else {
            // Sin filtros seleccionados - aplicar a todos por defecto
            payload.applies_to = 'todos';
            console.log('âœ… Modo: Todos los estudiantes');
            // ExplÃ­citamente NO incluir campos de filtro
            delete payload.students;
            delete payload.student;
            delete payload.semestre;
            delete payload.semestres;
            delete payload.career;
            delete payload.carrera;
            delete payload.careers;
            delete payload.carreras;
          }
        }
        console.log('ðŸ“¤ Sending payload:', JSON.stringify(payload, null, 2));
        console.log('ðŸ“‹ Payload object:', payload);
        if (payload.applies_to === 'tag') {
          console.log('ðŸ·ï¸  applicantTags especÃ­ficamente:', payload.applicantTags);
          console.log('ðŸ·ï¸  Tipo de applicantTags:', typeof payload.applicantTags, Array.isArray(payload.applicantTags) ? 'ARRAY' : 'NO ARRAY');
        }
        const token = localStorage.getItem('access_token');
        console.log('ðŸŽ¯ URL del API:', this.apiBaseUrl + '/v1/concepts');
        console.log('ðŸ”‘ Token presente:', !!token);
        if (!token) {
          this.errorMessage = 'âŒ No hay token, inicia sesiÃ³n.';
          return;
        }
        this.isSaving = true;
        const self = this;
        const executeSubmit = () => {
          if (window.AdminAPI && window.AdminAPI.createConcept) {
            if (self.formData.id) {
              return window.AdminAPI.updateConcept(self.formData.id, token, payload);
            } else {
              return window.AdminAPI.createConcept(token, payload);
            }
          } else {
            // CREAR nuevo concepto: enviar todo junto en POST
            if (!self.formData.id) {
              console.log('ðŸ“¤ JUSTO ANTES de stringify - applicantTags en payload:', payload.applicantTags);
              const bodyString = JSON.stringify(payload);
              console.log('ðŸ“¤ Body stringificado:', bodyString);
              console.log('ðŸ“¤ Â¿Contiene applicantTags?', bodyString.includes('applicantTags'));
              
              return fetch(`${self.apiBaseUrl}/v1/concepts`, {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`,
                  'X-User-Role': 'financial-staff',
                  'X-User-Permission': 'create.concepts'
                },
                body: bodyString
              }).then(async res => {
                console.log('ðŸ“¥ Response status:', res.status, res.statusText);
                console.log('ðŸ“¥ Response URL:', res.url);
                const data = await res.json().catch(() => ({}));
                console.log('ðŸ“¥ Response data:', JSON.stringify(data, null, 2));
                console.log('ðŸ“¤ Payload que se enviÃ³:', JSON.stringify(payload, null, 2));
                
                if (!res.ok) {
                  let errorMsg = data.message || res.statusText || 'Error desconocido';
                  
                  // Mensaje mÃ¡s especÃ­fico para RECIPIENTS_NOT_FOUND
                  if (data.error_code === 'RECIPIENTS_NOT_FOUND') {
                    const details = [];
                    if (payload.applies_to === 'carrera_semestre') {
                      const carrerasStr = payload.careers?.join(', ') || 'N/A';
                      const semestresStr = payload.semestres?.join(', ') || 'N/A';
                      details.push(`Carrera(s) ID: ${carrerasStr}`);
                      details.push(`Semestre(s): ${semestresStr}`);
                    } else if (payload.applies_to === 'carrera') {
                      details.push(`Carrera(s) ID: ${payload.careers?.join(', ') || 'N/A'}`);
                    } else if (payload.applies_to === 'semestre') {
                      details.push(`Semestre(s): ${payload.semestres?.join(', ') || 'N/A'}`);
                    } else if (payload.applies_to === 'estudiantes' && payload.students) {
                      details.push(`Estudiante(s) ID: ${payload.students.join(', ')}`);
                    }
                    
                    errorMsg = `âŒ No se encontraron estudiantes activos con los filtros seleccionados.\n\n` +
                               `Filtros aplicados:\n${details.join('\n')}\n\n` +
                               `Posibles causas:\n` +
                               `â€¢ No hay estudiantes registrados con esa combinaciÃ³n\n` +
                               `â€¢ Los estudiantes con esos filtros estÃ¡n inactivos o dados de baja\n` +
                               `â€¢ El semestre o carrera seleccionados no existen en el sistema\n\n` +
                               `Soluciones:\n` +
                               `â€¢ Verifique que existan estudiantes activos con esos filtros\n` +
                               `â€¢ Intente con otros semestres o carreras\n` +
                               `â€¢ Use "Todos los Estudiantes" si desea aplicar sin filtros`;
                  }
                  
                  // Mensaje mÃ¡s especÃ­fico si es error de estudiantes no encontrados
                  if (data.error_code === 'STUDENTS_NOT_FOUND' || errorMsg.includes('estudiantes') || errorMsg.includes('dado de baja')) {
                    const studentControls = payload.students || [];
                    errorMsg = `âŒ ERROR: Los nÃºmeros de control [${studentControls.join(', ')}] no existen o estÃ¡n dados de baja.\n\n` +
                               'POSIBLES CAUSAS:\n' +
                               '1. El/los estudiantes no estÃ¡n registrados en la base de datos\n' +
                               '2. Los estudiantes estÃ¡n marcados como dados de baja (deleted_at no NULL)\n' +
                               '3. Los nÃºmeros de control no coinciden con ningÃºn registro activo\n\n' +
                               'DETALLES:\n' +
                               `â€¢ NÃºmeros de control enviados: [${studentControls.join(', ')}]\n\n` +
                               'SOLUCIÃ“N:\n' +
                               'â€¢ Verifique que los nÃºmeros de control sean correctos\n' +
                               'â€¢ El administrador debe verificar si los estudiantes existen en la base de datos\n' +
                               'â€¢ Intente con otros estudiantes mientras se soluciona';
                  } else if (data.errors && typeof data.errors === 'object') {
                    const errorList = Object.entries(data.errors)
                      .map(([field, messages]) => `${field}: ${Array.isArray(messages) ? messages.join(', ') : messages}`)
                      .join(' | ');
                    errorMsg = `${errorMsg} - ${errorList}`;
                    
                    // Si es error de applicantTags, agregar mÃ¡s detalles
                    if (errorList.includes('applicantTags') || errorList.includes('applicantTag')) {
                      console.error('ðŸ’¡ HINT: Los valores enviados fueron:', payload.applicantTags);
                      console.error('ðŸ’¡ Pregunta al backend quÃ© valores son permitidos para applicantTags');
                      console.error('ðŸ’¡ SEGÃšN DOCUMENTACIÃ“N: Los valores deben ser ["applicant", "no_student_details"]');
                      console.error('ðŸ’¡ Verifica tambiÃ©n si el backend espera "applicant_tags" (snake_case) en lugar de "applicantTags" (camelCase)');
                      errorMsg += '\n\nðŸ’¡ Valores enviados: [' + (payload.applicantTags || []).join(', ') + ']';
                      errorMsg += '\nðŸ’¡ Valores permitidos segÃºn docs: ["applicant", "no_student_details"]';
                      errorMsg += '\nContacta al desarrollador del backend para conocer los valores permitidos.';
                    }
                  }
                  console.error('Backend validation errors:', data.errors);
                  return Promise.reject(new Error(errorMsg));
                }
                
                // âœ… Ã‰XITO en POST - Ahora guardar relaciones si existen
                const conceptId = data.data?.concept?.id || data.data?.id;
                console.log('âœ… Concepto creado exitosamente ID:', conceptId);

                const disableConceptIfNeeded = async (resultPayload) => {
                  if (!shouldDisableAfterCreate || !conceptId) {
                    return resultPayload;
                  }

                  try {
                    const disableRes = await fetch(`${self.apiBaseUrl}/v1/concepts/${conceptId}/disable`, {
                      method: 'POST',
                      headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'X-User-Role': 'financial-staff',
                        'X-User-Permission': 'update.concepts'
                      }
                    });

                    const disableData = await disableRes.json().catch(() => ({}));
                    if (!disableRes.ok) {
                      console.warn('âš ï¸ Concepto creado, pero no se pudo desactivar automÃ¡ticamente:', disableData?.message || disableRes.statusText);
                      return {
                        ...resultPayload,
                        statusUpdateWarning: disableData?.message || 'No se pudo cambiar a inactivo automÃ¡ticamente.'
                      };
                    }

                    console.log('âœ… Concepto desactivado automÃ¡ticamente tras creaciÃ³n');
                    return resultPayload;
                  } catch (disableErr) {
                    console.warn('âš ï¸ Concepto creado, pero fallÃ³ la desactivaciÃ³n automÃ¡tica:', disableErr);
                    return {
                      ...resultPayload,
                      statusUpdateWarning: 'No se pudo cambiar a inactivo automÃ¡ticamente.'
                    };
                  }
                };
                
                // Verificar si hay relaciones que guardar (PATCH update-relations)
                const needsRelationsUpdate = 
                  !self.formData.allStudents || 
                  self.formData.selectedCareers.length > 0 || 
                  self.formData.selectedSemesters.length > 0 || 
                  self.formData.selectedSpecificStudents.length > 0 || 
                  self.formData.exceptionStudents.length > 0 || 
                  self.formData.applicantTags.length > 0;
                
                if (needsRelationsUpdate && conceptId) {
                  console.log('ðŸ”— Guardando relaciones del concepto...');
                  
                  // Construir payload para PATCH update-relations
                  const relationsPayload = {
                    applies_to: payload.applies_to || 'todos',
                    replaceRelations: true,
                    replaceExceptions: self.formData.replaceExceptions,
                    removeAllExceptions: self.formData.removeAllExceptions
                  };
                  
                  // Agregar campos segÃºn el tipo de scope
                  if (self.formData.selectedCareers.length > 0) {
                    relationsPayload.careers = self.formData.selectedCareers.map(c => parseInt(c));
                  }
                  if (self.formData.selectedSemesters.length > 0) {
                    relationsPayload.semestres = self.formData.selectedSemesters.map(s => parseInt(s));
                  }
                  if (self.formData.selectedSpecificStudents.length > 0) {
                    relationsPayload.students = self.formData.selectedSpecificStudents.map(s => String(s.control || s.id));
                  }
                  if (self.formData.exceptionStudents.length > 0) {
                    relationsPayload.exceptionStudents = self.formData.exceptionStudents.map(e => String(e.id || e));
                  }
                  if (self.formData.applicantTags.length > 0) {
                    relationsPayload.applicantTags = self.formData.applicantTags;
                  }
                  
                  console.log('ðŸ”— Payload para PATCH update-relations:', relationsPayload);
                  
                  return fetch(`${self.apiBaseUrl}/v1/concepts/update-relations/${conceptId}`, {
                    method: 'PATCH',
                    headers: {
                      'Accept': 'application/json',
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${token}`,
                      'X-User-Role': 'financial-staff',
                      'X-User-Permission': 'update.concepts'
                    },
                    body: JSON.stringify(relationsPayload)
                  })
                  .then(async patchRes => {
                    const patchData = await patchRes.json().catch(() => ({}));
                    console.log('ðŸ“¥ PATCH Response status:', patchRes.status);
                    if (!patchRes.ok) {
                      let patchError = patchData.message || 'Error al guardar relaciones';
                      if (patchData.errors) {
                        const errorList = Object.entries(patchData.errors)
                          .map(([field, messages]) => `${field}: ${Array.isArray(messages) ? messages.join(', ') : messages}`)
                          .join(' | ');
                        patchError = `${patchError} - ${errorList}`;
                      }
                      console.error('âš ï¸ Error en PATCH, pero concepto ya fue creado:', patchError);
                      // No rechazar porque el concepto ya existe, solo avisar
                      return disableConceptIfNeeded({ ...data, relationsUpdate: { error: patchError } });
                    }
                    console.log('âœ… Relaciones guardadas correctamente');
                    return disableConceptIfNeeded(patchData);
                  });
                }
                
                return disableConceptIfNeeded(data);
              });
            }
            
            // ACTUALIZAR concepto existente: si estÃ¡ vencido, actualizar relaciones directamente
            const buildRelationsData = () => {
              const relationsData = {
                applies_to: payload.applies_to
              };

              if (payload.students) relationsData.students = payload.students;
              if (payload.careers) relationsData.careers = payload.careers;
              if (payload.semestres) relationsData.semestres = payload.semestres;

              if (payload.exceptionStudents && payload.exceptionStudents.length > 0) {
                relationsData.exceptionStudents = payload.exceptionStudents;
              }

              if (payload.applicantTags && payload.applicantTags.length > 0) {
                relationsData.applicantTags = payload.applicantTags;
                relationsData.applicant_tags = payload.applicantTags;
              }

              if (payload.replaceRelations !== undefined) relationsData.replaceRelations = payload.replaceRelations;
              if (payload.removeAllExceptions !== undefined) relationsData.removeAllExceptions = payload.removeAllExceptions;
              if (payload.replaceExceptions !== undefined) relationsData.replaceExceptions = payload.replaceExceptions;

              return relationsData;
            };

            const updateRelations = () => {
              const relationsData = buildRelationsData();
              console.log('ðŸ“¤ Actualizando relaciones:', relationsData);

              const toSet = (arr = []) => new Set((arr || []).map(v => String(v)));
              const setsEqual = (a, b) => {
                if (a.size !== b.size) return false;
                for (const value of a) if (!b.has(value)) return false;
                return true;
              };

              const verifyRelationsPersisted = async () => {
                // VerificaciÃ³n enfocada en relaciones que realmente enviamos
                const verifyUrl = `${self.apiBaseUrl}/v1/concepts/relations/${self.formData.id}?_t=${Date.now()}`;
                const verifyRes = await fetch(verifyUrl, {
                  method: 'GET',
                  cache: 'no-store',
                  headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'X-User-Role': 'financial-staff',
                    'X-User-Permission': 'view.concepts'
                  }
                });

                if (!verifyRes.ok) return true;

                const verifyJson = await verifyRes.json().catch(() => ({}));
                const tempConcept = { scopeRules: {} };
                self.mergeRelationsIntoConcept(tempConcept, verifyJson);

                const expectedSemestres = toSet(relationsData.semestres || []);
                const savedSemestres = toSet(tempConcept.semestres || tempConcept.semesters || tempConcept.scopeRules?.semestres || tempConcept.scopeRules?.semesters || []);

                const expectedCareers = toSet(relationsData.careers || []);
                const savedCareers = toSet(tempConcept.careers || tempConcept.scopeRules?.careers || []);

                const expectedStudents = toSet(relationsData.students || []);
                const savedStudents = toSet(tempConcept.students || tempConcept.scopeRules?.specificStudents || []);

                const semestersOk = expectedSemestres.size === 0 || setsEqual(expectedSemestres, savedSemestres);
                const careersOk = expectedCareers.size === 0 || setsEqual(expectedCareers, savedCareers);
                const studentsOk = expectedStudents.size === 0 || setsEqual(expectedStudents, savedStudents);

                return semestersOk && careersOk && studentsOk;
              };

              const sendPatch = (body) => fetch(`${self.apiBaseUrl}/v1/concepts/update-relations/${self.formData.id}`, {
                method: 'PATCH',
                cache: 'no-store',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`,
                  'X-User-Role': 'financial-staff',
                  'X-User-Permission': 'update.concepts'
                },
                body: JSON.stringify(body)
              });

              return sendPatch(relationsData)
              .then(async res => {
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                  let errorMsg = data.message || res.statusText || 'Error al actualizar relaciones';
                  if (data.errors && typeof data.errors === 'object') {
                    const errorList = Object.entries(data.errors)
                      .map(([field, messages]) => `${field}: ${Array.isArray(messages) ? messages.join(', ') : messages}`)
                      .join(' | ');
                    errorMsg = `${errorMsg} - ${errorList}`;
                  }
                  console.error('Backend validation errors:', data.errors);
                  return Promise.reject(new Error(errorMsg));
                }

                const persisted = await verifyRelationsPersisted().catch(() => true);
                if (!persisted && relationsData.replaceRelations === false) {
                  console.warn('âš ï¸ Relaciones no reflejadas tras PATCH. Reintentando con replaceRelations=true...');
                  const forcedBody = { ...relationsData, replaceRelations: true };
                  const retryRes = await sendPatch(forcedBody);
                  const retryData = await retryRes.json().catch(() => ({}));
                  if (!retryRes.ok) {
                    let retryError = retryData.message || retryRes.statusText || 'Error al reintentar actualizaciÃ³n de relaciones';
                    if (retryData.errors && typeof retryData.errors === 'object') {
                      const errorList = Object.entries(retryData.errors)
                        .map(([field, messages]) => `${field}: ${Array.isArray(messages) ? messages.join(', ') : messages}`)
                        .join(' | ');
                      retryError = `${retryError} - ${errorList}`;
                    }
                    return Promise.reject(new Error(retryError));
                  }
                  console.log('âœ… Relaciones actualizadas tras reintento con replaceRelations=true');
                  return retryData;
                }

                console.log('âœ… Relaciones actualizadas');
                return data;
              });
            };

            const conceptIsExpired = payload.end_date < todayISO;
            if (conceptIsExpired) {
              console.warn('âš ï¸ Concepto vencido: se omite PUT de datos bÃ¡sicos y se actualizan solo relaciones.');
              return updateRelations();
            }

            // Si no estÃ¡ vencido, mantener flujo completo: PUT (bÃ¡sicos) + PATCH (relaciones)
            const basicData = {
              concept_name: payload.concept_name,
              description: payload.description,
              status: payload.status,
              amount: payload.amount,
              start_date: payload.start_date,
              end_date: payload.end_date
            };

            console.log('ðŸ“¤ Actualizando datos bÃ¡sicos:', basicData);

            return fetch(`${self.apiBaseUrl}/v1/concepts/${self.formData.id}`, {
              method: 'PUT',
              cache: 'no-store',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'X-User-Role': 'financial-staff',
                'X-User-Permission': 'update.concepts'
              },
              body: JSON.stringify(basicData)
            })
            .then(async res => {
              const data = await res.json().catch(() => ({}));
              if (!res.ok) {
                let errorMsg = data.message || res.statusText || 'Error al actualizar datos bÃ¡sicos';
                if (data.errors && typeof data.errors === 'object') {
                  const errorList = Object.entries(data.errors)
                    .map(([field, messages]) => `${field}: ${Array.isArray(messages) ? messages.join(', ') : messages}`)
                    .join(' | ');
                  errorMsg = `${errorMsg} - ${errorList}`;
                }
                console.error('Backend validation errors:', data.errors);
                return Promise.reject(new Error(errorMsg));
              }
              console.log('âœ… Datos bÃ¡sicos actualizados');
              return data;
            })
            .then(() => updateRelations());
          }
        };
        executeSubmit()
          .then(result => {
            console.log('âœ… Resultado:', result);
            localStorage.removeItem('editingConcept');
            self.errorMessage = 'âœ“ Concepto guardado exitosamente. Redirigiendo...';
            setTimeout(() => { window.location.href = '/concepts'; }, 1200);
          })
          .catch(err => {
            console.error('âŒ Error completo:', err);
            self.errorMessage = `âŒ ${err.message || 'Error desconocido'}`;
            self.isSaving = false;
          })
          .finally(() => {
            self.isSaving = false;
          });
      },

      cancel() {
        localStorage.removeItem('editingConcept');
        window.location.href = '/concepts';
      }
    };
  </script>
  <style>
    /* Estilos de Alpine.js: MANTENER */
    [x-cloak] { display: none !important; }
    
    /* Variables y estilos personalizados: COLOR FINAL #2E594D */
    :root {
      --primary-solid: #2E594D; /* El color solicitado (Oscuro Menta/Verde) */
      --primary-hover: #3c7362; /* Ligeramente mÃ¡s claro para hover */
      --primary-lightest: #f0f4f3; /* Fondo muy claro para selecciones */
      --primary-text: #2E594D; /* Texto e iconos activos */
    }
    
    body {
      background-color: #f3f4f6; 
    }
    
    /* Estilos para el botÃ³n principal (Ahora sÃ³lido) */
    .btn-primary-gradient {
      background-color: var(--primary-solid); /* Color sÃ³lido */
      border: none;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px -2px rgba(46, 89, 77, 0.4); 
    }
    .btn-primary-gradient:hover {
      background-color: var(--primary-hover); /* Ligeramente mÃ¡s claro en hover */
      box-shadow: 0 4px 12px -2px rgba(46, 89, 77, 0.6);
      transform: translateY(-0.5px);
    }

    /* Estilos para inputs focuseados */
    .input-focus-style:focus {
      border-color: var(--primary-solid); 
      box-shadow: 0 0 0 3px rgba(46, 89, 77, 0.2); 
    }

    /* Clases para reemplazar colores de Tailwind en estados checked/active */
    .check-active {
        border-color: var(--primary-solid);
        background-color: var(--primary-lightest);
        box-shadow: 0 0 0 2px rgba(46, 89, 77, 0.3);
    }
    .text-active {
        color: var(--primary-text);
    }
    .bg-active {
        background-color: var(--primary-solid);
        color: white;
    }
    .bg-lightest {
        background-color: var(--primary-lightest);
    }
  </style>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <div class="p-4 sm:p-6 min-h-screen font-sans"> 
    <div
      x-data="window.conceptFormData"
      x-init="$nextTick(() => {
        const self = $data;
        (async () => {
          console.log('ðŸš€ Inicializando formulario de conceptos...');
          self.apiBaseUrl = window.__API_BASE_URL__ || '';
          const token = localStorage.getItem('access_token');
          
          // Cargar careers y students primero
          if (token) {
            await self.loadCareers();
            await self.loadStudents();
            // Log informativo sobre estudiantes si hay
            if (self.allStudents && self.allStudents.length > 0) {
              console.log(`âœ… ${self.allStudents.length} estudiantes disponibles en cache`);
            }
          } else {
            self.careers = self.CAREERS.map(c => ({ id: c.code, name: c.name }));
          }
          
          // Verificar si estamos editando
          const urlParams = new URLSearchParams(window.location.search);
          const editId = urlParams.get('edit');
          const rawConcept = localStorage.getItem('editingConcept');
          let conceptFromStorage = null;

          if (rawConcept) {
            try {
              conceptFromStorage = JSON.parse(rawConcept);
            } catch {
              conceptFromStorage = null;
            }
          }

          const fallbackEditId = conceptFromStorage?.id ? String(conceptFromStorage.id) : null;
          const effectiveEditId = editId || fallbackEditId;
          
          console.log('ðŸ” Modo:', effectiveEditId ? `EdiciÃ³n (ID: ${effectiveEditId})` : 'CreaciÃ³n');
          console.log('ðŸ“¦ localStorage editingConcept:', rawConcept ? 'Existe' : 'No existe');
          
          if (rawConcept && effectiveEditId) {
            try {
              const concept = conceptFromStorage || JSON.parse(rawConcept);
              concept.id = concept.id || effectiveEditId;
              console.log('ðŸ“‹ Concepto parseado:', concept);
              console.log('ðŸŽ¯ formData antes:', JSON.parse(JSON.stringify(self.formData)));
              
              // ðŸ”— CARGAR DATOS COMPLETOS DEL CONCEPTO DESDE LA API
              if (concept.id) {
                try {
                  const token = localStorage.getItem('access_token');
                  console.log('ðŸ”„ Cargando datos completos del concepto ID:', concept.id);
                  
                  // Nuevo: Usar GET /concepts/{id} para cargar los datos completos
                  const response = await fetch(`${window.__API_BASE_URL__}/v1/concepts/${concept.id}?_t=${Date.now()}`, {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json',
                      'X-User-Role': 'financial-staff',
                      'X-User-Permission': 'view.concepts'
                    }
                  });
                  
                  if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… Datos del concepto obtenidos desde GET /concepts/{id}:', data);
                    
                    // Merge los datos del concepto
                    if (data.data?.concept) {
                      const fullConcept = data.data.concept;
                      // Actualizar el concepto con todos los campos disponibles
                      Object.keys(fullConcept).forEach(key => {
                        // Mapear snake_case a camelCase si es necesario
                        if (key === 'concept_name') concept.conceptName = fullConcept[key];
                        if (key === 'start_date') concept.startDate = fullConcept[key];
                        if (key === 'end_date') concept.endDate = fullConcept[key];
                        if (key === 'created_at') concept.createdAt = fullConcept[key];
                        if (key === 'updated_at') concept.updatedAt = fullConcept[key];
                        concept[key] = fullConcept[key];
                      });
                    }

                    // Cargar relaciones (carreras/semestres/estudiantes/tags) desde endpoint dedicado
                    try {
                      const relationsResponse = await fetch(`${window.__API_BASE_URL__}/v1/concepts/relations/${concept.id}?_t=${Date.now()}`, {
                        method: 'GET',
                        cache: 'no-store',
                        headers: {
                          'Authorization': `Bearer ${token}`,
                          'Content-Type': 'application/json',
                          'Accept': 'application/json',
                          'X-User-Role': 'financial-staff',
                          'X-User-Permission': 'view.concepts'
                        }
                      });

                      if (relationsResponse.ok) {
                        const relationsData = await relationsResponse.json();
                        console.log('âœ… Relaciones obtenidas desde GET /concepts/relations/{id}:', relationsData);
                        self.mergeRelationsIntoConcept(concept, relationsData);
                      } else {
                        console.warn('âš ï¸ GET /concepts/relations/{id} retornÃ³ estado:', relationsResponse.status);
                      }
                    } catch (relationErr) {
                      console.warn('âš ï¸ Error al cargar relaciones del concepto:', relationErr);
                    }
                    
                    console.log('âœ… Concepto actualizado con datos de la API:', concept);
                  } else {
                    console.warn('âš ï¸  GET /concepts/{id} retornÃ³ estado:', response.status);
                  }
                } catch (err) {
                  console.warn('âš ï¸  Error al cargar datos del concepto:', err);
                }
              }
              
              // Esperar un tick mÃ¡s para asegurar reactividad de Alpine
              await $nextTick();
              self.populateForm(concept);
              
              console.log('ðŸŽ¯ formData despuÃ©s:', JSON.parse(JSON.stringify(self.formData)));
            } catch (e) {
              console.error('âŒ Error parseando concepto:', e);
            }
          } else {
            localStorage.removeItem('editingConcept');
            console.log('ðŸ†• Modo creaciÃ³n - localStorage limpiado');
          }
        })();
      })"
      class="space-y-5 max-w-4xl mx-auto px-2 sm:px-0 overflow-x-hidden"
    >
      
      <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between pb-5 gap-4 border-b-2 border-[#2E594D]/20">
        <div class="flex items-center gap-3 sm:gap-4 min-w-0">
          <div class="p-4 bg-gradient-to-br from-[#2E594D] to-[#1e3d35] rounded-2xl shadow-xl border-2 border-[#2E594D]/30">
            <i class="fas fa-file-invoice-dollar text-3xl text-white"></i>
          </div>
          <div class="min-w-0">
            <h1 class="text-2xl sm:text-3xl font-extrabold text-[#2E594D] tracking-tight flex flex-wrap items-center gap-2 leading-tight">
              <span x-text="formData.id ? 'Editar' : 'Nuevo'"></span> Concepto
              <span class="inline-block px-2 sm:px-3 py-1 text-[10px] sm:text-xs bg-[#2E594D]/10 text-[#2E594D] rounded-full font-semibold border border-[#2E594D]/20 whitespace-nowrap">
                <i class="fas fa-money-bill-wave mr-1"></i>Sistema de Cobros
              </span>
            </h1>
            <p class="text-gray-600 text-xs sm:text-sm mt-1 break-words">AdministraciÃ³n de cargos escolares obligatorios u opcionales</p>
          </div>
        </div>
        
        <div class="w-full mt-2 sm:mt-0 grid grid-cols-2 rounded-xl border-2 border-gray-300 overflow-hidden shadow-md bg-white">
          <button type="button" @click="cancel" class="min-w-0 h-10 sm:h-11 px-2 sm:px-3 text-gray-700 bg-white hover:bg-gray-50 font-semibold text-[11px] sm:text-xs transition-all flex items-center justify-center gap-1 border-r border-gray-200">
            <i class="fas fa-times text-[10px] sm:text-xs"></i>
            <span>Cancelar</span>
          </button>
          <button type="submit" @click="submitForm" class="min-w-0 h-10 sm:h-11 px-2 sm:px-3 bg-gradient-to-r from-[#2E594D] to-[#1e3d35] text-white font-bold btn-primary-gradient text-[11px] sm:text-xs flex items-center justify-center gap-1 hover:brightness-105 transition-all">
            <i class="fas fa-save text-[10px] sm:text-xs"></i>
            <span x-text="formData.id ? 'Actualizar Concepto' : 'Guardar Concepto'"></span>
          </button>
        </div>
      </header>

      <div x-cloak x-show="errorMessage"
        :class="errorMessage.includes('âœ“') ? 'bg-emerald-50 text-emerald-800 border-emerald-300' : 'bg-red-50 text-red-800 border-red-300'"
        class="p-4 rounded-xl font-medium text-sm flex items-start border shadow-md"
      >
        <i :class="errorMessage.includes('âœ“') ? 'fas fa-check-circle text-emerald-500' : 'fas fa-exclamation-triangle text-red-500'" class="text-xl mr-3 mt-0.5 flex-shrink-0"></i>
        <span x-text="errorMessage" class="flex-1 whitespace-pre-wrap"></span>
      </div>

      <div x-cloak x-show="formData.id"
        class="p-4 rounded-xl border-2 border-amber-300 bg-amber-50 text-amber-900 shadow-md"
      >
        <div class="flex items-start gap-3">
          <i class="fas fa-bullseye text-amber-700 text-xl mt-0.5"></i>
          <div class="flex-1 min-w-0">
            <p class="font-extrabold text-sm mb-1">Este concepto actualmente aplica a:</p>
            <p class="text-sm font-bold break-words" x-text="getScopeLabel()"></p>
            <p class="text-xs mt-1 break-words" x-text="getScopeSummary()"></p>
            <p class="text-xs mt-1 text-amber-800" x-text="getExceptionsSummary()"></p>
          </div>
        </div>
      </div>

      <!-- Alerta cuando no hay estudiantes cargados -->
      <div x-cloak x-show="allStudents.length === 0 && formData.scopeType === 'estudiantes'"
        class="p-4 rounded-xl font-medium text-sm flex items-start border border-blue-300 bg-blue-50 text-blue-900 shadow-md mb-6"
      >
        <i class="fas fa-info-circle text-blue-600 text-xl mr-3 mt-0.5"></i>
        <div class="flex-1">
          <p class="font-bold mb-2">ðŸ’¡ BÃºsqueda por API disponible</p>
          <p class="text-sm mb-2">Escribe un prefijo de nÃºmero de control (ej: "2023") para buscar en la base de datos, o escribe el nÃºmero completo y presiona Enter para agregarlo manualmente.</p>
        </div>
      </div>

      <form @submit.prevent="submitForm" class="space-y-6">

        <section class="bg-gradient-to-br from-white via-[#2E594D]/5 to-white p-4 sm:p-6 rounded-2xl shadow-2xl border-2 border-[#2E594D]/20 space-y-5 overflow-x-hidden">
          <div class="flex items-center gap-3 pb-3 border-b-2 border-[#2E594D]/10">
            <span class="flex items-center justify-center w-10 h-10 rounded-xl bg-gradient-to-br from-[#2E594D] to-[#1e3d35] text-white font-extrabold text-sm shadow-lg">
                <i class="fas fa-edit"></i> 
            </span>
            <h2 class="text-xl font-extrabold text-[#2E594D]">Datos del Cargo</h2>
          </div>
          
          <div class="space-y-5">
            
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-5"> 
              
              <div class="sm:col-span-2 min-w-0"> 
                <label for="title" class="block text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                  <i class="fas fa-tag text-[#2E594D]"></i>
                  TÃ­tulo del Concepto
                </label>
                <input type="text" id="title" x-model="formData.title" placeholder="Ej. InscripciÃ³n Semestre Feb-Jul"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl input-focus-style transition duration-200 text-sm font-medium shadow-sm hover:border-[#2E594D]/40" required>
              </div>
              
              <div class="sm:col-span-1 min-w-0">
                <label for="amount" class="block text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                  <i class="fas fa-dollar-sign text-emerald-600"></i>
                  Monto
                </label>
                <div class="relative">
                  <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-bold text-base">$</span>
                  <input type="number" id="amount" x-model.number="formData.amount" min="0.01" step="0.01" placeholder="0.00"
                    class="w-full px-4 py-3 pl-9 border-2 border-gray-300 rounded-xl input-focus-style transition duration-200 text-sm font-bold shadow-sm hover:border-emerald-400" required>
                </div>
              </div>
            </div>

            <div>
              <label for="description" class="block text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                <i class="fas fa-align-left text-[#2E594D]"></i>
                DescripciÃ³n (Opcional)
              </label>
              <textarea id="description" x-model="formData.description" rows="3" placeholder="Notas relevantes sobre el destino o las condiciones del pago..."
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl input-focus-style transition duration-200 text-sm shadow-sm hover:border-[#2E594D]/40"></textarea>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-5 bg-gray-50 p-3 sm:p-4 rounded-xl border-2 border-dashed border-[#2E594D]/20 overflow-hidden">
              <div class="min-w-0">
                <label for="startDate" class="block text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                  <i class="fas fa-calendar-check text-blue-600"></i>
                  Fecha de Inicio <span class="text-red-600">*</span>
                </label>
                <input type="date" id="startDate" x-model="formData.startDate"
                  class="w-full max-w-full min-w-0 box-border px-4 py-3 border-2 border-gray-300 rounded-xl input-focus-style transition duration-200 text-sm font-medium shadow-sm hover:border-blue-400" required>
              </div>
              
              <div class="min-w-0">
                <label for="endDate" class="block text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                  <i class="fas fa-calendar-times text-red-600"></i>
                  Fecha de Fin <span class="text-red-600">*</span>
                </label>
                <input type="date" id="endDate" x-model="formData.endDate"
                  :min="(() => { const n = new Date(); const today = n.getFullYear() + '-' + String(n.getMonth() + 1).padStart(2, '0') + '-' + String(n.getDate()).padStart(2, '0'); return (formData.startDate && formData.startDate > today) ? formData.startDate : today; })()"
                  class="w-full max-w-full min-w-0 box-border px-4 py-3 border-2 border-gray-300 rounded-xl input-focus-style transition duration-200 text-sm font-medium shadow-sm hover:border-red-400" required>
              </div>
            </div>
            
          </div>
        </section>


        <section class="bg-gradient-to-br from-white via-blue-50/30 to-white p-3 sm:p-5 rounded-2xl shadow-2xl border-2 border-blue-200/50 space-y-4 overflow-x-hidden">
          <div class="flex items-center gap-2.5 pb-2 border-b-2 border-blue-200/50">
            <span class="flex items-center justify-center w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 to-blue-700 text-white font-extrabold text-xs shadow-lg">
                <i class="fas fa-filter"></i>
            </span>
            <h2 class="text-lg sm:text-xl font-extrabold text-blue-900">Reglas de AplicaciÃ³n (Alcance)</h2>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
            <div @click="formData.allStudents = true; formData.selectedCareers = []; formData.selectedSemesters = []; formData.selectedSpecificStudents = [];"
              :class="formData.allStudents ? 'check-active ring-4 ring-[#2E594D]/20' : 'border-gray-300 hover:border-gray-400'"
              class="border-2 rounded-xl p-3 sm:p-4 cursor-pointer transition-all flex items-center gap-2.5 sm:gap-3 shadow-md hover:shadow-lg sm:hover:scale-105 min-w-0">
              <div :class="formData.allStudents ? 'bg-active' : 'bg-gray-200 text-gray-500'" class="p-3 rounded-lg transition">
                <i class="fas fa-users-cog text-lg sm:text-xl"></i>
              </div>
              <div>
                <p class="font-extrabold text-gray-950 text-sm sm:text-base leading-tight">MatrÃ­cula Completa</p>
                <p class="text-[11px] sm:text-xs text-gray-600 mt-0.5">Aplica a todos los estudiantes</p>
              </div>
            </div>
            
            <div @click="formData.allStudents = false; formData.scopeType = 'carrera'"
              :class="!formData.allStudents ? 'check-active ring-4 ring-[#2E594D]/20' : 'border-gray-300 hover:border-gray-400'"
              class="border-2 rounded-xl p-3 sm:p-4 cursor-pointer transition-all flex items-center gap-2.5 sm:gap-3 shadow-md hover:shadow-lg sm:hover:scale-105 min-w-0">
              <div :class="!formData.allStudents ? 'bg-active' : 'bg-gray-200 text-gray-500'" class="p-3 rounded-lg transition">
                <i class="fas fa-filter text-lg sm:text-xl"></i>
              </div>
              <div>
                <p class="font-extrabold text-gray-950 text-sm sm:text-base leading-tight">Alcance Restringido</p>
                <p class="text-[11px] sm:text-xs text-gray-600 mt-0.5">Filtrar por un Ã¡mbito especÃ­fico</p>
              </div>
            </div>
          </div>

          <div x-show="!formData.allStudents" x-cloak x-transition.opacity.duration.300ms class="space-y-3 pt-3">
            
            <!-- Selector de tipo de Ã¡mbito -->
            <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-3">
              <label class="block text-xs sm:text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                <i class="fas fa-bullseye text-amber-600"></i>
                Selecciona el tipo de Ã¡mbito (solo uno):
              </label>
              <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-2">
                <label class="cursor-pointer">
                  <input type="radio" value="carrera" x-model="formData.scopeType" @change="formData.selectedSemesters = []; formData.selectedSpecificStudents = []" class="sr-only peer">
                  <div class="p-2 sm:p-2.5 rounded-lg border-2 border-gray-300 text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:ring-2 peer-checked:ring-blue-200 hover:shadow-md">
                    <i class="fas fa-graduation-cap text-sm sm:text-base text-blue-600 mb-0.5"></i>
                    <p class="text-[11px] sm:text-xs font-bold leading-tight">Por Carrera</p>
                  </div>
                </label>
                <label class="cursor-pointer">
                  <input type="radio" value="semestre" x-model="formData.scopeType" @change="formData.selectedCareers = []; formData.selectedSpecificStudents = []" class="sr-only peer">
                  <div class="p-2 sm:p-2.5 rounded-lg border-2 border-gray-300 text-center transition-all peer-checked:border-purple-500 peer-checked:bg-purple-50 peer-checked:ring-2 peer-checked:ring-purple-200 hover:shadow-md">
                    <i class="fas fa-calendar-alt text-sm sm:text-base text-purple-600 mb-0.5"></i>
                    <p class="text-[11px] sm:text-xs font-bold leading-tight">Por Semestre</p>
                  </div>
                </label>
                <label class="cursor-pointer">
                  <input type="radio" value="carrera_semestre" x-model="formData.scopeType" @change="formData.selectedSpecificStudents = []" class="sr-only peer">
                  <div class="p-2 sm:p-2.5 rounded-lg border-2 border-gray-300 text-center transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:ring-2 peer-checked:ring-green-200 hover:shadow-md">
                    <i class="fas fa-layer-group text-sm sm:text-base text-green-600 mb-0.5"></i>
                    <p class="text-[11px] sm:text-xs font-bold leading-tight">Carrera + Semestre</p>
                  </div>
                </label>
                <label class="cursor-pointer">
                  <input type="radio" value="estudiantes" x-model="formData.scopeType" @change="formData.selectedCareers = []; formData.selectedSemesters = []; formData.exceptionStudents = []; formData.removeAllExceptions = false; formData.replaceExceptions = false" class="sr-only peer">
                  <div class="p-2 sm:p-2.5 rounded-lg border-2 border-gray-300 text-center transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 peer-checked:ring-2 peer-checked:ring-orange-200 hover:shadow-md">
                    <i class="fas fa-user-check text-sm sm:text-base text-orange-600 mb-0.5"></i>
                    <p class="text-[11px] sm:text-xs font-bold leading-tight">Estudiantes EspecÃ­ficos</p>
                  </div>
                </label>
                <label class="cursor-pointer">
                  <input type="radio" value="tags" x-model="formData.scopeType" @change="formData.selectedCareers = []; formData.selectedSemesters = []; formData.selectedSpecificStudents = []" class="sr-only peer">
                  <div class="p-2 sm:p-2.5 rounded-lg border-2 border-gray-300 text-center transition-all peer-checked:border-pink-500 peer-checked:bg-pink-50 peer-checked:ring-2 peer-checked:ring-pink-200 hover:shadow-md">
                    <i class="fas fa-star text-sm sm:text-base text-pink-600 mb-0.5"></i>
                    <p class="text-[11px] sm:text-xs font-bold leading-tight">Casos Especiales</p>
                  </div>
                </label>
              </div>
            </div>
            
            <!-- Filtros segÃºn el Ã¡mbito seleccionado -->
            <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
              
              <!-- Solo Carreras -->
              <div x-show="formData.scopeType === 'carrera'" x-cloak>
                <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                  <i class="fas fa-graduation-cap text-blue-600"></i>
                  Selecciona las Carreras:
                </label>
                <div x-show="careers.length === 0" class="text-sm text-red-600 mb-2 p-2 bg-red-50 rounded">
                  âš ï¸ No se cargaron carreras. Revisa la consola del navegador.
                </div>
                <div class="flex flex-wrap gap-2">
                  <template x-for="career in careers" :key="career.id">
                    <label class="cursor-pointer">
                      <input type="checkbox" :value="career.id" x-model="formData.selectedCareers" class="sr-only peer">
                      <div
                        class="px-3 py-1.5 rounded-full border-2 border-gray-300 text-left inline-flex items-center justify-center min-h-[30px] text-[11px] sm:text-xs leading-tight transition-all peer-checked:border-[var(--primary-solid)] peer-checked:bg-[var(--primary-lightest)] peer-checked:text-[var(--primary-text)] hover:shadow-sm"
                      >
                        <span class="font-semibold whitespace-nowrap" x-text="career.name"></span>
                      </div>
                    </label>
                  </template>
                </div>
              </div>

              <!-- Solo Semestres -->
              <div x-show="formData.scopeType === 'semestre'" x-cloak>
                <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                  <i class="fas fa-calendar-alt text-purple-600"></i>
                  Selecciona los Semestres:
                </label>
                <div class="flex flex-wrap gap-2">
                  <template x-for="sem in semesters" :key="sem.id">
                    <label class="cursor-pointer">
                      <input type="checkbox" :value="sem.id" x-model="formData.selectedSemesters" class="sr-only peer">
                      <div
                        class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-gray-300 text-sm font-bold transition-all peer-checked:border-[var(--primary-solid)] peer-checked:bg-[var(--primary-lightest)] peer-checked:text-[var(--primary-text)] hover:shadow-md"
                      >
                        <span x-text="sem.id + 'Â°'"></span>
                      </div>
                    </label>
                  </template>
                </div>
              </div>

              <!-- Carreras + Semestres -->
              <div x-show="formData.scopeType === 'carrera_semestre'" x-cloak class="space-y-4">
                <div>
                  <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-graduation-cap text-blue-600"></i>
                    Selecciona las Carreras:
                  </label>
                  <div class="flex flex-wrap gap-2">
                    <template x-for="career in careers" :key="career.id">
                      <label class="cursor-pointer">
                        <input type="checkbox" :value="career.id" x-model="formData.selectedCareers" class="sr-only peer">
                        <div
                          class="px-3 py-1.5 rounded-full border-2 border-gray-300 text-left inline-flex items-center justify-center min-h-[30px] text-[11px] sm:text-xs leading-tight transition-all peer-checked:border-[var(--primary-solid)] peer-checked:bg-[var(--primary-lightest)] peer-checked:text-[var(--primary-text)] hover:shadow-sm"
                        >
                          <span class="font-semibold whitespace-nowrap" x-text="career.name"></span>
                        </div>
                      </label>
                    </template>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-calendar-alt text-purple-600"></i>
                    Selecciona los Semestres:
                  </label>
                  <div class="flex flex-wrap gap-2">
                    <template x-for="sem in semesters" :key="sem.id">
                      <label class="cursor-pointer">
                        <input type="checkbox" :value="sem.id" x-model="formData.selectedSemesters" class="sr-only peer">
                        <div
                          class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-gray-300 text-sm font-bold transition-all peer-checked:border-[var(--primary-solid)] peer-checked:bg-[var(--primary-lightest)] peer-checked:text-[var(--primary-text)] hover:shadow-md"
                        >
                          <span x-text="sem.id + 'Â°'"></span>
                        </div>
                      </label>
                    </template>
                  </div>
                </div>
              </div>

              <!-- Casos Especiales -->
              <div x-show="formData.scopeType === 'tags'" x-cloak>
                <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                  <i class="fas fa-star text-pink-600"></i>
                  Selecciona los Casos Especiales:
                </label>
                <p class="text-xs text-gray-600 mb-2">Estos conceptos aplicarÃ¡n a usuarios con caracterÃ­sticas especiales.</p>
                <div class="flex flex-wrap gap-2">
                  <label class="cursor-pointer flex-1 min-w-[220px]">
                    <input type="checkbox" value="applicant" x-model="formData.applicantTags" class="sr-only peer">
                    <div class="h-full px-3 py-2 rounded-lg border-2 border-gray-300 transition-all peer-checked:border-pink-500 peer-checked:bg-pink-50 peer-checked:ring-2 peer-checked:ring-pink-200 hover:shadow-sm flex items-start gap-2">
                      <i class="fas fa-user-graduate text-sm text-pink-600 mt-0.5"></i>
                      <div class="min-w-0">
                        <p class="text-xs font-bold leading-tight">Aplicantes/Aspirantes</p>
                        <p class="text-[11px] text-gray-500 mt-0.5 leading-tight">Personas en proceso de admisiÃ³n</p>
                      </div>
                    </div>
                  </label>
                  <label class="cursor-pointer flex-1 min-w-[220px]">
                    <input type="checkbox" value="no_student_details" x-model="formData.applicantTags" class="sr-only peer">
                    <div class="h-full px-3 py-2 rounded-lg border-2 border-gray-300 transition-all peer-checked:border-pink-500 peer-checked:bg-pink-50 peer-checked:ring-2 peer-checked:ring-pink-200 hover:shadow-sm flex items-start gap-2">
                      <i class="fas fa-user-slash text-sm text-pink-600 mt-0.5"></i>
                      <div class="min-w-0">
                        <p class="text-xs font-bold leading-tight">Sin Detalles de Estudiante</p>
                        <p class="text-[11px] text-gray-500 mt-0.5 leading-tight">Usuarios sin informaciÃ³n completa</p>
                      </div>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Solo Estudiantes EspecÃ­ficos -->
              <div x-show="formData.scopeType === 'estudiantes'" x-cloak>
                <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-3 mb-3">
                  <div class="flex items-start gap-3">
                    <i class="fas fa-info-circle text-blue-600 text-xl flex-shrink-0 mt-0.5"></i>
                    <div class="flex-1">
                      <p class="text-sm font-bold text-blue-900 mb-1">â„¹ï¸ CÃ³mo buscar estudiantes</p>
                      <ul class="text-xs text-blue-800 space-y-1">
                        <li>â€¢ Escribe <strong>mÃ­nimo 3 caracteres</strong> del nÃºmero de control (busca por prefijo, ej: "202")</li>
                        <li>â€¢ <strong>Selecciona del dropdown</strong> que aparece o presiona <strong>Enter</strong> para buscar</li>
                        <li>â€¢ Solo se pueden agregar estudiantes que <strong>existan como usuarios activos</strong> en el sistema</li>
                      </ul>
                    </div>
                  </div>
                </div>
                
                <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                  <i class="fas fa-user-check text-orange-600"></i>
                  Buscar y Agregar Estudiantes:
                </label>
                
                <div class="relative flex-1">
                  <div class="flex gap-2">
                    <div class="flex-1 relative">
                      <input 
                        type="text" 
                        x-model="searchTerm"
                        @input="searchStudentsRealTime()"
                        @keydown.enter.prevent="addStudentByControl(); searchTerm = ''"
                        placeholder="Ej: 2023, 2024 (busca por prefijo) - presiona Enter para agregar"
                        class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition duration-200 text-sm">
                      
                      <!-- Indicador de carga -->
                      <span x-show="isSearching" class="absolute right-3 top-2.5 text-orange-500">
                        <i class="fas fa-spinner fa-spin"></i>
                      </span>
                    </div>
                    
                    <button 
                      type="button" 
                      @click="addStudentByControl(); searchTerm = ''"
                      class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-semibold text-sm transition-all flex items-center gap-2">
                      <i class="fas fa-plus"></i>
                      Agregar
                    </button>
                  </div>
                  
                  <!-- Mensaje de ayuda cuando hay menos de 3 caracteres -->
                  <div x-show="searchTerm.length > 0 && searchTerm.length < 3" x-cloak class="mt-1 text-xs text-gray-500 italic">
                    <i class="fas fa-keyboard"></i> Escribe al menos 3 caracteres para buscar o presiona Enter para agregar
                  </div>
                  
                  <!-- Mensaje cuando no hay resultados pero cumple mÃ­nimo -->
                  <div x-show="!isSearching && searchResults.length === 0 && searchTerm.length >= 3" x-cloak class="mt-1 text-xs text-blue-600 italic">
                    <i class="fas fa-info-circle"></i> No se encontrÃ³. Presiona Enter para agregar "<span x-text="searchTerm"></span>"
                  </div>
                  
                  <!-- Dropdown de resultados -->
                  <div x-show="searchResults.length > 0 && searchTerm.length >= 3" x-cloak @click.outside="searchResults = []" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-xl shadow-lg z-50 max-h-64 overflow-y-auto">
                    <template x-for="student in searchResults" :key="student.id">
                      <button 
                        type="button"
                        @click="selectStudentFromSearch(student); $nextTick(() => searchResults = [])"
                        class="w-full text-left px-4 py-2 hover:bg-orange-50 border-b border-gray-200 transition duration-150 flex justify-between items-start gap-2 last:border-b-0">
                        <div class="flex-1">
                          <div class="font-semibold text-sm text-gray-800" x-text="student.fullName"></div>
                          <div class="text-xs text-gray-600" x-text="'Control: ' + (student.control || 'N/A')"></div>
                          <template x-if="student.email">
                            <div class="text-xs text-gray-500" x-text="student.email"></div>
                          </template>
                        </div>
                      </button>
                    </template>
                  </div>
                </div>
                
                <div x-show="formData.selectedSpecificStudents.length > 0" class="mt-3">
                  <p class="text-xs font-semibold text-gray-700 mb-2">Estudiantes agregados (<span x-text="formData.selectedSpecificStudents.length"></span>):</p>
                  <div class="flex flex-wrap gap-2">
                    <template x-for="(student, index) in formData.selectedSpecificStudents" :key="index">
                      <div class="inline-flex items-start gap-2 px-3 py-2 bg-orange-50 border border-orange-300 text-orange-900 rounded-lg text-xs font-medium">
                        <div class="flex-1">
                          <div class="font-bold" x-text="student.name || student.control"></div>
                          <template x-if="student.email">
                            <div class="text-orange-700" x-text="student.email"></div>
                          </template>
                          <template x-if="student.career">
                            <div class="text-orange-700" x-text="student.career"></div>
                          </template>
                        </div>
                        <button type="button" @click="formData.selectedSpecificStudents.splice(index, 1)" class="hover:text-red-600 ml-1 flex-shrink-0">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Nueva secciÃ³n: Opciones de ActualizaciÃ³n (solo en modo ediciÃ³n) -->
        <section x-show="formData.id && !formData.allStudents" x-cloak x-transition.opacity.duration.300ms class="bg-gradient-to-br from-white via-yellow-50/30 to-white p-4 sm:p-6 rounded-2xl shadow-2xl border-2 border-yellow-200/50 space-y-5 overflow-x-hidden">
          <div class="flex items-center gap-3 pb-3 border-b-2 border-yellow-200/50">
            <span class="flex items-center justify-center w-10 h-10 rounded-xl bg-gradient-to-br from-yellow-500 to-yellow-700 text-white font-extrabold text-sm shadow-lg">
                <i class="fas fa-sync-alt"></i>
            </span>
            <h2 class="text-xl font-extrabold text-yellow-900">Opciones de ActualizaciÃ³n</h2>
          </div>

          <div class="space-y-4">
            <div class="bg-yellow-50/50 p-4 rounded-xl border border-yellow-200">
              <label class="flex items-start gap-3 cursor-pointer group">
                <input type="checkbox" x-model="formData.replaceRelations" class="mt-1 w-5 h-5 text-[#2E594D] border-gray-300 rounded focus:ring-[#2E594D] focus:ring-2">
                <div class="flex-1">
                  <p class="font-bold text-gray-800 text-sm group-hover:text-[#2E594D] transition">Reemplazar Relaciones</p>
                  <p class="text-xs text-gray-600 mt-1">Si estÃ¡ activo: reemplaza las relaciones existentes (carreras/semestres). Si estÃ¡ desactivado: agrega las nuevas sin eliminar las anteriores.</p>
                  <p class="text-xs text-yellow-700 mt-1 font-semibold">
                    <i class="fas fa-info-circle"></i> Ejemplo: Si el concepto aplicaba a semestres 1 y 2, y agregas el 3:
                    <br>â€¢ Con esta opciÃ³n: solo aplicarÃ¡ al semestre 3
                    <br>â€¢ Sin esta opciÃ³n: aplicarÃ¡ a los semestres 1, 2 y 3
                  </p>
                </div>
              </label>
            </div>

            <div x-show="formData.scopeType !== 'estudiantes'" x-cloak class="bg-red-50/50 p-4 rounded-xl border border-red-200">
              <label class="flex items-start gap-3 cursor-pointer group">
                <input type="checkbox" x-model="formData.removeAllExceptions" class="mt-1 w-5 h-5 text-red-600 border-gray-300 rounded focus:ring-red-600 focus:ring-2">
                <div class="flex-1">
                  <p class="font-bold text-gray-800 text-sm group-hover:text-red-600 transition">Eliminar Todas las Excepciones</p>
                  <p class="text-xs text-gray-600 mt-1">Al activar esta opciÃ³n, se eliminarÃ¡n TODAS las excepciones existentes y el concepto aplicarÃ¡ a los estudiantes segÃºn los filtros definidos.</p>
                  <p class="text-xs text-red-700 mt-1 font-semibold">
                    <i class="fas fa-exclamation-triangle"></i> Â¡Advertencia! Esta acciÃ³n eliminarÃ¡ las excepciones previamente configuradas.
                  </p>
                </div>
              </label>
            </div>

            <div x-show="formData.scopeType !== 'estudiantes'" x-cloak class="bg-orange-50/50 p-4 rounded-xl border border-orange-200">
              <label class="flex items-start gap-3 cursor-pointer group">
                <input type="checkbox" x-model="formData.replaceExceptions" class="mt-1 w-5 h-5 text-orange-600 border-gray-300 rounded focus:ring-orange-600 focus:ring-2">
                <div class="flex-1">
                  <p class="font-bold text-gray-800 text-sm group-hover:text-orange-600 transition">Reemplazar Excepciones</p>
                  <p class="text-xs text-gray-600 mt-1">Si estÃ¡ activo: reemplaza las excepciones existentes con las nuevas. Si estÃ¡ desactivado: agrega las nuevas excepciones sin eliminar las anteriores.</p>
                  <p class="text-xs text-orange-700 mt-1 font-semibold">
                    <i class="fas fa-info-circle"></i> Similar a "Reemplazar Relaciones", pero aplicado a las excepciones de estudiantes.
                  </p>
                </div>
              </label>
            </div>
          </div>
        </section>

        <section class="bg-gradient-to-br from-white via-purple-50/30 to-white p-3 sm:p-5 rounded-2xl shadow-2xl border-2 border-purple-200/50 space-y-4 overflow-x-hidden">
          <div class="flex items-center gap-2.5 pb-2 border-b-2 border-purple-200/50">
            <span class="flex items-center justify-center w-9 h-9 rounded-xl bg-gradient-to-br from-purple-500 to-purple-700 text-white font-extrabold text-xs shadow-lg">
                <i class="fas fa-toggle-on"></i>
            </span>
            <h2 class="text-lg sm:text-xl font-extrabold text-purple-900">Estado y AplicaciÃ³n</h2>
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2.5 sm:gap-3">
            <label class="cursor-pointer">
              <input type="radio" name="status" value="active" x-model="formData.status" class="sr-only peer">
              <div class="p-3 sm:p-3.5 rounded-xl border-2 border-gray-300 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 peer-checked:shadow-lg transition-all shadow-sm hover:shadow-md sm:hover:scale-[1.01] flex items-center gap-2.5 min-h-[68px]">
                <i class="fas fa-check-circle text-xl sm:text-2xl transition flex-shrink-0" :class="formData.status === 'active' ? 'text-emerald-600' : 'text-gray-400'"></i>
                <div class="min-w-0">
                  <p class="font-extrabold text-gray-950 text-sm sm:text-base leading-tight">Concepto Activo</p>
                  <p class="text-[11px] sm:text-xs text-gray-600 mt-0.5 leading-tight">Visible para estudiantes</p>
                </div>
              </div>
            </label>
            
            <label class="cursor-pointer">
              <input type="radio" name="status" value="inactive" x-model="formData.status" class="sr-only peer">
              <div class="p-3 sm:p-3.5 rounded-xl border-2 border-gray-300 peer-checked:border-gray-500 peer-checked:bg-gray-100 peer-checked:shadow-lg transition-all shadow-sm hover:shadow-md sm:hover:scale-[1.01] flex items-center gap-2.5 min-h-[68px]">
                <i class="fas fa-pause-circle text-xl sm:text-2xl transition flex-shrink-0" :class="formData.status === 'inactive' ? 'text-gray-600' : 'text-gray-400'"></i>
                <div class="min-w-0">
                  <p class="font-extrabold text-gray-950 text-sm sm:text-base leading-tight">Concepto Inactivo</p>
                  <p class="text-[11px] sm:text-xs text-gray-600 mt-0.5 leading-tight">No visible para estudiantes</p>
                </div>
              </div>
            </label>
          </div>
        </section>

      </form>
    </div>
  </div>

  <script type="module">
    // InicializaciÃ³n y utilidades de almacenamiento local (simulaciÃ³n de base de datos)
    (function () {
      
      window.getStudents = () => JSON.parse(localStorage.getItem('studentsList') || '[]');
      window.saveStudents = (students) => localStorage.setItem('studentsList', JSON.stringify(students));
      window.getConcepts = () => JSON.parse(localStorage.getItem('conceptsList') || '[]');
      window.getCharges = () => JSON.parse(localStorage.getItem('chargesList') || '[]');
      window.saveCharges = (charges) => localStorage.setItem('chargesList', JSON.stringify(charges));

      /**
       * Determina quÃ© estudiantes cumplen con las reglas de alcance del concepto.
       */
      window.getTargetStudentsForConcept = (concept) => {
        const students = window.getStudents();
        const activeStudents = students.filter(s => (s.status || '').toLowerCase() !== 'inactive' && (s.status || '').toLowerCase() !== 'inactivo');
        const rules = concept.scopeRules;

        if (rules.allStudents) return activeStudents;

        // LÃ“GICA CORREGIDA PARA EXCLUSIVIDAD
        // 1. Si hay estudiantes especÃ­ficos, devolver SOLO a esos.
        if (rules.specificStudents.length > 0) {
            return activeStudents.filter(alumno => {
                // *** CORRECCIÃ“N APLICADA AQUÃ ***
            // Se usa la misma lÃ³gica de prioridad que en Alpine (userId ?? id ?? numControl) para coincidir con la lista de IDs seleccionados.
            const alumnoId = String(alumno.userId ?? alumno.id ?? alumno.numControl ?? alumno.n_control ?? ''); 
                return rules.specificStudents.includes(alumnoId);
            });
        }
        
        // 2. Si no hay estudiantes especÃ­ficos, aplicar los filtros de Carrera Y Semestre.
        return activeStudents.filter(alumno => {
            let cumpleCareers = true;
            let cumpleSemesters = true;
            
            const alumnoCareer = String(alumno.career_id ?? alumno.careerId ?? alumno.career ?? alumno.carrera ?? '');
            const alumnoSemester = String(alumno.semester ?? alumno.semestre ?? '');

            if (rules.careers.length > 0) {
                cumpleCareers = rules.careers.includes(alumnoCareer);
            }
            
            if (rules.semesters.length > 0) {
                cumpleSemesters = rules.semesters.includes(alumnoSemester);
            }
            
            // Debe cumplir AMBOS filtros (Carrera Y Semestre)
            return cumpleCareers && cumpleSemesters;
        });
      };

      /**
       * Recalcula el adeudo total pendiente de cada estudiante basado en chargesList.
       */
      window.recalcStudentAdeudosFromCharges = () => {
        const charges = window.getCharges();
        const students = window.getStudents();
        const pendingChargesByStudent = {};
        
        charges.forEach(ch => {
          if ((ch.status || '').toLowerCase() === 'pending' || (ch.status || '').toLowerCase() === 'pendiente') {
            const sid = String(ch.studentId);
            pendingChargesByStudent[sid] = (pendingChargesByStudent[sid] || 0) + Number(ch.amount || 0);
          }
        });

        const updated = students.map(s => {
          s.adeudo = parseFloat((pendingChargesByStudent[String(s.id)] || 0).toFixed(2));
          return s;
        });
        window.saveStudents(updated);
      };

      /**
       * Crea nuevos cargos pendientes para los estudiantes que cumplen con el alcance del concepto.
       */
      window.assignConceptToScope = (concept) => {
        const targets = window.getTargetStudentsForConcept(concept);
        if (!targets || targets.length === 0) return 0;

        const amount = Number(concept.amount) || 0;
        const existingCharges = window.getCharges();
        const nowIso = new Date().toISOString();

        const toAdd = targets.reduce((acc, s) => {
          const exists = existingCharges.some(ec =>
            ec.conceptId === concept.id &&
            String(ec.studentId) === String(s.id) &&
            ((ec.status || '').toLowerCase() === 'pending' || (ec.status || '').toLowerCase() === 'pendiente')
          );

          if (!exists) {
            acc.push({
              id: 'chg_' + (Date.now().toString(36) + Math.random().toString(36).slice(2,6)),
              studentId: s.id,
              conceptId: concept.id,
              amount,
              status: 'pending',
              title: concept.title,
              createdAt: nowIso
            });
          }
          return acc;
        }, []);

        if (toAdd.length === 0) return 0;

        window.saveCharges(existingCharges.concat(toAdd));
        window.recalcStudentAdeudosFromCharges();
        
        return toAdd.length;
      };
      
    })();
    </script>
</Layout>