---
// src/pages/estudiante_lista.astro
import Layout from '../layouts/Layout.astro';

// L√≥gica de carga de datos: Intenta cargar de la API o usa datos de respaldo
let students = [];
try {
  const res = await fetch('/api/students');
  if (res.ok) {
    const json = await res.json();
    students = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
  }
} catch (e) {
  // Ignorar error de API y cargar datos de respaldo si est√°n disponibles
}

// Cargar datos de respaldo si la lista est√° vac√≠a o hubo error
if (!students || !students.length) {
  try {
    // Aseg√∫rese de que '../data/students.js' contenga un array de objetos
    const mod = await import('../data/students.js');
    students = mod.default || mod.students || [];
    // Ejemplo de datos de respaldo: ¬°DATOS AMPLIADOS PARA MEJOR PRUEBA DE FILTROS!
    if (students.length === 0) {
        students = [
            { id: '1', numControl: 'A19014', nombre: 'Fab√≠an', apellidoP: 'Cruz', apellidoM: 'Mendoza', semestre: 5, carrera: 'AGR', correo: 'fabian.cruz@uni.edu', password: 'pass'},
            { id: '2', numControl: 'A19015', nombre: 'Elena', apellidoP: 'G√≥mez', apellidoM: 'Vargas', semestre: 1, carrera: 'INF', correo: 'elena.gomez@uni.edu', password: 'pass'},
            { id: '3', numControl: 'A19013', nombre: 'Carla', apellidoP: 'Flores', apellidoM: 'Herrera', semestre: 3, carrera: 'ADM', correo: 'carla.flores@uni.edu', password: 'pass'},
            { id: '4', numControl: 'A19010', nombre: 'Julio', apellidoP: 'P√©rez', apellidoM: 'L√≥pez', semestre: 6, carrera: 'TEC', correo: 'julio.perez@uni.edu', password: 'pass'},
            { id: '5', numControl: 'A19011', nombre: 'Sof√≠a', apellidoP: 'Ram√≠rez', apellidoM: 'Garc√≠a', semestre: 2, carrera: 'INF', correo: 'sofia.ramirez@uni.edu', password: 'pass'},
            
            // --- DATOS ADICIONALES PARA PROBAR FILTRO DE SEMESTRE 3 ---
            { id: '6', numControl: 'A20001', nombre: 'David', apellidoP: 'Soto', apellidoM: 'Ramos', semestre: 3, carrera: 'ADM', correo: 'david.soto@uni.edu', password: 'pass'}, 
            { id: '7', numControl: 'A20002', nombre: 'Laura', apellidoP: 'Ruiz', apellidoM: 'Mora', semestre: 3, carrera: 'INF', correo: 'laura.ruiz@uni.edu', password: 'pass'}, 
            { id: '8', numControl: 'A20003', nombre: 'Miguel', apellidoP: 'T√©llez', apellidoM: 'Vela', semestre: 1, carrera: 'AGR', correo: 'miguel.tellez@uni.edu', password: 'pass'},
            { id: '9', numControl: 'A20004', nombre: 'Diana', apellidoP: 'Vega', apellidoM: 'Paz', semestre: 5, carrera: 'AGR', correo: 'diana.vega@uni.edu', password: 'pass'},
        ];
    }
  } catch (e) {
    students = [];
  }
}

// Normalizar y asegurar datos (importante para evitar errores en el JS)
students = students.map((s, i) => ({
  numControl: s.numControl ?? s.id ?? '',
  nombre: s.nombre ?? s.name ?? '',
  apellidoP: s.apellidoP ?? s.apellidoPaterno ?? s.apellido_paterno ?? '',
  apellidoM: s.apellidoM ?? s.apellidoMaterno ?? s.apellido_materno ?? '',
  semestre: s.semestre ? parseInt(s.semestre) : 0, // Asegura que sea n√∫mero
  carrera: s.carrera ?? s.career ?? '',
  correo: s.correo ?? s.email ?? '', 
  password: s.password ?? s.contrasena ?? '', 
  id: s.id ?? String(i + 1), // Asegura un ID √∫nico para l√≥gica de pagos/local storage
}));

// Pasar datos a JS de manera segura para la inicializaci√≥n
const initialJSON = JSON.stringify(students).replace(/</g, '\\u003c');
---
<Layout title="Gesti√≥n de Estudiantes">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js" type="text/javascript" defer></script>

    <div class="max-w-7xl xl:max-w-screen-xl mx-auto px-4 py-10 bg-gray-50 min-h-screen"> 
    <header class="flex items-center justify-between mb-8 pb-4 border-b border-gray-200">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-teal-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M9 20l-2.003-.594A4 4 0 003 15.25V7a4 4 0 014-4h10a4 4 0 014 4v8.25c0 .59-.234 1.157-.659 1.571L17 20m-2 1a2 2 0 100-4 2 2 0 000 4zM8 10h.01M12 10h.01M16 10h.01M9 16h.01M13 16h.01" />
            </svg>
            Lista de Estudiantes
        </h1>
        <p class="text-sm text-gray-500 mt-1 ml-10">Visualiza, filtra y exporta la lista de alumnos.</p>
      </div>
      <div>
        <a href="/Dashboard" class="text-sm font-medium text-teal-600 hover:text-teal-800 transition duration-150 ease-in-out flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Volver
        </a>
      </div>
    </header>

    <section class="grid grid-cols-1 gap-6"> 
        <div id="table-container" class="bg-white p-6 rounded-xl shadow-xl col-span-1 flex flex-col border border-gray-100"> 
          
          <div class="flex items-center justify-between mb-4 flex-wrap gap-3 relative">
            
            <h2 class="font-bold text-xl text-gray-800">Lista de Estudiantes <span id="students-total" class="text-sm font-medium text-teal-600">({students.length})</span></h2>
            
            <div class="flex flex-wrap gap-2 items-center">
                
                <div class="relative w-48 sm:w-56"> 
                    <input type="text" id="search-bar" placeholder="Buscar N. Control o Nombre..." class="w-full p-2 pl-10 border border-gray-300 rounded-lg text-xs focus:ring-teal-500 focus:border-teal-500" />
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
                
                <button id="toggle-filters-btn" class="flex items-center px-3 py-2 rounded-lg bg-teal-50 border border-teal-200 text-teal-700 text-xs font-medium hover:bg-teal-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707v3.414l-4 4v-4.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    <span id="filters-status">Filtros</span>
                </button>
                
                <div id="filters-popover" class="absolute z-20 top-full right-0 mt-2 w-72 bg-white rounded-lg shadow-2xl p-4 border border-gray-200 hidden transform origin-top-right transition duration-200 ease-out scale-95 opacity-0">
                    <h3 class="text-sm font-bold text-gray-700 mb-3 border-b pb-2">Aplicar Filtros</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="filter-carrera" class="block text-xs font-medium text-gray-500 mb-1">Carrera:</label>
                            <select id="filter-carrera" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-gray-800 shadow-sm focus:ring-1 focus:ring-teal-500 focus:border-teal-500 transition text-sm">
                                <option value="">Todas</option>
                                <option value="AGR">Agronom√≠a</option>
                                <option value="INF">Inform√°tica</option>
                                <option value="ADM">Administraci√≥n</option>
                                <option value="TEC">Ofim√°tica</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="filter-semestre" class="block text-xs font-medium text-gray-500 mb-1">Semestre:</label>
                            <select id="filter-semestre" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-gray-800 shadow-sm focus:ring-1 focus:ring-teal-500 focus:border-teal-500 transition text-sm">
                                <option value="">Todos</option>
                                <option value="1">1ro</option>
                                <option value="2">2do</option>
                                <option value="3">3ro</option>
                                <option value="4">4to</option>
                                <option value="5">5to</option>
                                <option value="6">6to</option>
                                <option value="0">N/A</option>
                            </select>
                        </div>
                    </div>
                    <button id="clear-filters-btn" class="w-full mt-4 px-3 py-2 bg-red-50 text-red-700 border border-red-200 rounded-lg shadow-sm hover:bg-red-100 transition flex items-center justify-center text-xs">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        Limpiar Filtros
                    </button>
                </div>
                
                <button id="export-xlsx" class="flex items-center px-3 py-2 rounded-lg bg-gray-50 border text-gray-700 text-xs hover:bg-gray-100 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>XLSX</button>
                <button id="export-csv" class="flex items-center px-3 py-2 rounded-lg bg-gray-50 border text-gray-700 text-xs hover:bg-gray-100 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>CSV</button>
            </div>
            </div>
          
          <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full text-xs divide-y divide-gray-200">
              <thead class="bg-gray-50 text-left sticky top-0 z-10">
                <tr>
                    <th class="px-3 py-2 font-semibold text-gray-600 w-24">N. Control</th>
                    <th class="px-3 py-2 font-semibold text-gray-600 w-32">Nombre</th>
                    <th class="px-3 py-2 font-semibold text-gray-600 w-32">Apellido P.</th>
                    <th class="px-3 py-2 font-semibold text-gray-600 w-32">Apellido M.</th>
                    <th class="px-3 py-2 font-semibold text-gray-600 w-20 text-center">Semestre</th>
                    <th class="px-3 py-2 font-semibold text-gray-600 w-24">Carrera</th>
                    <th class="px-3 py-2 font-semibold text-gray-600 w-24 text-center">St. Pagos</th>
                    <th class="px-3 py-2 font-semibold text-gray-600 w-24 text-right">Adeudo</th>
                </tr>
              </thead>
              <tbody id="students-tbody" class="bg-white divide-y divide-gray-100">
                </tbody>
            </table>
          </div>
        </div>
    </section>
  </div>

  <script>
    // Variable global para inicializar el script de cliente con los datos de Astro
    window.__INITIAL_STUDENTS = JSON.parse('${initialJSON}');
  </script>

  <script type="module" client:load>
  (function () {
    const STORAGE_KEY = 'studentsList';
    const initial = Array.isArray(window.__INITIAL_STUDENTS) ? window.__INITIAL_STUDENTS : [];
    
    const CARRERA_MAP = {
        'AGR': 'Agronom√≠a',
        'INF': 'Inform√°tica',
        'ADM': 'Administraci√≥n',
        'TEC': 'Ofim√°tica',
        '': 'Sin Carrera',
        '0': 'Sin Carrera',
    };
    
    // Estado de los filtros, ahora incluye el t√©rmino de b√∫squeda
    let currentFilters = {
        semestre: '',
        carrera: '',
        searchText: ''
    };


    // Elementos del DOM
    const tbody = document.getElementById('students-tbody');
    const totalEl = document.getElementById('students-total');
    const filterCarrera = document.getElementById('filter-carrera');
    const filterSemestre = document.getElementById('filter-semestre');
    const filtersPopover = document.getElementById('filters-popover');
    const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
    const filtersStatusEl = document.getElementById('filters-status');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const searchBar = document.getElementById('search-bar'); 


    // --- FUNCIONES DE UTILIDAD CLAVE ---
    
    // Leer Local Storage o usar la lista inicial de Astro
    const readLocal = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw && raw !== '[]') {
             const arr = JSON.parse(raw);
             return Array.isArray(arr) ? arr : initial.slice();
        }
        return initial.slice();
      } catch (e) {
        return initial.slice();
      }
    };
    
    // Funci√≥n de escape HTML
    function escapeHtml(s) {
      if (s === undefined || s === null) return '';
      return String(s).replace(/[&<>"']/g, function (m) {
        return ({ '&':'&amp;','<':'&amp;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m];
      });
    }
    
    // Aplicar Filtros (Incluye b√∫squeda de texto)
    const applyFilters = (list) => {
        const text = currentFilters.searchText.toLowerCase().trim();

        return list.filter(s => {
            // Filtro por Carrera y Semestre
            const matchCarrera = !currentFilters.carrera || s.carrera === currentFilters.carrera;
            // CORRECCI√ìN: Se asegura que el semestre del estudiante sea tratado como string para la comparaci√≥n
            const matchSemestre = !currentFilters.semestre || String(s.semestre) === currentFilters.semestre; 
            
            // Filtro por Texto (Nombre o N. Control)
            let matchSearch = true;
            if (text.length > 0) {
                const nombreCompleto = `${s.nombre} ${s.apellidoP} ${s.apellidoM}`.toLowerCase();
                const numControl = s.numControl.toLowerCase();
                
                // Busca el texto en Nombre Completo o N√∫mero de Control
                matchSearch = nombreCompleto.includes(text) || numControl.includes(text);
            }
            
            return matchCarrera && matchSemestre && matchSearch;
        });
    };
    
    // Actualizar el estado de los filtros
    const updateFiltersStatus = (filteredCount, totalCount) => {
        // Se considera activo si hay b√∫squeda, o filtro de carrera/semestre aplicado
        const isActive = currentFilters.carrera || currentFilters.semestre || currentFilters.searchText.length > 0;
        totalEl.textContent = `(${totalCount}${isActive ? ' - Filtrados: ' + filteredCount : ''})`;
        
        // Muestra si hay filtros de b√∫squeda o selectores activos
        let statusText = 'Filtros';
        if (isActive) {
            statusText = currentFilters.searchText.length > 0 ? 'B√∫squeda/Filtros' : 'Filtros Activos';
        }
        filtersStatusEl.textContent = statusText;
        
        // Estilo del bot√≥n de filtros
        toggleFiltersBtn.classList.toggle('bg-teal-50', !isActive);
        toggleFiltersBtn.classList.toggle('bg-yellow-100', isActive);
        toggleFiltersBtn.classList.toggle('border-teal-200', !isActive);
        toggleFiltersBtn.classList.toggle('border-yellow-300', isActive);
    };

    // L√ìGICA DE PAGOS/ADEUDOS ‚Äî usar solo cargos (chargesList) para determinar estado
    function getChargesSumForStudent(studentId) {
        try {
            const charges = JSON.parse(localStorage.getItem('chargesList') || '[]');
            return charges
              .filter(c => String(c.studentId) === String(studentId))
              .reduce((sum, c) => sum + (Number(c.amount) || 0), 0);
        } catch (e) {
            return 0;
        }
    }

    // Si tiene adeudo (>0) => "Pago Pendiente", si no => "Al Corriente"
    const getStudentPaymentStatus = (studentId) => {
        const chargesSum = getChargesSumForStudent(studentId);
        const total = Number(chargesSum || 0);

        if (total > 0) {
            return {
                status: 'Pago Pendiente',
                adeudo: total.toFixed(2),
                isAdeudo: true
            };
        } else {
            return {
                status: 'Al Corriente',
                adeudo: '0.00',
                isAdeudo: false
            };
        }
    };

    // Ajuste de badges para los dos estados usados
    const getStatusBadge = (statusObj) => {
        const status = statusObj.status;
        const adeudo = statusObj.adeudo;

        let colorClasses = '';
        if (status === 'Pago Pendiente') {
            colorClasses = 'bg-yellow-100 text-yellow-800';
        } else if (status === 'Al Corriente') {
            colorClasses = 'bg-green-100 text-green-800';
        } else {
            colorClasses = 'bg-gray-100 text-gray-800';
        }

        const adeudoFormat = statusObj.isAdeudo ? `<span class="font-bold text-red-600">$${adeudo}</span>` : `<span class="text-green-600">N/A</span>`;

        return {
            statusHtml: `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${colorClasses}">${status}</span>`,
            adeudoHtml: adeudoFormat
        };
    };
    
    // Funci√≥n de renderizado principal
    const render = () => {
      // 1. Leer y Filtrar - Se lee del local storage y se aplican filtros
      const rawList = readLocal(); 
      const filteredList = applyFilters(rawList); 
      
      tbody.innerHTML = '';
      
      // La tabla tiene 8 columnas
      if (filteredList.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="px-4 py-8 text-center text-gray-500 italic">
                    No se encontraron estudiantes (${rawList.length} en total) con los filtros de b√∫squeda o selecci√≥n aplicados.
                </td>
            </tr>
        `;
      } else {
        // 2. Renderizar la lista filtrada
        filteredList.forEach((s) => {
            const paymentStatus = getStudentPaymentStatus(s.id); 
            const badges = getStatusBadge(paymentStatus); 

          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50';
          
          tr.innerHTML = `
            <td class="px-3 py-2 font-medium text-gray-900 w-24">${escapeHtml(s.numControl)}</td>
            <td class="px-3 py-2 w-32">${escapeHtml(s.nombre)}</td>
            <td class="px-3 py-2 w-32">${escapeHtml(s.apellidoP)}</td>
            <td class="px-3 py-2 w-32">${escapeHtml(s.apellidoM)}</td>
            <td class="px-3 py-2 w-20 text-center">${s.semestre === 0 ? 'N/A' : s.semestre}</td>
            <td class="px-3 py-2 text-teal-600 font-medium w-24">${CARRERA_MAP[s.carrera] || s.carrera}</td>
            
            <td class="px-3 py-2 w-24 text-center">${badges.statusHtml}</td>
            <td class="px-3 py-2 w-24 text-right">${badges.adeudoHtml}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      updateFiltersStatus(filteredList.length, rawList.length);
    };
    
    // --- Listeners de Eventos ---
    
    // Listener para la barra de b√∫squeda
    searchBar.addEventListener('input', (e) => {
        currentFilters.searchText = e.target.value;
        render(); // Llama a render en cada cambio para actualizar la tabla
    });

    // Listeners de Filtros 
    toggleFiltersBtn.addEventListener('click', () => {
        filtersPopover.classList.toggle('hidden');
        filtersPopover.classList.toggle('scale-95');
        filtersPopover.classList.toggle('opacity-0');
        filtersPopover.classList.toggle('scale-100');
        filtersPopover.classList.toggle('opacity-100');
    });

    filterCarrera.addEventListener('change', (e) => {
        currentFilters.carrera = e.target.value;
        render();
    });

    filterSemestre.addEventListener('change', (e) => {
        currentFilters.semestre = e.target.value;
        render();
    });

    clearFiltersBtn.addEventListener('click', () => {
        filterCarrera.value = '';
        filterSemestre.value = '';
        searchBar.value = ''; // Limpiar barra de b√∫squeda tambi√©n
        currentFilters.carrera = '';
        currentFilters.semestre = '';
        currentFilters.searchText = '';
        render();
        // Opcional: Cerrar el popover despu√©s de limpiar
        filtersPopover.classList.add('hidden', 'scale-95', 'opacity-0');
        filtersPopover.classList.remove('scale-100', 'opacity-100');
    });

    // Funci√≥n de Exportaci√≥n 
    const exportData = (format) => {
        const studentsToExport = readLocal().map(s => ({
            'Num Control': s.numControl,
            'Nombre': s.nombre,
            'Apellido Paterno': s.apellidoP,
            'Apellido Materno': s.apellidoM,
            'Semestre': s.semestre,
            'Carrera': CARRERA_MAP[s.carrera] || s.carrera,
            'Correo': s.correo,
            'Status Pago': getStudentPaymentStatus(s.id).status,
            'Adeudo': getStudentPaymentStatus(s.id).adeudo,
        }));
        
        const worksheet = XLSX.utils.json_to_sheet(studentsToExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Estudiantes");
        XLSX.writeFile(workbook, `estudiantes_lista.${format}`);
    };
    
    document.getElementById('export-xlsx').addEventListener('click', () => exportData('xlsx'));
    document.getElementById('export-csv').addEventListener('click', () => exportData('csv'));

    // Re-render cuando cambie localStorage (por ejemplo, se asign√≥ un concepto y se cre√≥ chargesList)
    window.addEventListener('storage', (e) => {
      if (['chargesList', 'studentsList', 'chargesLastUpdate', 'studentsLastUpdate'].includes(e.key)) {
        try { render(); } catch (err) { /* silent */ }
      }
    });

    // üèÅ Inicializaci√≥n (Primer renderizado)
    render();
  })();
  </script>
</Layout>