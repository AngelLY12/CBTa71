---
import Layout from "../layouts/Layout.astro";

const pageTitle = "Pagos Vencidos - CBTA 71";

// Note: Data will be loaded client-side with authentication
const overduePayments = [];

const overduePaymentsJSON = JSON.stringify(overduePayments);
---

<Layout title={pageTitle}>
  <!-- Load StudentAPI globally before any module scripts -->
  <script src="/studentAPI.js" is:inline></script>
  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    
    <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-10 pb-8 border-b-2 border-red-500/20">
      <div class="flex items-center gap-4 w-full justify-start">
        <div class="p-3 bg-red-600 rounded-xl shadow-lg shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4v2m0 4v2m0-12V4m-7 14l1-1m-1 1l-1 1m1-1l1-1m-1 1l-1-1m14 0l-1-1m1 1l1-1m-1 1l-1 1m1-1l1 1m-9-9l1 1m-1-1l-1 1m1-1l1-1m-1 1l-1-1" />
          </svg>
        </div>
        <div class="text-left">
          <h1 class="text-3xl font-black text-gray-900 tracking-tight leading-none text-left">Pagos Vencidos</h1>
          <p class="text-sm text-red-600 mt-1 font-medium text-left">⚠️ Requieren atención inmediata.</p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto justify-start lg:justify-end">
        <div class="relative w-full lg:w-[300px]">
           <input type="text" id="search-input" placeholder="Buscar alumno..." class="w-full pl-4 h-[46px] border-2 border-gray-200 rounded-xl text-sm outline-none focus:border-red-500 bg-white shadow-sm" />
        </div>
        <button id="refresh-overdue-btn" class="h-[46px] px-5 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-all flex items-center justify-center text-[10px] font-black uppercase tracking-widest gap-2 shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
          Actualizar
        </button>
        <button id="export-overdue" class="h-[46px] px-5 bg-red-600 text-white rounded-xl shadow-md hover:bg-red-700 transition-all flex items-center justify-center text-[10px] font-black uppercase tracking-widest gap-2">
           EXPORTAR EXCEL
        </button>
      </div>
    </header>

    <div class="bg-white rounded-[2rem] shadow-2xl border border-gray-100 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse">
          <thead class="bg-red-600">
            <tr>
              <th class="px-8 py-5 text-left text-[10px] font-black text-white uppercase tracking-widest">Estudiante</th>
              <th class="px-8 py-5 text-left text-[10px] font-black text-white uppercase tracking-widest">Concepto</th>
              <th class="px-8 py-5 text-left text-[10px] font-black text-white uppercase tracking-widest">Vencimiento</th>
              <th class="px-8 py-5 text-right text-[10px] font-black text-white uppercase tracking-widest">Monto</th>
              <th class="px-8 py-5 text-center text-[10px] font-black text-white uppercase tracking-widest">Días Vencidos</th>
            </tr>
          </thead>
          <tbody id="overdue-table-body" class="bg-white divide-y divide-gray-50"></tbody>
        </table>
      </div>

      <div class="px-8 py-4 bg-gray-50 border-t border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4">
        <span id="pagination-info" class="text-[11px] font-bold text-gray-500 uppercase">Mostrando 0 de 0 vencidos</span>
        <div class="flex items-center gap-2" id="pagination-buttons"></div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">
      <div class="bg-red-50 border border-red-200 rounded-xl p-6">
        <div class="text-center">
          <p class="text-sm font-bold text-red-600 uppercase">Total Vencido</p>
          <p id="total-overdue" class="text-3xl font-black text-red-600 mt-2">$0.00</p>
        </div>
      </div>
      
      <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
        <div class="text-center">
          <p class="text-sm font-bold text-yellow-600 uppercase">Pagos Vencidos</p>
          <p id="count-overdue" class="text-3xl font-black text-yellow-600 mt-2">0</p>
        </div>
      </div>
      
      <div class="bg-orange-50 border border-orange-200 rounded-xl p-6">
        <div class="text-center">
          <p class="text-sm font-bold text-orange-600 uppercase">Promedio Días Vencidos</p>
          <p id="avg-days-overdue" class="text-3xl font-black text-orange-600 mt-2">0</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>

  <script type="module">
    // StudentAPI is loaded globally via public/studentAPI.js
    
    // Wait for StudentAPI to be available
    async function ensureStudentAPI() {
      let attempts = 0;
      while (!window.StudentAPI && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      if (!window.StudentAPI) {
        throw new Error('StudentAPI could not be loaded');
      }
    }
    
    const ITEMS_PER_PAGE = 50;
    let currentPage = 1;
    let overduePayments = [];
    let isLoading = false;

    const tableBody = document.getElementById('overdue-table-body');
    const searchInput = document.getElementById('search-input');
    const paginationInfo = document.getElementById('pagination-info');
    const paginationButtons = document.getElementById('pagination-buttons');
    const refreshBtn = document.getElementById('refresh-overdue-btn');
    const exportBtn = document.getElementById('export-overdue');
    const totalOverdueEl = document.getElementById('total-overdue');
    const countOverdueEl = document.getElementById('count-overdue');
    const avgDaysEl = document.getElementById('avg-days-overdue');
    const AUTO_REFRESH_INTERVAL_MS = 180000;
    let autoRefreshTimer = null;
    let autoRefreshFocusHandler = null;
    let autoRefreshVisibilityHandler = null;

    const fmt = n => '$' + Number(n).toLocaleString('es-MX', { minimumFractionDigits: 2 });
    
    function calculateDaysOverdue(endDate) {
      const end = new Date(endDate);
      const today = new Date();
      const diff = today - end;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      return Math.max(0, days);
    }

    async function loadOverduePayments(forceRefresh = false) {
      if (isLoading) return;
      
      try {
        isLoading = true;
        if (refreshBtn) {
          refreshBtn.disabled = true;
          refreshBtn.innerHTML = `
            <svg class="animate-spin w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Cargando...
          `;
        }

        const token = localStorage.getItem('access_token');
        if (!token) {
          console.warn('No hay token de autenticación');
          renderTable();
          return;
        }

        // Obtener role del usuario
        const userRole = localStorage.getItem('user_role') || 'student';
        
        const response = await window.StudentAPI.getOverduePayments(null, token, forceRefresh, userRole);
        
        if (response.success && response.data?.pending_payments) {
          overduePayments = response.data.pending_payments.map(payment => ({
            id: payment.id,
            conceptName: payment.concept_name,
            description: payment.description,
            amount: parseFloat(payment.amount || 0),
            startDate: payment.start_date,
            endDate: payment.end_date,
            daysOverdue: calculateDaysOverdue(payment.end_date)
          }));
          
          console.log('✅ Pagos vencidos cargados:', overduePayments.length);
          renderTable();
          updateSummary();
        }
      } catch (error) {
        console.error('❌ Error al cargar pagos vencidos:', error);
        renderTable();
      } finally {
        isLoading = false;
        if (refreshBtn) {
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
            </svg>
            Actualizar
          `;
        }
      }
    }

    function renderTable() {
      const term = searchInput.value.toLowerCase();
      
      const filtered = overduePayments.filter(payment => {
        return !term || 
               payment.conceptName.toLowerCase().includes(term) ||
               payment.description.toLowerCase().includes(term);
      });

      const totalItems = filtered.length;
      const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
      if (currentPage > totalPages) currentPage = totalPages || 1;
      
      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const pageData = filtered.slice(start, start + ITEMS_PER_PAGE);

      tableBody.innerHTML = pageData.map((payment) => {
        const severityClass = payment.daysOverdue > 30 ? 'bg-red-50' : payment.daysOverdue > 7 ? 'bg-orange-50' : 'bg-yellow-50';
        const badgeClass = payment.daysOverdue > 30 ? 'text-red-600 bg-red-100' : payment.daysOverdue > 7 ? 'text-orange-600 bg-orange-100' : 'text-yellow-600 bg-yellow-100';
        
        return `
          <tr class="hover:bg-gray-50 transition-all border-l-4 border-red-500 ${severityClass}">
            <td class="px-8 py-5">
                <div class="text-[12px] font-black text-gray-900 uppercase">${payment.conceptName}</div>
                <div class="text-[9px] text-gray-400 font-mono font-bold">${payment.description}</div>
            </td>
            <td class="px-8 py-5 text-[11px] text-gray-600 font-bold">${payment.conceptName}</td>
            <td class="px-8 py-5 text-[11px] text-red-600 font-bold">${new Date(payment.endDate).toLocaleDateString('es-MX')}</td>
            <td class="px-8 py-5 text-right text-sm font-black text-red-600 font-mono">${fmt(payment.amount)}</td>
            <td class="px-8 py-5 text-center">
              <span class="px-3 py-1 rounded-full text-[11px] font-black ${badgeClass}">
                ${payment.daysOverdue}d
              </span>
            </td>
          </tr>
        `;
      }).join('');

      updatePaginationControls(totalItems, totalPages);
    }

    function updatePaginationControls(totalItems, totalPages) {
      const startItem = totalItems === 0 ? 0 : (currentPage - 1) * ITEMS_PER_PAGE + 1;
      const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
      paginationInfo.innerText = `Mostrando ${startItem}-${endItem} de ${totalItems} vencidos`;
      paginationButtons.innerHTML = '';
      if (totalPages <= 1) return;
      
      const createBtn = (text, targetPage, active = false, disabled = false) => {
        const btn = document.createElement('button');
        btn.innerText = text;
        btn.className = `min-w-[32px] h-8 px-2 rounded-lg text-xs font-black ${active ? 'bg-red-600 text-white' : disabled ? 'text-gray-300' : 'text-gray-500 hover:bg-gray-200'}`;
        if (!disabled) btn.onclick = () => { currentPage = targetPage; renderTable(); window.scrollTo(0,0); };
        return btn;
      };
      paginationButtons.appendChild(createBtn('←', currentPage - 1, false, currentPage === 1));
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          paginationButtons.appendChild(createBtn(i, i, currentPage === i));
        }
      }
      paginationButtons.appendChild(createBtn('→', currentPage + 1, false, currentPage === totalPages));
    }

    function updateSummary() {
      const totalAmount = overduePayments.reduce((sum, p) => sum + p.amount, 0);
      const count = overduePayments.length;
      const avgDays = count > 0 ? Math.round(overduePayments.reduce((sum, p) => sum + p.daysOverdue, 0) / count) : 0;
      
      if (totalOverdueEl) totalOverdueEl.textContent = fmt(totalAmount);
      if (countOverdueEl) countOverdueEl.textContent = count;
      if (avgDaysEl) avgDaysEl.textContent = avgDays;
    }

    // Export to Excel
    exportBtn.addEventListener('click', () => {
      const data = overduePayments.map(p => ({
        'Concepto': p.conceptName,
        'Descripción': p.description,
        'Monto': p.amount,
        'Fecha Vencimiento': new Date(p.endDate).toLocaleDateString('es-MX'),
        'Días Vencidos': p.daysOverdue
      }));

      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Pagos Vencidos");
      XLSX.writeFile(workbook, `Pagos_Vencidos_${new Date().toLocaleDateString()}.xlsx`);
    });

    // Event listeners
    searchInput.addEventListener('input', () => { currentPage = 1; renderTable(); });
    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => loadOverduePayments(true));
    }

    const triggerAutoRefresh = () => {
      if (isLoading || document.hidden) return;
      loadOverduePayments(true).catch((err) => console.warn('⚠️ Auto-refresh overdue:', err?.message || err));
    };

    const setupAutoRefresh = () => {
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
      autoRefreshTimer = setInterval(triggerAutoRefresh, AUTO_REFRESH_INTERVAL_MS);

      if (!autoRefreshFocusHandler) {
        autoRefreshFocusHandler = () => triggerAutoRefresh();
        window.addEventListener('focus', autoRefreshFocusHandler);
      }

      if (!autoRefreshVisibilityHandler) {
        autoRefreshVisibilityHandler = () => {
          if (!document.hidden) triggerAutoRefresh();
        };
        document.addEventListener('visibilitychange', autoRefreshVisibilityHandler);
      }
    };
    
    // Load data initially (esperar a que StudentAPI esté disponible)
    ensureStudentAPI()
      .then(() => {
        setupAutoRefresh();
        return loadOverduePayments();
      })
      .catch(err => console.error('❌ Error al inicializar:', err));

    window.addEventListener('beforeunload', () => {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
      }
    }, { once: true });
  </script>

  <style>
    [x-cloak] { display: none !important; }
  </style>
</Layout>
