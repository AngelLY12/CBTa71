---
import Layout from '../layouts/Layout.astro';
// RECUERDA: Debes incluir el script de Alpine.js en tu Layout.astro para que el modal funcione.
// Ejemplo: <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
---

<Layout title="Adeudos">
    <div class="bg-white p-6 rounded-2xl shadow-xl space-y-6" x-data="arrearsData()" x-init="init()" x-cloak>
        <div class="flex items-center justify-between space-x-3 text-[#2e594d] border-b pb-4 border-[#e5e7eb]">
            <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-users" width="32" height="32" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"></path>
                    <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
                    <path d="M16 3.161a3 3 0 1 0 3.839 3.839"></path>
                    <path d="M16 14v-1a4 4 0 0 1 4 -4h1"></path>
                </svg>
                <h1 class="text-2xl font-bold">Adeudos</h1>
            </div>

            <!-- Botón para abrir modal de validar pago -->
            <div>
                <button 
                    class="open-validate-btn inline-flex items-center gap-2 px-4 py-2 bg-[#2e594d] text-white rounded-lg hover:bg-[#234539]"
                    @click="openValidateModal()"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 5v14"></path><path d="M5 12h14"></path>
                    </svg>
                    Validar adeudo
                </button>
            </div>
        </div>

        <div class="space-y-6">
            <div class="flex items-center space-x-3 text-lg font-semibold text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-table" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M4 14m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v2a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path>
                    <path d="M4 6m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v2a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path>
                    <path d="M4 14h16"></path>
                </svg>
                <span>Registros de pagos / sesiones (pendientes y concretados)</span>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="relative flex-1">
                    <input 
                        type="text" 
                        x-model="searchTerm" 
                        placeholder="Buscar por ID, matrícula o nombre" 
                        class="w-full h-10 pl-10 pr-4 py-2 border border-gray-300 rounded-xl focus:border-[#3b7666] focus:ring-1 focus:ring-[#3b7666] transition duration-200"
                        @input.debounce.300ms="filterData"
                    >
                    <button @click="filterData" class="absolute inset-y-0 left-0 px-3 flex items-center text-gray-500 hover:text-[#2e594d]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path>
                            <path d="M21 21l-6 -6"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto rounded-xl border-t border-gray-300">
            <table class="min-w-full">
                <thead class="bg-white text-left">
                    <tr>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider">N. Control / Matrícula</th>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider">NOMBRE</th>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider">CONCEPTO</th>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer select-none" @click="sortBy = 'Monto', sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'">
                            <div class="flex items-center justify-end">
                                MONTO
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-selector ml-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <path d="M8 9l4 -4l4 4"></path>
                                    <path d="M16 15l-4 4l-4 -4"></path>
                                </svg>
                            </div>
                        </th>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider">ESTADO</th>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider">FECHA</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    <template x-for="(item, index) in paginatedData" :key="item.id">
                        <tr :class="index % 2 === 0 ? 'bg-white' : 'bg-[#f0fff4]'">
                            <td x-text="item.id" class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900 border-b border-gray-200"></td>
                            <td x-text="item.control" class="px-6 py-3 whitespace-nowrap text-sm text-gray-700 border-b border-gray-200"></td>
                            <td x-text="item.name" class="px-6 py-3 whitespace-nowrap text-sm text-gray-700 border-b border-gray-200"></td>
                            <td x-text="item.concept" class="px-6 py-3 whitespace-nowrap text-sm text-gray-700 border-b border-gray-200"></td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm font-semibold text-gray-800 border-b border-gray-200 text-right"><span x-text="formatCurrency(item.amount)"></span></td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700 border-b border-gray-200"><span :class="item.status === 'paid' ? 'text-green-600 font-semibold' : 'text-yellow-700' " x-text="item.statusLabel"></span></td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-600 border-b border-gray-200" x-text="item.dateLabel"></td>
                        </tr>
                    </template>
                    <tr x-show="paginatedData.length === 0">
                        <td colspan="7" class="text-center py-6 text-gray-500">No se encontraron registros.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <nav class="flex items-center justify-center pt-4" aria-label="Pagination">
            <div class="flex-1 flex justify-between sm:justify-center items-center space-x-2 text-sm">
                <button @click="currentPage > 1 && currentPage--" :disabled="currentPage === 1" class="text-gray-500 disabled:opacity-50 hover:text-[#2e594d] transition-colors flex items-center">&larr; Previous</button>
                
                <div class="flex space-x-1 items-center">
                    <template x-for="page in totalPages" :key="page">
                        <button 
                            x-show="shouldShowPage(page)"
                            @click="currentPage = page" 
                            x-text="page" 
                            :class="{'bg-gray-800 text-white': currentPage === page, 'text-gray-700 hover:bg-gray-100': currentPage !== page, 'px-3 py-1 rounded-full text-sm font-medium transition-colors': true}"
                        ></button>
                    </template>
                    <span x-show="totalPages > 5 && currentPage < totalPages - 2" class="px-1 py-1 text-gray-500">...</span>
                </div>
                
                <button @click="currentPage < totalPages && currentPage++" :disabled="currentPage === totalPages" class="text-gray-500 disabled:opacity-50 hover:text-[#2e594d] transition-colors flex items-center">Next &rarr;</button>
            </div>
        </nav>

    </div>

    <!-- Modal: Validar adeudo (imagen UI) -->
    <div id="validate-modal-overlay" x-show="showValidateModal" x-cloak @click="closeValidateModal()" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4">
      <div @click.stop class="bg-white rounded-2xl w-full max-w-xl p-6 border border-gray-200">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-800">Validar adeudo</h3>
          <button class="close-validate-btn text-gray-500 hover:text-gray-800" @click="closeValidateModal()">&times;</button>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-1">
            <label class="block text-sm text-gray-600 mb-1">Alumno</label>
            <div class="flex gap-2">
              <input x-ref="validateInput" x-model="validateStudentInput" @keyup.enter="searchStudent()" type="text" placeholder="N.Control o CURP de alumno" class="w-full border rounded px-3 py-2" />
              <button @click="searchStudent()" class="px-3 py-2 bg-[#2e594d] text-white rounded">Buscar</button>
            </div>
            <template x-if="foundStudent">
              <div class="mt-3 flex items-center text-green-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 6L9 17l-5-5"></path>
                </svg>
                <span>Alumno encontrado: <strong x-text="foundStudent.name"></strong></span>
              </div>
            </template>
            <template x-if="!foundStudent && validateStudentInput">
              <div class="mt-3 text-sm text-red-600">No se encontró alumno.</div>
            </template>
          </div>

          <div class="col-span-1">
            <label class="block text-sm text-gray-600 mb-1">Código</label>
            <input x-model="validateCode" type="text" placeholder="Escribe el código generado" class="w-full border rounded px-3 py-2" />
            <div class="text-sm text-gray-500 mt-2">Introduce el código de sesión/pago (Stripe / referencia).</div>
          </div>
        </div>

        <div class="mt-6">
          <div class="flex gap-3 justify-end">
            <button class="close-validate-btn px-4 py-2 border rounded" @click="closeValidateModal()" type="button">Cancelar</button>
            <button @click="validatePayment()" :disabled="!foundStudent || !validateCode" type="button" class="px-6 py-2 bg-green-600 text-white rounded disabled:opacity-50">
              Validar pago
            </button>
          </div>

          <div class="mt-4">
            <template x-if="validateMessage">
              <div class="text-sm text-green-700" x-text="validateMessage"></div>
            </template>
            <template x-if="validateError">
              <div class="text-sm text-red-600" x-text="validateError"></div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <script>
        function arrearsData() {
            // Helper to read various localStorage keys used across the app
            function safeParse(key) {
                try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch (e) { return []; }
            }

            function getCharges() {
                return safeParse('chargesList');
            }
            function saveCharges(arr) {
                try { localStorage.setItem('chargesList', JSON.stringify(arr)); localStorage.setItem('chargesLastUpdate', Date.now().toString()); } catch(e) {}
            }
            function getStudents() {
                return safeParse('studentsList');
            }
            // potential keys where minimal stripe session records could be stored
            function getSessions() {
                const candidates = ['paymentSessions', 'stripeSessions', 'pendingPayments', 'paymentsPending', 'payment_sessions'];
                for (const k of candidates) {
                    const data = safeParse(k);
                    if (Array.isArray(data) && data.length) return data;
                }
                return [];
            }

            // find student full name / control
            function findStudentInfo(students, sidOrCurp) {
                if (!students || !students.length) return null;
                const s = students.find(x => String(x.id) === String(sidOrCurp) || String(x.numControl) === String(sidOrCurp) || String(x.matricula) === String(sidOrCurp) || (x.curp && String(x.curp).toLowerCase() === String(sidOrCurp).toLowerCase()));
                if (!s) return null;
                const name = [s.nombre, s.apellidoP, s.apellidoM].filter(Boolean).join(' ').trim() || s.fullName || s.name || '-';
                const control = s.numControl ?? s.matricula ?? s.id ?? '-';
                return { name, control, raw: s };
            }

            return {
                items: [],
                filteredItems: [],
                searchTerm: '',
                sortBy: 'Monto',
                sortDirection: 'desc',
                itemsPerPage: 12,
                currentPage: 1,

                // validate modal state
                showValidateModal: false,
                validateStudentInput: '',
                validateCode: '',
                foundStudent: null,
                validateMessage: null,
                validateError: null,

                init() {
                    this.loadData();
                    // listen localStorage changes made elsewhere
                    window.addEventListener('storage', (e) => {
                        if (['chargesList','studentsList','paymentSessions','stripeSessions','pendingPayments','paymentsPending'].includes(e.key)) {
                            this.loadData();
                        }
                    });
                },

                openValidateModal() {
                  this.validateStudentInput = '';
                  this.validateCode = '';
                  this.foundStudent = null;
                  this.validateMessage = null;
                  this.validateError = null;
                  this.showValidateModal = true;
                  // focus input after modal opens
                  this.$nextTick(() => { if (this.$refs.validateInput) this.$refs.validateInput.focus(); });
                },

                closeValidateModal() {
                  this.showValidateModal = false;
                  // clear modal state on close
                  this.validateStudentInput = '';
                  this.validateCode = '';
                  this.foundStudent = null;
                  this.validateMessage = null;
                  this.validateError = null;
                },

                searchStudent() {
                  if (!this.validateStudentInput) {
                    this.foundStudent = null;
                    return;
                  }
                  const students = getStudents();
                  const res = findStudentInfo(students, this.validateStudentInput.trim());
                  this.foundStudent = res;
                  this.validateMessage = null;
                  this.validateError = null;
                },

                // combine payments (charges) and pending sessions into a single list
                loadData() {
                    const charges = getCharges();
                    const sessions = getSessions();
                    const students = getStudents();

                    const chargesBySessionId = new Set((charges || []).map(c => String(c.sessionId || c.session || c.id || '').trim()).filter(Boolean));

                    const sessionItems = (sessions || []).map(s => {
                        const sid = s.id || s.sessionId || s.paymentId || s.code || ('sess_' + (s._id || Math.random().toString(36).slice(2,8)));
                        // skip if there is a corresponding charge already recorded
                        if (chargesBySessionId.has(String(sid))) return null;
                        const studentInfo = (s.studentId || s.student || s.studentControl) ? (findStudentInfo(students, s.studentId || s.student || s.studentControl) || {name:'-', control: s.studentId||s.student||s.studentControl||'-'}) : {name:'-', control:'-'};
                        return {
                            id: String(sid),
                            sessionId: String(sid),
                            name: studentInfo.name,
                            control: studentInfo.control,
                            concept: s.conceptTitle || s.concept || s.description || 'Pago pendiente',
                            amount: Number(s.amount || s.total || s.value || 0),
                            status: 'pending',
                            statusLabel: 'Pendiente',
                            date: s.createdAt || s.created || s.date || null,
                            dateLabel: s.createdAt ? new Date(s.createdAt).toLocaleString() : (s.date ? String(s.date) : '-')
                        };
                    }).filter(Boolean);

                    const chargeItems = (charges || []).map(c => {
                        const studentInfo = (c.studentId || c.student || c.studentControl) ? (findStudentInfo(students, c.studentId || c.student || c.studentControl) || {name:'-', control: c.studentId||c.student||c.studentControl||'-'}) : {name:'-', control:'-'};
                        const id = c.id || c.chargeId || ('chg_' + Math.random().toString(36).slice(2,8));
                        const dateVal = c.paidAt || c.createdAt || c.created || c.date || null;
                        return {
                            id: String(id),
                            sessionId: c.sessionId ? String(c.sessionId) : null,
                            name: studentInfo.name,
                            control: studentInfo.control,
                            concept: c.conceptTitle || c.concept || c.description || '-',
                            amount: Number(c.amount || c.monto || 0),
                            status: (c.status || 'paid').toLowerCase(),
                            statusLabel: (c.status && String(c.status).toLowerCase().includes('paid')) ? 'Pagado' : (c.status || 'Pagado'),
                            date: dateVal,
                            dateLabel: dateVal ? new Date(dateVal).toLocaleString() : '-'
                        };
                    });

                    // Merge: sessions first (pending), then charges (completed)
                    this.items = [...sessionItems, ...chargeItems];
                    this.filteredItems = [...this.items];
                    this.currentPage = 1;
                    this.sortData();
                },

                formatCurrency(amount) {
                    const n = Number(amount || 0);
                    return `$${n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                },
                
                filterData() {
                    const q = String(this.searchTerm || '').trim().toLowerCase();
                    if (!q) {
                        this.filteredItems = [...this.items];
                    } else {
                        this.filteredItems = this.items.filter(item => {
                            return String(item.id || '').toLowerCase().includes(q) ||
                                String(item.control || '').toLowerCase().includes(q) ||
                                String(item.name || '').toLowerCase().includes(q) ||
                                String(item.concept || '').toLowerCase().includes(q);
                        });
                    }
                    this.currentPage = 1;
                    this.sortData();
                },

                // Validate payment using code and foundStudent
                validatePayment() {
                  this.validateMessage = null;
                  this.validateError = null;

                  if (!this.foundStudent) { this.validateError = 'Primero busca y selecciona un alumno.'; return; }
                  if (!this.validateCode) { this.validateError = 'Introduce el código de sesión/pago.'; return; }

                  const sessions = getSessions();
                  const charges = getCharges();

                  // buscar sesión por varios campos
                  const code = String(this.validateCode).trim();
                  const session = (sessions || []).find(s => {
                    return String(s.id) === code || String(s.sessionId) === code || String(s.paymentId) === code || String(s.code) === code || String(s.reference) === code;
                  });

                  // buscar cargo ya existente por sessionId o referencia
                  const existingCharge = (charges || []).find(c => String(c.sessionId) === code || String(c.reference) === code || String(c.id) === code);

                  if (!session && !existingCharge) {
                    this.validateError = 'No se encontró sesión ni pago con ese código.';
                    return;
                  }

                  if (existingCharge) {
                    this.validateMessage = 'Pago ya registrado en el sistema.';
                    // optionally mark as paid or update student adeudo reload
                    this.loadData();
                    return;
                  }

                  // si hay sesión y no existe cargo, crear registro mínimo en chargesList (base de datos mínima)
                  const amount = Number(session.amount || session.total || session.value || 0);
                  const now = new Date().toISOString();
                  const newCharge = {
                    id: 'chg_' + (Date.now().toString(36) + Math.random().toString(36).slice(2,6)),
                    sessionId: String(session.id || session.sessionId || session.paymentId || session.code || ''),
                    studentId: this.foundStudent.control,
                    amount,
                    method: session.paymentMethod || session.method || session.methodType || 'referenciado',
                    reference: code,
                    status: 'paid',
                    paidAt: now,
                    createdAt: now
                  };
                  charges.push(newCharge);
                  saveCharges(charges);

                  this.validateMessage = 'Pago validado y registrado correctamente.';
                  this.validateError = null;
                  this.loadData();
                },

                sortData() {
                    const key = this.sortBy;
                    this.filteredItems.sort((a, b) => {
                        let aVal = a[key === 'Monto' ? 'amount' : (key === 'Fecha' ? 'date' : key.toLowerCase())];
                        let bVal = b[key === 'Monto' ? 'amount' : (key === 'Fecha' ? 'date' : key.toLowerCase())];

                        if (key === 'Monto') {
                            aVal = Number(aVal || 0);
                            bVal = Number(bVal || 0);
                        } else if (key === 'Fecha') {
                            aVal = aVal ? new Date(aVal).getTime() : 0;
                            bVal = bVal ? new Date(bVal).getTime() : 0;
                        } else {
                            aVal = String(aVal || '').toLowerCase();
                            bVal = String(bVal || '').toLowerCase();
                        }

                        if (aVal < bVal) return this.sortDirection === 'asc' ? -1 : 1;
                        if (aVal > bVal) return this.sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                },

                get totalPages() {
                    return Math.max(1, Math.ceil(this.filteredItems.length / this.itemsPerPage));
                },
                get paginatedData() {
                    this.sortData();
                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    return this.filteredItems.slice(start, end);
                },
                
                shouldShowPage(page) {
                    if (this.totalPages <= 5) return true;
                    if (page === 1 || page === this.totalPages) return true;
                    if (page >= this.currentPage - 1 && page <= this.currentPage + 1) return true;
                    return false;
                }
            }
        }

        // Fallback DOM listeners para asegurar que el modal se cierre aunque Alpine falle
        document.addEventListener('DOMContentLoaded', () => {
          const overlay = document.getElementById('validate-modal-overlay');
          const openBtn = document.querySelector('.open-validate-btn');
          const closeBtns = document.querySelectorAll('.close-validate-btn');

          function domClose() {
            if (overlay) overlay.style.display = 'none';
            const root = document.querySelector('[x-data]');
            try {
              if (root && root.__x && root.__x.$data) {
                root.__x.$data.showValidateModal = false;
                root.__x.$data.validateStudentInput = '';
                root.__x.$data.validateCode = '';
                root.__x.$data.foundStudent = null;
                root.__x.$data.validateMessage = null;
                root.__x.$data.validateError = null;
              }
            } catch (e) { /* ignore */ }
          }

          function domOpen() {
            if (overlay) overlay.style.display = 'flex';
            const root = document.querySelector('[x-data]');
            try {
              if (root && root.__x && root.__x.$data) root.__x.$data.showValidateModal = true;
              setTimeout(() => { const ref = root ? root.querySelector('[x-ref="validateInput"]') : null; if (ref) ref.focus(); }, 80);
            } catch (e) { /* ignore */ }
          }

          if (openBtn) openBtn.addEventListener('click', domOpen);
          closeBtns.forEach(b => b.addEventListener('click', domClose));
          if (overlay) overlay.addEventListener('click', (e) => { if (e.target === overlay) domClose(); });
        });
    </script>
</Layout>