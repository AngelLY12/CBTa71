---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Roles y Usuarios">
    {/* Alpine.js Data Store para manejar el estado de la tabla */}
    <div x-data="rolesData" class="space-y-8">
        
        {/* Encabezado y Botón de Acción */}
        <header class="flex justify-between items-center pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-gray-900">
                Gestión de Roles y Usuarios
            </h1>
            {/* Botón "Nuevo Usuario" que abre el modal de agregar */}
            <button 
                @click="isAdding = true; isEditing = false; newUser = { id: null, username: '', email: '', role: 'caja', status: 'Activo' }"
                class="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14"/><path d="M5 12l14 0"/></svg>
                Nuevo Usuario
            </button>
        </header>

        {/* --- */}

        {/* Filtros y Búsqueda (Funcional con x-model) */}
        <section class="flex items-center space-x-4">
            <input 
                x-model="searchText"
                type="text" 
                placeholder="Buscar por nombre, email o rol..." 
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-600 focus:border-green-600"
            />
            <select x-model="filterRole" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-600 focus:border-green-600">
                <option value="">Todos los Roles</option>
                <option value="Administrador">Administrador</option>
                <option value="Caja">Caja</option>
                <option value="Maestro">Maestro</option>
            </select>
        </section>

        {/* --- */}

        {/* Tabla de Roles/Usuarios (Iteración con x-for) */}
        <section class="bg-gray-50 p-6 rounded-xl shadow-inner overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-300">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Nombre de Usuario</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Rol Asignado</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Estado</th>
                        <th class="px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {/* El filtro y la búsqueda se aplican en la propiedad 'filteredUsers' */}
                    <template x-for="user in filteredUsers" :key="user.id">
                        <tr class="hover:bg-gray-50 transition duration-150">
                            <td x-text="user.id" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"></td>
                            <td x-text="user.username" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"></td>
                            <td x-text="user.email" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"></td>
                            
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                {/* Colores dinámicos para el rol */}
                                <span :class="{
                                    'bg-red-100 text-red-800': user.role === 'Administrador',
                                    'bg-blue-100 text-blue-800': user.role === 'Caja',
                                    'bg-yellow-100 text-yellow-800': user.role === 'Maestro',
                                }" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    <span x-text="user.role"></span>
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                {/* Colores dinámicos para el estado */}
                                <span :class="{'bg-green-100 text-green-800': user.status === 'Activo', 'bg-red-100 text-red-800': user.status === 'Inactivo'}" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    <span x-text="user.status"></span>
                                </span>
                            </td>
                            
                            {/* Botones de acción */}
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2">
                                {/* Botón Editar */}
                                <button @click="editUser(user)" title="Editar" class="text-indigo-600 hover:text-indigo-900">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"/><path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.585 8.585v4h4l8.585 -8.585z"/><path d="M16 5l3 3"/></svg>
                                </button>
                                {/* Botón Borrar */}
                                <button @click="deleteUser(user.id)" title="Eliminar" class="text-red-600 hover:text-red-900">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0"/><path d="M10 11l0 6"/><path d="M14 11l0 6"/><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"/><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"/></svg>
                                </button>
                            </td>
                        </tr>
                    </template>

                    {/* Mensaje de No Resultados */}
                    <tr x-show="filteredUsers.length === 0">
                        <td colspan="6" class="px-6 py-4 text-center text-lg text-gray-500">
                            No se encontraron usuarios que coincidan con los criterios.
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>


        {/* Modal de Agregar/Editar (x-show) */}
        <div x-show="isAdding || isEditing" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div @click.away="closeModal()" class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 space-y-4 transform transition-all">
                <h3 class="text-xl font-bold text-gray-900" x-text="isAdding ? 'Agregar Nuevo Usuario' : 'Editar Usuario'"></h3>
                <form @submit.prevent="saveUser()" class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Nombre de Usuario</label>
                        <input x-model="newUser.username" id="username" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input x-model="newUser.email" id="email" type="email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="role" class="block text-sm font-medium text-gray-700">Rol Asignado</label>
                        <select x-model="newUser.role" id="role" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500">
                            <option value="Administrador">Administrador</option>
                            <option value="Caja">Caja</option>
                            <option value="Maestro">Maestro</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 pt-2">
                        <button @click.prevent="closeModal()" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition">
                            <span x-text="isAdding ? 'Guardar Usuario' : 'Actualizar Usuario'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</Layout>

<script is:inline>
    // Inicialización del objeto de datos y lógica de Alpine.js
    document.addEventListener('alpine:init', () => {
        Alpine.data('rolesData', () => ({
            // --- Estado de la aplicación ---
            users: [
                { id: 101, username: 'admin_sys', email: 'admin@cbta71.edu.mx', role: 'Administrador', status: 'Activo' },
                { id: 105, username: 'martha_caja', email: 'martha@cbta71.edu.mx', role: 'Caja', status: 'Activo' },
                { id: 110, username: 'pedro_maestro', email: 'pedro@cbta71.edu.mx', role: 'Maestro', status: 'Inactivo' },
                { id: 115, username: 'luisa_caja', email: 'luisa@cbta71.edu.mx', role: 'Caja', status: 'Activo' },
            ],
            searchText: '',
            filterRole: '',
            isAdding: false,
            isEditing: false,
            newUser: { id: null, username: '', email: '', role: 'Caja', status: 'Activo' }, // Objeto para el modal

            // --- Computed Property para filtros y búsqueda ---
            get filteredUsers() {
                let filtered = this.users;
                
                // 1. Filtrar por Rol
                if (this.filterRole) {
                    filtered = filtered.filter(user => user.role === this.filterRole);
                }

                // 2. Buscar por texto
                if (this.searchText.length > 0) {
                    const searchLower = this.searchText.toLowerCase();
                    filtered = filtered.filter(user => 
                        user.username.toLowerCase().includes(searchLower) ||
                        user.email.toLowerCase().includes(searchLower) ||
                        user.role.toLowerCase().includes(searchLower)
                    );
                }

                return filtered;
            },

            // --- Funciones de CRUD (Simuladas) ---
            closeModal() {
                this.isAdding = false;
                this.isEditing = false;
                this.newUser = { id: null, username: '', email: '', role: 'Caja', status: 'Activo' };
            },

            // 1. Agregar/Actualizar Usuario
            saveUser() {
                if (this.isEditing) {
                    // Lógica de Edición
                    const index = this.users.findIndex(u => u.id === this.newUser.id);
                    if (index !== -1) {
                        this.users[index] = { ...this.newUser }; // Actualiza el objeto
                        alert(`Usuario ${this.newUser.username} actualizado.`);
                    }
                } else {
                    // Lógica de Adición
                    const newId = Math.max(...this.users.map(u => u.id)) + 1;
                    const newUserWithId = { ...this.newUser, id: newId };
                    this.users.push(newUserWithId); // Añade el nuevo usuario
                    alert(`Usuario ${newUserWithId.username} agregado con ID ${newId}.`);
                }
                this.closeModal();
            },

            // 2. Editar Usuario (prepara el modal)
            editUser(user) {
                this.isEditing = true;
                this.isAdding = false;
                // Clona el objeto para evitar modificar el original directamente antes de guardar
                this.newUser = { ...user }; 
            },

            // 3. Borrar Usuario
            deleteUser(id) {
                if (confirm('¿Estás seguro de que quieres eliminar este usuario? (Simulación)')) {
                    this.users = this.users.filter(user => user.id !== id);
                    alert(`Usuario con ID ${id} eliminado.`);
                }
            }
        }));
    });
</script>