---
// src/pages/pago_estado.astro
import Layout from "../layouts/Layout.astro"; 

const pageTitle = "Historial de Pagos - CBTA 71";
const primaryColor = "#154335"; 
const primaryBg = "[#154335]";
const accentColor = "green-600";
const lightAccent = "green-50";

let students = [];
try {
    const res = await fetch('/api/students');
    if (res.ok) {
        const json = await res.json();
        students = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
    }
} catch (e) {}

if (!students.length) {
    try {
        const mod = await import('../data/students.js'); 
        students = mod.default || mod.students || [];
    } catch (e) {
        students = [];
    }
}

const safeStudents = students.map((s, i) => ({
    id: s.id ?? String(i + 1),
    numControl: s.numControl ?? s.id ?? '',
    nombre: s.nombre ?? s.name ?? '',
    apellidoP: s.apellidoP ?? s.apellidoPaterno ?? '',
    apellidoM: s.apellidoM ?? s.apellidoMaterno ?? '',
    carrera: s.carrera ?? s.career ?? '',
}));

const studentsJSON = JSON.stringify(safeStudents).replace(/</g, '\\u003c');
---

<Layout title={pageTitle}>
<div class="max-w-7xl xl:max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-10 bg-gray-50/50 min-h-screen">

    <!-- Header con filtros -->
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 pb-4 border-b border-green-700/50">
        <div>
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">
                Historial de Pagos Realizados üí∞
            </h1>
            <p class="text-sm text-gray-500 mt-1">Monitoreo y gesti√≥n de transacciones de estudiantes.</p>
        </div>

        <!-- Filtros alineados a la derecha -->
        <div class="mt-4 sm:mt-0 flex gap-3 items-center">
            <select id="method-filter" class="border border-gray-300 rounded-lg px-4 py-2 text-sm bg-white shadow-sm focus:ring-green-500 focus:border-green-500 transition">
                <option value="all">Todos los m√©todos</option>
                <option value="tarjeta">Tarjeta</option>
                <option value="referencia">Pago referenciado</option>
                <option value="transferencia">Transferencia</option>
                <option value="otro">Efectivo / Otro</option>
            </select>

            <select id="semester-filter" class="border border-gray-300 rounded-lg px-4 py-2 text-sm bg-white shadow-sm focus:ring-green-500 focus:border-green-500 transition">
                <option value="all">Todos los semestres</option>
                <option value="1">Semestre 1</option>
                <option value="2">Semestre 2</option>
                <option value="3">Semestre 3</option>
                <option value="4">Semestre 4</option>
                <option value="5">Semestre 5</option>
                <option value="6">Semestre 6</option>
            </select>
        </div>
    </header>

    <!-- Tabla de pagos -->
    <div class="bg-white rounded-xl shadow-xl border border-gray-100 overflow-x-auto mb-6">
        <table class="min-w-full divide-y divide-gray-200 text-base">
            <thead class={`bg-${primaryBg} sticky top-0 z-10`}>
                <tr>
                    <th class="px-4 py-3 text-left font-semibold text-white uppercase tracking-wider">Fecha</th>
                    <th class="px-4 py-3 text-left font-semibold text-white uppercase tracking-wider">Concepto</th>
                    <th class="px-4 py-3 text-right font-semibold text-white uppercase tracking-wider">Monto</th>
                    <th class="px-4 py-3 text-left font-semibold text-white uppercase tracking-wider">M√©todo</th>
                    <th class="px-4 py-3 text-left font-semibold text-white uppercase tracking-wider">N. Control</th>
                    <th class="px-4 py-3 text-left font-semibold text-white uppercase tracking-wider">Alumno</th>
                    <th class="px-4 py-3 text-right font-semibold text-white uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody id="payments-table-body" class="bg-white divide-y divide-gray-100 text-sm"></tbody>
        </table>
        <div id="no-payments" class="hidden text-center text-gray-500 py-6 text-sm italic">
            No se encontraron transacciones con el filtro actual.
        </div>
    </div>

    <!-- Modal de detalle -->
    <div id="detail-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 transition-opacity duration-300 ease-out opacity-0 hidden">
        <div class="bg-white rounded-xl w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300 ease-out">
            <div class={`px-5 py-3 bg-${primaryBg} rounded-t-xl flex justify-between items-center`}>
                <h3 class="text-lg font-bold text-white tracking-wide">Detalle de Transacci√≥n</h3>
                <button id="close-modal-icon" class="text-white hover:text-green-200 transition">
                    ‚úñ
                </button>
            </div>
            <div class="p-5 space-y-5">
                <div class="border-b border-gray-200 pb-4">
                    <h4 class="text-base font-bold text-gray-700 mb-2">Datos del Estudiante</h4>
                    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <div>
                            <dt class="text-gray-500 font-medium">Nombre Completo:</dt>
                            <dd id="detail-student-name" class="text-gray-900 font-semibold mt-0.5"></dd>
                        </div>
                        <div>
                            <dt class="text-gray-500 font-medium">N. Control / Matr√≠cula:</dt>
                            <dd id="detail-student-control" class="text-gray-900 mt-0.5"></dd>
                        </div>
                        <div>
                            <dt class="text-gray-500 font-medium">Carrera:</dt>
                            <dd id="detail-student-carrera" class="text-gray-900 mt-0.5"></dd>
                        </div>
                        <div class="col-span-1 sm:col-span-2">
                            <dt class="text-gray-500 font-medium">Adeudo Pendiente Total:</dt>
                            <dd id="detail-student-adeudo" class="text-xl font-extrabold text-red-600 mt-0.5"></dd>
                        </div>
                    </dl>
                </div>

                <div>
                    <h4 class="text-base font-bold text-gray-700 mb-2">Detalles de la Transacci√≥n</h4>
                    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <div class="sm:col-span-2">
                            <dt class="text-gray-500 font-medium">Concepto:</dt>
                            <dd id="detail-payment-concept" class="text-gray-900 font-bold text-sm mt-0.5"></dd>
                        </div>
                        <div class="col-span-1">
                            <dt class="text-gray-500 font-medium">Monto Pagado:</dt>
                            <dd id="detail-payment-amount" class="text-xl font-extrabold text-green-700 mt-0.5"></dd>
                        </div>
                        <div class="col-span-1">
                            <dt class="text-gray-500 font-medium">Fecha y Hora de Pago:</dt>
                            <dd id="detail-payment-date" class="text-gray-900 mt-0.5 text-xs sm:text-sm"></dd>
                        </div>
                        <div class="col-span-1">
                            <dt class="text-gray-500 font-medium">M√©todo de Pago:</dt>
                            <dd id="detail-payment-method" class="text-gray-900 mt-0.5 text-xs sm:text-sm"></dd>
                        </div>
                        <div class="col-span-1">
                            <dt class="text-gray-500 font-medium">Referencia/Folio:</dt>
                            <dd id="detail-payment-reference" class="text-gray-900 italic mt-0.5 text-xs sm:text-sm">N/A</dd>
                        </div>
                    </dl>
                </div>
            </div>
            <div class="px-5 py-3 bg-gray-50 rounded-b-xl flex justify-end border-t border-gray-200">
                <button id="close-modal" class="px-3 py-1.5 bg-gray-100 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-200 transition">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
window.__INITIAL_STUDENTS_PAYMENTS = JSON.parse('${studentsJSON}');
</script>

<script type="module" client:load>
(function() {
    const CHARGES_STORAGE_KEY = 'chargesList';
    const STUDENT_STORAGE_KEY = 'studentsList'; 

    const METHOD_MAP = {
        'tarjeta': 'Tarjeta de Cr√©dito/D√©bito',
        'referencia': 'Pago Referenciado (Banco)',
        'transferencia': 'Transferencia Electr√≥nica',
        'otro': 'Efectivo / Otro',
        '': 'Sin especificar'
    };

    const paymentsTableBody = document.getElementById('payments-table-body');
    const methodFilter = document.getElementById('method-filter');
    const semesterFilter = document.getElementById('semester-filter');

    const detailModal = document.getElementById('detail-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const closeModalIconBtn = document.getElementById('close-modal-icon'); 
    const detailStudentName = document.getElementById('detail-student-name');
    const detailStudentControl = document.getElementById('detail-student-control');
    const detailStudentCarrera = document.getElementById('detail-student-carrera');
    const detailStudentAdeudo = document.getElementById('detail-student-adeudo');
    const detailPaymentAmount = document.getElementById('detail-payment-amount');
    const detailPaymentDate = document.getElementById('detail-payment-date');
    const detailPaymentConcept = document.getElementById('detail-payment-concept');
    const detailPaymentMethod = document.getElementById('detail-payment-method');
    const detailPaymentReference = document.getElementById('detail-payment-reference');

    let initialStudents = window.__INITIAL_STUDENTS_PAYMENTS;

    const readCharges = () => {
        try {
            const raw = localStorage.getItem(CHARGES_STORAGE_KEY);
            return JSON.parse(raw || '[]').filter(c => String(c.status || '').toLowerCase() === 'paid' || String(c.status || '').toLowerCase() === 'pagado');
        } catch (e) { return []; }
    };

    const readStudents = () => {
        try {
            const raw = localStorage.getItem(STUDENT_STORAGE_KEY);
            return raw && raw !== '[]' ? JSON.parse(raw) : initialStudents;
        } catch (e) { return initialStudents; }
    };

    const formatCurrency = (amount) => new Intl.NumberFormat('es-MX', { style:'currency', currency:'MXN', minimumFractionDigits:2 }).format(amount);

    const applyFilters = (list) => {
        const method = methodFilter.value;
        const semester = semesterFilter.value;
        return list.filter(p => {
            let methodMatch = (method === 'all') || ((p.paymentMethod || p.method || '').toLowerCase() === method);
            let semesterMatch = true;
            if (semester !== 'all') semesterMatch = String(p.semester || '') === semester;
            return methodMatch && semesterMatch;
        });
    };

    const renderPaymentsTable = () => {
        const payments = applyFilters(readCharges());
        const studentsData = readStudents();
        paymentsTableBody.innerHTML = '';

        if (!payments.length) {
            paymentsTableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-center text-gray-500 font-medium text-sm">üòî No se encontraron transacciones.</td></tr>';
            return;
        }

        payments.sort((a,b) => new Date(b.paidAt || b.createdAt || b.date) - new Date(a.paidAt || a.createdAt || a.date));

        payments.forEach(p => {
            const student = studentsData.find(s => String(s.id) === String(p.studentId) || String(s.numControl) === String(p.studentId));
            const studentName = student ? `${student.nombre} ${student.apellidoP} ${student.apellidoM}`.trim() : 'Alumno Desconocido';
            const numControl = student ? student.numControl : (p.studentId || 'N/A');
            const date = new Date(p.paidAt || p.createdAt || p.date);
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 transition duration-150 ease-in-out';
            tr.innerHTML = `
                <td class="px-4 py-3 text-gray-500">${date.toLocaleDateString('es-MX')}</td>
                <td class="px-4 py-3 text-gray-900 font-medium">${p.conceptTitle || p.concept || 'Pago de Matr√≠cula'}</td>
                <td class="px-4 py-3 text-green-700 font-bold text-right">${formatCurrency(p.amount)}</td>
                <td class="px-4 py-3"><span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-blue-100 text-blue-800">${METHOD_MAP[(p.paymentMethod || p.method || 'otro').toLowerCase()]}</span></td>
                <td class="px-4 py-3 text-gray-700">${numControl}</td>
                <td class="px-4 py-3 text-gray-700 font-light">${studentName}</td>
                <td class="px-4 py-3 text-right"><button class="view-detail-btn px-2 py-1 text-xs bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition" data-payment-id="${p.id}" data-student-id="${p.studentId}">Detalle</button></td>
            `;
            paymentsTableBody.appendChild(tr);
        });

        document.querySelectorAll('.view-detail-btn').forEach(button => {
            button.removeEventListener('click', handleDetailClick); 
            button.addEventListener('click', handleDetailClick);
        });
    };

    const openModal = () => {
        detailModal.classList.remove('hidden');
        setTimeout(() => {
            detailModal.classList.remove('opacity-0');
            detailModal.querySelector('div').classList.remove('scale-95');
            detailModal.querySelector('div').classList.add('scale-100');
        }, 10);
    };

    const closeModal = () => {
        detailModal.classList.add('opacity-0');
        detailModal.querySelector('div').classList.remove('scale-100');
        detailModal.querySelector('div').classList.add('scale-95');
        setTimeout(() => detailModal.classList.add('hidden'), 300);
    };

    const showPaymentDetail = (paymentId, studentId) => {
        const payments = readCharges();
        const studentsData = readStudents();
        const payment = payments.find(p => String(p.id) === String(paymentId));
        const student = studentsData.find(s => String(s.id) === String(studentId) || String(s.numControl) === String(studentId));
        if (!payment || !student) return alert('Detalle no encontrado');

        detailStudentName.textContent = `${student.nombre} ${student.apellidoP} ${student.apellidoM}`.trim();
        detailStudentControl.textContent = student.numControl || 'N/A';
        detailStudentCarrera.textContent = student.carrera || 'N/A';
        detailStudentAdeudo.textContent = formatCurrency(0); // Adeudo pendiente: si tienes l√≥gica, reemplazar

        detailPaymentAmount.textContent = formatCurrency(payment.amount);
        detailPaymentDate.textContent = new Date(payment.paidAt || payment.createdAt || payment.date).toLocaleString('es-MX');
        detailPaymentConcept.textContent = payment.conceptTitle || payment.concept || 'Pago Manual';
        detailPaymentMethod.textContent = METHOD_MAP[(payment.paymentMethod || payment.method || 'otro').toLowerCase()];
        detailPaymentReference.textContent = payment.reference || 'N/A';

        openModal();
    };

    const handleDetailClick = (e) => {
        const paymentId = e.currentTarget.dataset.paymentId;
        const studentId = e.currentTarget.dataset.studentId;
        showPaymentDetail(paymentId, studentId);
    };

    methodFilter.addEventListener('change', renderPaymentsTable);
    semesterFilter.addEventListener('change', renderPaymentsTable);
    closeModalBtn.addEventListener('click', closeModal);
    closeModalIconBtn.addEventListener('click', closeModal);
    detailModal.addEventListener('click', e => { if(e.target === detailModal) closeModal(); });
    document.addEventListener('keydown', e => { if(e.key === 'Escape') closeModal(); });
    window.addEventListener('storage', e => { if(e.key===CHARGES_STORAGE_KEY||e.key===STUDENT_STORAGE_KEY) renderPaymentsTable(); });

    renderPaymentsTable();
})();
</script>
</Layout>
